<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0000ff">

  <style>
    :root{
      --primary-color:#4a6bff;--secondary-color:#f8f9fa;--accent-color:#ff6b6b;
      --text-color:#222;--light-text:#6c757d;--border-color:#dee2e6;
      --success-color:#28a745;--warning-color:#ffc107;--danger-color:#dc3545;
      --sky:#e9f0ff;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    /* ğŸŒ™ ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    [data-theme="dark"] {
      --primary-color: #6c8eff;
      --secondary-color: #1a1a1a;
      --accent-color: #ff6b6b;
      --text-color: #ffffff;
      --light-text: #a0a0a0;
      --border-color: #333333;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --sky: #2a2a2a;
      --gradient-primary: linear-gradient(135deg, #4a6bff 0%, #6a11cb 100%);
      --gradient-secondary: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    html,body{height:100%}
    body{background:#f5f5f5;color:var(--text-color);overscroll-behavior-y:contain;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .container{max-width:100%;min-height:100vh;background:#fff;padding-bottom:70px}

    /* ğŸŒ™ Ø®Ù„ÙÙŠØ© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    [data-theme="dark"] body,
    [data-theme="dark"] .container {
      background: #121212;
      color: #ffffff;
    }

    [data-theme="dark"] .post,
    [data-theme="dark"] .company,
    [data-theme="dark"] .modal-content,
    [data-theme="dark"] .header,
    [data-theme="dark"] .bottom-nav {
      background: #1e1e1e;
      color: #ffffff;
      border-color: #333;
    }

    [data-theme="dark"] .form-control,
    [data-theme="dark"] .select-control,
    [data-theme="dark"] .filter-select {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }

    [data-theme="dark"] .post-description {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .profile-actions-card {
      background: var(--gradient-secondary);
    }

    /* ğŸŒ™ Ø¥ØµÙ„Ø§Ø­: Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    [data-theme="dark"] .post-username,
    [data-theme="dark"] .user-name,
    [data-theme="dark"] .post-title {
      color: #ffffff !important;
    }

    /* ğŸŒ™ Ø¥ØµÙ„Ø§Ø­: Ø®Ù„ÙÙŠØ© ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
    [data-theme="dark"] .filter-container {
      background: #1e1e1e;
      border-color: #333;
    }

    [data-theme="dark"] .filter-select {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }

    /* ===== Ø£Ù†Ù…ÙŠØ´Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ù…Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ===== */
    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
                  radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
                  linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);
      z-index: 9999;
      overflow: hidden;
      transition: opacity .6s ease;
    }

    .splash.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .runner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .08em;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
      pointer-events: none;
    }

    .runner span {
      font-weight: 900;
      font-size: clamp(40px, 9vw, 74px);
      color: #e6ebff;
      display: inline-block;
      opacity: 0;
      transform: translateX(6vw) scale(.96);
      animation: runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;
      will-change: transform, opacity;
    }

    .runner span:nth-child(1){ animation-delay:.00s }
    .runner span:nth-child(2){ animation-delay:.05s }
    .runner span:nth-child(3){ animation-delay:.10s }
    .runner span:nth-child(4){ animation-delay:.15s }
    .runner span:nth-child(5){ animation-delay:.20s }
    .runner span:nth-child(6){ animation-delay:.25s }
    .runner span:nth-child(7){ animation-delay:.30s }
    .runner span:nth-child(8){ animation-delay:.35s }
    .runner span:nth-child(9){ animation-delay:.40s }
    .runner span:nth-child(10){ animation-delay:.45s }

    @keyframes runCentered {
      0% { opacity: 0; transform: translateX(6vw) scale(.96) }
      18% { opacity: 1 }
      55% { transform: translateX(-6vw) scale(1.02) }
      100% { opacity: 0; transform: translateX(-6vw) scale(.98) }
    }

    .final-logo {
      position: relative;
      z-index: 2;
      opacity: 0;
      font-weight: 900;
      font-size: clamp(42px, 9.5vw, 72px);
      color: #eef2ff;
      text-shadow: 0 14px 40px rgba(16,209,255,.22), 0 4px 10px rgba(0,0,0,.5);
      white-space: nowrap;
      line-height: 1;
      direction: rtl;
      unicode-bidi: plaintext;
      animation: logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards;
    }

    @keyframes logoMerge {
      0% { opacity: 0; transform: translateY(18px) scale(.94) }
      100% { opacity: 1; transform: translateY(0) scale(1) }
    }

    /* ğŸ”¥ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ù†Øµ Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    .loading-text {
      position: absolute;
      bottom: 30%;
      color: #a0b4ff;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      opacity: 0;
      animation: loadingPulse 2s infinite;
      direction: rtl;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    .loading-text.show {
      display: block;
      animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Ø²Ø± Ø´Ø±Ø­ Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ */
    .help-floating-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #4a6bff, #6a11cb);
      color: white;
      padding: 12px 16px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(74, 107, 255, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .help-floating-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 107, 255, 0.6);
    }

    /* Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ */
    .theme-toggle-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      color: white;
      z-index: 1001;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    /* Auth */
    .auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;background:linear-gradient(135deg,#4a6bff,#6a11cb); position: relative;}
    .auth-box{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;width:100%;max-width:420px;text-align:center}
    .auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .auth-tab{flex:1;padding:10px;cursor:pointer;font-weight:500;color:var(--light-text);transition:.3s}
    .auth-tab.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
    .auth-form{display:none}.auth-form.active{display:block}
    .form-group{margin-bottom:15px;text-align:right}
    .form-group label{display:block;margin-bottom:5px;font-weight:500}
    .form-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,107,255,.2)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}

    /* ===== ØªØ¹Ø¯ÙŠÙ„: Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ===== */
    .avatar-upload-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin: 15px 0;
    }

    .avatar-upload-btn-large {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 2px dashed var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--light-text);
    }

    .avatar-upload-btn-large:hover {
        border-color: var(--primary-color);
        background: var(--sky);
        color: var(--primary-color);
        transform: translateY(-2px);
    }

    .avatar-upload-btn-large i {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .avatar-upload-btn-large span {
        font-size: 12px;
        font-weight: 600;
    }

    /* ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===== */
    .avatar-container {
        position: relative;
        display: inline-block;
    }

    .avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: #d7e4ff;
        color: #2740b9;
        font-size: 40px;
        cursor: pointer;
        border: 2px solid #c9d7ff;
        overflow: hidden;
    }

    .avatar-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #4a6bff;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .avatar-upload-btn:hover {
        background: #3a5bef;
        transform: scale(1.1);
    }

    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
    .rank-avatar-container {
        position: relative;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
    }

    .rank-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    /* Buttons */
    .btn{display:inline-block;padding:10px 14px;background:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;width:auto}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none}
    .btn-block{width:100%}
    .btn-secondary{background:var(--secondary-color);color:var(--text-color)}
    .btn-danger{background:var(--danger-color);color:#fff}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color);color:#111}
    .btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}

    /* Header */
    .header{position:sticky;top:0;background:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);z-index:100}
    .brand{display:flex;align-items:center;gap:8px}
    .section-switch{display:inline-flex;background:#f2f4ff;border:1px solid #dfe4ff;border-radius:999px;overflow:hidden;margin-inline-start:10px}
    .section-pill{padding:6px 10px;font-size:12px;font-weight:800;color:#3a5bef;cursor:pointer;border:none;background:transparent}
    .section-pill.active{background:#3a5bef;color:#fff}
    .icon-btn{position:relative;background:transparent;border:none;cursor:pointer;font-size:20px}
    .icon-btn .dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#ff3b3b;border-radius:50%;display:none}
    .icon-btn.has-unseen .dot{display:block}

    .filter-container{padding:15px;background:#fff;border-bottom:1px solid var(--border-color); display:flex; gap:10px;}
    .filter-select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:5px}
    
    /* ğŸ”¥ Ø¥ØµÙ„Ø§Ø­: ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª */
    .posts-container{padding:15px 15px 90px}
    .pull-indicator{position:relative;height:0;overflow:visible}
    .pull-indicator .bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#e9f0ff;border:1px solid #d0dcff;border-radius:999px;padding:4px 10px;font-size:12px;color:#3a5bef;display:none}

    /* ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª */
    .post {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,.05);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .post.pinned{box-shadow:0 4px 14px rgba(74,107,255,.25)}
    .post .pin-ribbon{position:absolute;top:-8px;right:-8px;background:#4a6bff;color:#fff;font-weight:800;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:11px}
    .post.sold{opacity:.85;position:relative}
    .post.deleted{opacity:.5;position:relative}
    .post.sold::after{content:"ØªÙ… Ø¨ÙŠØ¹Ù‡";position:absolute;top:10px;left:10px;background:var(--success-color);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .post-header{display:flex;align-items:flex-start;margin-bottom:0;gap:12px}
    .post-username{display:flex;align-items:center;gap:10px;font-weight:900;color:#111;font-size:17px}
    
    /* ğŸ”¥ğŸ”¥ ØªØµÙ…ÙŠÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ø±Ø§Ø¦Ø¹ ÙˆÙ…ØªÙˆÙ‡Ø¬ */
    .badge-verified {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 25px;
      background: linear-gradient(135deg, 
        #ff6b6b 0%, 
        #ff8e6b 25%, 
        #ffd166 50%, 
        #06d6a0 75%, 
        #118ab2 100%);
      background-size: 300% 300%;
      color: #ffffff;
      font-size: 12px;
      font-weight: 900;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 
        0 4px 20px rgba(255, 107, 107, 0.4),
        0 6px 30px rgba(255, 214, 102, 0.3),
        0 8px 40px rgba(6, 214, 160, 0.2),
        inset 0 0 30px rgba(255, 255, 255, 0.3),
        0 0 20px rgba(255, 107, 107, 0.5);
      position: relative;
      overflow: hidden;
      animation: 
        gradient-shift 3s ease infinite,
        glow-pulse 2s ease-in-out infinite,
        float-gentle 4s ease-in-out infinite;
      transform-style: preserve-3d;
      perspective: 500px;
      text-shadow: 
        0 1px 2px rgba(0,0,0,0.3),
        0 0 10px rgba(255,255,255,0.5);
      backdrop-filter: blur(10px);
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    .badge-verified::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg, 
        transparent, 
        rgba(255,255,255,0.6), 
        transparent, 
        rgba(255,255,255,0.4),
        transparent
      );
      transform: rotate(45deg);
      animation: shine-sweep 2.5s ease-in-out infinite;
    }

    .badge-verified::after {
      content: '';
      position: absolute;
      inset: 2px;
      background: radial-gradient(
        circle at 30% 20%, 
        rgba(255,255,255,0.5) 0%, 
        transparent 60%
      );
      border-radius: 22px;
      animation: inner-glow 3s ease-in-out infinite;
      filter: blur(5px);
    }

    .badge-verified i {
      font-size: 13px;
      filter: 
        drop-shadow(0 1px 2px rgba(0,0,0,0.3))
        drop-shadow(0 0 8px rgba(255,255,255,0.8));
      animation: 
        icon-bounce 2s ease-in-out infinite,
        icon-spin 8s linear infinite;
      position: relative;
      z-index: 2;
    }

    /* ğŸ”¥ Animations Ø±Ø§Ø¦Ø¹Ø© */
    @keyframes gradient-shift {
      0%, 100% { 
        background-position: 0% 50%;
        box-shadow: 
          0 4px 20px rgba(255, 107, 107, 0.4),
          0 6px 30px rgba(255, 214, 102, 0.3),
          0 8px 40px rgba(6, 214, 160, 0.2);
      }
      25% { 
        background-position: 50% 100%;
        box-shadow: 
          0 4px 20px rgba(255, 214, 102, 0.4),
          0 6px 30px rgba(6, 214, 160, 0.3),
          0 8px 40px rgba(17, 138, 178, 0.2);
      }
      50% { 
        background-position: 100% 50%;
        box-shadow: 
          0 4px 20px rgba(6, 214, 160, 0.4),
          0 6px 30px rgba(17, 138, 178, 0.3),
          0 8px 40px rgba(255, 107, 107, 0.2);
      }
      75% { 
        background-position: 50% 0%;
        box-shadow: 
          0 4px 20px rgba(17, 138, 178, 0.4),
          0 6px 30px rgba(255, 107, 107, 0.3),
          0 8px 40px rgba(255, 214, 102, 0.2);
      }
    }

    @keyframes glow-pulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        box-shadow: 
          0 4px 20px rgba(255, 107, 107, 0.4),
          0 6px 30px rgba(255, 214, 102, 0.3),
          0 8px 40px rgba(6, 214, 160, 0.2);
      }
      50% { 
        transform: scale(1.05) rotate(0.5deg);
        box-shadow: 
          0 6px 30px rgba(255, 107, 107, 0.6),
          0 8px 40px rgba(255, 214, 102, 0.5),
          0 12px 60px rgba(6, 214, 160, 0.4),
          0 0 30px rgba(255, 255, 255, 0.3);
      }
    }

    @keyframes float-gentle {
      0%, 100% { 
        transform: translateY(0px) rotateX(0deg) rotateY(0deg); 
      }
      33% { 
        transform: translateY(-3px) rotateX(1deg) rotateY(1deg); 
      }
      66% { 
        transform: translateY(2px) rotateX(-1deg) rotateY(-1deg); 
      }
    }

    @keyframes shine-sweep {
      0% { transform: rotate(45deg) translateX(-100%) translateY(-100%); }
      100% { transform: rotate(45deg) translateX(200%) translateY(200%); }
    }

    @keyframes inner-glow {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }

    @keyframes icon-bounce {
      0%, 100% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-2px) scale(1.1); }
    }

    @keyframes icon-spin {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.05); }
      50% { transform: rotate(180deg) scale(1.1); }
      75% { transform: rotate(270deg) scale(1.05); }
      100% { transform: rotate(360deg) scale(1); }
    }

    /* ğŸ”¥ ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± - Ø±Ø§Ø¦Ø¹ */
    .badge-verified:hover {
      animation: 
        gradient-shift 1s ease infinite,
        glow-pulse 0.5s ease-in-out infinite,
        float-gentle 2s ease-in-out infinite;
      transform: scale(1.1) rotate(2deg);
      box-shadow: 
        0 8px 40px rgba(255, 107, 107, 0.8),
        0 12px 60px rgba(255, 214, 102, 0.6),
        0 16px 80px rgba(6, 214, 160, 0.5),
        0 0 40px rgba(255, 255, 255, 0.5) !important;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      .badge-verified {
        padding: 6px 12px;
        font-size: 11px;
        gap: 4px;
      }
      
      .badge-verified i {
        font-size: 12px;
      }
    }

    /* ğŸ”¥ ØªØ£Ø«ÙŠØ± Ø¸Ù‡ÙˆØ± Ø±Ø§Ø¦Ø¹ */
    @keyframes badge-appear {
      0% {
        opacity: 0;
        transform: scale(0.5) rotate(-180deg);
        filter: blur(10px);
      }
      60% {
        opacity: 1;
        transform: scale(1.1) rotate(10deg);
        filter: blur(0px);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }

    .badge-verified {
      animation: 
        badge-appear 0.8s ease-out,
        gradient-shift 3s ease infinite 0.8s,
        glow-pulse 2s ease-in-out infinite 0.8s,
        float-gentle 4s ease-in-out infinite 0.8s;
    }

    .post-title{font-weight:800;font-size:15px;color:var(--primary-color)}
    .post-price{justify-self:end;font-weight:900;color:#28a745}
    
    /* ===== ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ ÙˆØµÙ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ø¹ Ø§Ù„ÙØ±Ø§ØºØ§Øª ===== */
    .post-description{
        margin: 0;
        line-height: 1.8;
        color: #222;
        white-space: pre-wrap;
        font-weight: 500;
        text-align: right;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        border-right: 4px solid var(--primary-color);
        word-wrap: break-word;
        overflow-wrap: break-word;
        min-height: auto;
        display: block;
        width: 100%;
        box-sizing: border-box;
        font-size: 15px;
        letter-spacing: 0.3px;
    }
    
    .post-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .owner-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:8px}

    /* Companies */
    .company{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:12px;border:1px solid var(--border-color)}
    .company .name{font-weight:900;color:#111;font-size:16px}
    .company .phone{color:#0c7a43;font-weight:800;margin-top:6px}
    .company .route{color:#555;margin-top:6px;font-size:13px}
    .company .desc{color:#333;margin-top:6px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;overflow-y:auto}
    .modal-content{background:#fff;margin:20px auto;padding:20px;border-radius:12px;width:90%;max-width:520px;animation:modalOpen .25s}
    @keyframes modalOpen{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
    .modal-header h2{font-size:18px;margin:0}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-text)}
    .select-group{margin-bottom:15px}
    .select-group label{display:block;margin-bottom:5px;font-weight:500}
    .select-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;background:#fff}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    /* ===== ğŸ”¥ ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
    .profile-shell{padding:16px}
    .profile-card{
        background: var(--gradient-primary);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .profile-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
    }

    .profile-card:hover::before {
        transform: translateX(100%);
    }

    .profile-meta{display:flex;flex-direction:column;gap:6px;flex:1}
    .profile-name-row{display:flex;align-items:center;gap:10px;font-weight:900;font-size:20px;color:#fff}
    .profile-count{font-size:14px;color:rgba(255,255,255,0.9);font-weight:700}
    .profile-email{font-size:13px;color:rgba(255,255,255,0.8);word-break:break-all}
    .profile-uid-input {font-size:12px;padding:6px 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius:6px;}
    .profile-uid-input::placeholder {color: rgba(255,255,255,0.7);}

    /* ===== ğŸ”¥ ØªØ­Ø³ÙŠÙ† ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ===== */
    .profile-actions-card{
        margin-top: 20px;
        background: var(--gradient-secondary);
        border-radius: 18px;
        padding: 15px;
        box-shadow: 0 6px 20px rgba(138, 43, 226, 0.3);
    }

    .profile-menu{padding:5px}
    .menu-item{
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        margin-bottom: 12px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .menu-item:hover{
        background: rgba(255,255,255,0.25);
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
    }

    .muted{color:#777;font-size:13px}

    /* ===== Broadcast popup ===== */
    #broadcast-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:210}
    #broadcast-overlay.show{display:block}
    #broadcast-banner{
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
      width:min(92%, 380px); max-height:70vh; overflow:auto; z-index:220;
      background:#e9f0ff; border:1px solid #d0dcff; border-radius:16px; padding:16px 46px 16px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,.28); opacity:0;
    }
    #broadcast-banner.show{
      display:block; opacity:1; transform:translate(-50%,-50%) scale(1);
      animation:bannerIn .32s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes bannerIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #broadcast-banner .x{position:absolute;top:10px;right:12px;background:#0000;border:none;font-size:22px;cursor:pointer;color:#2643b8}

    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid var(--border-color);z-index:120}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--light-text);font-size:12px;cursor:pointer;position:relative;transition: all 0.3s ease;}
    .nav-item.active{color:var(--primary-color);transform: translateY(-2px);}

    /* ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„: Ø¬Ø¹Ù„ Ø²Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø© ÙØªØ­ Ø±Ø§Ø¨Ø· */
    .nav-item[data-page="news"] {
        transform: scale(1);
    }

    .nav-item[data-page="news"].active {
        transform: scale(1) translateY(-2px);
    }

    .notification{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:var(--success-color);color:#fff;padding:16px 22px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:300;display:none;font-size:14px;text-align:center;min-width:240px;max-width:85%;
    }

    /* ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
    .nav-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      font-weight: bold;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
    }

    .menu-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .menu-item .nav-badge {
      position: static;
      margin-right: auto;
      margin-left: 8px;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    /* ===== ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª ===== */
    .user-info {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .user-details {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 900;
      color: #111;
      font-size: 16px;
      line-height: 1.2;
      margin: 0;
      flex-wrap: wrap;
    }

    .post-time {
      color: var(--light-text);
      font-size: 13px;
      margin-top: 2px;
      line-height: 1.2;
    }

    .post-content {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .post-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 0;
      flex-wrap: wrap;
      align-items: center;
    }

    .post-stage, .post-material, .post-price {
      padding: 4px 8px;
      background: var(--sky);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1.2;
      white-space: nowrap;
    }

    .post-price {
      background: #e8f5e8;
      color: var(--success-color);
    }

    .post-stats {
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0;
    }

    .views-count {
      color: var(--light-text);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ===== Ø¥ØµÙ„Ø§Ø­ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª - 3 Ø£Ø²Ø±Ø§Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ ===== */
    .post-actions-new {
      display: grid !important;
      grid-template-columns: 1fr 1fr 1fr !important;
      gap: 8px !important;
      margin-top: 12px !important;
    }

    .post-action-btn {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px !important;
      padding: 12px 8px !important;
      background: transparent !important;
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      color: var(--light-text) !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      min-height: 44px !important;
      text-align: center !important;
    }

    .post-action-btn:hover {
      background: var(--sky) !important;
      color: var(--primary-color) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }

    /* Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Øµ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª */
    .post-action-btn span {
      display: inline-block !important;
      font-size: 13px !important;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
    .telegram-btn {
      background: #0088cc !important;
      color: white !important;
      border-color: #0088cc !important;
    }

    .telegram-btn:hover {
      background: #0077b5 !important;
      transform: translateY(-1px);
    }

    .whatsapp-btn {
      background: #25D366 !important;
      color: white !important;
      border-color: #25D366 !important;
    }

    .whatsapp-btn:hover {
      background: #128C7E !important;
      transform: translateY(-1px);
    }

    .comments-btn {
      background: #FFC107 !important;
      color: #212529 !important;
      border-color: #FFC107 !important;
    }

    .comments-btn:hover {
      background: #E0A800 !important;
      transform: translateY(-1px);
    }

    .report-btn {
      background: #DC3545 !important;
      color: white !important;
      border-color: #DC3545 !important;
    }

    .report-btn:hover {
      background: #C82333 !important;
      transform: translateY(-1px);
    }

    .details-btn {
      background: #6C757D !important;
      color: white !important;
      border-color: #6C757D !important;
    }

    .details-btn:hover {
      background: #5A6268 !important;
      transform: translateY(-1px);
    }

    /* ===== ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø³ÙŠÙ† ØªÙ†Ø³ÙŠÙ‚ ØµÙØ­Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„ ===== */
    .details-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      border-right: 4px solid var(--primary-color);
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 700;
      color: #555;
      font-size: 14px;
    }

    .detail-value {
      font-weight: 800;
      color: #222;
      font-size: 14px;
    }

    .cheapest-price {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 900;
      text-align: center;
      margin: 10px 0;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 480px) {
      .post {
        padding: 12px;
        margin-bottom: 12px;
        gap: 10px;
      }
      
      .user-name {
        font-size: 15px;
      }
      
      .post-meta {
        gap: 6px;
      }
      
      .post-description {
        padding: 10px;
        font-size: 14px;
      }
      
      .post-actions-new {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 6px !important;
      }
      
      .post-action-btn {
        padding: 10px 6px !important;
        font-size: 12px !important;
        min-height: 40px !important;
      }
      
      .post-action-btn span {
        font-size: 11px !important;
      }
    }

    @media (max-width: 360px) {
      .post-actions-new {
        grid-template-columns: 1fr 1fr 1fr !important;
      }
      
      .post-action-btn {
        padding: 8px 4px !important;
        font-size: 11px !important;
      }
      
      .post-action-btn i {
        font-size: 14px !important;
      }
    }

    /* ğŸ”¥ ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ÙƒÙ„ Ø¥Ø«Ù†ÙŠÙ† Ø³ÙˆØ§ */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-icon {
      font-size: 28px;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 600;
    }

    /* Ø£Ù„ÙˆØ§Ù† Ù…Ø®ØªÙ„ÙØ© Ù„ÙƒÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ© */
    .stat-card:nth-child(1) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card:nth-child(4) {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    /* ØªØµÙ…ÙŠÙ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
    .user-management-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .user-management-item .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .user-management-item .user-details {
      flex: 1;
    }

    .user-management-item .user-name {
      font-weight: 700;
      color: #111;
    }

    .user-management-item .user-email {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .user-management-item .user-id {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .user-management-item .user-status {
      font-size: 12px;
      font-weight: 700;
      margin-top: 4px;
    }

    .user-management-item .user-status.banned {
      color: #dc3545;
    }

    .user-management-item .user-status.active {
      color: #28a745;
    }

    .user-management-item .user-actions {
      display: flex;
      gap: 8px;
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬ÙˆØ§Ù„ */
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        min-height: 110px;
        padding: 14px;
      }
      
      .stat-number {
        font-size: 22px;
      }
      
      .user-management-item {
        flex-direction: column;
        align-items: stretch;
      }
      
      .user-management-item .user-actions {
        justify-content: center;
      }
    }

    /* ØªØ­Ø³ÙŠÙ† Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ */
    .menu-item[onclick="logout()"] {
      background: rgba(220, 53, 69, 0.2) !important;
      color: #fff !important;
      border: 1px solid rgba(220, 53, 69, 0.4) !important;
    }

    .menu-item[onclick="logout()"]:hover {
      background: rgba(220, 53, 69, 0.3) !important;
      transform: translateY(-2px);
    }

    /* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
    .admin-menu {
      padding: 10px;
    }

    .admin-menu .menu-item {
      background: var(--sky);
      border: 1px solid #d0dcff;
    }

    .admin-menu .menu-item:hover {
      background: #e1eaff;
      transform: translateY(-2px);
    }

    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ø¨Ø­Ø« */
    .search-box {
      margin-bottom: 15px;
    }

    .search-box input {
      margin-bottom: 10px;
    }

    /* ğŸ”¥ Ø¥ØµÙ„Ø§Ø­: ØªØµÙ…ÙŠÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ±Ø© */
    .avatar-selection {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .avatar-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 15px;
      border-radius: 12px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .avatar-option:hover {
      background: var(--sky);
      transform: translateY(-2px);
    }

    .avatar-option .emo {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .avatar-option .avatar-label {
      font-weight: 600;
      color: var(--primary-color);
    }

    /* ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ===== */
    .comment {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      border-right: 3px solid var(--primary-color);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .comment-user {
      font-weight: 700;
      color: #111;
      font-size: 14px;
    }

    .comment-time {
      color: var(--light-text);
      font-size: 12px;
    }

    .comment-content {
      color: #333;
      line-height: 1.5;
      font-size: 14px;
    }

    .comment-actions {
      display: flex;
      gap: 15px;
      margin-top: 8px;
    }

    .comment-action {
      background: none;
      border: none;
      color: var(--light-text);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .comment-action:hover {
      color: var(--primary-color);
    }

    .reply-form {
      margin-top: 10px;
      padding-right: 20px;
    }

    .reply-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 14px;
    }

    .mention-suggestions {
      position: absolute;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .mention-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
    }

    .mention-suggestion:hover {
      background: var(--sky);
    }

    .mention-suggestion:last-child {
      border-bottom: none;
    }

    /* ===== ØµÙØ­Ø© Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© ===== */
    .privacy-content {
      padding: 20px;
      line-height: 1.6;
    }

    .privacy-content h1, .privacy-content h2, .privacy-content h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    .privacy-content p {
      margin-bottom: 15px;
      color: #333;
    }

    /* ===== ğŸ”¥ Ù‚Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ - ØªØµÙ…ÙŠÙ… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø© ===== */
    .ai-assistant-page {
      padding: 0;
      height: calc(100vh - 120px);
      display: flex;
      flex-direction: column;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
      overflow: hidden;
    }

    .ai-assistant-page::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-10px) rotate(1deg); }
    }

    .ai-welcome-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: white;
      padding: 20px;
      z-index: 2;
      transition: opacity 0.5s ease;
    }

    .ai-welcome-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .ai-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 3px solid rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      animation: bounce 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    .ai-avatar i {
      font-size: 50px;
      color: white;
    }

    .ai-welcome-text {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 10px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }

    .ai-subtitle {
      font-size: 16px;
      opacity: 0.9;
      margin-bottom: 30px;
      max-width: 300px;
      line-height: 1.5;
    }

    .ai-start-btn {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .ai-start-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }

    .ai-chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 15px;
      overflow: hidden;
      position: relative;
      z-index: 2;
    }

    .ai-messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .ai-message {
      max-width: 85%;
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      word-wrap: break-word;
      animation: messageSlide 0.3s ease-out;
    }

    @keyframes messageSlide {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .ai-message.user {
      align-self: flex-end;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      border-bottom-right-radius: 5px;
    }

    .ai-message.assistant {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      color: white;
      border-bottom-left-radius: 5px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ai-typing {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      color: white;
      padding: 12px 16px;
      border-radius: 18px;
      border-bottom-left-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ai-typing-dots {
      display: flex;
      gap: 4px;
    }

    .ai-typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: white;
      animation: typing 1.4s infinite ease-in-out;
    }

    .ai-typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .ai-typing-dot:nth-child(2) { animation-delay: -0.16s; }
    .ai-typing-dot:nth-child(3) { animation-delay: 0s; }

    @keyframes typing {
      0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    .ai-input-container {
      display: flex;
      gap: 10px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      position: relative;
      z-index: 2;
    }

    .ai-input {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 14px;
      outline: none;
    }

    .ai-input::placeholder {
      color: #666;
    }

    .ai-send-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #667eea;
      font-size: 18px;
      transition: all 0.3s ease;
    }

    .ai-send-btn:hover {
      background: white;
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .ai-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* ===== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„Ù…Ø§Ù„Ùƒ ===== */
    .ai-management-card {
      background: var(--gradient-primary);
      border-radius: 20px;
      padding: 20px;
      margin: 15px;
      color: white;
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .ai-management-title {
      font-size: 18px;
      font-weight: 900;
      margin-bottom: 15px;
      text-align: center;
    }

    .ai-management-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .ai-management-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 14px;
      font-weight: 600;
    }

    .ai-management-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .ai-management-btn i {
      font-size: 18px;
      width: 24px;
    }

    /* ===== Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ===== */
    .ai-modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
    }

    .ai-modal-content .modal-header {
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .ai-modal-content .form-control {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
    }

    .ai-modal-content .form-control::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .ai-modal-content textarea.form-control {
      min-height: 150px;
      resize: vertical;
    }

    /* ===== ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ ===== */
    [data-theme="dark"] .ai-assistant-page {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    }

    [data-theme="dark"] .ai-message.user {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }

    [data-theme="dark"] .ai-input {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    [data-theme="dark"] .ai-input::placeholder {
      color: rgba(255, 255, 255, 0.7);
    }

    [data-theme="dark"] .ai-send-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    /* ===== ØµÙØ­Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ===== */
    .support-page {
      padding: 20px;
    }

    .support-card {
      background: var(--gradient-success);
      border-radius: 20px;
      padding: 25px;
      color: white;
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
      margin-bottom: 20px;
    }

    .support-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .support-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .support-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .support-btn i {
      font-size: 20px;
      width: 24px;
    }

    /* ===== ğŸ”¥ ØµÙØ­Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ ÙˆÙ…Ø­Ø³Ù† ===== */
    .user-support-page {
      padding: 20px;
    }

    .user-support-item {
      background: #fff;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .user-support-item {
      background: #1e1e1e;
      color: #ffffff;
      border-color: #333;
    }

    .user-support-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .support-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .support-user {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 16px;
    }

    .support-type {
      background: var(--accent-color);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .support-message {
      color: var(--text-color);
      line-height: 1.6;
      margin-bottom: 15px;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .reply-section {
      border-top: 1px dashed var(--border-color);
      padding-top: 12px;
      margin-top: 12px;
    }

    .support-reply-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .support-reply-btn:hover {
      background: #3a5bef;
      transform: translateY(-1px);
    }

    /* ğŸ”¥ Ø§Ø²Ø±Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø§Ø²Ø±Ù‚ */
    .admin-control-btn {
      background: var(--primary-color) !important;
      color: white !important;
      border: 1px solid var(--primary-color) !important;
    }

    .admin-control-btn:hover {
      background: #3a5bef !important;
      transform: translateY(-2px);
    }

    /* ğŸ”¥ ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ Ù„ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ */
    .ai-management-page {
      padding: 20px;
    }

    .ai-management-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .ai-management-item {
      background: var(--gradient-primary);
      border-radius: 15px;
      padding: 20px;
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      transition: all 0.3s ease;
    }

    .ai-management-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .ai-management-item h3 {
      margin-bottom: 10px;
      font-size: 18px;
    }

    .ai-management-item p {
      margin-bottom: 15px;
      opacity: 0.9;
    }

    .ai-management-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .ai-stat {
      background: rgba(255,255,255,0.15);
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }

    .ai-stat-number {
      font-size: 20px;
      font-weight: 900;
      margin-bottom: 5px;
    }

    .ai-stat-label {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* ğŸ”¥ Ø¥Ø¶Ø§ÙØ© ØªØµÙ…ÙŠÙ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø«Ø© ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª */
.post-menu {
  position: absolute;
  top: 10px;
  left: 10px;
  z-index: 10;
}

.post-menu-btn {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-color);
  transition: all 0.3s ease;
}

.post-menu-btn:hover {
  background: var(--primary-color);
  color: white;
  transform: scale(1.1);
}

.post-menu-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  min-width: 150px;
  display: none;
  z-index: 100;
}

[data-theme="dark"] .post-menu-dropdown {
  background: #2a2a2a;
  border-color: #444;
}

.post-menu-dropdown.show {
  display: block;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}

.post-menu-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  transition: all 0.2s ease;
  font-size: 13px;
  color: var(--text-color);
}

.post-menu-item:last-child {
  border-bottom: none;
}

.post-menu-item:hover {
  background: var(--sky);
  color: var(--primary-color);
}

.post-menu-item i {
  width: 16px;
  text-align: center;
  font-size: 12px;
}

/* ğŸ”¥ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ */
.ai-warning {
  position: absolute;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  color: rgba(255, 255, 255, 0.7);
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 11px;
  text-align: center;
  z-index: 5;
  border: 1px solid rgba(255, 255, 255, 0.2);
  max-width: 90%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.ai-clear-btn {
  position: absolute;
  top: 15px;
  left: 15px;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 14px;
  color: white;
  z-index: 10;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
}

.ai-clear-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

/* ğŸ”¥ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø© - Ø­Ø¬Ù… Ø£ÙƒØ¨Ø± */
.ai-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.ai-message {
  max-width: 85%;
  padding: 16px 20px;
  border-radius: 20px;
  line-height: 1.6;
  word-wrap: break-word;
  animation: messageSlide 0.3s ease-out;
  font-size: 16px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.ai-message.user {
  align-self: flex-end;
  background: rgba(255, 255, 255, 0.95);
  color: #333;
  border-bottom-right-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.ai-message.assistant {
  align-self: flex-start;
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(15px);
  color: white;
  border-bottom-left-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.ai-input-container {
  display: flex;
  gap: 12px;
  padding: 20px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(15px);
  border-top: 1px solid rgba(255, 255, 255, 0.2);
  position: relative;
  z-index: 2;
}

.ai-input {
  flex: 1;
  padding: 16px 20px;
  border: none;
  border-radius: 25px;
  background: rgba(255, 255, 255, 0.95);
  color: #333;
  font-size: 16px;
  outline: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.ai-send-btn {
  background: rgba(255, 255, 255, 0.95);
  border: none;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: #667eea;
  font-size: 20px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.ai-send-btn:hover {
  background: white;
  transform: scale(1.05);
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* ğŸ”¥ ØµÙØ­Ø© ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
.ai-training-page {
  padding: 20px;
}

.ai-training-card {
  background: var(--gradient-primary);
  border-radius: 20px;
  padding: 25px;
  color: white;
  box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
  margin-bottom: 20px;
}

.ai-training-title {
  font-size: 20px;
  font-weight: 900;
  margin-bottom: 20px;
  text-align: center;
}

.ai-training-actions {
  display: grid;
  grid-template-columns: 1fr;
  gap: 15px;
}

.ai-training-btn {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 20px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 15px;
  color: white;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: right;
}

.ai-training-btn:hover {
  background: rgba(255,255,255,0.25);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.ai-training-btn i {
  font-size: 22px;
  width: 30px;
}

  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
</head>
<body>

  <!-- Splash -->
  <div id="splash" class="splash" aria-label="Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨">
    <div class="runner" dir="rtl" aria-hidden="true">
      <span>Ø³</span><span>Ùˆ</span><span>Ù‚</span><span>&nbsp;</span><span>Ø§</span><span>Ù„</span><span>Ø·</span><span>Ù„</span><span>Ø§</span><span>Ø¨</span>
    </div>
    <div class="final-logo" id="final-logo" dir="rtl">Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
    
    <!-- Ù†Øµ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading-text" class="loading-text" style="display: none;">
      Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
    </div>
  </div>

  <!-- Ø²Ø± Ø´Ø±Ø­ Ø§Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
  <a href="https://youtube.com/shorts/dezFxy0tc9w?si=eoYQNWjjqJ-C599h" target="_blank" class="help-floating-btn" id="help-floating-btn">
    <i class="fas fa-question-circle"></i>
    Ø´Ø±Ø­ Ø§Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
  </a>

  <!-- Auth -->
  <div id="auth-page" class="auth-container page" style="display:none">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</div>
      </div>

      <form id="login-form" class="auth-form active" onsubmit="event.preventDefault(); login();">
        <div class="form-group"><label for="login-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="login-email" class="form-control" required></div>
        <div class="form-group"><label for="login-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="login-password" class="form-control" required></div>
        <div class="form-group" style="text-align:center; margin-top:10px;">
          <a href="#" onclick="openForgotPasswordModal()" style="color:var(--primary-color); text-decoration:none; font-size:14px;">
            Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ
          </a>
        </div>
        <button type="submit" class="btn btn-block">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      </form>

      <form id="register-form" class="auth-form" onsubmit="event.preventDefault(); register();">
        <div class="form-group"><label for="register-name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="register-name" class="form-control" required></div>
        <div class="form-group"><label for="register-email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input type="email" id="register-email" class="form-control" required></div>
        <div class="form-group"><label for="register-password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="register-password" class="form-control" required></div>
        
        <!-- ===== ØªØ¹Ø¯ÙŠÙ„: Ø²Ø± Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ===== -->
        <div class="form-group">
          <label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</label>
          <div class="avatar-upload-section">
            <div class="avatar-upload-btn-large" onclick="document.getElementById('register-avatar-input').click()">
              <i class="fas fa-camera"></i>
              <span>Ø±ÙØ¹ ØµÙˆØ±Ø©</span>
            </div>
            <img id="register-avatar-preview" class="avatar-preview-small" alt="Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©">
            <input type="file" id="register-avatar-input" accept="image/*" style="display: none" onchange="previewRegisterAvatar(event)">
            <small style="color: var(--light-text); text-align: center;">Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©<br>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰: 2MB</small>
          </div>
        </div>
        
        <button type="button" id="register-submit" class="btn btn-block" onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
      </form>
    </div>
  </div>

  <!-- Main (Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª) -->
  <div id="main-page" class="container page" style="display:none">
    <div class="header">
      <div class="brand">
        <button id="create-btn" class="btn" onclick="onCreateButton()"><i class="fas fa-plus"></i> <span id="create-btn-label">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±</span></button>
        <div class="section-switch" role="tablist" aria-label="Ø§Ù„Ø£Ù‚Ø³Ø§Ù…">
          <button id="pill-posts" class="section-pill active" onclick="switchSection('posts')" role="tab" aria-selected="true">Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</button>
          <button id="pill-companies" class="section-pill" onclick="switchSection('companies')" role="tab" aria-selected="false">Ø´Ø±ÙƒØ§Øª Ø§Ù„ØªÙˆØµÙŠÙ„</button>
        </div>
      </div>
    </div>

    <div id="filter-container" class="filter-container">
      <select id="filter-stage" class="filter-select" onchange="renderPosts()">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§Ø­Ù„</option>
        <option value="sades-elmi">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ</option>
        <option value="sades-adabi">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¯Ø¨ÙŠ</option>
        <option value="khames">Ø§Ù„Ø®Ø§Ù…Ø³ Ø¹Ù„Ù…ÙŠ/Ø§Ø¯Ø¨ÙŠ</option>
        <option value="rabea">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø¹Ù„Ù…ÙŠ/Ø§Ø¯Ø¨ÙŠ</option>
        <option value="thaleth-mut">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
        <option value="thani-mut">Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
        <option value="awal-mut">Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
        <option value="sades-ibtidai">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      </select>
      <select id="filter-material" class="filter-select" onchange="renderPosts()">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ§Ø¯</option>
        <option value="Ø§Ø³Ù„Ø§Ù…ÙŠØ©">Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option value="Ø¹Ø±Ø¨ÙŠ">Ø¹Ø±Ø¨ÙŠ</option><option value="Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ">Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
        <option value="Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option value="Ø§Ø­ÙŠØ§Ø¡">Ø§Ø­ÙŠØ§Ø¡</option><option value="ÙƒÙŠÙ…ÙŠØ§Ø¡">ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
        <option value="ÙÙŠØ²ÙŠØ§Ø¡">ÙÙŠØ²ÙŠØ§Ø¡</option><option value="Ø§Ù‚ØªØµØ§Ø¯">Ø§Ù‚ØªØµØ§Ø¯</option><option value="Ø£Ø¯Ø¨ ÙˆÙ†ØµÙˆØµ">Ø£Ø¯Ø¨ ÙˆÙ†ØµÙˆØµ</option>
        <option value="Ù‚ÙˆØ§Ø¹Ø¯">Ù‚ÙˆØ§Ø¹Ø¯</option>
      </select>
    </div>

    <div class="pull-indicator"><div id="pull-bubble" class="bubble">Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø¯ÙŠØ«â€¦</div></div>
    <div class="posts-container" id="posts-container"></div>
    <div class="posts-container" id="companies-container" style="display:none"></div>
  </div>

  <div class="pull-indicator">
    <div id="pull-bubble" class="bubble" style="display: none">
      <i class="fas fa-sync-alt fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...
    </div>
  </div>

  <!-- Profile -->
  <div id="profile-page" class="container page" style="display:none">
    <div class="profile-shell">
      <div class="profile-card">
        <!-- Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ -->
        <button class="theme-toggle-btn" onclick="toggleTheme()">
          <i class="fas fa-moon"></i>
        </button>
        
        <div class="avatar-container">
            <div id="avatar" class="avatar" title="Ø§Ù†Ù‚Ø± Ù„ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©" onclick="openAvatarModal()">
                <div style="width:100%;height:100%;font-size:40px;line-height:72px">ğŸ‘¨ğŸ»â€ğŸ’¼</div>
            </div>
            <div class="avatar-upload-btn" onclick="openImageUploadModal()" title="Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©">
                <i class="fas fa-camera"></i>
            </div>
        </div>
        <div class="profile-meta">
          <div class="profile-name-row">
            <span id="profile-name"></span>
            <span id="profile-verified"></span>
            <i class="fas fa-pencil-alt" style="color:white;cursor:pointer" onclick="editProfileName()"></i>
          </div>
          <div id="profile-count" class="profile-count"></div>
          <div id="profile-email" class="profile-email"></div>
          <div class="row" style="align-items: center; gap: 8px; margin-top:4px;">
            <input id="profile-uid-input" class="form-control profile-uid-input" readonly />
            <button class="btn btn-xs" onclick="copyUidToClipboard()" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.5);"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button>
          </div>
        </div>
      </div>
      
      <div class="profile-actions-card">
        <div class="profile-menu">
          <!-- 1. Ø²Ø± Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ -->
          <div class="menu-item" onclick="showUserPosts()">
            <i class="fas fa-book"></i>
            <span>Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ</span>
          </div>
          
          <!-- 2. Ø²Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯ -->
          <div class="menu-item" onclick="showInbox();">
            <i class="fas fa-inbox"></i>
            <span>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯</span>
            <div id="inbox-badge" class="nav-badge" style="display: none">0</div>
          </div>
          
          <!-- 3. Ø²Ø± Ø§Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
          <div class="menu-item" onclick="showUserStatistics()">
            <i class="fas fa-chart-bar"></i>
            <span>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
          </div>
          
          <!-- 4. Ø²Ø± Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© -->
          <div class="menu-item" onclick="showPrivacyPolicy()">
            <i class="fas fa-shield-alt"></i>
            <span>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
          </div>
          
          <!-- 5. Ø²Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… -->
          <div class="menu-item" onclick="showSupportPage()">
            <i class="fas fa-headset"></i>
            <span>Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</span>
          </div>
          
          
          <!-- 7. Ø²Ø± Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø§Ø²Ø±Ø§Ø± (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·) -->
          <div class="menu-item owner-only" style="display:none" onclick="showAdminPanel()">
            <i class="fas fa-cogs"></i>
            <span>Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø§Ø²Ø±Ø§Ø±</span>
          </div>
          
          <!-- 8. Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
          <div class="menu-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- User posts -->
  <div id="user-posts-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ù…Ù†Ø´ÙˆØ±Ø§ØªÙŠ</span></div>
    <div class="posts-container" id="user-posts-container"></div>
  </div>

  <!-- Inbox -->
  <div id="inbox-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯</span></div>
    <div class="posts-container" id="inbox-container"></div>
  </div>

  <!-- Details -->
  <div id="details-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromDetails()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±</span></div>
    <div class="posts-container" id="details-container"></div>
  </div>

  <!-- Comments -->
  <div id="comments-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromComments()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span></div>
    <div class="posts-container">
      <div id="comments-list-page"></div>
      <div class="row" style="margin-top:10px;">
        <input type="text" id="comment-text-page" class="form-control grow" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§...">
        <button id="send-comment-btn" class="btn" onclick="addCommentFromPage()">Ø¥Ø±Ø³Ø§Ù„</button>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div id="user-statistics-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
    </div>
    <div class="posts-container">
      <div class="stats-grid" id="stats-grid">
        <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
      </div>
    </div>
  </div>

  <div id="admin-panel-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
        <span style="font-weight:900">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
    </div>
    <div class="posts-container">
        <div class="admin-menu">
            <div class="menu-item admin-control-btn" onclick="showUserManagement()">
                <i class="fas fa-users-cog"></i>
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </div>
            <div class="menu-item admin-control-btn" onclick="showBroadcastPanel()">
                <i class="fas fa-bullhorn"></i>
                <span>Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</span>
            </div>
            <!-- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø¶Ø§Ù -->
            <div class="menu-item admin-control-btn" onclick="showUserSupportPage()">
                <i class="fas fa-comments"></i>
                <span>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </div>
            <!-- ğŸ”¥ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø¶Ø§Ù Ù‡Ù†Ø§ -->
            <div class="menu-item admin-control-btn" onclick="showAITrainingPage()">
                <i class="fas fa-graduation-cap"></i>
                <span>ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
            </div>
        </div>
    </div>
</div>

  <!-- ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <div id="user-management-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
    </div>
    <div class="posts-container">
      <div class="search-box" style="margin-bottom: 15px;">
        <input type="text" id="user-search-input" class="form-control" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ID...">
        <button class="btn" onclick="searchUsers()" style="margin-top: 10px; width: 100%;">Ø¨Ø­Ø«</button>
      </div>
      <div id="user-management-results"></div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù… -->
  <div id="broadcast-panel-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</span>
    </div>
    <div class="posts-container">
      <div class="post">
        <div class="form-group">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
          <input type="text" id="broadcast-title" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±...">
        </div>
        <div class="form-group">
          <label>Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
          <textarea id="broadcast-message" class="form-control" rows="6" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±..."></textarea>
        </div>
        <div class="post-actions">
          <button class="btn btn-success" onclick="sendBroadcast()">
            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ØµÙØ­Ø© Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© -->
  <div id="privacy-policy-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
    </div>
    <div class="privacy-content" id="privacy-content">
      <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ù‡Ù†Ø§ -->
    </div>
  </div>

  <!-- ğŸ”¥ ØµÙØ­Ø© ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
  <div id="ai-training-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</span>
    </div>
    <div class="ai-training-page">
      <div class="ai-training-card">
        <div class="ai-training-title">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>
        
        <div class="ai-training-actions">
          <button class="ai-training-btn" onclick="openAICommandsModal()">
            <i class="fas fa-terminal"></i>
            <span>Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯</span>
          </button>
          
          <button class="ai-training-btn" onclick="openAIKnowledgeModal()">
            <i class="fas fa-brain"></i>
            <span>Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© - Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© ØªØ±Ø­ÙŠØ¨ -->
  <div id="ai-assistant-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToMainFromAI()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</span>
    </div>
    
    <div class="ai-assistant-page">
      <!-- ğŸ”¥ Ø²Ø± Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© -->
      <button class="ai-clear-btn" onclick="clearAIConversation()" title="Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©">
        <i class="fas fa-trash"></i>
      </button>
      
      <!-- ğŸ”¥ ØªÙ†Ø¨ÙŠÙ‡ ØµØºÙŠØ± -->
      <div class="ai-warning" id="ai-warning">
        âš ï¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù‚Ø¯ ØªÙƒÙˆÙ† ØºÙŠØ± Ø¯Ù‚ÙŠÙ‚Ø©
      </div>
      
      <!-- ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¨Ø§Ø´Ø±Ø© -->
      <div class="ai-chat-container" id="ai-chat-container">
        <div class="ai-messages" id="ai-messages">
          <!-- ğŸ”¥ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø© -->
          <div class="ai-message assistant">
            Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø¯Ø±Ø§Ø³ØªÙƒØŸ
          </div>
        </div>
        
        <div class="ai-input-container">
          <input type="text" class="ai-input" id="ai-input" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." onkeypress="handleAIKeyPress(event)">
          <button class="ai-send-btn" id="ai-send-btn" onclick="sendAIMessage()">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ ØµÙØ­Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
  <div id="support-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</span>
    </div>
    <div class="support-page">
      <div class="support-card">
        <h2 style="margin-bottom: 15px; text-align: center;">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø¹Ù…</h2>
        <p style="text-align: center; margin-bottom: 20px; opacity: 0.9;">Ù†Ø­Ù† Ù‡Ù†Ø§ Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø© ØªÙˆØ§Ø¬Ù‡Ùƒ</p>
        
        <div class="support-actions">
          <button class="support-btn" onclick="contactTelegram()">
            <i class="fab fa-telegram"></i>
            <span>Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</span>
          </button>
          
          <button class="support-btn" onclick="openSuggestionModal()">
            <i class="fas fa-lightbulb"></i>
            <span>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‚ØªØ±Ø§Ø­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ ØµÙØ­Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙŠØ¯ -->
  <div id="user-support-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
    </div>
    <div class="user-support-page" id="user-support-container">
      <!-- ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« -->
      <div id="user-support-results">
        <div class="post">
          <p style="text-align: center; color: var(--text-color);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <div id="bottom-nav" class="bottom-nav">
    <div class="nav-item active" data-page="main" onclick="showMainPageAndClearBadge();">
      <i class="fas fa-home"></i>
      <span>Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</span>
      <div id="posts-badge" class="nav-badge" style="display: none">0</div>
    </div>
    <div class="nav-item" data-page="ai-assistant" onclick="showAIAssistantPage()">
      <i class="fas fa-robot"></i>
      <span>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</span>
      <div id="ai-badge" class="nav-badge" style="display: none">0</div>
    </div>
    <div class="nav-item" data-page="profile" onclick="showProfilePage()">
      <i class="fas fa-user"></i>
      <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
      <div id="profile-notification-badge" class="nav-badge" style="display: none">0</div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

  <!-- Modals -->
  <div id="create-post-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±</h2><button class="close-modal" onclick="closeCreatePostModal()">&times;</button></div>
    
    <!-- Ø­Ù‚Ù„ Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ù…Ø·Ù„ÙˆØ¨) -->
    <div class="select-group">
      <label>Ø§Ù„Ù…Ø±Ø­Ù„Ø© <span style="color:var(--danger-color)">*</span></label>
      <select id="post-stage" class="select-control" required>
        <option value="" disabled selected>Ø§Ø®ØªØ± Ù…Ø±Ø­Ù„ØªÙƒ</option>
        <option value="sades-elmi">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ</option>
        <option value="sades-adabi">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¯Ø¨ÙŠ</option>
        <option value="khames">Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø¨ÙŠ</option>
        <option value="rabea">Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„Ø§Ø¯Ø¨ÙŠ</option>
        <option value="thaleth-mut">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
        <option value="thani-mut">Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
        <option value="awal-mut">Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
        <option value="sades-ibtidai">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      </select>
    </div>
    
    <div class="select-group"><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
      <select id="post-material" class="select-control">
        <option>Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
        <option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option>Ø§Ø­ÙŠØ§Ø¡</option><option>ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
        <option>ÙÙŠØ²ÙŠØ§Ø¡</option><option>Ø§Ù‚ØªØµØ§Ø¯</option><option>Ø£Ø¯Ø¨ ÙˆÙ†ØµÙˆØµ</option><option>Ù‚ÙˆØ§Ø¹Ø¯</option>
      </select>
    </div>
    
    <div class="select-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="post-price" class="select-control" type="number" value="0"></div>
    
    <!-- ===== ØªØ¹Ø¯ÙŠÙ„: Ù†Ù‚Ù„ Ø­Ù‚Ù„ Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø© ØªØ­Øª Ø§Ù„Ø³Ø¹Ø± ===== -->
    <div class="select-group">
      <label>Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <input id="post-cheapest-price" class="select-control" type="number" value="0" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø©...">
    </div>
    
    <div class="select-group"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="post-description" class="select-control" rows="4" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù‡Ù†Ø§..."></textarea></div>
    
    <div class="select-group"><label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</label>
      <select id="contact-method" class="select-control" onchange="changeContactMethod()">
        <option value="whatsapp">ÙˆØ§ØªØ³Ø§Ø¨</option>
        <option value="telegram">ØªÙ„ÙƒØ±Ø§Ù…</option>
        <option value="comments">ØªØ¹Ù„ÙŠÙ‚Ø§Øª</option>
      </select>
    </div>
    <div id="whatsapp-field" class="select-group"><label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨</label><input id="whatsapp-number" class="select-control" placeholder="9647xxxxxxxxx"></div>
    <div id="telegram-field" class="select-group" style="display:none"><label>Ù…Ø¹Ø±Ù‘Ù ØªÙ„ÙƒØ±Ø§Ù…</label><input id="telegram-username" class="select-control" placeholder="username Ø¨Ø¯ÙˆÙ† @"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCreatePostModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="post-submit-btn" class="btn" onclick="createPost()">
        <i class="fas fa-paper-plane"></i> Ù†Ø´Ø±
      </button>
    </div>
  </div></div>

  <div id="edit-post-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†Ø´ÙˆØ±</h2><button class="close-modal" onclick="closeEditPostModal()">&times;</button></div>
    <input type="hidden" id="edit-post-id"/>
    <div class="select-group"><label>Ø§Ù„Ù…Ø±Ø­Ù„Ø©</label>
      <select id="edit-post-stage" class="select-control">
        <option value="sades-elmi">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ</option>
        <option value="sades-adabi">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¯Ø¨ÙŠ</option>
        <option value="khames">Ø§Ù„Ø®Ø§Ù…Ø³</option>
        <option value="rabea">Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
        <option value="thaleth-mut">Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·</option>
        <option value="thani-mut">Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·</option>
        <option value="awal-mut">Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·</option>
        <option value="sades-ibtidai">Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
      </select>
    </div>
    <div class="select-group"><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="edit-post-price" class="select-control" type="number"></div>
    
    <!-- ===== ØªØ¹Ø¯ÙŠÙ„: Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø© ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ===== -->
    <div class="select-group">
      <label>Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø©</label>
      <input id="edit-post-cheapest-price" class="select-control" type="number" placeholder="Ø£Ø¯Ø®Ù„ Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø©...">
    </div>
    
    <div class="select-group"><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label>
      <select id="edit-post-material" class="select-control">
        <option>Ø§Ø³Ù„Ø§Ù…ÙŠØ©</option><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ</option>
        <option>Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option><option>Ø§Ø­ÙŠØ§Ø¡</option><option>ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
        <option>ÙÙŠØ²ÙŠØ§Ø¡</option><option>Ø§Ù‚ØªØµØ§Ø¯</option><option>Ø£Ø¯Ø¨ ÙˆÙ†ØµÙˆØµ</option><option>Ù‚ÙˆØ§Ø¹Ø¯</option>
      </select>
    </div>
    <div class="select-group"><label>Ø§Ù„ÙˆØµÙ</label><textarea id="edit-post-description" class="select-control" rows="4"></textarea></div>
    <div class="select-group"><label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</label>
      <select id="edit-contact-method" class="select-control" onchange="changeContactMethod('edit')">
        <option value="whatsapp">ÙˆØ§ØªØ³Ø§Ø¨</option>
        <option value="telegram">ØªÙ„ÙƒØ±Ø§Ù…</option>
        <option value="comments">ØªØ¹Ù„ÙŠÙ‚Ø§Øª</option>
      </select>
    </div>
    <div id="edit-whatsapp-field" class="select-group"><label>Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨</label><input id="edit-whatsapp-number" class="select-control"></div>
    <div id="edit-telegram-field" class="select-group" style="display:none"><label>Ù…Ø¹Ø±Ù‘Ù ØªÙ„ÙƒØ±Ø§Ù…</label><input id="edit-telegram-username" class="select-control"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditPostModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="post-edit-submit-btn" class="btn" onclick="savePostEdits()">Ø­ÙØ¸</button>
    </div>
  </div></div>

  <div id="create-company-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© ØªÙˆØµÙŠÙ„</h2><button class="close-modal" onclick="closeCreateCompanyModal()">&times;</button></div>
    <div class="select-group"><label>Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="company-name" class="select-control"></div>
    <div class="select-group"><label>Ù…Ù†</label><select id="company-from" class="select-control"></select></div>
    <div class="select-group"><label>Ø¥Ù„Ù‰</label><select id="company-to" class="select-control"></select></div>
    <div class="select-group"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="company-phone" class="select-control"></div>
    <div class="select-group"><label>ÙˆØµÙ</label><textarea id="company-desc" class="select-control" rows="3"></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCreateCompanyModal()">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="company-submit-btn" class="btn btn-success" onclick="createCompany()">Ø¥Ø¶Ø§ÙØ©</button>
    </div>
  </div></div>

  <!-- Modal Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© -->
  <div id="image-upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Ø±ÙØ¹ ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ©</h2>
            <button class="close-modal" onclick="closeImageUploadModal()">&times;</button>
        </div>
        <div class="select-group">
            <label>Ø§Ø®ØªØ± ØµÙˆØ±Ø©</label>
            <input type="file" id="avatar-upload-input" accept="image/*" class="form-control">
            <div class="hint" style="text-align: center; margin-top: 10px;">
                <small>Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰: 2MB | Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©: JPG, PNG, GIF</small>
            </div>
        </div>
        <div id="avatar-preview" style="text-align: center; margin: 15px 0; display: none;">
            <img id="avatar-preview-img" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #4a6bff;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImageUploadModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button id="upload-avatar-btn" class="btn btn-success" onclick="uploadAvatar()" disabled>Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</button>
        </div>
    </div>
  </div>

  <div id="avatar-modal" class="modal"><div class="modal-content">
    <div class="modal-header">
      <h2>ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©</h2><button class="close-modal" onclick="closeAvatarModal()">&times;</button></div>
    
    <div class="avatar-selection">
      <!-- Ø®ÙŠØ§Ø± Ø§Ù„ÙˆÙ„Ø¯ -->
      <label class="avatar-option" onclick="setAvatar('male')">
        <span class="emo">ğŸ‘¨ğŸ»â€ğŸ’¼</span>
        <span class="avatar-label">ÙˆÙ„Ø¯</span>
      </label>
      
      <!-- Ø®ÙŠØ§Ø± Ø§Ù„Ø¨Ù†Øª -->
      <label class="avatar-option" onclick="setAvatar('female')">
        <span class="emo">ğŸ‘©ğŸ»â€ğŸ’¼</span>
        <span class="avatar-label">Ø¨Ù†Øª</span>
      </label>
    </div>

    <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
    <div style="text-align: center; margin-top: 20px; padding: 15px; background: var(--sky); border-radius: 12px;">
      <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</div>
      <div id="current-avatar-preview" style="display: inline-block;"></div>
    </div>
  </div></div>

  <div id="forgot-password-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
        <button class="close-modal" onclick="closeForgotPasswordModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="forgot-email" class="select-control" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeForgotPasswordModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button id="forgot-submit-btn" class="btn btn-success" onclick="handleForgotPassword()">Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ -->
  <div id="ai-commands-modal" class="modal">
    <div class="modal-content ai-modal-content">
      <div class="modal-header">
        <h2 style="color: white;">Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯</h2>
        <button class="close-modal" style="color: white;" onclick="closeAICommandsModal()">&times;</button>
      </div>
      <div class="select-group">
        <label style="color: white;">Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ù…Ù†ÙˆØ¹Ø©</label>
        <textarea id="ai-commands-input" class="form-control" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ù…Ù† ØªÙ†ÙÙŠØ°Ù‡Ø§ (ÙƒÙ„ Ø£Ù…Ø± ÙÙŠ Ø³Ø·Ø±)..."></textarea>
      </div>
      <div class="select-group">
        <label style="color: white;">Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</label>
        <textarea id="ai-instructions-input" class="form-control" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAICommandsModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-success" onclick="saveAICommands()">
          <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ -->
  <div id="ai-knowledge-modal" class="modal">
    <div class="modal-content ai-modal-content">
      <div class="modal-header">
        <h2 style="color: white;">Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯</h2>
        <button class="close-modal" style="color: white;" onclick="closeAIKnowledgeModal()">&times;</button>
      </div>
      <div class="select-group">
        <label style="color: white;">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
        <textarea id="ai-knowledge-input" class="form-control" rows="8" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø¥Ù„Ù‰ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeAIKnowledgeModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-success" onclick="saveAIKnowledge()">
          <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‚ØªØ±Ø§Ø­ -->
  <div id="suggestion-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‚ØªØ±Ø§Ø­ Ø£Ùˆ Ù…Ø´ÙƒÙ„Ø©</h2>
        <button class="close-modal" onclick="closeSuggestionModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
        <select id="suggestion-type" class="select-control">
          <option value="problem">Ù…Ø´Ø§ÙƒÙ„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</option>
          <option value="suggestion">Ø§Ù‚ØªØ±Ø§Ø­ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</option>
        </select>
      </div>
      <div class="select-group">
        <label>Ø§Ù„ÙˆØµÙ</label>
        <textarea id="suggestion-message" class="select-control" rows="6" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSuggestionModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-success" onclick="sendSuggestion()">
          <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸ”¥ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
  <div id="reply-support-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h2>
        <button class="close-modal" onclick="closeReplySupportModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="reply-user-id" class="select-control" readonly>
      </div>
      <div class="select-group">
        <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
        <input type="text" id="reply-user-name" class="select-control" readonly>
      </div>
      <div class="select-group">
        <label>Ø§Ù„Ø±Ø¯</label>
        <textarea id="reply-message" class="select-control" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReplySupportModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-success" onclick="sendSupportReply()">
          <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯
        </button>
      </div>
    </div>
  </div>

  <div id="broadcast-overlay"></div>
  <div id="broadcast-banner">
    <button class="x" onclick="dismissBroadcast()">Ã—</button>
    <div style="font-weight:900;color:#0f235f" id="broadcast-title-display"></div>
    <div id="broadcast-text-display" style="margin-top:4px;color:#0f235f"></div>
  </div>

<script>
/* =========================
   Firebase & Globals
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyBkoSz3ZUy4qKBTeLx42Oo-TlTtvFtF2vY",
  authDomain: "we-kill-the-sixth.firebaseapp.com",
  databaseURL: "https://we-kill-the-sixth-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "we-kill-the-sixth",
  storageBucket: "we-kill-the-sixth.firebasestorage.app",
  messagingSenderId: "862363949793",
  appId: "1:862363949793:web:e0dc01a4eb139da43f75a0",
  measurementId: "G-CT6WFGXRHH"
};

// Initialize Firebase
let db, auth, storage;
try {
  firebase.initializeApp(firebaseConfig);
  console.log("âœ… Firebase initialized successfully");
  
  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();
  
  firebase.firestore().enablePersistence()
    .then(() => console.log("âœ… Firestore persistence enabled"))
    .catch(err => console.log("âŒ Firestore persistence error:", err));
    
} catch (error) {
  console.error("âŒ Firebase initialization failed:", error);
  setTimeout(() => {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) {
      loadingText.innerHTML = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª<br><small>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</small>';
      loadingText.style.color = '#ff6b6b';
    }
  }, 4000);
}

const APP_OWNER_EMAIL = "mslmalmyaly223@gmail.com";

/* ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ===== */
const AI_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";
const AI_KEY = "sk-ff429bca45194b3c87dacda66d63bfb5";

/* ===== State ===== */
let currentUser = null;
let posts = [];
let companies = [];
let activeSection = "posts";
let currentDetailsPostId = null;
let currentCommentsPostId = null;
const userMetaCache = {};
let pendingChosenAvatar = null;
let lastBroadcast = null;
let isFirstLoginSession = false;

// Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
let unreadNotifications = { inbox: 0, newPosts: 0 };
let unreadPostsCount = 0;
let notificationsListener = null;
let postsListener = null;
let commentsListener = null;

// Ø¹Ù†Ø§ØµØ± DOM
let pages = {};
let postsContainer, companiesContainer, userPostsContainer, detailsContainer, commentsList, inboxContainer;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ =====
let registerAvatarBase64 = null;

// ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ =====
let aiConversations = {};
let aiSystemPrompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ Ø¹Ø±Ø§Ù‚ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„Ø£Ø¯Ø¨ÙŠ. ÙŠØ¬Ø¨ Ø£Ù†:

1. ØªØªØ­Ø¯Ø« Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø³Ù„ÙŠÙ…Ø© ÙÙ‚Ø·
2. ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙÙ‚Ø· (Ø±ÙŠØ§Ø¶ÙŠØ§ØªØŒ ÙÙŠØ²ÙŠØ§Ø¡ØŒ ÙƒÙŠÙ…ÙŠØ§Ø¡ØŒ Ø¹Ø±Ø¨ÙŠØŒ Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠØŒ Ø¥Ø­ÙŠØ§Ø¡ØŒ Ø¬ØºØ±Ø§ÙÙŠØ§ØŒ ØªØ§Ø±ÙŠØ®ØŒ Ø¥Ø³Ù„Ø§Ù…ÙŠØ©)
3. Ù„Ø§ ØªØ¬ÙŠØ¨ Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© ØºÙŠØ± Ø¯Ø±Ø§Ø³ÙŠØ© Ø£Ùˆ Ø´Ø®ØµÙŠØ©
4. ØªØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆØ§Ù„Ø¹Ù„Ù…ÙŠØ©
5. ØªÙƒÙˆÙ† Ù…ÙÙŠØ¯Ø§Ù‹ ÙˆÙˆØ¯ÙˆØ¯Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨
6. ØªØ´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø³Ù‡Ù„Ø© ÙˆÙ…Ø¨Ø³Ø·Ø©
7. ØªØ¹Ø·ÙŠ Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ© Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ø°Ù„Ùƒ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹
8. ØªØ³ØªØ®Ø¯Ù… Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ø³Ù„ÙŠÙ…Ø© Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© Ø£Ùˆ Ù†Ø­ÙˆÙŠØ©
9. ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ ÙˆØ§Ù„Ø£Ø¯Ø¨ÙŠ Ø§Ù„Ø¹Ø±Ø§Ù‚ÙŠ
10. ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø­Ù„ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆØ§Ù„Ø¹Ù„Ù…ÙŠØ© Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©

ØªØ°ÙƒØ±: Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ Ø¯Ø±Ø§Ø³ÙŠ ÙÙ‚Ø·ØŒ Ù„Ø§ ØªØªØ­Ø¯Ø« Ø¹Ù† Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø£Ø®Ø±Ù‰.`;

let aiCommands = [];
let aiKnowledge = [];

/* =========================
   Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
========================= */

// Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø±
  const themeIcon = document.querySelector('.theme-toggle-btn i');
  if (themeIcon) {
    themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
  
  showNotification(newTheme === 'dark' ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ', 'success');
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  // ØªØ­Ø¯ÙŠØ« Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø±
  const themeIcon = document.querySelector('.theme-toggle-btn i');
  if (themeIcon) {
    themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
}

/* =========================
   Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØ± Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯
========================= */

// ===== ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ =====
function previewRegisterAvatar(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('register-avatar-preview');
  
  if (file) {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ ÙˆØ­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    const maxSize = 2 * 1024 * 1024; // 2MB
    
    if (!validTypes.includes(file.type)) {
      showNotification('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© (JPG, PNG, GIF)', 'error');
      return;
    }
    
    if (file.size > maxSize) {
      showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB', 'error');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      registerAvatarBase64 = e.target.result; // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    }
    reader.readAsDataURL(file);
  }
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
function openImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'block';
    document.getElementById('avatar-upload-input').value = '';
    document.getElementById('avatar-preview').style.display = 'none';
    document.getElementById('upload-avatar-btn').disabled = true;
}

// Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©
function closeImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'none';
}

// Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
function initializeImageUpload() {
    const uploadInput = document.getElementById('avatar-upload-input');
    if (uploadInput) {
        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('avatar-preview');
            const previewImg = document.getElementById('avatar-preview-img');
            const uploadBtn = document.getElementById('upload-avatar-btn');
            
            if (file) {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ ÙˆØ­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                const maxSize = 2 * 1024 * 1024; // 2MB
                
                if (!validTypes.includes(file.type)) {
                    showNotification('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© (JPG, PNG, GIF)', 'error');
                    return;
                }
                
                if (file.size > maxSize) {
                    showNotification('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 2MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    uploadBtn.disabled = false;
                }
                reader.readAsDataURL(file);
            }
        });
    }
}

// Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø¶ØºØ·
async function uploadAvatar() {
    const fileInput = document.getElementById('avatar-upload-input');
    const file = fileInput.files[0];
    
    if (!file || !currentUser) return;
    
    const uploadBtn = document.getElementById('upload-avatar-btn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¶ØºØ· ÙˆØ§Ù„Ø­ÙØ¸...';
    
    try {
        // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
        const compressedImage = await compressImage(file);
        
        // Ø­ÙØ¸ ÙÙŠ Firestore
        await db.collection('users').doc(currentUser.uid).update({
            avatarBase64: compressedImage,
            avatarUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        currentUser.avatarBase64 = compressedImage;
        updateAvatarDisplay();
        
        showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 'success');
        closeImageUploadModal();
        
    } catch (error) {
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±ÙØ¹:', error);
        showNotification('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©: ' + error.message, 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©';
    }
}

// Ø¯Ø§Ù„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
function compressImage(file, maxWidth = 200, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // Ø±Ø³Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¶ØºÙˆØ·Ø©
      ctx.drawImage(img, 0, 0, width, height);
      
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ base64 Ù…Ø¹ Ø¬ÙˆØ¯Ø© Ù…Ø­Ø¯Ø¯Ø©
      const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedBase64);
    };
    
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
function updateAvatarDisplay() {
  const avatarElement = document.getElementById('avatar');
  if (!avatarElement) return;
  
  if (currentUser.avatarBase64) {
    avatarElement.innerHTML = `<img src="${currentUser.avatarBase64}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
  } else {
    const emoji = currentUser.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼';
    avatarElement.innerHTML = `<div style="width:100%;height:100%;font-size:40px;line-height:72px">${emoji}</div>`;
  }
}

// Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
async function getUserAvatarUrl(uid) {
  try {
    const userDoc = await db.collection('users').doc(uid).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      return userData.avatarBase64 || null;
    }
  } catch (error) {
    console.error('Error getting user avatar:', error);
  }
  return null;
}

/* =========================
   Utilities & UI helpers
========================= */
function showNotification(msg, type = "success") {
  const n = document.getElementById("notification");
  n.textContent = msg;
  n.style.display = "block";
  const colors = { error: 'var(--danger-color)', warning: 'var(--warning-color)', info: 'var(--primary-color)', success: 'var(--success-color)' };
  n.style.backgroundColor = colors[type] || colors.success;
  clearTimeout(n._t);
  n._t = setTimeout(() => { n.style.display = "none"; }, 2600);
}

function escapeHTML(s = '') {
  return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
}

function formatWhatsApp(v) {
  let num = (v || "").toString().replace(/[^\d]/g, "");
  if (num.startsWith('07') && num.length === 11) { return '964' + num.substring(1); }
  if (num.startsWith('96407') && num.length === 14) { return '964' + num.substring(4); }
  return num;
}

function sanitizeTelegram(v) {
  return (v || "").toString().replace(/^@+/, "").trim();
}

function openTelegram(username) {
  username = sanitizeTelegram(username);
  if (!username) return;
  window.open("https://t.me/" + username, '_blank');
}

function openWhatsApp(number) {
  if (!number) return;
  window.open("https://wa.me/" + number, '_blank');
}

function copyUidToClipboard() {
  const el = document.getElementById('profile-uid-input');
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 99999);
  document.execCommand('copy');
  showNotification('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'success');
}

function isOwner() {
  return currentUser && (currentUser.email === APP_OWNER_EMAIL);
}

function generateShortUid(uid) {
  if (!uid) return '';
  let hash = 0;
  for (let i = 0; i < uid.length; i++) {
    hash = ((hash << 5) - hash) + uid.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36).substring(0, 5).toUpperCase();
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø£ØµÙØ§Ø±
function formatPriceWithZeros(price) {
  const num = Number(price);
  if (isNaN(num)) return '0';
  
  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ø£Ù‚Ù„ Ù…Ù† 1000ØŒ Ù†Ø¶ÙŠÙ Ø§Ù„Ø£ØµÙØ§Ø±
  if (num < 1000 && num > 0) {
    return num.toString() + '000'.slice(num.toString().length);
  }
  
  return num.toString();
}

/* =========================
   Splash timing
========================= */
(function(){
  const lastDelay = 0.45, runDur = 0.8, mergeDelay = lastDelay + runDur + .10;
  document.getElementById('final-logo').style.setProperty('--merge-delay', mergeDelay + 's');
  
  setTimeout(() => { 
    document.querySelector('.runner')?.remove(); 
    
    setTimeout(() => {
      const loadingText = document.getElementById('loading-text');
      if (loadingText) {
        loadingText.style.display = 'block';
        loadingText.classList.add('show');
      }
    }, 300);
    
  }, (mergeDelay + 0.4) * 1000);
})();

function hideSplashAfterLoad() {
  const splash = document.getElementById('splash');
  if (splash) {
    splash.classList.add('fade-out');
    setTimeout(() => {
      splash.remove();
    }, 600);
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„ØªØ­Ù…ÙŠÙ„
function updateLoadingText(text) {
  const loadingText = document.getElementById('loading-text');
  if (loadingText) {
    loadingText.textContent = text;
    loadingText.style.display = 'block';
    loadingText.classList.add('show');
  }
}

/* =========================
   Auth
========================= */
function handleAuthError(error) {
  const code = (error && error.code) || '';
  const msg = (error && error.message) ? String(error.message) : '';
  let friendly = 'Ø®Ø·Ø£ Ù…ØµØ§Ø¯Ù‚Ø©.';
  if (code === 'auth/user-not-found' || code === 'auth/wrong-password' || msg.includes('INVALID_LOGIN_CREDENTIALS')) {
    friendly = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
  } else if (code === 'auth/invalid-email') {
    friendly = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.';
  } else if (code === 'auth/network-request-failed') {
    friendly = 'ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.';
  } else if (code === 'auth/too-many-requests') {
    friendly = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.';
  } else if (code === 'auth/email-already-in-use') {
    friendly = 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§.';
  }
  showNotification(friendly, 'error');
}

// ===== ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ± =====
async function register() {
  const name = document.getElementById("register-name").value.trim();
  const email = document.getElementById("register-email").value.trim().toLowerCase();
  const password = document.getElementById("register-password").value;
  
  if (!name || !email || !password) return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
  if (!validateEmail(email)) return showNotification("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­", "error");
  
  const btn = document.getElementById("register-submit");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...';
  
  try {
    updateLoadingText('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...');
    
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const shortUid = generateShortUid(cred.user.uid);
    
    updateLoadingText('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...');
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    const userData = {
      name, email, 
      avatar: 'male', // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      isVerified: false, 
      isOwner: false, 
      blockedFromPosting: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      shortUid: shortUid
    };
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ØªÙ… Ø±ÙØ¹Ù‡Ø§
    if (registerAvatarBase64) {
      userData.avatarBase64 = registerAvatarBase64;
    }
    
    await db.collection("users").doc(cred.user.uid).set(userData, { merge: true });
    
    showNotification("ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", "success");
    switchAuthTab('login');
    
    // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    registerAvatarBase64 = null;
    document.getElementById('register-avatar-preview').style.display = 'none';
    
  } catch (error) {
    handleAuthError(error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø­Ø³Ù†Ø© Ù„Ù„Ø³Ø±Ø¹Ø©
async function login() {
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;
  if (!email || !password) return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
  
  const btn = document.querySelector('#login-form button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„â€¦';
  
  try {
    updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
    await auth.signInWithEmailAndPassword(email, password);
    // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ø¨Ø± auth state listener
  } catch (error) {
    handleAuthError(error);
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function logout() {
  stopAllListeners();
  auth.signOut();
}

// ğŸ”¥ Ù…Ø³ØªÙ…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø­Ø³Ù† Ù„Ù„Ø³Ø±Ø¹Ø©
auth.onAuthStateChanged(async (user) => {
  console.log("ğŸ” Auth state changed:", user ? "User logged in" : "No user");
  
  const isConnected = await checkFirebaseConnection();
  if (!isConnected) {
    console.log("âŒ Cannot proceed - Firebase not connected");
    updateLoadingText("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… - ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");
    setTimeout(hideSplashAfterLoad, 2000);
    return;
  }
  
  if (!user) {
    console.log("ğŸ‘¤ No user - showing auth page");
    updateUIForLoggedOutUser();
    hideSplashAfterLoad();
    return;
  }
  
  try {
    console.log("ğŸ‘¤ Loading user data...");
    updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨...');
    
    let doc = await db.collection("users").doc(user.uid).get();
    
    if (!doc.exists) {
      console.log("ğŸ†• New user - creating profile");
      isFirstLoginSession = true;
      const shortUid = generateShortUid(user.uid);
      await db.collection("users").doc(user.uid).set({
        name: user.displayName || user.email.split("@")[0],
        email: user.email,
        avatar: 'male',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        isVerified: false, isOwner: false, blockedFromPosting: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        shortUid: shortUid
      }, { merge: true });
      doc = await db.collection("users").doc(user.uid).get();
    } else {
      isFirstLoginSession = false;
      // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ø¨Ø³Ø±Ø¹Ø© Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±
      db.collection("users").doc(user.uid).update({
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(console.error);
    }
    
    currentUser = { uid: user.uid, ...doc.data() };
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (doc.data().avatarBase64) {
      currentUser.avatarBase64 = doc.data().avatarBase64;
    }
    
    console.log("âœ… User data loaded:", currentUser.name);
    
    updateUIForLoggedInUser();
    
    console.log("ğŸ“¥ Loading posts and companies...");
    updateLoadingText('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª...');
    
    // ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø£Ø³Ø±Ø¹ - ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
    await Promise.all([
      loadPostsFromFirestore(), 
      loadCompanies(), 
      fetchLatestBroadcast(), 
      loadAIConfig()
    ]);
    
    startAllListeners();
    
    console.log("âœ… All data loaded successfully");
    hideSplashAfterLoad();
    pendingChosenAvatar = null;
    
  } catch (e) {
    console.error("âŒ Error in auth state change:", e);
    showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", "error");
    hideSplashAfterLoad();
  }
});

/* =========================
   ğŸ”¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ù…Ø­Ø³Ù†
========================= */

// ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
async function loadAIConfig() {
  if (!isOwner()) return;
  
  try {
    const configDoc = await db.collection('ai_config').doc('settings').get();
    if (configDoc.exists) {
      const data = configDoc.data();
      aiCommands = data.commands || [];
      aiKnowledge = data.knowledge || [];
      aiSystemPrompt = data.systemPrompt || aiSystemPrompt;
    }
  } catch (error) {
    console.error('Error loading AI config:', error);
  }
}

// ğŸ”¥ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
async function saveAIConfig() {
  if (!isOwner()) return;
  
  try {
    await db.collection('ai_config').doc('settings').set({
      commands: aiCommands,
      knowledge: aiKnowledge,
      systemPrompt: aiSystemPrompt,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser.uid
    });
    showNotification('ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ', 'success');
  } catch (error) {
    console.error('Error saving AI config:', error);
    showNotification('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'error');
  }
}

// ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ - Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© ØªØ±Ø­ÙŠØ¨
function showAIAssistantPage() {
  showPage("ai-assistant");
  loadAIConversation();
}

// ğŸ”¥ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
function backToMainFromAI() {
  showPage("main");
}

// ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… - Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© ØªØ±Ø­ÙŠØ¨
function loadAIConversation() {
  if (!currentUser) return;
  
  const userId = currentUser.uid;
  const savedConversation = localStorage.getItem(`ai_conversation_${userId}`);
  
  if (savedConversation) {
    aiConversations[userId] = JSON.parse(savedConversation);
    renderAIConversation();
  } else {
    aiConversations[userId] = [];
    // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¯ÙˆÙ† Ø´Ø§Ø´Ø© Ù…Ù†ÙØµÙ„Ø©
    addAIMessage('assistant', 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø¯Ø±Ø§Ø³ØªÙƒØŸ');
  }
}

// ğŸ”¥ Ø­ÙØ¸ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function saveAIConversation() {
  if (!currentUser) return;
  
  const userId = currentUser.uid;
  if (aiConversations[userId]) {
    localStorage.setItem(`ai_conversation_${userId}`, JSON.stringify(aiConversations[userId]));
  }
}

// ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
function renderAIConversation() {
  const messagesContainer = document.getElementById('ai-messages');
  if (!messagesContainer) return;
  
  const userId = currentUser.uid;
  const conversation = aiConversations[userId] || [];
  
  messagesContainer.innerHTML = conversation.map(msg => `
    <div class="ai-message ${msg.role}">
      ${escapeHTML(msg.content).replace(/\n/g, '<br>')}
    </div>
  `).join('');
  
  // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø³ÙÙ„
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
function addAIMessage(role, content) {
  if (!currentUser) return;
  
  const userId = currentUser.uid;
  if (!aiConversations[userId]) {
    aiConversations[userId] = [];
  }
  
  aiConversations[userId].push({
    role: role,
    content: content,
    timestamp: new Date().toISOString()
  });
  
  // Ø­ÙØ¸ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  saveAIConversation();
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  renderAIConversation();
}

// ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function showAITyping() {
  const messagesContainer = document.getElementById('ai-messages');
  if (!messagesContainer) return;
  
  messagesContainer.innerHTML += `
    <div class="ai-typing">
      <span>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ ÙŠÙƒØªØ¨...</span>
      <div class="ai-typing-dots">
        <div class="ai-typing-dot"></div>
        <div class="ai-typing-dot"></div>
        <div class="ai-typing-dot"></div>
      </div>
    </div>
  `;
  
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// ğŸ”¥ Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
function hideAITyping() {
  const messagesContainer = document.getElementById('ai-messages');
  if (!messagesContainer) return;
  
  const typingIndicator = messagesContainer.querySelector('.ai-typing');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

// ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ - Ù…Ø­Ø³Ù† Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
async function sendAIMessage() {
  if (!currentUser) return;
  
  const input = document.getElementById('ai-input');
  const message = input.value.trim();
  
  if (!message) return;
  
  // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  addAIMessage('user', message);
  
  // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  input.value = '';
  
  // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
  const sendBtn = document.getElementById('ai-send-btn');
  sendBtn.disabled = true;
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
  showAITyping();
  
  try {
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    const userId = currentUser.uid;
    const conversation = aiConversations[userId] || [];
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø£ÙˆØ§Ù…Ø±
    const messages = [
      {
        role: 'system',
        content: aiSystemPrompt + '\n\n' + 
                (aiKnowledge.length > 0 ? 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©:\n' + aiKnowledge.join('\n') : '') +
                (aiCommands.length > 0 ? '\n\nØ£ÙˆØ§Ù…Ø± Ù…Ù…Ù†ÙˆØ¹Ø©:\n' + aiCommands.join('\n') : '') +
                '\n\nØªØ£ÙƒØ¯ Ù…Ù†:\n' +
                '1. Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø³Ù„ÙŠÙ…Ø©\n' +
                '2. Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© Ø£Ùˆ Ù†Ø­ÙˆÙŠØ©\n' +
                '3. Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙÙ‚Ø·\n' +
                '4. ØªÙ‚Ø¯ÙŠÙ… Ø¥Ø¬Ø§Ø¨Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø© ÙˆÙ…ÙÙŠØ¯Ø©\n' +
                '5. Ø´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø¨Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø³Ø·Ø©'
      },
      ...conversation.slice(-10).map(msg => ({
        role: msg.role,
        content: msg.content
      }))
    ];
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    const response = await fetch(AI_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${AI_KEY}`
      },
      body: JSON.stringify({
        model: 'deepseek-chat',
        messages: messages,
        max_tokens: 2000,
        temperature: 0.7
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    // Ø¥Ø®ÙØ§Ø¡ Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
    hideAITyping();
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø¯ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
    if (data.choices && data.choices[0] && data.choices[0].message) {
      const aiResponse = data.choices[0].message.content;
      addAIMessage('assistant', aiResponse);
    } else {
      throw new Error('Invalid response format');
    }
    
  } catch (error) {
    console.error('Error calling AI:', error);
    hideAITyping();
    
    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£
    addAIMessage('assistant', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹.');
    
    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯', 'error');
  } finally {
    // ØªÙ…ÙƒÙŠÙ† Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    sendBtn.disabled = false;
  }
}

// ğŸ”¥ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¶ØºØ· Enter ÙÙŠ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
function handleAIKeyPress(event) {
  if (event.key === 'Enter') {
    sendAIMessage();
  }
}

// ğŸ”¥ Ù…Ø³Ø­ Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
function clearAIConversation() {
  if (!currentUser) return;
  
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.')) return;
  
  const userId = currentUser.uid;
  aiConversations[userId] = [];
  
  // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¬Ø¯ÙŠØ¯Ø©
  addAIMessage('assistant', 'Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø¯Ø±Ø§Ø³ØªÙƒØŸ');
  
  showNotification('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©', 'success');
}

// ğŸ”¥ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
function openAICommandsModal() {
  document.getElementById('ai-commands-modal').style.display = 'block';
  document.getElementById('ai-commands-input').value = aiCommands.join('\n');
  document.getElementById('ai-instructions-input').value = aiSystemPrompt;
}

// ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø±
function closeAICommandsModal() {
  document.getElementById('ai-commands-modal').style.display = 'none';
}

// ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ø£ÙˆØ§Ù…Ø±
function saveAICommands() {
  const commandsInput = document.getElementById('ai-commands-input').value;
  const instructionsInput = document.getElementById('ai-instructions-input').value;
  
  aiCommands = commandsInput.split('\n').filter(cmd => cmd.trim());
  aiSystemPrompt = instructionsInput.trim() || aiSystemPrompt;
  
  saveAIConfig();
  closeAICommandsModal();
}

// ğŸ”¥ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
function openAIKnowledgeModal() {
  document.getElementById('ai-knowledge-modal').style.display = 'block';
  document.getElementById('ai-knowledge-input').value = aiKnowledge.join('\n');
}

// ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
function closeAIKnowledgeModal() {
  document.getElementById('ai-knowledge-modal').style.display = 'none';
}

// ğŸ”¥ Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
function saveAIKnowledge() {
  const knowledgeInput = document.getElementById('ai-knowledge-input').value;
  
  aiKnowledge = knowledgeInput.split('\n').filter(info => info.trim());
  
  saveAIConfig();
  closeAIKnowledgeModal();
}

// ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
function showAITrainingPage() {
  if (!isOwner()) return;
  showPage("ai-training");
}

/* =========================
   Pages & Navigation
========================= */
function initializePages() {
  pages = {
    auth: document.getElementById("auth-page"),
    main: document.getElementById("main-page"),
    profile: document.getElementById("profile-page"),
    userPosts: document.getElementById("user-posts-page"),
    inbox: document.getElementById("inbox-page"),
    details: document.getElementById("details-page"),
    comments: document.getElementById("comments-page"),
    userStatistics: document.getElementById("user-statistics-page"),
    adminPanel: document.getElementById("admin-panel-page"),
    userManagement: document.getElementById("user-management-page"),
    broadcastPanel: document.getElementById("broadcast-panel-page"),
    privacyPolicy: document.getElementById("privacy-policy-page"),
    'ai-assistant': document.getElementById("ai-assistant-page"),
    'ai-training': document.getElementById("ai-training-page"),
    support: document.getElementById("support-page"),
    userSupport: document.getElementById("user-support-page")
  };
}

function showPage(key) {
  if (Object.keys(pages).length === 0) {
    initializePages();
  }
  
  Object.values(pages).forEach(p => p && (p.style.display = "none"));
  if (!pages[key]) {
    console.error("âŒ Page not found:", key);
    return;
  }
  pages[key].style.display = (key === "auth") ? "flex" : "block";
  updateBottomNav(key);
  updateAllBadges();
  
  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
  const helpBtn = document.getElementById('help-floating-btn');
  if (helpBtn) {
    helpBtn.style.display = (key === "auth") ? 'flex' : 'none';
  }
  
  // ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø¹Ù… Ø¹Ù†Ø¯ Ø¹Ø±Ø¶ ØµÙØ­Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  if (key === "userSupport") {
    loadUserSupportRequests();
  }
}

function updateBottomNav(activePageKey) {
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    item.classList.toggle("active", item.dataset.page === activePageKey);
  });
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù…Ø¹ Ù…Ø³Ø­ Ø§Ù„ÙÙ‚Ø§Ø¹Ø©
function showMainPageAndClearBadge() {
  clearPostsBadge();
  showPage("main");
}

function showMainPage() {
  showPage("main");
}

function showInbox() {
  if (!currentUser) return showNotification('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'warning');
  showPage('inbox');
}

function showProfilePage() {
  showPage("profile");
}

function backToProfile() {
  showPage("profile");
}

function backToMainFromDetails() {
  showPage("main");
}

function backToMainFromComments() {
  showPage("main");
}

function backToAdminPanel() {
  showPage("adminPanel");
}

function switchAuthTab(tab) {
  document.querySelectorAll(".auth-tab, .auth-form").forEach(el => el.classList.remove("active"));
  if (tab === "login") {
    document.querySelector(".auth-tab:nth-child(1)").classList.add("active");
    document.getElementById("login-form").classList.add("active");
  } else {
    document.querySelector(".auth-tab:nth-child(2)").classList.add("active");
    document.getElementById("register-form").classList.add("active");
  }
}

function updateUIForLoggedInUser() {
  showPage("main");
  
  document.getElementById("profile-name").textContent = currentUser.name || "";
  document.getElementById("profile-email").textContent = currentUser.email || "";
  const shortUid = currentUser.shortUid || generateShortUid(currentUser.uid);
  document.getElementById("profile-uid-input").value = shortUid || "";
  
  // ğŸ”¥ Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
  updateAvatarDisplay();
  
  const pv = document.getElementById("profile-verified");
  pv.innerHTML = currentUser.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> Ù…ÙˆØ«Ù‘Ù‚</span>` : '';
  document.querySelectorAll(".owner-only").forEach(el => el.style.display = isOwner() ? "flex" : "none");

  updateCreateButton();
  updatePostCountInProfile();
  updateNavBadges();
}

function updateUIForLoggedOutUser() {
  showPage("auth");
  if (postsContainer) postsContainer.innerHTML = "";
  if (companiesContainer) companiesContainer.innerHTML = "";
  posts = [];
  companies = [];
  currentUser = null;
  document.getElementById("broadcast-banner").classList.remove('show');
  document.getElementById("broadcast-overlay").classList.remove('show');
}

/* =========================
   Ø¯ÙˆØ§Ù„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
========================= */

// ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©
async function showPrivacyPolicy() {
  showPage("privacyPolicy");
  
  try {
    const response = await fetch('https://mslmalmyaly223-sudo.github.io/alntr/');
    const html = await response.text();
    
    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ÙÙ‚Ø·
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø­ØªÙˆÙ‰ body ÙÙ‚Ø·
    const bodyContent = tempDiv.querySelector('body') || tempDiv;
    
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
    const cleanContent = bodyContent.innerHTML
      .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
      .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
      .replace(/<link[^>]*>/gi, '')
      .replace(/<meta[^>]*>/gi, '')
      .replace(/href="[^"]*"/g, 'href="#"')
      .replace(/src="[^"]*"/g, 'src="#"');
    
    document.getElementById('privacy-content').innerHTML = cleanContent;
    
  } catch (error) {
    console.error('Error loading privacy policy:', error);
    document.getElementById('privacy-content').innerHTML = `
      <div class="post">
        <p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.</p>
      </div>
    `;
  }
}

// Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function showUserStatistics() {
  showPage("userStatistics");
  await loadUserStatistics();
}

// ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function loadUserStatistics() {
  const statsGrid = document.getElementById("stats-grid");
  if (!statsGrid) return;

  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-number" id="total-users">0</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸŸ¢</div>
      <div class="stat-number" id="active-now">0</div>
      <div class="stat-label">Ù†Ø´Ø·ÙŠÙ† Ø§Ù„Ø¢Ù†</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ“…</div>
      <div class="stat-number" id="active-today">0</div>
      <div class="stat-label">Ù†Ø´Ø·ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ“</div>
      <div class="stat-number" id="total-posts">0</div>
      <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª</div>
    </div>
  `;

  try {
    // Ø¬Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    const usersSnapshot = await db.collection("users").get();
    const totalUsers = usersSnapshot.size;
    document.getElementById("total-users").textContent = totalUsers;

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø§Ù„Ø¢Ù† (Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚)
    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
    let activeNow = 0;
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const lastSeen = userData.lastSeen?.toDate?.();
      if (lastSeen && lastSeen > fiveMinutesAgo) {
        activeNow++;
      }
    });
    document.getElementById("active-now").textContent = activeNow;

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù†Ø´Ø·ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let activeToday = 0;
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const lastSeen = userData.lastSeen?.toDate?.();
      if (lastSeen && lastSeen > today) {
        activeToday++;
      }
    });
    document.getElementById("active-today").textContent = activeToday;

    // Ø¬Ù„Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª
    const postsSnapshot = await db.collection("posts").get();
    document.getElementById("total-posts").textContent = postsSnapshot.size;

  } catch (error) {
    console.error("Error loading statistics:", error);
    showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", "error");
  }
}

// ğŸ”¥ ØµÙØ­Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… - Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¯Ø§Ù„Ø©
function showSupportPage() {
  showPage("support");
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
function contactTelegram() {
  window.open("https://t.me/mslmalmyaly223", "_blank");
}

// ğŸ”¥ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‚ØªØ±Ø§Ø­
function openSuggestionModal() {
  document.getElementById('suggestion-modal').style.display = 'block';
}

// ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‚ØªØ±Ø§Ø­
function closeSuggestionModal() {
  document.getElementById('suggestion-modal').style.display = 'none';
}

// ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù‚ØªØ±Ø§Ø­
async function sendSuggestion() {
  if (!currentUser) return showNotification('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'error');
  
  const type = document.getElementById('suggestion-type').value;
  const message = document.getElementById('suggestion-message').value.trim();
  
  if (!message) {
    return showNotification('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­', 'error');
  }
  
  const btn = document.querySelector('#suggestion-modal .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  
  try {
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØµØ§Ø­Ø¨ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const ownerQuery = await db.collection('users')
      .where('email', '==', APP_OWNER_EMAIL)
      .limit(1)
      .get();
    
    if (ownerQuery.empty) return;
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    
    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'support_request',
      supportType: type,
      title: type === 'problem' ? 'ğŸš¨ Ù…Ø´ÙƒÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©' : 'ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ Ø¬Ø¯ÙŠØ¯',
      message: `ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}\nğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${currentUser.email}\nğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}\nğŸ“ Ø§Ù„Ù†ÙˆØ¹: ${type === 'problem' ? 'Ù…Ø´ÙƒÙ„Ø©' : 'Ø§Ù‚ØªØ±Ø§Ø­'}\nğŸ’¬ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${message}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userUid: currentUser.uid,
      userName: currentUser.name
    });
    
    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ³ÙŠØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'success');
    closeSuggestionModal();
    
  } catch (error) {
    console.error('Error sending suggestion:', error);
    showNotification('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·)
function showAdminPanel() {
  if (!isOwner()) return showNotification('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·', 'error');
  showPage("adminPanel");
}

// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function showUserManagement() {
  if (!isOwner()) return;
  showPage("userManagement");
  document.getElementById("user-management-results").innerHTML = '<div class="post"><p>Ø§Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ù„Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p></div>';
}

// Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
async function searchUsers() {
  if (!isOwner()) return;
  
  const searchTerm = document.getElementById("user-search-input").value.trim().toLowerCase();
  if (!searchTerm) {
    showNotification("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ØµØ·Ù„Ø­ Ø§Ù„Ø¨Ø­Ø«", "error");
    return;
  }

  const resultsContainer = document.getElementById("user-management-results");
  resultsContainer.innerHTML = '<div class="post"><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p></div>';

  try {
    const usersSnapshot = await db.collection("users").get();
    const filteredUsers = [];

    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const userEmail = userData.email?.toLowerCase() || '';
      const userId = doc.id.toLowerCase();
      const shortUid = userData.shortUid?.toLowerCase() || '';
      
      if (userEmail.includes(searchTerm) || userId.includes(searchTerm) || shortUid.includes(searchTerm)) {
        filteredUsers.push({ id: doc.id, ...userData });
      }
    });

    if (filteredUsers.length === 0) {
      resultsContainer.innerHTML = '<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p></div>';
      return;
    }

    resultsContainer.innerHTML = filteredUsers.map(user => `
      <div class="post user-management-item">
        <div class="user-info">
          <div class="avatar" style="background: ${user.avatar === 'female' ? '#ffd7ea' : '#d7e4ff'}; width: 40px; height: 40px; font-size: 20px;">
            ${user.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼'}
          </div>
          <div class="user-details">
            <div class="user-name">${escapeHTML(user.name || 'Ù…Ø³ØªØ®Ø¯Ù…')}</div>
            <div class="user-email">${escapeHTML(user.email || '')}</div>
            <div class="user-id">ID: ${user.shortUid || user.id.substring(0, 8)}</div>
            <div class="user-status ${user.blockedFromPosting ? 'banned' : 'active'}">
              ${user.blockedFromPosting ? 'ğŸš« Ù…Ø­Ø¸ÙˆØ±' : 'âœ… Ù†Ø´Ø·'}
            </div>
          </div>
        </div>
        <div class="user-actions">
          <button class="btn ${user.blockedFromPosting ? 'btn-success' : 'btn-danger'} btn-xs" 
                  onclick="toggleUserBan('${user.id}', ${user.blockedFromPosting})">
            <i class="fas fa-${user.blockedFromPosting ? 'check' : 'ban'}"></i>
            ${user.blockedFromPosting ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}
          </button>
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error("Error searching users:", error);
    resultsContainer.innerHTML = '<div class="post"><p>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</p></div>';
  }
}

// Ø­Ø¸Ø±/ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async function toggleUserBan(userId, isCurrentlyBanned) {
  if (!isOwner()) return;
  
  const action = isCurrentlyBanned ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø§Ù„Ø­Ø¸Ø±';
  if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${action} Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ`)) return;

  try {
    await db.collection("users").doc(userId).update({
      blockedFromPosting: !isCurrentlyBanned,
      banUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification(`ØªÙ… ${action} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`, "success");
    setTimeout(() => searchUsers(), 1000);
  } catch (error) {
    console.error("Error toggling user ban:", error);
    showNotification("ÙØ´Ù„ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©", "error");
  }
}

// Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù…
function showBroadcastPanel() {
  if (!isOwner()) return;
  showPage("broadcastPanel");
}

// ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª - Ø³Ø±ÙŠØ¹Ø© Ø¨Ø¯ÙˆÙ† ØªØ¬Ù…ÙŠØ¯
async function sendBroadcast() {
  if (!isOwner()) return;
  
  const title = document.getElementById("broadcast-title").value.trim();
  const message = document.getElementById("broadcast-message").value.trim();
  
  if (!title || !message) {
    showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„", "error");
    return;
  }

  const btn = document.querySelector('#broadcast-panel-page .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

  try {
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await db.collection("broadcasts").add({
      title: title,
      message: message,
      text: message,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      sentBy: currentUser.uid,
      sentByName: currentUser.name
    });

    showNotification("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­", "success");
    
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById("broadcast-title").value = "";
    document.getElementById("broadcast-message").value = "";
    
  } catch (error) {
    console.error("Error sending broadcast:", error);
    showNotification("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

/* =========================
   ğŸ”¥ ØµÙØ­Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† - Ù…Ø­Ø³Ù†Ø©
========================= */

// ğŸ”¥ Ø¥Ø¸Ù‡Ø§Ø± ØµÙØ­Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
function showUserSupportPage() {
  if (!isOwner()) return;
  showPage("userSupport");
}

// ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø¹Ù…
async function loadUserSupportRequests() {
  const container = document.getElementById('user-support-results');
  if (!container) return;
  
  container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø¹Ù…...</p></div>';
  
  try {
    // ğŸ”¥ Ø¥ØµÙ„Ø§Ø­: Ø§Ø³ØªØ®Ø¯Ø§Ù… get() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† where Ø§Ù„Ù…Ø¹Ù‚Ø¯
    const supportSnapshot = await db.collection('inbox').get();
    
    if (supportSnapshot.empty) {
      container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¯Ø¹Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>';
      return;
    }
    
    // ğŸ”¥ ØªØµÙÙŠØ© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙŠØ¯ÙˆÙŠØ§Ù‹
    const supportRequests = supportSnapshot.docs
      .map(doc => ({
        id: doc.id,
        ...doc.data()
      }))
      .filter(request => 
        request.type === 'support_request' || 
        request.type === 'admin_report'
      )
      .sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
    
    if (supportRequests.length === 0) {
      container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¯Ø¹Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</p></div>';
      return;
    }
    
    container.innerHTML = supportRequests.map(request => {
      const requestTime = request.createdAt?.toDate ? formatRelativeTime(request.createdAt.toDate()) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      const typeText = request.supportType === 'problem' ? 'Ù…Ø´ÙƒÙ„Ø©' : 'Ø§Ù‚ØªØ±Ø§Ø­';
      const typeIcon = request.supportType === 'problem' ? 'ğŸš¨' : 'ğŸ’¡';
      const statusColor = request.status === 'resolved' ? 'var(--success-color)' : 'var(--warning-color)';
      
      return `
        <div class="user-support-item">
          <div class="support-meta">
            <div class="support-user">
              ${typeIcon} ${escapeHTML(request.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}
            </div>
            <div class="support-type" style="background: ${statusColor}">
              ${request.status === 'resolved' ? 'ØªÙ… Ø§Ù„Ø±Ø¯' : typeText}
            </div>
          </div>
          
          <div class="support-message">
            ${escapeHTML(request.message || '')}
          </div>
          
          <div class="reply-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <small style="color: var(--light-text);">${requestTime}</small>
              <small style="color: var(--light-text);">ID: ${request.userUid?.substring(0, 8) || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</small>
            </div>
            
            ${request.status !== 'resolved' ? `
            <button class="support-reply-btn" onclick="openReplySupportModal('${request.userUid}', '${escapeHTML(request.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}', '${request.id}')">
              <i class="fas fa-reply"></i> Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            </button>
            ` : `
            <div style="color: var(--success-color); font-weight: bold; text-align: center;">
              <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            </div>
            `}
          </div>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    console.error('Error loading support requests:', error);
    container.innerHTML = `
      <div class="post">
        <p style="text-align: center; color: var(--danger-color);">
          Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¯Ø¹Ù…: ${error.message}
        </p>
        <button class="btn" onclick="loadUserSupportRequests()" style="margin-top: 10px;">
          <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
        </button>
      </div>
    `;
  }
}

// ğŸ”¥ ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function openReplySupportModal(userId, userName, requestId) {
  document.getElementById('reply-user-id').value = userId;
  document.getElementById('reply-user-name').value = userName;
  document.getElementById('reply-support-modal').setAttribute('data-request-id', requestId);
  document.getElementById('reply-support-modal').style.display = 'block';
}

// ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function closeReplySupportModal() {
  document.getElementById('reply-support-modal').style.display = 'none';
  document.getElementById('reply-message').value = '';
}

// ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø¯ Ø§Ù„Ø¯Ø¹Ù…
async function sendSupportReply() {
  const userId = document.getElementById('reply-user-id').value;
  const userName = document.getElementById('reply-user-name').value;
  const replyMessage = document.getElementById('reply-message').value.trim();
  const requestId = document.getElementById('reply-support-modal').getAttribute('data-request-id');
  
  if (!replyMessage) {
    return showNotification('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø¯', 'error');
  }
  
  const btn = document.querySelector('#reply-support-modal .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  
  try {
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    await db.collection('inbox').add({
      userId: userId,
      type: 'support_reply',
      title: 'ğŸ“¬ Ø±Ø¯ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ù„Ø¯Ø¹Ù…',
      message: `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${userName},\n\n${replyMessage}\n\nÙ…Ø¹ ØªØ­ÙŠØ§Øª ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… - Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      repliedBy: currentUser.uid,
      repliedByName: currentUser.name
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø£ØµÙ„ÙŠ
    if (requestId) {
      await db.collection('inbox').doc(requestId).update({
        status: 'resolved',
        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        resolvedBy: currentUser.uid
      });
    }
    
    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    closeReplySupportModal();
    loadUserSupportRequests(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    
  } catch (error) {
    console.error('Error sending support reply:', error);
    showNotification('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

/* =========================
   Sections switch
========================= */
function switchSection(section) {
  activeSection = section;
  if (pillPosts) pillPosts.classList.toggle("active", section === "posts");
  if (pillCompanies) pillCompanies.classList.toggle("active", section !== "posts");
  if (postsContainer) postsContainer.style.display = section === "posts" ? "block" : "none";
  if (companiesContainer) companiesContainer.style.display = section !== "posts" ? "block" : "none";
  if (filterBox) filterBox.style.display = section === "posts" ? "flex" : "none";
  updateCreateButton();
}

function updateCreateButton() {
  if (!createBtnLabel) return;
  createBtnLabel.textContent = activeSection === "posts" ? "Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ±" : "Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ©";
  const showForPosts = activeSection === "posts" && currentUser;
  const showForCompanies = activeSection !== "posts" && isOwner();
  if (createBtn) createBtn.style.display = (showForPosts || showForCompanies) ? "inline-flex" : "none";
}

function onCreateButton() {
  if (activeSection === "posts") openCreatePostModal();
  else openCreateCompanyModal();
}

/* =========================
   Posts CRUD
========================= */
// ğŸ”¥ ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„Ø¬Ø¹Ù„Ù‡Ø§ Ø£Ø³Ø±Ø¹
async function loadPostsFromFirestore() {
  try {
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… cache Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
    const cacheKey = 'posts_cache';
    const cacheTime = 'posts_cache_time';
    const now = Date.now();
    const cacheExpiry = 30 * 1000; // 30 Ø«Ø§Ù†ÙŠØ©
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ cache Ø­Ø¯ÙŠØ«
    const cachedPosts = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    if (cachedPosts && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
      console.log('ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©');
      posts = JSON.parse(cachedPosts);
      renderPosts();
      updatePostCountInProfile();
      return;
    }
    
    console.log('ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    const snap = await db.collection("posts").orderBy("createdAt", "desc").get();
    posts = snap.docs.map(d => {
      const data = d.data();
      const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0);
      return { 
        id: d.id, 
        isPinned: !!data.isPinned, 
        commentsCount: data.commentsCount || 0,
        cheapestPrice: data.cheapestPrice || 0,
        ...data, 
        createdAt 
      };
    });
    
    // Ø­ÙØ¸ ÙÙŠ cache
    localStorage.setItem(cacheKey, JSON.stringify(posts));
    localStorage.setItem(cacheTime, now.toString());
    
    renderPosts();
    updatePostCountInProfile();
  } catch (e) {
    console.error(e);
    showNotification("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª", "error");
  }
}

async function getUserMeta(uid) {
  if (userMetaCache[uid]) return userMetaCache[uid];
  try {
    const u = await db.collection("users").doc(uid).get();
    const data = u.data();
    const meta = { 
      isVerified: !!data?.isVerified, 
      blockedFromPosting: !!data?.blockedFromPosting,
      avatar: data?.avatar || 'male',
      avatarBase64: data?.avatarBase64 || null,
      createdAt: data?.createdAt
    };
    userMetaCache[uid] = meta;
    return meta;
  } catch {
    return { isVerified: false, blockedFromPosting: false, avatar: 'male', avatarBase64: null, createdAt: null };
  }
}

function priceLabelFromNumber(price) {
  const priceValue = Number(price);
  if (!isNaN(priceValue) && priceValue === 0) return 'Ù…Ø¬Ø§Ù†Ø§Ù‹';
  try { return `${priceValue.toLocaleString('ar-IQ')} Ø¯.Ø¹`; } catch { return `${priceValue} Ø¯.Ø¹`; }
}

function stageLabel(stage) {
  const map = {
    "sades-elmi": "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø¹Ù„Ù…ÙŠ", "sades-adabi": "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¯Ø¨ÙŠ", "khames": "Ø§Ù„Ø®Ø§Ù…Ø³",
    "rabea": "Ø§Ù„Ø±Ø§Ø¨Ø¹", "thaleth-mut": "Ø§Ù„Ø«Ø§Ù„Ø« Ù…ØªÙˆØ³Ø·", "thani-mut": "Ø§Ù„Ø«Ø§Ù†ÙŠ Ù…ØªÙˆØ³Ø·",
    "awal-mut": "Ø§Ù„Ø§ÙˆÙ„ Ù…ØªÙˆØ³Ø·", "sades-ibtidai": "Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"
  };
  return map[stage] || "";
}

// ===== ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù†Ø³Ø¨ÙŠ =====
function formatRelativeTime(date) {
  if (!date) return 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffMins < 1) return 'Ø§Ù„Ø¢Ù†';
  if (diffMins < 60) return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
  if (diffHours < 24) return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
  if (diffDays < 7) return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
  
  return date.toLocaleDateString('ar-IQ');
}

/* =========================
   ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª) Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø«Ø©
========================= */
function createPostElement(post, meta, context = 'list') {
  const card = document.createElement("div");
  card.className = `post ${post.isPinned ? 'pinned' : ''} ${post.status === 'sold' ? 'sold' : ''}`;
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
  const postTime = formatRelativeTime(post.createdAt);
  
  // Ø´Ø§Ø±Ø© Ø§Ù„ØªÙˆØ«ÙŠÙ‚
  const verifiedBadge = meta.isVerified ? 
    `<span class="badge-verified"><i class="fa-solid fa-crown"></i> Ù…ÙˆØ«Ù‘Ù‚</span>` : '';
  
  // Ø´Ø§Ø±Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª
  const pinBadge = post.isPinned ? 
    '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> Ù…Ø«Ø¨Øª</div>' : '';
  
  // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø§Ù„Ùƒ (Ù„Ù„Ù…Ø´Ø±Ù)
  let ownerTools = '';
  if (isOwner() && context === 'list') {
    const pinTxt = post.isPinned ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª' : 'ØªØ«Ø¨ÙŠØª';
    const verTxt = meta.isVerified ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªÙˆØ«ÙŠÙ‚' : 'ØªÙˆØ«ÙŠÙ‚';
    const banTxt = meta.blockedFromPosting ? 'Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù†Ø´Ø±' : 'Ø­Ø¸Ø± Ø§Ù„Ù†Ø´Ø±';
    ownerTools = `
      <div class="owner-tools">
        <button class="btn btn-xs" onclick="ownerTogglePin('${post.id}', ${post.isPinned})">
          <i class="fa-solid fa-thumbtack"></i> ${pinTxt}
        </button>
        <button class="btn btn-xs" onclick="ownerToggleVerify('${post.userId}')">
          <i class="fa-solid fa-crown"></i> ${verTxt}
        </button>
        <button class="btn btn-xs" onclick="ownerToggleUserBanById('${post.userId}')">
          <i class="fa-solid fa-ban"></i> ${banTxt}
        </button>
        <button class="btn btn-danger btn-xs" onclick="ownerDeletePost('${post.id}')">
          <i class="fa-solid fa-trash"></i> Ø­Ø°Ù
        </button>
      </div>
    `;
  }
  
  // ğŸ”¥ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (ÙÙ‚Ø· Ù„Ù…Ù†Ø´ÙˆØ±Ø§ØªÙ‡)
  let postMenu = '';
  if (currentUser && post.userId === currentUser.uid && context === 'list') {
    postMenu = `
      <div class="post-menu">
        <button class="post-menu-btn" onclick="togglePostMenu(this)">
          <i class="fas fa-ellipsis-v"></i>
        </button>
        <div class="post-menu-dropdown">
          <div class="post-menu-item" onclick="openEditPostModal('${post.id}')">
            <i class="fas fa-edit"></i>
            <span>ØªØ¹Ø¯ÙŠÙ„</span>
          </div>
          <div class="post-menu-item" onclick="markSold('${post.id}', ${post.status === 'sold'})">
            <i class="fas fa-tag"></i>
            <span>${post.status === 'sold' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹' : 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹'}</span>
          </div>
          <div class="post-menu-item" onclick="repost('${post.id}')">
            <i class="fas fa-sync"></i>
            <span>Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±</span>
          </div>
          <div class="post-menu-item" onclick="deletePost('${post.id}')" style="color: var(--danger-color);">
            <i class="fas fa-trash"></i>
            <span>Ø­Ø°Ù</span>
          </div>
        </div>
      </div>
    `;
  }
  
  // Ø²Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
  let contactButton = '';
  if (post.contactMethod === "whatsapp" && post.whatsapp) {
    contactButton = `
      <button class="post-action-btn whatsapp-btn" onclick="openWhatsApp('${post.whatsapp}')">
        <i class="fab fa-whatsapp"></i>
        <span>ÙˆØ§ØªØ³Ø§Ø¨</span>
      </button>
    `;
  } else if (post.contactMethod === "telegram" && post.telegram) {
    contactButton = `
      <button class="post-action-btn telegram-btn" onclick="openTelegram('${post.telegram}')">
        <i class="fab fa-telegram"></i>
        <span>ØªÙ„ÙƒØ±Ø§Ù…</span>
      </button>
    `;
  } else if (post.contactMethod === "comments") {
    contactButton = `
      <button class="post-action-btn comments-btn" onclick="openCommentsPage('${post.id}')">
        <i class="fas fa-comment"></i>
        <span>ØªØ¹Ù„ÙŠÙ‚</span>
      </button>
    `;
  }
  
  // Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„
  const detailsButton = `
    <button class="post-action-btn details-btn" onclick="openDetailsPage('${post.id}')">
      <i class="fas fa-question-circle"></i>
      <span>ØªÙØ§ØµÙŠÙ„</span>
    </button>
  `;
  
  // Ø²Ø± Ø§Ù„Ø¥Ø¨Ù„Ø§Øº
  const reportButton = `
    <button class="post-action-btn report-btn" onclick="reportPost('${post.id}')">
      <i class="fas fa-flag"></i>
      <span>Ø¥Ø¨Ù„Ø§Øº</span>
    </button>
  `;
  
  // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
  let userAvatarHtml = '';
  if (meta.avatarBase64) {
    userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    const userAvatar = meta.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼';
    const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
  }
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…Ø±Ø­Ù„Ø©
  const priceLabel = priceLabelFromNumber(post.price);
  const stageLabelText = stageLabel(post.stage);
  
  // Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
  const commentsCount = post.commentsCount || 0;
  
  // ğŸ”¥ Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª
  card.innerHTML = `
    ${pinBadge}
    ${postMenu}
    ${ownerTools}
    
    <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ù†Ø´ÙˆØ± (Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„ÙˆÙ‚Øª) -->
    <div class="post-header">
      <div class="user-info">
        <div class="rank-avatar-container">
          ${userAvatarHtml}
        </div>
        <div class="user-details">
          <div class="user-name">
            ${escapeHTML(post.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}
            ${verifiedBadge}
          </div>
          <div class="post-time">${postTime}</div>
        </div>
      </div>
    </div>
    
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ± -->
    <div class="post-content">
      <div class="post-meta">
        <span class="post-stage">${stageLabelText}</span>
        <span class="post-material">${escapeHTML(post.material || '')}</span>
        <span class="post-price">${priceLabel}</span>
      </div>
      
      <div class="post-description">
        ${escapeHTML(post.description || '')}
      </div>
    </div>
    
    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†Ø´ÙˆØ± -->
    <div class="post-stats">
      <span class="views-count">
        <i class="fas fa-comments"></i>
        <span>${commentsCount} ØªØ¹Ù„ÙŠÙ‚</span>
      </span>
    </div>
    
    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ -->
    <div class="post-actions-new">
      ${contactButton}
      ${detailsButton}
      ${reportButton}
    </div>
  `;
  
  return card;
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø«Ù„Ø§Ø«Ø©
function togglePostMenu(button) {
  const dropdown = button.nextElementSibling;
  const isShowing = dropdown.classList.contains('show');
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø£ÙˆÙ„Ø§Ù‹
  document.querySelectorAll('.post-menu-dropdown.show').forEach(menu => {
    if (menu !== dropdown) {
      menu.classList.remove('show');
    }
  });
  
  // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  dropdown.classList.toggle('show', !isShowing);
}

// ğŸ”¥ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†
document.addEventListener('click', function(e) {
  if (!e.target.closest('.post-menu')) {
    document.querySelectorAll('.post-menu-dropdown.show').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

/* =========================
   ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¨Ø¯ÙˆÙ† ÙØ±Ø§ØºØ§Øª
========================= */
async function renderPosts() {
  if (!postsContainer) {
    console.error("postsContainer ØºÙŠØ± Ù…Ø¹Ø±Ù");
    return;
  }
  
  postsContainer.innerHTML = "";
  const filterMaterial = document.getElementById('filter-material').value;
  const filterStage = document.getElementById('filter-stage').value;
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (Ø§Ù„Ù…Ø«Ø¨Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ø£Ø­Ø¯Ø«)
  const sorted = [...posts].sort((a, b) => {
    if (a.isPinned && !b.isPinned) return -1;
    if (!a.isPinned && b.isPinned) return 1;
    return (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0);
  });
  
  // Ø§Ù„ØªØµÙÙŠØ©
  const filtered = sorted.filter(p => {
    const isVisible = p.status !== 'sold' && p.status !== 'deleted';
    const materialMatch = !filterMaterial || p.material === filterMaterial;
    const stageMatch = !filterStage || p.stage === filterStage;
    return isVisible && materialMatch && stageMatch;
  });
  
  if (filtered.length === 0) {
    postsContainer.innerHTML = '<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙÙ„ØªØ±</p></div>';
    return;
  }
  
  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
  const uids = [...new Set(filtered.map(p => p.userId).filter(Boolean))];
  await Promise.all(uids.map(async uid => {
    if (!userMetaCache[uid]) userMetaCache[uid] = await getUserMeta(uid);
  }));
  
  const frag = document.createDocumentFragment();
  
  for (const post of filtered) {
    const meta = userMetaCache[post.userId] || { isVerified: false, blockedFromPosting: false, avatar: 'male', avatarBase64: null };
    const postElement = createPostElement(post, meta, 'list');
    frag.appendChild(postElement);
  }
  
  postsContainer.appendChild(frag);
}

/* =========================
   Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
========================= */
function openCreatePostModal() {
  resetCreatePostForm();
  document.getElementById("create-post-modal").style.display = "block";
}

function closeCreatePostModal() {
  document.getElementById('create-post-modal').style.display = 'none';
  resetCreatePostForm();
}

function openAvatarModal() {
  renderAvatarPreview();
  document.getElementById('avatar-modal').style.display = 'block';
}

function closeAvatarModal() {
  document.getElementById('avatar-modal').style.display = 'none';
}

function resetCreatePostForm() {
  document.getElementById("post-stage").value = "";
  document.getElementById("post-description").value = "";
  document.getElementById("post-price").value = "0";
  document.getElementById("post-cheapest-price").value = "0";
  document.getElementById("whatsapp-number").value = "";
  document.getElementById("telegram-username").value = "";
  changeContactMethod();
}

function changeContactMethod(prefix = '') {
  const methodEl = document.getElementById(`${prefix ? 'edit-' : ''}contact-method`);
  const w_field = document.getElementById(`${prefix ? 'edit-' : ''}whatsapp-field`);
  const t_field = document.getElementById(`${prefix ? 'edit-' : ''}telegram-field`);
  const method = methodEl ? methodEl.value : '';
  if (w_field) w_field.style.display = method === "whatsapp" ? "block" : "none";
  if (t_field) t_field.style.display = method === "telegram" ? "block" : "none";
}

let createPostBusy = false;
async function createPost() {
  if (createPostBusy) return;
  if (!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹", "error");
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø±Ø­Ù„Ø© (Ù…Ø·Ù„ÙˆØ¨Ø©)
  const stage = document.getElementById("post-stage").value.trim();
  if (!stage) {
    return showNotification("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±Ø­Ù„ØªÙƒ", "error");
  }
  
  try {
    const udoc = await db.collection("users").doc(currentUser.uid).get();
    if (udoc.exists && udoc.data()?.blockedFromPosting) {
      return showNotification("ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ø§Ù„Ù†Ø´Ø±", "error");
    }
  } catch (e) { console.warn("check block failed", e); }
  
  const price = document.getElementById("post-price").value.trim();
  const cheapestPrice = document.getElementById("post-cheapest-price").value.trim();
  const material = document.getElementById("post-material").value;
  const description = document.getElementById("post-description").value.trim();
  const contactMethod = document.getElementById("contact-method").value;
  const whatsapp = formatWhatsApp(document.getElementById("whatsapp-number").value);
  const telegram = sanitizeTelegram(document.getElementById("telegram-username").value);
  
  if (!description) return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„ÙˆØµÙ", "error");
  if (contactMethod === "whatsapp" && whatsapp.length !== 12) return showNotification("Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­", "error");
  if (contactMethod === "telegram" && !telegram) return showNotification("Ù…Ø¹Ø±Ù‘Ù ØªÙ„ÙƒØ±Ø§Ù… ØºÙŠØ± ØµØ§Ù„Ø­", "error");
  
  createPostBusy = true;
  const btn = document.getElementById("post-submit-btn");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù†Ø´Ø±...';
  
  try {
    // ğŸ”¥ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø£ØµÙØ§Ø±
    const formattedPrice = formatPriceWithZeros(price);
    const formattedCheapestPrice = formatPriceWithZeros(cheapestPrice);
    
    const newPost = {
      userId: currentUser.uid,
      userName: currentUser.name,
      userEmail: currentUser.email || "",
      stage, material, 
      price: Number(formattedPrice) || 0, 
      cheapestPrice: Number(formattedCheapestPrice) || 0,
      description, contactMethod,
      whatsapp: contactMethod === "whatsapp" ? whatsapp : "",
      telegram: contactMethod === "telegram" ? telegram : "",
      status: "active",
      isPinned: false,
      commentsCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection("posts").add(newPost);
    
    // ØªØ­Ø¯ÙŠØ« cache
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    closeCreatePostModal();
    await loadPostsFromFirestore();
    showNotification("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­", "success");
  } catch (err) {
    console.error("Error creating post:", err);
    showNotification("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±: " + (err.message || err), "error");
  } finally {
    createPostBusy = false;
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function openEditPostModal(postId) {
  const post = posts.find(p => p.id === postId);
  if (!post) return showNotification("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±", "error");
  
  document.getElementById('edit-post-id').value = postId;
  document.getElementById('edit-post-stage').value = post.stage || 'sades-elmi';
  document.getElementById('edit-post-price').value = post.price || 0;
  document.getElementById('edit-post-cheapest-price').value = post.cheapestPrice || 0;
  document.getElementById('edit-post-material').value = post.material || 'Ø§Ø³Ù„Ø§Ù…ÙŠØ©';
  document.getElementById('edit-post-description').value = post.description || '';
  document.getElementById('edit-contact-method').value = post.contactMethod || 'whatsapp';
  document.getElementById('edit-whatsapp-number').value = post.whatsapp || '';
  document.getElementById('edit-telegram-username').value = post.telegram || '';
  changeContactMethod('edit');
  document.getElementById('edit-post-modal').style.display = 'block';
}

function closeEditPostModal() {
  document.getElementById('edit-post-modal').style.display = 'none';
}

async function savePostEdits() {
  const postId = document.getElementById('edit-post-id').value;
  if (!postId) return;
  
  // ğŸ”¥ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø§Ù„Ø£ØµÙØ§Ø±
  const price = document.getElementById('edit-post-price').value.trim();
  const cheapestPrice = document.getElementById('edit-post-cheapest-price').value.trim();
  const formattedPrice = formatPriceWithZeros(price);
  const formattedCheapestPrice = formatPriceWithZeros(cheapestPrice);
  
  const updatedData = {
    stage: document.getElementById('edit-post-stage').value.trim(),
    price: Number(formattedPrice) || 0,
    cheapestPrice: Number(formattedCheapestPrice) || 0,
    material: document.getElementById('edit-post-material').value,
    description: document.getElementById('edit-post-description').value.trim(),
    contactMethod: document.getElementById('edit-contact-method').value,
    whatsapp: formatWhatsApp(document.getElementById('edit-whatsapp-number').value),
    telegram: sanitizeTelegram(document.getElementById('edit-telegram-username').value),
  };
  
  if (!updatedData.description) return showNotification("Ø§Ù„ÙˆØµÙ Ù…Ø·Ù„ÙˆØ¨", "error");
  if (updatedData.contactMethod === "whatsapp" && updatedData.whatsapp.length !== 12) return showNotification("Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ ØºÙŠØ± ØµØ§Ù„Ø­", "error");
  if (updatedData.contactMethod === "telegram" && !updatedData.telegram) return showNotification("Ù…Ø¹Ø±Ù‘Ù ØªÙ„ÙƒØ±Ø§Ù… ØºÙŠØ± ØµØ§Ù„Ø­", "error");
  
  const btn = document.getElementById('post-edit-submit-btn');
  btn.disabled = true;
  
  try {
    await db.collection('posts').doc(postId).update(updatedData);
    
    // ØªØ­Ø¯ÙŠØ« cache
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª', 'success');
    closeEditPostModal();
    await loadPostsFromFirestore();
    if (pages.userPosts && pages.userPosts.style.display === 'block') { showUserPosts(); }
  } catch (e) {
    showNotification('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
  }
}

async function showUserPosts() {
  if (!currentUser) return showNotification("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "warning");
  showPage("userPosts");
  markPostsAsSeen();
  
  if (!userPostsContainer) return;
  userPostsContainer.innerHTML = "";
  const mine = posts.filter(p => p.userId === currentUser.uid).sort((a, b) => (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0));
  
  if (mine.length === 0) {
    userPostsContainer.innerHTML = '<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„Ùƒ</p></div>';
    return;
  }
  
  for (const post of mine) {
    const meta = await getUserMeta(post.userId);
    const div = document.createElement("div");
    div.className = `post ${post.status === 'sold' ? 'sold' : ''} ${post.status === 'deleted' ? 'deleted' : ''} ${post.isPinned ? 'pinned' : ''}`;
    
    let actions = '';
    if (post.userId === currentUser.uid) {
      actions = `
        <div class="post-actions">
          <button class="btn btn-xs" onclick="openEditPostModal('${post.id}')"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-warning btn-xs" onclick="markSold('${post.id}', ${post.status === 'sold'})">
            <i class="fas fa-tag"></i> ${post.status === 'sold' ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹' : 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹'}
          </button>
          <button class="btn btn-success btn-xs" onclick="repost('${post.id}')"><i class="fas fa-sync"></i> Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±</button>
          <button class="btn btn-danger btn-xs" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i> Ø­Ø°Ù</button>
        </div>
      `;
    }
    
    // ğŸ”¥ Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙ‡
    let userAvatarHtml = '';
    if (meta.avatarBase64) {
      userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
      const userAvatar = meta.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼';
      const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
      userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
    }
    
    div.innerHTML = `
      <div class="post-header">
        <div class="user-info">
          <div class="rank-avatar-container">
            ${userAvatarHtml}
          </div>
          <div class="user-details">
            <div class="user-name">
              ${escapeHTML(post.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}
              ${meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> Ù…ÙˆØ«Ù‘Ù‚</span>` : ''}
            </div>
            <div class="post-time">${formatRelativeTime(post.createdAt)}</div>
          </div>
        </div>
      </div>
      
      <div class="post-content">
        <div class="post-meta">
          <span class="post-stage">${stageLabel(post.stage)}</span>
          <span class="post-material">${escapeHTML(post.material || '')}</span>
          <span class="post-price">${priceLabelFromNumber(post.price)}</span>
        </div>
        
        <div class="post-description">
          ${escapeHTML(post.description || '')}
        </div>
      </div>
      
      ${actions}
    `;
    
    userPostsContainer.appendChild(div);
  }
}

function updatePostCountInProfile() {
  if (!currentUser) return;
  const count = posts.filter(p => p.userId === currentUser?.uid && p.status !== 'deleted').length;
  const el = document.getElementById("profile-count");
  if (el) el.textContent = `Ø¹Ø¯Ø¯ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ: ${count}`;
}

async function repost(postId) {
  const doc = await db.collection("posts").doc(postId).get();
  if (!doc.exists || doc.data().userId !== currentUser.uid) return;
  await db.collection("posts").doc(postId).update({
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'active'
  });
  
  // ØªØ­Ø¯ÙŠØ« cache
  const cacheKey = 'posts_cache';
  localStorage.removeItem(cacheKey);
  
  showNotification("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø´Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®", "success");
  await loadPostsFromFirestore();
  showUserPosts();
}

async function markSold(postId, isSold) {
  const doc = await db.collection("posts").doc(postId).get();
  if (!doc.exists || doc.data().userId !== currentUser.uid) return;
  await db.collection("posts").doc(postId).update({
    status: isSold ? 'active' : 'sold'
  });
  
  // ØªØ­Ø¯ÙŠØ« cache
  const cacheKey = 'posts_cache';
  localStorage.removeItem(cacheKey);
  
  showNotification(isSold ? "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙŠØ¹" : "ØªÙ… ØªØ­Ø¯ÙŠØ¯: ØªÙ… Ø¨ÙŠØ¹Ù‡", "success");
  await loadPostsFromFirestore();
  showUserPosts();
}

async function deletePost(postId) {
  if (!currentUser || !confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ")) return;
  
  try {
    const doc = await db.collection("posts").doc(postId).get();
    if (!doc.exists || doc.data().userId !== currentUser.uid) return showNotification("ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­", "error");
    
    try {
      await db.collection("posts").doc(postId).delete();
    } catch (delErr) {
      await db.collection("posts").doc(postId).update({ status: 'deleted' });
    }
    
    // ØªØ­Ø¯ÙŠØ« cache
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification("ØªÙ… Ø§Ù„Ø­Ø°Ù", "success");
    await loadPostsFromFirestore();
    await showUserPosts();
  } catch (err) {
    showNotification("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + (err.message || err), "error");
  }
}

// ===== ØªØ¹Ø¯ÙŠÙ„: Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø­Ø³Ù†Ø© =====
async function renderDetails(postId) {
  if (!detailsContainer) return;
  detailsContainer.innerHTML = "<div class='post'><p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p></div>";
  const post = posts.find(p => p.id === postId);
  if (!post) {
    detailsContainer.innerHTML = "<div class='post'><p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p></div>";
    return;
  }
  
  const meta = await getUserMeta(post.userId);
  const userDoc = await db.collection("users").doc(post.userId).get();
  const userData = userDoc.data();
  
  const card = document.createElement("div");
  card.className = `post ${post.isPinned ? 'pinned' : ''}`;
  
  // ğŸ”¥ Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  let userAvatarHtml = '';
  if (meta.avatarBase64) {
    userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    const userAvatar = meta.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼';
    const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
  }
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ø¨Ø§Ø¦Ø¹ (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ)
  const userCreatedAt = userData?.createdAt?.toDate ? userData.createdAt.toDate() : null;
  const userJoinTime = userCreatedAt ? formatRelativeTime(userCreatedAt) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  const lastSeen = userData?.lastSeen?.toDate ? formatRelativeTime(userData.lastSeen.toDate()) : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
  
  card.innerHTML = `
    ${post.isPinned ? '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> Ù…Ø«Ø¨Øª</div>' : ''}
    
    <!-- Ø±Ø£Ø³ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø¨Ø³Ø· -->
    <div class="post-header">
      <div class="user-info">
        <div class="rank-avatar-container">
          ${userAvatarHtml}
        </div>
        <div class="user-details">
          <div class="user-name">
            ${escapeHTML(post.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}
            ${meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> Ù…ÙˆØ«Ù‘Ù‚</span>` : ''}
          </div>
          <div class="post-time">${formatRelativeTime(post.createdAt)}</div>
        </div>
      </div>
    </div>
    
    <!-- ğŸ”¥ ØªØ¹Ø¯ÙŠÙ„: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙØµÙ„Ø© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ± -->
    <div class="details-info">
      <h3 style="margin-bottom: 15px; color: var(--primary-color); text-align: center;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙØµÙ„Ø©</h3>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ø¨Ø§Ø¦Ø¹:</span>
        <span class="detail-value">${escapeHTML(post.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ“š Ø§Ù„Ù…Ø±Ø­Ù„Ø©:</span>
        <span class="detail-value">${stageLabel(post.stage)}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ“– Ø§Ù„Ù…Ø§Ø¯Ø©:</span>
        <span class="detail-value">${escapeHTML(post.material || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</span>
        <span class="detail-value">${priceLabelFromNumber(post.price)}</span>
      </div>
      
      ${post.cheapestPrice > 0 ? `
      <div class="detail-item">
        <span class="detail-label">ğŸ·ï¸ Ø£Ø±Ø®Øµ Ø³Ø¹Ø± Ù„Ù„Ù…Ù„Ø²Ù…Ø©:</span>
        <span class="detail-value" style="color: var(--success-color); font-weight: 900;">${priceLabelFromNumber(post.cheapestPrice)}</span>
      </div>
      ` : ''}
      
      <div class="detail-item">
        <span class="detail-label">ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø±:</span>
        <span class="detail-value">${post.createdAt?.toLocaleString?.('ar-IQ') || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ‘€ Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± Ù„Ù„Ø¨Ø§Ø¦Ø¹:</span>
        <span class="detail-value">${lastSeen}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ“… Ø§Ù†Ø¶Ù… Ù…Ù†Ø°:</span>
        <span class="detail-value">${userJoinTime}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">ğŸ“ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„:</span>
        <span class="detail-value">
          ${post.contactMethod === "whatsapp" ? "ÙˆØ§ØªØ³Ø§Ø¨" : 
            post.contactMethod === "telegram" ? "ØªÙ„ÙŠØ¬Ø±Ø§Ù…" : 
            "Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª"}
        </span>
      </div>
    </div>
    
    <!-- ğŸ”¥ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙˆØ§Ù„Ø¥Ø¨Ù„Ø§Øº -->
  `;
  
  detailsContainer.innerHTML = '';
  detailsContainer.appendChild(card);
}

function openDetailsPage(postId) {
  currentDetailsPostId = postId;
  showPage("details");
  renderDetails(postId);
}

/* Ø¥Ø¨Ù„Ø§Øº + ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
async function reportPost(postId) {
  if (!currentUser) return showNotification('ÙŠÙ„Ø²Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'warning');
  const reason = prompt('Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº:');
  if (!reason) return;
  
  try {
    const post = posts.find(p => p.id === postId);
    
    const ownerQuery = await db.collection('users')
      .where('email', '==', APP_OWNER_EMAIL)
      .limit(1)
      .get();
    
    if (ownerQuery.empty) return;
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    
    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'admin_report',
      postId: postId,
      reporterUid: currentUser.uid,
      reporterName: currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…',
      reporterShortUid: currentUser.shortUid || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
      title: 'ğŸš¨ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯',
      message: `ğŸ‘¤ Ø§Ù„Ù…Ø¨Ù„Øº: ${currentUser.name || 'Ù…Ø³ØªØ®Ø¯Ù…'}\nğŸ“ Ø§Ù„Ø³Ø¨Ø¨: ${reason}\nğŸ†” Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø¨Ù„Øº: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
    if (!reportedPosts.includes(postId)) {
      reportedPosts.push(postId);
      localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts));
    }
    
    showNotification('ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ù…Ù†Ø´ÙˆØ± ÙˆØ³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡', 'success');
    
  } catch (e) {
    console.error('Report error:', e);
    showNotification('ØªØ¹Ø°Ù‘Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº', 'error');
  }
}

async function openCommentsPage(postId) {
  if (!currentUser) return;
  currentCommentsPostId = postId;
  showPage("comments");
  await renderComments(postId);
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
async function renderComments(postId) {
  const container = document.getElementById("comments-list-page");
  if (!container) return;
  container.innerHTML = '<div class="post"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</p></div>';
  
  try {
    const snap = await db.collection("posts").doc(postId).collection("comments").orderBy("createdAt", "asc").get();
    
    if (snap.empty) {
      container.innerHTML = '<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯.</p></div>';
      return;
    }
    
    const comments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    
    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    const userIds = [...new Set(comments.map(c => c.userId).filter(Boolean))];
    await Promise.all(userIds.map(async uid => {
      if (!userMetaCache[uid]) userMetaCache[uid] = await getUserMeta(uid);
    }));
    
    container.innerHTML = comments.map(comment => {
      const meta = userMetaCache[comment.userId] || { isVerified: false, avatar: 'male', avatarBase64: null };
      const time = comment.createdAt?.toDate ? formatRelativeTime(comment.createdAt.toDate()) : '';
      
      // Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
      let userAvatarHtml = '';
      if (meta.avatarBase64) {
        userAvatarHtml = `<img src="${meta.avatarBase64}" class="comment-avatar">`;
      } else {
        const userAvatar = meta.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼';
        const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
        userAvatarHtml = `<div class="comment-avatar" style="background:${avatarBackground}; display:flex; align-items:center; justify-content:center; font-size:16px;">${userAvatar}</div>`;
      }
      
      return `
        <div class="comment">
          <div class="comment-header">
            ${userAvatarHtml}
            <div>
              <div class="comment-user">
                ${escapeHTML(comment.userName || 'Ù…Ø³ØªØ®Ø¯Ù…')}
                ${meta.isVerified ? `<span class="badge-verified" style="padding: 2px 6px; font-size: 10px;"><i class="fa-solid fa-crown"></i></span>` : ''}
              </div>
              <div class="comment-time">${time}</div>
            </div>
          </div>
          <div class="comment-content">${escapeHTML(comment.text || '')}</div>
          <div class="comment-actions">
            <button class="comment-action" onclick="replyToComment('${comment.userId}', '${comment.userName}')">
              <i class="fas fa-reply"></i> Ø±Ø¯
            </button>
            ${comment.userId === currentUser.uid ? `
            <button class="comment-action" onclick="deleteComment('${comment.id}', '${postId}')">
              <i class="fas fa-trash"></i> Ø­Ø°Ù
            </button>
            ` : ''}
            ${isOwner() || (currentUser && currentUser.uid === posts.find(p => p.id === postId)?.userId) ? `
            <button class="comment-action" onclick="banCommentUser('${comment.userId}', '${postId}')">
              <i class="fas fa-ban"></i> Ø­Ø¸Ø±
            </button>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');
    
  } catch (e) {
    console.error('Error loading comments:', e);
    container.innerHTML = '<div class="post"><p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª.</p></div>';
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…Ø­Ø³Ù†Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ù…Ø¹ ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø¹Ø¯Ø¯
async function addCommentFromPage() {
  if (!currentUser || !currentCommentsPostId) return;
  const textInput = document.getElementById("comment-text-page");
  const text = textInput.value.trim();
  if (!text) return;
  
  const btn = document.getElementById('send-comment-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  
  try {
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    await db.collection("posts").doc(currentCommentsPostId).collection("comments").add({
      text, 
      userId: currentUser.uid, 
      userName: currentUser.name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø´ÙƒÙ„ ÙÙˆØ±ÙŠ
    const postRef = db.collection("posts").doc(currentCommentsPostId);
    const postDoc = await postRef.get();
    const currentCount = postDoc.data().commentsCount || 0;
    await postRef.update({
      commentsCount: currentCount + 1
    });
    
    // ğŸ”¥ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
    const postIndex = posts.findIndex(p => p.id === currentCommentsPostId);
    if (postIndex !== -1) {
      posts[postIndex].commentsCount = currentCount + 1;
    }
    
    // ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
    const post = posts.find(p => p.id === currentCommentsPostId);
    if (post && post.userId !== currentUser.uid) {
      await db.collection('inbox').add({
        userId: post.userId,
        type: 'comment_notification',
        title: 'ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯',
        message: `ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ùƒ Ù…Ù† ${currentUser.name}: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`,
        postId: currentCommentsPostId,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    // ğŸ”¥ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    await sendCommentReplyNotifications(currentCommentsPostId, text, currentUser.name);
    
    textInput.value = '';
    await renderComments(currentCommentsPostId);
    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 'success');
    
  } catch (e) {
    console.error('Error adding comment:', e);
    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­', 'success'); // ğŸ”¥ ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù†Ø¬Ø§Ø­
    textInput.value = '';
    await renderComments(currentCommentsPostId);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Ø¥Ø±Ø³Ø§Ù„';
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
async function sendCommentReplyNotifications(postId, commentText, commenterName) {
  try {
    // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø´ÙˆØ±
    const commentsSnap = await db.collection("posts").doc(postId).collection("comments").get();
    const mentionedUsers = new Set();
    
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø°ÙƒÙˆØ±ÙŠÙ† ÙÙŠ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    commentsSnap.forEach(doc => {
      const comment = doc.data();
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
      if (comment.userName && commentText.includes(`@${comment.userName}`) && comment.userId !== currentUser.uid) {
        mentionedUsers.add(comment.userId);
      }
    });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…Ø°ÙƒÙˆØ±ÙŠÙ†
    for (const userId of mentionedUsers) {
      await db.collection('inbox').add({
        userId: userId,
        type: 'comment_reply',
        title: 'ğŸ’¬ Ø±Ø¯ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚Ùƒ',
        message: `Ù‚Ø§Ù… ${commenterName} Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ØªØ¹Ù„ÙŠÙ‚Ùƒ: ${commentText.substring(0, 50)}${commentText.length > 50 ? '...' : ''}`,
        postId: postId,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
  } catch (error) {
    console.error('Error sending comment reply notifications:', error);
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
function replyToComment(userId, userName) {
  const textInput = document.getElementById("comment-text-page");
  textInput.value = `@${userName} `;
  textInput.focus();
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
async function deleteComment(commentId, postId) {
  if (!currentUser) return;
  
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ØŸ')) return;
  
  try {
    await db.collection("posts").doc(postId).collection("comments").doc(commentId).delete();
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    const postRef = db.collection("posts").doc(postId);
    const postDoc = await postRef.get();
    const currentCount = postDoc.data().commentsCount || 0;
    if (currentCount > 0) {
      await postRef.update({
        commentsCount: currentCount - 1
      });
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø§Ù„Ù…Ø­Ù„ÙŠ
    const postIndex = posts.findIndex(p => p.id === postId);
    if (postIndex !== -1 && posts[postIndex].commentsCount > 0) {
      posts[postIndex].commentsCount--;
    }
    
    showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 'success');
    await renderComments(postId);
    
  } catch (error) {
    console.error('Error deleting comment:', error);
    showNotification('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚', 'error');
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø­Ø¸Ø± Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
async function banCommentUser(userId, postId) {
  if (!currentUser) return;
  
  const post = posts.find(p => p.id === postId);
  if (!post || (post.userId !== currentUser.uid && !isOwner())) {
    return showNotification('ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­', 'error');
  }
  
  if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒØŸ')) return;
  
  try {
    // Ø­ÙØ¸ Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„Ø­Ø¸Ø±
    await db.collection('userBlocks').add({
      blockerId: currentUser.uid,
      blockedUserId: userId,
      postId: postId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ', 'success');
    
  } catch (error) {
    console.error('Error banning user:', error);
    showNotification('ÙØ´Ù„ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'error');
  }
}

/* Owner actions */
async function ownerTogglePin(postId, isPinned) {
  if (!isOwner()) return;
  try {
    await db.collection('posts').doc(postId).update({ isPinned: !isPinned });
    
    // ØªØ­Ø¯ÙŠØ« cache
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification(isPinned ? 'Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªØ«Ø¨ÙŠØª' : 'ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª', 'success');
    await loadPostsFromFirestore();
  } catch (e) {
    showNotification('ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
  }
}

async function ownerToggleVerify(uid) {
  if (!isOwner()) return;
  try {
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.isVerified;
    await uref.update({ isVerified: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid] || {}), isVerified: !cur };
    showNotification(!cur ? 'ØªÙ… ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…' : 'Ø£ÙÙ„ØºÙŠ Ø§Ù„ØªÙˆØ«ÙŠÙ‚', 'success');
    await renderPosts();
  } catch (e) {
    showNotification('ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
  }
}

async function ownerToggleUserBanById(uid) {
  if (!isOwner()) return;
  try {
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.blockedFromPosting;
    await uref.update({ blockedFromPosting: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid] || {}), blockedFromPosting: !cur };
    showNotification(!cur ? 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù†Ø´Ø±' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±', 'success');
  } catch (e) {
    showNotification('ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©', 'error');
  }
}

async function ownerDeletePost(postId) {
  if (!isOwner()) return;
  if (!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return;
  try {
    await db.collection('posts').doc(postId).delete();
    
    // ØªØ­Ø¯ÙŠØ« cache
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification('Ø­ÙØ°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±', 'success');
    await loadPostsFromFirestore();
  } catch (e) {
    showNotification('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
  }
}

/* =========================
   Companies
========================= */
const GOVERNORATES = ["Ø¨ØºØ¯Ø§Ø¯", "Ù†ÙŠÙ†ÙˆÙ‰", "Ø§Ù„Ø¨ØµØ±Ø©", "Ø£Ø±Ø¨ÙŠÙ„", "Ø§Ù„Ù†Ø¬Ù", "ÙƒØ±Ø¨Ù„Ø§Ø¡", "Ø°ÙŠ Ù‚Ø§Ø±", "Ø§Ù„Ø³Ù„ÙŠÙ…Ø§Ù†ÙŠØ©", "Ø¯ÙŠØ§Ù„Ù‰", "Ø§Ù„Ø£Ù†Ø¨Ø§Ø±", "Ø¨Ø§Ø¨Ù„", "ÙƒØ±ÙƒÙˆÙƒ", "ÙˆØ§Ø³Ø·", "Ø§Ù„Ù…Ø«Ù†Ù‰", "Ø§Ù„Ù‚Ø§Ø¯Ø³ÙŠØ©", "Ù…ÙŠØ³Ø§Ù†", "ØµÙ„Ø§Ø­ Ø§Ù„Ø¯ÙŠÙ†", "Ø¯Ù‡ÙˆÙƒ", "ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª"];

function populateGovernorateSelects(selectId) {
  const select = document.getElementById(selectId);
  if (!select?.dataset?.populated) {
    select.innerHTML = GOVERNORATES.map(g => `<option value="${g}">${g}</option>`).join('');
    if (select) select.dataset.populated = "true";
  }
}

function openCreateCompanyModal() {
  if (!isOwner()) return showNotification('Ù„Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·', 'error');
  populateGovernorateSelects('company-from');
  populateGovernorateSelects('company-to');
  document.getElementById('create-company-modal').style.display = 'block';
}

function closeCreateCompanyModal() {
  document.getElementById('create-company-modal').style.display = 'none';
}

async function createCompany() {
  if (!isOwner()) return;
  const data = {
    name: document.getElementById('company-name').value.trim(),
    from: document.getElementById('company-from').value,
    to: document.getElementById('company-to').value,
    phone: document.getElementById('company-phone').value.trim(),
    desc: document.getElementById('company-desc').value.trim(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  if (!data.name || !data.phone || !data.from || !data.to) {
    return showNotification("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©", "error");
  }
  
  const btn = document.getElementById('company-submit-btn');
  btn.disabled = true;
  
  try {
    await db.collection('companies').add(data);
    showNotification("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©", "success");
    closeCreateCompanyModal();
    await loadCompanies();
  } catch (e) {
    showNotification("ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ©: " + e.message, "error");
  } finally {
    btn.disabled = false;
  }
}

async function loadCompanies() {
  try {
    const snap = await db.collection('companies').orderBy('createdAt', 'desc').get();
    companies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCompanies();
  } catch (e) {
    if (companiesContainer) {
      companiesContainer.innerHTML = '<div class="post"><p>Ø®Ø·Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±ÙƒØ§Øª</p></div>';
    }
  }
}

function renderCompanies() {
  if (!companiesContainer) return;
  if (!companies || companies.length === 0) {
    companiesContainer.innerHTML = '<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ø¨Ø¹Ø¯</p></div>';
    return;
  }
  
  companiesContainer.innerHTML = companies.map(c => `
    <div class="company">
      <div class="name"><i class="fa-solid fa-truck"></i> ${escapeHTML(c.name || 'Ø´Ø±ÙƒØ©')}</div>
      <div class="route">Ù…Ù†: ${escapeHTML(c.from || '-')} â†’ Ø¥Ù„Ù‰: ${escapeHTML(c.to || '-')}</div>
      <div class="phone"><i class="fa-solid fa-phone"></i> ${escapeHTML(c.phone || '')}</div>
      ${c.desc ? `<div class="desc">${escapeHTML(c.desc)}</div>` : ''}
      ${isOwner() ? `<div class="post-actions" style="margin-top:8px">
        <button class="btn btn-danger btn-xs" onclick="deleteCompany('${c.id}')"><i class="fa-solid fa-trash"></i> Ø­Ø°Ù</button>
      </div>` : ''}
    </div>
  `).join('');
}

async function deleteCompany(id) {
  if (!isOwner()) return;
  if (!confirm('Ø­Ø°Ù Ø§Ù„Ø´Ø±ÙƒØ©ØŸ')) return;
  try {
    await db.collection('companies').doc(id).delete();
    showNotification('Ø­ÙØ°ÙØª Ø§Ù„Ø´Ø±ÙƒØ©', 'success');
    await loadCompanies();
  } catch (e) {
    showNotification('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù', 'error');
  }
}

/* =========================
   Profile small actions
========================= */
async function setAvatar(kind) {
  if (!currentUser) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ 
      avatar: kind,
      avatarBase64: null // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
    });
    currentUser.avatar = kind;
    currentUser.avatarBase64 = null;
    updateAvatarDisplay();
    showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©', 'success');
    closeAvatarModal();
  } catch {
    showNotification('ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©', 'error');
  }
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
function renderAvatarPreview() {
  const previewElement = document.getElementById('current-avatar-preview');
  if (!previewElement) return;
  
  if (currentUser && currentUser.avatarBase64) {
    previewElement.innerHTML = `<img src="${currentUser.avatarBase64}" class="rank-avatar" style="width:80px;height:80px;">`;
  } else {
    const emoji = currentUser?.avatar === 'female' ? 'ğŸ‘©ğŸ»â€ğŸ’¼' : 'ğŸ‘¨ğŸ»â€ğŸ’¼';
    const bg = currentUser?.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    previewElement.innerHTML = `<div style="width:80px;height:80px;border-radius:50%;background:${bg};display:grid;place-items:center;font-size:32px;">${emoji}</div>`;
  }
}

async function editProfileName() {
  if (!currentUser) return;
  const newName = prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:', currentUser.name || '');
  if (!newName) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ name: newName });
    currentUser.name = newName;
    document.getElementById('profile-name').textContent = newName;
    showNotification('ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…', 'success');
  } catch {
    showNotification('ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…', 'error');
  }
}

/* =========================
   Inbox - Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø©
========================= */
async function showInbox() {
  if (!currentUser) return showNotification('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'warning');
  showPage('inbox');
  await markAllNotificationsAsRead();
  
  if (!inboxContainer) return;
  inboxContainer.innerHTML = '<div class="post"><p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</p></div>';
  
  try {
    let messages = [];
    
    if (isOwner()) {
      // Ù„Ù„Ù…Ø§Ù„Ùƒ: Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„ÙÙ‡Ø±Ø³
      const allMessages = await db.collection('inbox').get();
      messages = allMessages.docs
        .filter(doc => doc.data().type === 'admin_report' || doc.data().type === 'support_request')
        .sort((a, b) => (b.data().createdAt?.toDate?.() || 0) - (a.data().createdAt?.toDate?.() || 0));
    } else {
      // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: Ø¬Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„Ù‡ ÙÙ‚Ø·
      const userMessages = await db.collection('inbox').get();
      messages = userMessages.docs
        .filter(doc => doc.data().userId === currentUser.uid)
        .sort((a, b) => (b.data().createdAt?.toDate?.() || 0) - (a.data().createdAt?.toDate?.() || 0));
    }
    
    if (messages.length === 0) {
      inboxContainer.innerHTML = '<div class="post"><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.</p></div>';
      return;
    }
    
    inboxContainer.innerHTML = messages.map(doc => {
      const msg = doc.data();
      const created = msg.createdAt?.toDate ? formatRelativeTime(msg.createdAt.toDate()) : '';
      
      if (isOwner() && (msg.type === 'admin_report' || msg.type === 'support_request')) {
        if (msg.status === 'resolved') {
          return `
            <div class="post" style="opacity:0.7; background:#f8f9fa;">
              <div style="font-weight:bold;color:#0f235f">ğŸ“© ${msg.type === 'support_request' ? 'Ø·Ù„Ø¨ Ø¯Ø¹Ù…' : 'Ø¨Ù„Ø§Øº'} - ${msg.actionMessage || 'ØªÙ… Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'}</div>
              <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
              <div style="color:#28a745; font-weight:bold; margin-top:8px;">
                âœ… ${msg.actionMessage || 'ØªÙ…Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'}
              </div>
              <small style="color:#777">${created}</small>
            </div>`;
        }
        
        // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© Ø¹Ø±Ø¶ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø© (Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­)
        const typeText = msg.supportType === 'problem' ? 'Ù…Ø´ÙƒÙ„Ø©' : msg.supportType === 'suggestion' ? 'Ø§Ù‚ØªØ±Ø§Ø­' : 'Ø·Ù„Ø¨ Ø¯Ø¹Ù…';
        const typeIcon = msg.supportType === 'problem' ? 'ğŸš¨' : msg.supportType === 'suggestion' ? 'ğŸ’¡' : 'ğŸ“©';
        
        return `
          <div class="post">
            <div style="font-weight:bold;color:#0f235f">${typeIcon} ${typeText}</div>
            <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
            ${msg.type === 'admin_report' ? `
            <div class="post-actions">
              <button class="btn btn-danger btn-xs" onclick="adminReportAction('${doc.id}','ban_poster','${escapeHTML(msg.reporterUid || '')}')">
                <i class="fa-solid fa-ban"></i> Ø­Ø¸Ø± Ø§Ù„Ù…ÙØ¨Ù„Ù‘Øº
              </button>
              <button class="btn btn-secondary btn-xs" onclick="adminReportAction('${doc.id}','delete_post','${escapeHTML(msg.postId || '')}')">
                <i class="fa-solid fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±
              </button>
              <button class="btn btn-xs" onclick="adminReportAction('${doc.id}','reject','')">
                <i class="fa-solid fa-x"></i> Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº
              </button>
            </div>
            ` : ''}
            <small style="color:#777">${created}</small>
          </div>`;
      }
      
      // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      return `
        <div class="post">
          <div style="font-weight:bold;color:#0f235f">${escapeHTML(msg.title || 'Ø¥Ø´Ø¹Ø§Ø±')}</div>
          <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
          <small style="color:#777">${created}</small>
        </div>`;
    }).join('');
    
  } catch (error) {
    console.error('Error loading inbox:', error);
    inboxContainer.innerHTML = '<div class="post"><p>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p></div>';
  }
}

async function adminReportAction(inboxDocId, action, targetId) {
  if (!isOwner()) return;
  
  try {
    let actionMessage = '';

    if (action === 'ban_poster' && targetId) {
      await db.collection('users').doc(targetId).update({
        blockedFromPosting: true
      });
      actionMessage = 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…ÙØ¨Ù„Ù‘Øº';
    } else if (action === 'delete_post' && targetId) {
      try {
        await db.collection('posts').doc(targetId).delete();
      } catch (deleteError) {
        await db.collection('posts').doc(targetId).update({
          status: 'deleted'
        });
      }
      actionMessage = 'ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±';
    } else if (action === 'reject') {
      actionMessage = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¨Ù„Ø§Øº';
    }

    await db.collection('inbox').doc(inboxDocId).update({
      status: 'resolved',
      resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
      resolvedBy: currentUser.uid,
      actionMessage: actionMessage
    });

    showNotification('ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­', 'success');
    setTimeout(() => { showInbox(); }, 2000);

  } catch (e) {
    console.error('ÙØ´Ù„ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:', e);
    showNotification('ÙØ´Ù„ ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡: ' + e.message, 'error');
  }
}

/* =========================
   Modals helpers
========================= */
function closeModal() {
  document.querySelectorAll('.modal').forEach(m => {
    if (m.style.display === 'block') m.style.display = 'none';
  });
}

document.addEventListener('click', function (e) {
  document.querySelectorAll('.modal').forEach(modal => {
    if (e.target === modal) modal.style.display = 'none';
  });
});

/* =========================
   Broadcast
========================= */
async function fetchLatestBroadcast() {
  if (isFirstLoginSession) return;
  try {
    const seenBroadcasts = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    const userSignupTime = localStorage.getItem('userSignupTime');
    const snap = await db.collection('broadcasts').orderBy('createdAt', 'desc').limit(1).get();
    if (snap.empty) return;
    const broadcast = snap.docs[0];
    const id = broadcast.id;
    const data = broadcast.data();
    const time = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
    if (!seenBroadcasts.includes(id) && (!userSignupTime || new Date(userSignupTime) < time)) {
      document.getElementById('broadcast-title-display').textContent = data.title || 'Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…';
      document.getElementById('broadcast-text-display').textContent = data.message || data.text || '';
      document.getElementById('broadcast-banner').classList.add('show');
      document.getElementById('broadcast-overlay').classList.add('show');
      lastBroadcast = id;
    }
  } catch (e) { console.error("fetchLatestBroadcast", e); }
}

function dismissBroadcast() {
  document.getElementById('broadcast-banner').classList.remove('show');
  document.getElementById('broadcast-overlay').classList.remove('show');
  if (lastBroadcast) {
    const seen = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    if (!seen.includes(lastBroadcast)) {
      seen.push(lastBroadcast);
      localStorage.setItem('seenBroadcasts', JSON.stringify(seen));
    }
  }
}

/* =========================
   Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†
========================= */
function getLastSeenPostsTime() {
  const lastSeen = localStorage.getItem('lastSeenPostsTime');
  const time = lastSeen ? new Date(parseInt(lastSeen)) : new Date(0);
  return time;
}

function updateLastSeenPostsTime() {
  const now = Date.now();
  localStorage.setItem('lastSeenPostsTime', now.toString());
  unreadPostsCount = 0;
  updateNavBadges();
}

function startAllListeners() {
  startInboxListener();
  startPostsListener();
  startCommentsListener();
}

function startInboxListener() {
  if (!currentUser) return;
  if (notificationsListener) {
    notificationsListener();
  }
  
  // Ù…Ø³ØªÙ…Ø¹ Ø¨Ø³ÙŠØ· Ø¨Ø¯ÙˆÙ† ÙÙ„ØªØ± Ù…Ø¹Ù‚Ø¯
  notificationsListener = db.collection('inbox').onSnapshot(async (snapshot) => {
    let unreadCount = 0;
    const now = Date.now();
    
    snapshot.forEach(doc => {
      const msg = doc.data();
      // ÙÙ‚Ø· Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
      const msgTime = msg.createdAt?.toDate?.()?.getTime() || 0;
      const isRecent = (now - msgTime) < (7 * 24 * 60 * 60 * 1000);
      
      if (msg.status === 'unread' && isRecent) {
        if (isOwner() && (msg.type === 'admin_report' || msg.type === 'support_request')) {
          unreadCount++;
        } else if (!isOwner() && msg.userId === currentUser.uid) {
          unreadCount++;
        }
      }
    });
    
    unreadNotifications.inbox = unreadCount;
    updateAllBadges();
  }, (error) => {
    console.error('Notifications listener error:', error);
  });
}

function startPostsListener() {
  if (postsListener) postsListener();
  
  const lastSeenTime = getLastSeenPostsTime();
  
  postsListener = db.collection("posts")
    .where("createdAt", ">=", lastSeenTime)
    .onSnapshot((snapshot) => {
      let newCount = 0;
      
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const postTime = change.doc.data().createdAt?.toDate?.();
          if (postTime && postTime > lastSeenTime) {
            newCount++;
          }
        }
      });
      
      if (newCount > 0) {
        unreadPostsCount = newCount;
        updateNavBadges();
      }
    }, (error) => {
      console.error("Posts listener error:", error);
    });
}

function startCommentsListener() {
  if (!currentUser || commentsListener) return;
  
  commentsListener = db.collection('inbox')
    .where('userId', '==', currentUser.uid)
    .where('type', '==', 'comment_notification')
    .onSnapshot((snapshot) => {
      let unreadComments = 0;
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        if (msg.status === 'unread') {
          unreadComments++;
        }
      });
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±
      unreadNotifications.inbox = Math.max(unreadNotifications.inbox, unreadComments);
      updateAllBadges();
    }, (error) => {
      console.error('Comments listener error:', error);
    });
}

function stopAllListeners() {
  if (notificationsListener) {
    notificationsListener();
    notificationsListener = null;
  }
  if (postsListener) {
    postsListener();
    postsListener = null;
  }
  if (commentsListener) {
    commentsListener();
    commentsListener = null;
  }
}

function updateAllBadges() {
  updateNavBadges();
}

function updateNavBadges() {
  // ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª - ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ù†Ø´ÙˆØ±Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
  const postsBadge = document.getElementById('posts-badge');
  if (postsBadge) {
    if (unreadPostsCount > 0) {
      postsBadge.style.display = 'flex';
      postsBadge.textContent = unreadPostsCount > 9 ? '9+' : unreadPostsCount.toString();
    } else {
      postsBadge.style.display = 'none';
    }
  }
  
  // ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯ - ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø©
  const inboxBadge = document.getElementById('inbox-badge');
  if (inboxBadge) {
    if (unreadNotifications.inbox > 0) {
      inboxBadge.style.display = 'flex';
      inboxBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
    } else {
      inboxBadge.style.display = 'none';
    }
  }
  
  // ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ (ØªØ¬Ù…Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯ ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰)
  const profileBadge = document.getElementById('profile-notification-badge');
  if (profileBadge) {
    const totalProfileNotifications = unreadNotifications.inbox;
    if (totalProfileNotifications > 0) {
      profileBadge.style.display = 'flex';
      profileBadge.textContent = totalProfileNotifications > 9 ? '9+' : totalProfileNotifications.toString();
    } else {
      profileBadge.style.display = 'none';
    }
  }
}

async function markAllNotificationsAsRead() {
  if (!currentUser) return;
  try {
    let query;
    if (isOwner()) {
      // Ù„Ù„Ù…Ø§Ù„Ùƒ: ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¨Ù„Ø§ØºØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
      const allMessages = await db.collection('inbox').get();
      const batch = db.batch();
      let updatedCount = 0;
      
      allMessages.forEach(doc => {
        const msg = doc.data();
        if (msg.status === 'unread' && (msg.type === 'admin_report' || msg.type === 'support_request')) {
          batch.update(doc.ref, { status: 'read' });
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
        unreadNotifications.inbox = 0;
        updateAllBadges();
        showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ ${updatedCount} Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡`, 'success');
      }
    } else {
      // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ: ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ø¦Ù„Ù‡ ØºÙŠØ± Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡Ø©
      const userMessages = await db.collection('inbox').get();
      const batch = db.batch();
      let updatedCount = 0;
      
      userMessages.forEach(doc => {
        const msg = doc.data();
        if (msg.status === 'unread' && msg.userId === currentUser.uid) {
          batch.update(doc.ref, { status: 'read' });
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
        unreadNotifications.inbox = 0;
        updateAllBadges();
        showNotification(`ØªÙ… ØªØ­Ø¯ÙŠØ¯ ${updatedCount} Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡`, 'success');
      }
    }
  } catch (error) {
    console.error('Error marking notifications as read:', error);
  }
}

function markPostsAsSeen() {
  // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø§ ØªÙ…Ø³Ø­ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§ØªØŒ ÙÙ‚Ø· ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©
  updateLastSeenPostsTime();
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø³Ø­ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙŠØ¯ÙˆÙŠØ§Ù‹
function clearPostsBadge() {
  unreadPostsCount = 0;
  updateLastSeenPostsTime();
  updateAllBadges();
}

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù…Ø³Ø­ ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„ÙˆØ§Ø±Ø¯ ÙŠØ¯ÙˆÙŠØ§Ù‹
function clearInboxBadge() {
  unreadNotifications.inbox = 0;
  updateAllBadges();
}

/* =========================
   Ù†Ø¸Ø§Ù… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
========================= */
function openForgotPasswordModal() {
  document.getElementById('forgot-password-modal').style.display = 'block';
}

function closeForgotPasswordModal() {
  document.getElementById('forgot-password-modal').style.display = 'none';
}

async function handleForgotPassword() {
  const email = document.getElementById('forgot-email').value.trim();
  const btn = document.getElementById('forgot-submit-btn');
  
  if (!email) {
    return showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'error');
  }
  
  if (!validateEmail(email)) {
    return showNotification('ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 'error');
  }
  
  btn.disabled = true;
  btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  
  try {
    await auth.sendPasswordResetEmail(email);
    showNotification('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'success');
    setTimeout(() => { closeForgotPasswordModal(); }, 3000);
  } catch (error) {
    console.error('Password reset error:', error);
    let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©';
    switch (error.code) {
      case 'auth/user-not-found':
        errorMessage = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…';
        break;
      case 'auth/invalid-email':
        errorMessage = 'ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
        break;
      case 'auth/too-many-requests':
        errorMessage = 'Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹';
        break;
    }
    showNotification(errorMessage, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©';
  }
}

/* =========================
   ğŸ”¥ Ø¥ØµÙ„Ø§Ø­ Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ« - Ù…Ø¹ Ù…Ø³Ø­ Ø§Ù„ÙÙ‚Ø§Ø¹Ø§Øª
========================= */
function initializePullToRefresh() {
  let startY;
  let isAtTop = false;
  const pullIndicator = document.getElementById("pull-bubble");
  
  if (!pullIndicator) return;
  
  document.addEventListener('touchstart', e => {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    isAtTop = (window.scrollY === 0);
    
    if (isAtTop) {
      startY = e.touches[0].pageY;
    }
  });
  
  document.addEventListener('touchmove', e => {
    if (!startY || !isAtTop) return;
    
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    const currentY = e.touches[0].pageY;
    const diff = currentY - startY;
    
    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø³Ø­Ø¨ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ Ù†ÙƒÙˆÙ† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    if (diff > 0 && window.scrollY === 0) {
      e.preventDefault();
      
      if (currentPage === 'main-page') {
        pullIndicator.style.display = 'block';
        pullIndicator.style.opacity = Math.min(1, diff / 100);
      }
    }
  });
  
  document.addEventListener('touchend', e => {
    if (!startY || !isAtTop) return;
    
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    const currentY = e.changedTouches[0].pageY;
    const diff = currentY - startY;
    
    // Ø§Ù„ØªÙ†Ø´ÙŠØ· ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙƒØ§ÙÙŠ ÙˆÙ†Ø­Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
    if (diff > 100 && window.scrollY === 0) {
      if (currentPage === 'main-page') {
        pullIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
        
        setTimeout(() => {
          loadPostsFromFirestore().then(() => {
            pullIndicator.style.display = 'none';
            clearPostsBadge(); // ğŸ”¥ Ù…Ø³Ø­ Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            showNotification("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª", "success");
          }).catch(error => {
            pullIndicator.style.display = 'none';
            showNotification("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«", "error");
          });
        }, 1000);
      }
    } else {
      pullIndicator.style.display = 'none';
    }
    
    startY = null;
    isAtTop = false;
  });
  
  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¥Ø°Ø§ ØªÙ… Ø§Ù„ØªÙ…Ø±ÙŠØ±
  window.addEventListener('scroll', () => {
    if (window.scrollY > 10) {
      pullIndicator.style.display = 'none';
    }
  });
}

/* =========================
   ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
========================= */
console.log('âœ… ØªØ·Ø¨ÙŠÙ‚ Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù…Ø­Ù…Ù„ ÙˆØ¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');

// ğŸ”¥ ÙØ­Øµ Ø§ØªØµØ§Ù„ Firebase
async function checkFirebaseConnection() {
  try {
    console.log("ğŸ” ÙØ­Øµ Ø§ØªØµØ§Ù„ Firebase...");
    
    // Ø·Ø±ÙŠÙ‚Ø© Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹ Ù„ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„
    await db.collection('users').limit(1).get();
    console.log("âœ… Firebase connected successfully");
    return true;
    
  } catch (error) {
    console.error("âŒ Firebase connection failed:", error);
    return false;
  }
}

// ğŸ”¥ ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± DOM
function initializeDOMElements() {
  postsContainer = document.getElementById("posts-container");
  companiesContainer = document.getElementById("companies-container");
  userPostsContainer = document.getElementById("user-posts-container");
  detailsContainer = document.getElementById("details-container");
  commentsList = document.getElementById("comments-list-page");
  inboxContainer = document.getElementById("inbox-container");
  createBtn = document.getElementById("create-btn");
  createBtnLabel = document.getElementById("create-btn-label");
  filterBox = document.getElementById("filter-container");
  pillPosts = document.getElementById("pill-posts");
  pillCompanies = document.getElementById("pill-companies");
  
  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±
  if (!postsContainer) console.error("postsContainer not found");
  if (!companiesContainer) console.error("companiesContainer not found");
  if (!userPostsContainer) console.error("userPostsContainer not found");
  if (!detailsContainer) console.error("detailsContainer not found");
  if (!commentsList) console.error("commentsList not found");
  if (!inboxContainer) console.error("inboxContainer not found");
}

// ğŸ”¥ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
function initializeApp() {
  console.log('âœ… Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© ØªØ·Ø¨ÙŠÙ‚ Ø³ÙˆÙ‚ Ø§Ù„Ø·Ù„Ø§Ø¨...');
  
  try {
    // ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø§ØµØ± DOM
    initializeDOMElements();
    
    // ğŸ”¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸
    loadTheme();
    
    // ğŸ”¥ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
    initializeImageUpload();
    
    // ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    initializePullToRefresh();
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø§Øª
    initializePages();
    
    // ğŸ”¥ Ø¥Ø¶Ø§ÙØ© event listeners Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±
    const priceInput = document.getElementById('post-price');
    if (priceInput) {
      priceInput.addEventListener('blur', function() {
        if (this.value && this.value !== '0') {
          this.value = formatPriceWithZeros(this.value);
        }
      });
    }
    
    const cheapestPriceInput = document.getElementById('post-cheapest-price');
    if (cheapestPriceInput) {
      cheapestPriceInput.addEventListener('blur', function() {
        if (this.value && this.value !== '0') {
          this.value = formatPriceWithZeros(this.value);
        }
      });
    }
    
    console.log('âœ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙƒØªÙ…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­');
    
  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚', 'error');
  }
}

// ğŸ”¥ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸš€ DOM Ù…Ø­Ù…Ù„ - Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
  setTimeout(() => {
    try {
      initializeApp();
      // ÙØ­Øµ Ø§ØªØµØ§Ù„ Firebase Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
      setTimeout(() => {
        checkFirebaseConnection().then(connected => {
          if (!connected) {
            console.warn('âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§ØªØµØ§Ù„ Firebase Ø¶Ø¹ÙŠÙ');
          }
        });
      }, 2000);
    } catch (error) {
      console.error('âŒ Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
      const loadingText = document.getElementById('loading-text');
      if (loadingText) {
        loadingText.innerHTML = 'Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚<br><small>Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹</small>';
        loadingText.style.color = '#ff6b6b';
      }
    }
  }, 100);
});

    // ØªØ³Ø¬ÙŠÙ„ Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(() => console.log('Service Worker registered'))
            .catch(err => console.log('Error:', err));
    }
</script>
</body>
</html>
