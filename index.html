<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>سوق الطلاب</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@500;700;900&display=swap" rel="stylesheet">
  <link rel="manifest" href="manifest.json">
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <meta name="theme-color" content="#0000ff">

  <style>
    :root{
      --primary-color:#4a6bff;--secondary-color:#f8f9fa;--accent-color:#ff6b6b;
      --text-color:#222;--light-text:#6c757d;--border-color:#dee2e6;
      --success-color:#28a745;--warning-color:#ffc107;--danger-color:#dc3545;
      --sky:#e9f0ff;
      --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-secondary: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
      --gradient-success: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-warning: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    [data-theme="dark"] {
      --primary-color: #6c8eff;
      --secondary-color: #1a1a1a;
      --accent-color: #ff6b6b;
      --text-color: #ffffff;
      --light-text: #a0a0a0;
      --border-color: #333333;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --sky: #2a2a2a;
      --gradient-primary: linear-gradient(135deg, #4a6bff 0%, #6a11cb 100%);
      --gradient-secondary: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:'Tajawal','Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    html,body{height:100%}
    body{background:#f5f5f5;color:var(--text-color);overscroll-behavior-y:contain;-webkit-text-size-adjust:100%;touch-action:manipulation}
    .container{max-width:100%;min-height:100vh;background:#fff;padding-bottom:70px}

    [data-theme="dark"] body,
    [data-theme="dark"] .container {
      background: #121212;
      color: #ffffff;
    }

    [data-theme="dark"] .post,
    [data-theme="dark"] .company,
    [data-theme="dark"] .modal-content,
    [data-theme="dark"] .header,
    [data-theme="dark"] .bottom-nav {
      background: #1e1e1e;
      color: #ffffff;
      border-color: #333;
    }

    [data-theme="dark"] .form-control,
    [data-theme="dark"] .select-control,
    [data-theme="dark"] .filter-select {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }

    [data-theme="dark"] .post-description {
      background: #2a2a2a;
      color: #ffffff;
    }

    [data-theme="dark"] .profile-actions-card {
      background: var(--gradient-secondary);
    }

    [data-theme="dark"] .post-username,
    [data-theme="dark"] .user-name,
    [data-theme="dark"] .post-title {
      color: #ffffff !important;
    }

    [data-theme="dark"] .filter-container {
      background: #1e1e1e;
      border-color: #333;
    }

    [data-theme="dark"] .filter-select {
      background: #2a2a2a;
      color: #ffffff;
      border-color: #444;
    }

    .splash {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: radial-gradient(60% 90% at 20% 10%, rgba(16,209,255,.20), transparent 60%),
                  radial-gradient(70% 80% at 90% 90%, rgba(106,17,203,.18), transparent 60%),
                  linear-gradient(135deg,#0d0f1a 0%, #0f1330 100%);
      z-index: 9999;
      overflow: hidden;
      transition: opacity .6s ease;
    }

    .splash.fade-out {
      opacity: 0;
      pointer-events: none;
    }

    .runner {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .08em;
      filter: drop-shadow(0 10px 28px rgba(0,0,0,.45));
      pointer-events: none;
    }

    .runner span {
      font-weight: 900;
      font-size: clamp(40px, 9vw, 74px);
      color: #e6ebff;
      display: inline-block;
      opacity: 0;
      transform: translateX(6vw) scale(.96);
      animation: runCentered .8s cubic-bezier(.2,.8,.2,1) forwards;
      will-change: transform, opacity;
    }

    .runner span:nth-child(1){ animation-delay:.00s }
    .runner span:nth-child(2){ animation-delay:.05s }
    .runner span:nth-child(3){ animation-delay:.10s }
    .runner span:nth-child(4){ animation-delay:.15s }
    .runner span:nth-child(5){ animation-delay:.20s }
    .runner span:nth-child(6){ animation-delay:.25s }
    .runner span:nth-child(7){ animation-delay:.30s }
    .runner span:nth-child(8){ animation-delay:.35s }
    .runner span:nth-child(9){ animation-delay:.40s }
    .runner span:nth-child(10){ animation-delay:.45s }

    @keyframes runCentered {
      0% { opacity: 0; transform: translateX(6vw) scale(.96) }
      18% { opacity: 1 }
      55% { transform: translateX(-6vw) scale(1.02) }
      100% { opacity: 0; transform: translateX(-6vw) scale(.98) }
    }

    .final-logo {
      position: relative;
      z-index: 2;
      opacity: 0;
      font-weight: 900;
      font-size: clamp(42px, 9.5vw, 72px);
      color: #eef2ff;
      text-shadow: 0 14px 40px rgba(16,209,255,.22), 0 4px 10px rgba(0,0,0,.5);
      white-space: nowrap;
      line-height: 1;
      direction: rtl;
      unicode-bidi: plaintext;
      animation: logoMerge .55s cubic-bezier(.2,.9,.1,1) var(--merge-delay,1.35s) forwards;
    }

    @keyframes logoMerge {
      0% { opacity: 0; transform: translateY(18px) scale(.94) }
      100% { opacity: 1; transform: translateY(0) scale(1) }
    }

    .loading-text {
      position: absolute;
      bottom: 30%;
      color: #a0b4ff;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      opacity: 0;
      animation: loadingPulse 2s infinite;
      direction: rtl;
    }

    @keyframes loadingPulse {
      0%, 100% { opacity: 0.7; }
      50% { opacity: 1; }
    }

    .loading-text.show {
      display: block;
      animation: fadeInUp 0.5s ease forwards;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .help-floating-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #4a6bff, #6a11cb);
      color: white;
      padding: 12px 16px;
      border-radius: 25px;
      text-decoration: none;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 4px 15px rgba(74, 107, 255, 0.4);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .help-floating-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 107, 255, 0.6);
    }

    .theme-toggle-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      color: white;
      z-index: 1001;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .theme-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .auth-container{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;padding:20px;background:linear-gradient(135deg,#4a6bff,#6a11cb); position: relative;}
    .auth-box{background:#fff;border-radius:10px;box-shadow:0 5px 15px rgba(0,0,0,.1);padding:30px;width:100%;max-width:420px;text-align:center}
    .auth-tabs{display:flex;margin-bottom:20px;border-bottom:1px solid var(--border-color)}
    .auth-tab{flex:1;padding:10px;cursor:pointer;font-weight:500;color:var(--light-text);transition:.3s}
    .auth-tab.active{color:var(--primary-color);border-bottom:2px solid var(--primary-color)}
    .auth-form{display:none}.auth-form.active{display:block}
    .form-group{margin-bottom:15px;text-align:right}
    .form-group label{display:block;margin-bottom:5px;font-weight:500}
    .form-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;transition:.3s}
    .form-control:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(74,107,255,.2)}
    .row{display:flex;gap:8px;align-items:center}
    .grow{flex:1}

    .avatar-upload-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin: 15px 0;
    }

    .avatar-upload-btn-large {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: #f8f9fa;
        border: 2px dashed var(--border-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: var(--light-text);
    }

    .avatar-upload-btn-large:hover {
        border-color: var(--primary-color);
        background: var(--sky);
        color: var(--primary-color);
        transform: translateY(-2px);
    }

    .avatar-upload-btn-large i {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .avatar-upload-btn-large span {
        font-size: 12px;
        font-weight: 600;
    }

    .avatar-container {
        position: relative;
        display: inline-block;
    }

    .avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        background: #d7e4ff;
        color: #2740b9;
        font-size: 40px;
        cursor: pointer;
        border: 2px solid #c9d7ff;
        overflow: hidden;
    }

    .avatar-upload-btn {
        position: absolute;
        bottom: 0;
        right: 0;
        background: #4a6bff;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        cursor: pointer;
        border: 2px solid white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .avatar-upload-btn:hover {
        background: #3a5bef;
        transform: scale(1.1);
    }

    .rank-avatar-container {
        position: relative;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
    }

    .rank-avatar {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #e9ecef;
        background: #f8f9fa;
    }

    .btn{display:inline-block;padding:10px 14px;background:var(--primary-color);color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:700;cursor:pointer;transition:.2s;width:auto}
    .btn:hover{transform:translateY(-1px)}
    .btn[disabled]{opacity:.65;cursor:not-allowed;transform:none}
    .btn-block{width:100%}
    .btn-secondary{background:var(--secondary-color);color:var(--text-color)}
    .btn-danger{background:var(--danger-color);color:#fff}
    .btn-success{background:var(--success-color)}
    .btn-warning{background:var(--warning-color);color:#111}
    .btn-xs{padding:6px 8px;font-size:12px;border-radius:8px}

    .header{position:sticky;top:0;background:#fff;padding:12px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border-color);z-index:100}
    .brand{display:flex;align-items:center;gap:8px}
    .section-switch{display:inline-flex;background:#f2f4ff;border:1px solid #dfe4ff;border-radius:999px;overflow:hidden;margin-inline-start:10px}
    .section-pill{padding:6px 10px;font-size:12px;font-weight:800;color:#3a5bef;cursor:pointer;border:none;background:transparent}
    .section-pill.active{background:#3a5bef;color:#fff}
    .icon-btn{position:relative;background:transparent;border:none;cursor:pointer;font-size:20px}
    .icon-btn .dot{position:absolute;top:-2px;right:-2px;width:8px;height:8px;background:#ff3b3b;border-radius:50%;display:none}
    .icon-btn.has-unseen .dot{display:block}

    .filter-container{padding:15px;background:#fff;border-bottom:1px solid var(--border-color); display:flex; gap:10px;}
    .filter-select{width:100%;padding:10px;border:1px solid var(--border-color);border-radius:5px}
    
    .posts-container{padding:15px 15px 90px}
    .pull-indicator{position:relative;height:0;overflow:visible}
    .pull-indicator .bubble{position:absolute;top:-28px;left:50%;transform:translateX(-50%);background:#e9f0ff;border:1px solid #d0dcff;border-radius:999px;padding:4px 10px;font-size:12px;color:#3a5bef;display:none}

    .post {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 5px rgba(0,0,0,.05);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--border-color);
      position: relative;
      line-height: 1.4;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .post.pinned{box-shadow:0 4px 14px rgba(74,107,255,.25)}
    .post .pin-ribbon{position:absolute;top:-8px;right:-8px;background:#4a6bff;color:#fff;font-weight:800;padding:4px 8px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-size:11px}
    .post.sold{opacity:.85;position:relative}
    .post.deleted{opacity:.5;position:relative}
    .post.sold::after{content:"تم بيعه";position:absolute;top:10px;left:10px;background:var(--success-color);color:#fff;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:800}
    .post-header{display:flex;align-items:flex-start;margin-bottom:0;gap:12px}
    .post-username{display:flex;align-items:center;gap:10px;font-weight:900;color:#111;font-size:17px}
    
    .badge-verified {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border-radius: 25px;
      background: linear-gradient(135deg, 
        #ff6b6b 0%, 
        #ff8e6b 25%, 
        #ffd166 50%, 
        #06d6a0 75%, 
        #118ab2 100%);
      background-size: 300% 300%;
      color: #ffffff;
      font-size: 12px;
      font-weight: 900;
      border: 2px solid rgba(255, 255, 255, 0.8);
      box-shadow: 
        0 4px 20px rgba(255, 107, 107, 0.4),
        0 6px 30px rgba(255, 214, 102, 0.3),
        0 8px 40px rgba(6, 214, 160, 0.2),
        inset 0 0 30px rgba(255, 255, 255, 0.3),
        0 0 20px rgba(255, 107, 107, 0.5);
      position: relative;
      overflow: hidden;
      animation: 
        gradient-shift 3s ease infinite,
        glow-pulse 2s ease-in-out infinite,
        float-gentle 4s ease-in-out infinite;
      transform-style: preserve-3d;
      perspective: 500px;
      text-shadow: 
        0 1px 2px rgba(0,0,0,0.3),
        0 0 10px rgba(255,255,255,0.5);
      backdrop-filter: blur(10px);
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }

    .badge-verified::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg, 
        transparent, 
        rgba(255,255,255,0.6), 
        transparent, 
        rgba(255,255,255,0.4),
        transparent
      );
      transform: rotate(45deg);
      animation: shine-sweep 2.5s ease-in-out infinite;
    }

    .badge-verified::after {
      content: '';
      position: absolute;
      inset: 2px;
      background: radial-gradient(
        circle at 30% 20%, 
        rgba(255,255,255,0.5) 0%, 
        transparent 60%
      );
      border-radius: 22px;
      animation: inner-glow 3s ease-in-out infinite;
      filter: blur(5px);
    }

    .badge-verified i {
      font-size: 13px;
      filter: 
        drop-shadow(0 1px 2px rgba(0,0,0,0.3))
        drop-shadow(0 0 8px rgba(255,255,255,0.8));
      animation: 
        icon-bounce 2s ease-in-out infinite,
        icon-spin 8s linear infinite;
      position: relative;
      z-index: 2;
    }

    @keyframes gradient-shift {
      0%, 100% { 
        background-position: 0% 50%;
        box-shadow: 
          0 4px 20px rgba(255, 107, 107, 0.4),
          0 6px 30px rgba(255, 214, 102, 0.3),
          0 8px 40px rgba(6, 214, 160, 0.2);
      }
      25% { 
        background-position: 50% 100%;
        box-shadow: 
          0 4px 20px rgba(255, 214, 102, 0.4),
          0 6px 30px rgba(6, 214, 160, 0.3),
          0 8px 40px rgba(17, 138, 178, 0.2);
      }
      50% { 
        background-position: 100% 50%;
        box-shadow: 
          0 4px 20px rgba(6, 214, 160, 0.4),
          0 6px 30px rgba(17, 138, 178, 0.3),
          0 8px 40px rgba(255, 107, 107, 0.2);
      }
      75% { 
        background-position: 50% 0%;
        box-shadow: 
          0 4px 20px rgba(17, 138, 178, 0.4),
          0 6px 30px rgba(255, 107, 107, 0.3),
          0 8px 40px rgba(255, 214, 102, 0.2);
      }
    }

    @keyframes glow-pulse {
      0%, 100% { 
        transform: scale(1) rotate(0deg);
        box-shadow: 
          0 4px 20px rgba(255, 107, 107, 0.4),
          0 6px 30px rgba(255, 214, 102, 0.3),
          0 8px 40px rgba(6, 214, 160, 0.2);
      }
      50% { 
        transform: scale(1.05) rotate(0.5deg);
        box-shadow: 
          0 6px 30px rgba(255, 107, 107, 0.6),
          0 8px 40px rgba(255, 214, 102, 0.5),
          0 12px 60px rgba(6, 214, 160, 0.4),
          0 0 30px rgba(255, 255, 255, 0.3);
      }
    }

    @keyframes float-gentle {
      0%, 100% { 
        transform: translateY(0px) rotateX(0deg) rotateY(0deg); 
      }
      33% { 
        transform: translateY(-3px) rotateX(1deg) rotateY(1deg); 
      }
      66% { 
        transform: translateY(2px) rotateX(-1deg) rotateY(-1deg); 
      }
    }

    @keyframes shine-sweep {
      0% { transform: rotate(45deg) translateX(-100%) translateY(-100%); }
      100% { transform: rotate(45deg) translateX(200%) translateY(200%); }
    }

    @keyframes inner-glow {
      0%, 100% { opacity: 0.4; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.1); }
    }

    @keyframes icon-bounce {
      0%, 100% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-2px) scale(1.1); }
    }

    @keyframes icon-spin {
      0% { transform: rotate(0deg) scale(1); }
      25% { transform: rotate(90deg) scale(1.05); }
      50% { transform: rotate(180deg) scale(1.1); }
      75% { transform: rotate(270deg) scale(1.05); }
      100% { transform: rotate(360deg) scale(1); }
    }

    .badge-verified:hover {
      animation: 
        gradient-shift 1s ease infinite,
        glow-pulse 0.5s ease-in-out infinite,
        float-gentle 2s ease-in-out infinite;
      transform: scale(1.1) rotate(2deg);
      box-shadow: 
        0 8px 40px rgba(255, 107, 107, 0.8),
        0 12px 60px rgba(255, 214, 102, 0.6),
        0 16px 80px rgba(6, 214, 160, 0.5),
        0 0 40px rgba(255, 255, 255, 0.5) !important;
    }

    @media (max-width: 768px) {
      .badge-verified {
        padding: 6px 12px;
        font-size: 11px;
        gap: 4px;
      }
      
      .badge-verified i {
        font-size: 12px;
      }
    }

    @keyframes badge-appear {
      0% {
        opacity: 0;
        transform: scale(0.5) rotate(-180deg);
        filter: blur(10px);
      }
      60% {
        opacity: 1;
        transform: scale(1.1) rotate(10deg);
        filter: blur(0px);
      }
      100% {
        opacity: 1;
        transform: scale(1) rotate(0deg);
      }
    }

    .badge-verified {
      animation: 
        badge-appear 0.8s ease-out,
        gradient-shift 3s ease infinite 0.8s,
        glow-pulse 2s ease-in-out infinite 0.8s,
        float-gentle 4s ease-in-out infinite 0.8s;
    }

    .post-title{font-weight:800;font-size:15px;color:var(--primary-color)}
    .post-price{justify-self:end;font-weight:900;color:#28a745}
    
    .post-description{
        margin: 0;
        line-height: 1.8;
        color: #222;
        white-space: pre-wrap;
        font-weight: 500;
        text-align: right;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
        border-right: 4px solid var(--primary-color);
        word-wrap: break-word;
        overflow-wrap: break-word;
        min-height: auto;
        display: block;
        width: 100%;
        box-sizing: border-box;
        font-size: 15px;
        letter-spacing: 0.3px;
    }
    
    .post-actions{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .owner-tools{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:8px}

    .company{background:#fff;border-radius:14px;box-shadow:0 2px 5px rgba(0,0,0,.05);padding:15px;margin-bottom:12px;border:1px solid var(--border-color)}
    .company .name{font-weight:900;color:#111;font-size:16px}
    .company .phone{color:#0c7a43;font-weight:800;margin-top:6px}
    .company .route{color:#555;margin-top:6px;font-size:13px}
    .company .desc{color:#333;margin-top:6px}

    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;overflow-y:auto}
    .modal-content{background:#fff;margin:20px auto;padding:20px;border-radius:12px;width:90%;max-width:520px;animation:modalOpen .25s}
    @keyframes modalOpen{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:10px;border-bottom:1px solid var(--border-color)}
    .modal-header h2{font-size:18px;margin:0}
    .close-modal{background:none;border:none;font-size:24px;cursor:pointer;color:var(--light-text)}
    .select-group{margin-bottom:15px}
    .select-group label{display:block;margin-bottom:5px;font-weight:500}
    .select-control{width:100%;padding:12px 15px;border:1px solid var(--border-color);border-radius:8px;font-size:16px;background:#fff}
    .modal-footer{display:flex;justify-content:flex-end;gap:10px;margin-top:20px}

    .profile-shell{padding:16px}
    .profile-card{
        background: var(--gradient-primary);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .profile-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
        transform: translateX(-100%);
        transition: transform 0.6s;
    }

    .profile-card:hover::before {
        transform: translateX(100%);
    }

    .profile-meta{display:flex;flex-direction:column;gap:6px;flex:1}
    .profile-name-row{display:flex;align-items:center;gap:10px;font-weight:900;font-size:20px;color:#fff}
    .profile-count{font-size:14px;color:rgba(255,255,255,0.9);font-weight:700}
    .profile-email{font-size:13px;color:rgba(255,255,255,0.8);word-break:break-all}
    .profile-uid-input {font-size:12px;padding:6px 8px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; border-radius:6px;}
    .profile-uid-input::placeholder {color: rgba(255,255,255,0.7);}

    .profile-actions-card{
        margin-top: 20px;
        background: var(--gradient-secondary);
        border-radius: 18px;
        padding: 15px;
        box-shadow: 0 6px 20px rgba(138, 43, 226, 0.3);
    }

    .profile-menu{padding:5px}
    .menu-item{
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        margin-bottom: 12px;
        background: rgba(255,255,255,0.15);
        backdrop-filter: blur(10px);
        border-radius: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        color: white;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .menu-item:hover{
        background: rgba(255,255,255,0.25);
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .menu-item i {
        font-size: 18px;
        width: 24px;
        text-align: center;
    }

    .muted{color:#777;font-size:13px}

    #broadcast-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.35);z-index:210}
    #broadcast-overlay.show{display:block}
    #broadcast-banner{
      display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.98);
      width:min(92%, 380px); max-height:70vh; overflow:auto; z-index:220;
      background:#e9f0ff; border:1px solid #d0dcff; border-radius:16px; padding:16px 46px 16px 16px;
      box-shadow:0 20px 40px rgba(0,0,0,.28); opacity:0;
    }
    #broadcast-banner.show{
      display:block; opacity:1; transform:translate(-50%,-50%) scale(1);
      animation:bannerIn .32s cubic-bezier(.2,.8,.2,1) forwards;
    }
    @keyframes bannerIn{to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
    #broadcast-banner .x{position:absolute;top:10px;right:12px;background:#0000;border:none;font-size:22px;cursor:pointer;color:#2643b8}

    .bottom-nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:flex;justify-content:space-around;padding:12px 0;border-top:1px solid var(--border-color);z-index:120}
    .nav-item{display:flex;flex-direction:column;align-items:center;color:var(--light-text);font-size:12px;cursor:pointer;position:relative;transition: all 0.3s ease;}
    .nav-item.active{color:var(--primary-color);transform: translateY(-2px);}

    .nav-item[data-page="news"] {
        transform: scale(1);
    }

    .nav-item[data-page="news"].active {
        transform: scale(1) translateY(-2px);
    }

    .notification{
      position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:var(--success-color);color:#fff;padding:16px 22px;border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:300;display:none;font-size:14px;text-align:center;min-width:240px;max-width:85%;
    }

    .nav-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      font-size: 11px;
      font-weight: bold;
      display: none;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      animation: pulse 2s infinite;
    }

    .menu-item {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .menu-item .nav-badge {
      position: static;
      margin-right: auto;
      margin-left: 8px;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    
    .user-info {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .user-details {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 900;
      color: #111;
      font-size: 16px;
      line-height: 1.2;
      margin: 0;
      flex-wrap: wrap;
    }

    .post-time {
      color: var(--light-text);
      font-size: 13px;
      margin-top: 2px;
      line-height: 1.2;
    }

    .post-content {
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .post-meta {
      display: flex;
      gap: 8px;
      margin-bottom: 0;
      flex-wrap: wrap;
      align-items: center;
    }

    .post-stage, .post-material, .post-price {
      padding: 4px 8px;
      background: var(--sky);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 700;
      color: var(--primary-color);
      line-height: 1.2;
      white-space: nowrap;
    }

    .post-price {
      background: #e8f5e8;
      color: var(--success-color);
    }

    .post-stats {
      padding: 12px 0;
      border-top: 1px solid var(--border-color);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 0;
    }

    .views-count {
      color: var(--light-text);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .post-actions-new {
      display: grid !important;
      grid-template-columns: 1fr 1fr 1fr !important;
      gap: 8px !important;
      margin-top: 12px !important;
    }

    .post-action-btn {
      display: flex !important;
      flex-direction: row !important;
      align-items: center !important;
      justify-content: center !important;
      gap: 6px !important;
      padding: 12px 8px !important;
      background: transparent !important;
      border: 1px solid var(--border-color) !important;
      border-radius: 8px !important;
      color: var(--light-text) !important;
      cursor: pointer !important;
      transition: all 0.3s ease !important;
      font-size: 14px !important;
      font-weight: 600 !important;
      min-height: 44px !important;
      text-align: center !important;
    }

    .post-action-btn:hover {
      background: var(--sky) !important;
      color: var(--primary-color) !important;
      transform: translateY(-2px) !important;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1) !important;
    }

    .post-action-btn span {
      display: inline-block !important;
      font-size: 13px !important;
    }

    .telegram-btn {
      background: #0088cc !important;
      color: white !important;
      border-color: #0088cc !important;
    }

    .telegram-btn:hover {
      background: #0077b5 !important;
      transform: translateY(-1px);
    }

    .whatsapp-btn {
      background: #25D366 !important;
      color: white !important;
      border-color: #25D366 !important;
    }

    .whatsapp-btn:hover {
      background: #128C7E !important;
      transform: translateY(-1px);
    }

    .comments-btn {
      background: #FFC107 !important;
      color: #212529 !important;
      border-color: #FFC107 !important;
    }

    .comments-btn:hover {
      background: #E0A800 !important;
      transform: translateY(-1px);
    }

    .report-btn {
      background: #DC3545 !important;
      color: white !important;
      border-color: #DC3545 !important;
    }

    .report-btn:hover {
      background: #C82333 !important;
      transform: translateY(-1px);
    }

    .details-btn {
      background: #6C757D !important;
      color: white !important;
      border-color: #6C757D !important;
    }

    .details-btn:hover {
      background: #5A6268 !important;
      transform: translateY(-1px);
    }

    .details-info {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      border-right: 4px solid var(--primary-color);
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #e9ecef;
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 700;
      color: #555;
      font-size: 14px;
    }

    .detail-value {
      font-weight: 800;
      color: #222;
      font-size: 14px;
    }

    .cheapest-price {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 900;
      text-align: center;
      margin: 10px 0;
    }

    @media (max-width: 480px) {
      .post {
        padding: 12px;
        margin-bottom: 12px;
        gap: 10px;
      }
      
      .user-name {
        font-size: 15px;
      }
      
      .post-meta {
        gap: 6px;
      }
      
      .post-description {
        padding: 10px;
        font-size: 14px;
      }
      
      .post-actions-new {
        grid-template-columns: 1fr 1fr 1fr !important;
        gap: 6px !important;
      }
      
      .post-action-btn {
        padding: 10px 6px !important;
        font-size: 12px !important;
        min-height: 40px !important;
      }
      
      .post-action-btn span {
        font-size: 11px !important;
      }
    }

    @media (max-width: 360px) {
      .post-actions-new {
        grid-template-columns: 1fr 1fr 1fr !important;
      }
      
      .post-action-btn {
        padding: 8px 4px !important;
        font-size: 11px !important;
      }
      
      .post-action-btn i {
        font-size: 14px !important;
      }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 15px;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 16px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .stat-icon {
      font-size: 28px;
      margin-bottom: 8px;
      opacity: 0.9;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 4px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .stat-label {
      font-size: 13px;
      opacity: 0.9;
      font-weight: 600;
    }

    .stat-card:nth-child(1) {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .stat-card:nth-child(2) {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card:nth-child(3) {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .stat-card:nth-child(4) {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }

    .user-management-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .user-management-item .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .user-management-item .user-details {
      flex: 1;
    }

    .user-management-item .user-name {
      font-weight: 700;
      color: #111;
    }

    .user-management-item .user-email {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }

    .user-management-item .user-id {
      font-size: 11px;
      color: #999;
      margin-top: 2px;
    }

    .user-management-item .user-status {
      font-size: 12px;
      font-weight: 700;
      margin-top: 4px;
    }

    .user-management-item .user-status.banned {
      color: #dc3545;
    }

    .user-management-item .user-status.active {
      color: #28a745;
    }

    .user-management-item .user-actions {
      display: flex;
      gap: 8px;
    }

    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .stat-card {
        min-height: 110px;
        padding: 14px;
      }
      
      .stat-number {
        font-size: 22px;
      }
      
      .user-management-item {
        flex-direction: column;
        align-items: stretch;
      }
      
      .user-management-item .user-actions {
        justify-content: center;
      }
    }

    .menu-item[onclick="logout()"] {
      background: rgba(220, 53, 69, 0.2) !important;
      color: #fff !important;
      border: 1px solid rgba(220, 53, 69, 0.4) !important;
    }

    .menu-item[onclick="logout()"]:hover {
      background: rgba(220, 53, 69, 0.3) !important;
      transform: translateY(-2px);
    }

    .admin-menu {
      padding: 10px;
    }

    .admin-menu .menu-item {
      background: var(--sky);
      border: 1px solid #d0dcff;
    }

    .admin-menu .menu-item:hover {
      background: #e1eaff;
      transform: translateY(-2px);
    }

    .search-box {
      margin-bottom: 15px;
    }

    .search-box input {
      margin-bottom: 10px;
    }

    .avatar-selection {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .avatar-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      padding: 15px;
      border-radius: 12px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .avatar-option:hover {
      background: var(--sky);
      transform: translateY(-2px);
    }

    .avatar-option .emo {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .avatar-option .avatar-label {
      font-weight: 600;
      color: var(--primary-color);
    }

    .comment {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 10px;
      border-right: 3px solid var(--primary-color);
    }

    .comment-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .comment-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .comment-user {
      font-weight: 700;
      color: #111;
      font-size: 14px;
    }

    .comment-time {
      color: var(--light-text);
      font-size: 12px;
    }

    .comment-content {
      color: #333;
      line-height: 1.5;
      font-size: 14px;
    }

    .comment-actions {
      display: flex;
      gap: 15px;
      margin-top: 8px;
    }

    .comment-action {
      background: none;
      border: none;
      color: var(--light-text);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .comment-action:hover {
      color: var(--primary-color);
    }

    .reply-form {
      margin-top: 10px;
      padding-right: 20px;
    }

    .reply-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 14px;
    }

    .mention-suggestions {
      position: absolute;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .mention-suggestion {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
    }

    .mention-suggestion:hover {
      background: var(--sky);
    }

    .mention-suggestion:last-child {
      border-bottom: none;
    }

    .privacy-content {
      padding: 20px;
      line-height: 1.6;
    }

    .privacy-content h1, .privacy-content h2, .privacy-content h3 {
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    .privacy-content p {
      margin-bottom: 15px;
      color: #333;
    }

    .support-page {
      padding: 20px;
    }

    .support-card {
      background: var(--gradient-success);
      border-radius: 20px;
      padding: 25px;
      color: white;
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.3);
      margin-bottom: 20px;
    }

    .support-actions {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .support-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 18px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 15px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .support-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .support-btn i {
      font-size: 20px;
      width: 24px;
    }

    .user-support-page {
      padding: 20px;
    }

    .user-support-item {
      background: #fff;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }

    [data-theme="dark"] .user-support-item {
      background: #1e1e1e;
      color: #ffffff;
      border-color: #333;
    }

    .user-support-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    .support-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .support-user {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 16px;
    }

    .support-type {
      background: var(--accent-color);
      color: white;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .support-message {
      color: var(--text-color);
      line-height: 1.6;
      margin-bottom: 15px;
      white-space: pre-wrap;
      font-size: 14px;
    }

    .reply-section {
      border-top: 1px dashed var(--border-color);
      padding-top: 12px;
      margin-top: 12px;
    }

    .support-reply-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .support-reply-btn:hover {
      background: #3a5bef;
      transform: translateY(-1px);
    }

    .admin-control-btn {
      background: var(--primary-color) !important;
      color: white !important;
      border: 1px solid var(--primary-color) !important;
    }

    .admin-control-btn:hover {
      background: #3a5bef !important;
      transform: translateY(-2px);
    }
    
    .post-menu {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }

    .post-menu-btn {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .post-menu-btn:hover {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }

    .post-menu-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 150px;
      display: none;
      z-index: 100;
    }

    [data-theme="dark"] .post-menu-dropdown {
      background: #2a2a2a;
      border-color: #444;
    }

    .post-menu-dropdown.show {
      display: block;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .post-menu-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.2s ease;
      font-size: 13px;
      color: var(--text-color);
    }

    .post-menu-item:last-child {
      border-bottom: none;
    }

    .post-menu-item:hover {
      background: var(--sky);
      color: var(--primary-color);
    }

    .post-menu-item i {
      width: 16px;
      text-align: center;
      font-size: 12px;
    }

    #report-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    #report-modal .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        width: 90%;
        max-width: 400px;
        color: white;
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -60%);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%);
        }
    }

    #report-modal .modal-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    #report-modal .modal-header i {
        font-size: 24px;
        color: #ffd166;
    }

    #report-modal .modal-header h2 {
        margin: 0;
        font-size: 20px;
        font-weight: 900;
    }

    #report-modal .report-reasons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }

    .report-reason-btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 15px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: right;
        backdrop-filter: blur(10px);
    }

    .report-reason-btn:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .report-reason-btn i {
        margin-left: 8px;
        font-size: 16px;
    }

    #report-custom-input {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 15px;
        color: white;
        font-size: 14px;
        margin-top: 10px;
        resize: vertical;
        min-height: 80px;
        backdrop-filter: blur(10px);
    }

    #report-custom-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    #report-custom-input:focus {
        outline: none;
        border-color: #ffd166;
        box-shadow: 0 0 0 2px rgba(255, 209, 102, 0.3);
    }

    .report-modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .report-modal-actions button {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    #report-submit-btn {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        color: #000;
    }

    #report-submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
    }

    #report-cancel-btn {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    #report-cancel-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    #report-submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .confirmation-modal .modal-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .confirmation-modal .modal-header {
      border-bottom: 1px solid rgba(255,255,255,0.3);
      padding-bottom: 15px;
    }

    .confirmation-modal .modal-body {
      padding: 20px 0;
      text-align: center;
      font-size: 16px;
      line-height: 1.6;
    }

    .confirmation-modal .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .confirmation-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 100px;
    }

    .confirm-btn {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: #000;
    }

    .confirm-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(67, 233, 123, 0.4);
    }

    .cancel-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .cancel-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }

    body {
        touch-action: pan-y;
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        text-size-adjust: 100%;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    input, select, textarea {
        font-size: 16px !important;
        max-height: 44px;
    }

    @media screen and (max-width: 768px) {
        input, select, textarea {
            font-size: 16px !important;
        }
    }

    .audio-management-item {
        transition: all 0.3s ease;
    }

    .audio-management-item:hover {
        background: rgba(255,255,255,0.2) !important;
    }
    
    <style>
/* إضافة ستايل لأزرار التثبيت */
.btn-pinned {
    background: linear-gradient(135deg, #FFD700, #FFA500) !important;
    color: white !important;
    font-weight: 900 !important;
    border: none !important;
    box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4) !important;
}

.btn-unpinned {
    background: var(--secondary-color) !important;
    color: var(--text-color) !important;
    border: 1px solid var(--border-color) !important;
}

/* تحسين مشغل الصوت */
#audio-player {
    backdrop-filter: blur(10px);
    border: 2px solid var(--primary-color);
}

#audio-player .btn {
    transition: all 0.3s ease;
}

#audio-player .btn:hover {
    transform: scale(1.1);
}

/* تحسين شات الذكاء الاصطناعي */
#ai-chat-container {
    scroll-behavior: smooth;
}

#ai-chat-container .post {
    transition: all 0.3s ease;
}

#ai-chat-container .post:hover {
    transform: translateX(-5px);
}

/* أضف هذا في قسم الـ style */
#youtube-modal .btn {
    padding: 10px 15px;
    border-radius: 8px;
    font-weight: 700;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    min-width: 100px;
}

#youtube-modal .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.hidden-player-btn {
    transition: all 0.3s ease;
}

.hidden-player-btn:hover {
    transform: scale(1.1);
    background: rgba(255,255,255,0.3) !important;
}

#hidden-audio-player {
    animation: slideInUp 0.3s ease-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* مشغل YouTube المخفي */
#hidden-audio-player {
    position: fixed;
    top: -1000px;
    left: -1000px;
    width: 1px;
    height: 1px;
    overflow: hidden;
    opacity: 0;
    pointer-events: none;
}

#hidden-audio-player iframe {
    width: 1px;
    height: 1px;
    border: none;
}

/* زر الإيقاف */
#audio-controls button {
    transition: all 0.3s ease;
}

#audio-controls button:hover {
    transform: scale(1.1);
    background: #c82333 !important;
}

/* أنماط إضافية للجدول */
#schedule-table-container table {
    border: 2px solid #2c3e50;
}

#schedule-table-container th {
    font-weight: 900;
    font-size: 16px;
}

#schedule-table-container td {
    font-size: 14px;
    transition: background-color 0.3s ease;
}

#schedule-table-container tr:hover td {
    background-color: #f0f7ff !important;
}

#schedule-table-container .difficulty-stars {
    direction: ltr;
    unicode-bidi: bidi-override;
}

/* أنماط للأزرار */
#save-schedule-btn, #rate-schedule-btn, #share-schedule-btn {
    min-width: 120px;
    padding: 12px 20px;
    font-weight: 700;
    font-size: 15px;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

#save-schedule-btn:hover, #rate-schedule-btn:hover, #share-schedule-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

/* أنماط خاصة للجدول لجعله متجاوباً */
@media (max-width: 480px) {
    #schedule-table-container {
        font-size: 9px !important;
    }
    
    #schedule-table-container th,
    #schedule-table-container td {
        padding: 6px 4px !important;
        font-size: 9px !important;
    }
    
    #schedule-table-container h2 {
        font-size: 12px !important;
    }
    
    #schedule-table-container .schedule-info div {
        font-size: 14px !important;
    }
    
    #schedule-table-container .schedule-info span {
        font-size: 10px !important;
    }
}

/* جعل الجدول يتناسب مع الشاشة */
#schedule-table-container table {
    table-layout: auto !important;
}

/* تحسين التفاف النص */
#schedule-table-container th,
#schedule-table-container td {
    word-wrap: break-word;
    overflow-wrap: break-word;
    hyphens: auto;
}

/* تحسين العرض على الشاشات الصغيرة */
@media (max-width: 360px) {
    #schedule-table-container {
        zoom: 0.9;
        transform: scale(0.9);
        transform-origin: top center;
        width: 111% !important; /* لتعويض التصغير */
        margin-left: -5.5% !important;
    }
}

/* إخفاء التمرير الأفقي إن أمكن */
#schedule-table-container > div {
    overflow-x: hidden !important;
}

/* تحسين عرض النجوم */
.difficulty-stars {
    font-size: 10px;
    letter-spacing: -1px;
}

/* تحسين الأزرار */
#save-schedule-btn, #rate-schedule-btn, #share-schedule-btn {
    font-size: 14px !important;
    padding: 10px 15px !important;
    min-width: 100px !important;
}


</style>

  </style>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js"></script>
</head>
<body>

  <div id="splash" class="splash" aria-label="سوق الطلاب">
    <div class="runner" dir="rtl" aria-hidden="true">
      <span>س</span><span>و</span><span>ق</span><span>&nbsp;</span><span>ا</span><span>ل</span><span>ط</span><span>ل</span><span>ا</span><span>ب</span>
    </div>
    <div class="final-logo" id="final-logo" dir="rtl">سوق الطلاب</div>
    
    <div id="loading-text" class="loading-text" style="display: none;">
      جاري التحميل...
    </div>
  </div>

  <a href="https://youtube.com/shorts/dezFxy0tc9w?si=eoYQNWjjqJ-C599h" target="_blank" class="help-floating-btn" id="help-floating-btn">
    <i class="fas fa-question-circle"></i>
    شرح انشاء حساب جديد
  </a>

  <div id="auth-page" class="auth-container page" style="display:none">
    <div class="auth-box">
      <div class="auth-tabs">
        <div class="auth-tab active" onclick="switchAuthTab('login')">تسجيل الدخول</div>
        <div class="auth-tab" onclick="switchAuthTab('register')">إنشاء حساب</div>
      </div>

      <form id="login-form" class="auth-form active" onsubmit="event.preventDefault(); login();">
        <div class="form-group"><label for="login-email">البريد الإلكتروني</label><input type="email" id="login-email" class="form-control" required></div>
        <div class="form-group"><label for="login-password">كلمة المرور</label><input type="password" id="login-password" class="form-control" required></div>
        <div class="form-group" style="text-align:center; margin-top:10px;">
          <a href="#" onclick="openForgotPasswordModal()" style="color:var(--primary-color); text-decoration:none; font-size:14px;">
            نسيت كلمة المرور؟
          </a>
        </div>
        <button type="submit" class="btn btn-block">تسجيل الدخول</button>
      </form>

      <form id="register-form" class="auth-form" onsubmit="event.preventDefault(); register();">
        <div class="form-group"><label for="register-name">الاسم الكامل</label><input type="text" id="register-name" class="form-control" required></div>
        <div class="form-group"><label for="register-email">البريد الإلكتروني</label><input type="email" id="register-email" class="form-control" required></div>
        <div class="form-group"><label for="register-password">كلمة المرور</label><input type="password" id="register-password" class="form-control" required></div>
        
        <div class="form-group">
          <label>الصورة الشخصية</label>
          <div class="avatar-upload-section">
            <div class="avatar-upload-btn-large" onclick="document.getElementById('register-avatar-input').click()">
              <i class="fas fa-camera"></i>
              <span>رفع صورة</span>
            </div>
            <img id="register-avatar-preview" class="avatar-preview-small" alt="معاينة الصورة">
            <input type="file" id="register-avatar-input" accept="image/*" style="display: none" onchange="previewRegisterAvatar(event)">
            <small style="color: var(--light-text); text-align: center;">انقر لرفع صورتك الشخصية<br>الحجم الأقصى: 2MB</small>
          </div>
        </div>
        
        <button type="button" id="register-submit" class="btn btn-block" onclick="register()">إنشاء حساب</button>
      </form>
    </div>
  </div>

  <div id="main-page" class="container page" style="display:none">
    <div class="header">
      <div class="brand">
        <button id="create-btn" class="btn" onclick="onCreateButton()"><i class="fas fa-plus"></i> <span id="create-btn-label">إنشاء منشور</span></button>
        <div class="section-switch" role="tablist" aria-label="الأقسام">
          <button id="pill-posts" class="section-pill active" onclick="switchSection('posts')" role="tab" aria-selected="true">المنشورات</button>
          <button id="pill-companies" class="section-pill" onclick="switchSection('companies')" role="tab" aria-selected="false">شركات التوصيل</button>
        </div>
      </div>
    </div>

    <div id="filter-container" class="filter-container">
      <select id="filter-stage" class="filter-select" onchange="renderPosts()">
        <option value="">كل المراحل</option>
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس علمي/ادبي</option>
        <option value="rabea">الرابع علمي/ادبي</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
      <select id="filter-material" class="filter-select" onchange="renderPosts()">
        <option value="">كل المواد</option>
        <option value="اسلامية">اسلامية</option><option value="عربي">عربي</option><option value="انكليزي">انكليزي</option>
        <option value="رياضيات">رياضيات</option><option value="احياء">احياء</option><option value="كيمياء">كيمياء</option>
        <option value="فيزياء">فيزياء</option><option value="اقتصاد">اقتصاد</option><option value="أدب ونصوص">أدب ونصوص</option>
        <option value="قواعد">قواعد</option>
      </select>
    </div>

    <div class="pull-indicator"><div id="pull-bubble" class="bubble">اسحب للتحديث…</div></div>
    <div class="posts-container" id="posts-container"></div>
    <div class="posts-container" id="companies-container" style="display:none"></div>
  </div>

  <div class="pull-indicator">
    <div id="pull-bubble" class="bubble" style="display: none">
      <i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...
    </div>
  </div>

  <div id="profile-page" class="container page" style="display:none">
    <div class="profile-shell">
      <div class="profile-card">
        <button class="theme-toggle-btn" onclick="toggleTheme()">
          <i class="fas fa-moon"></i>
        </button>
        
        <div class="avatar-container">
            <div id="avatar" class="avatar" title="انقر لتغيير الصورة" onclick="openAvatarModal()">
                <div style="width:100%;height:100%;font-size:40px;line-height:72px">👨🏻‍💼</div>
            </div>
            <div class="avatar-upload-btn" onclick="openImageUploadModal()" title="رفع صورة شخصية">
                <i class="fas fa-camera"></i>
            </div>
        </div>
        <div class="profile-meta">
          <div class="profile-name-row">
            <span id="profile-name"></span>
            <span id="profile-verified"></span>
            <i class="fas fa-pencil-alt" style="color:white;cursor:pointer" onclick="editProfileName()"></i>
          </div>
          <div id="profile-count" class="profile-count"></div>
          <div id="profile-email" class="profile-email"></div>
          <div class="row" style="align-items: center; gap: 8px; margin-top:4px;">
            <input id="profile-uid-input" class="form-control profile-uid-input" readonly />
            <button class="btn btn-xs" onclick="copyUidToClipboard()" style="background: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.5);"><i class="fas fa-copy"></i> نسخ</button>
          </div>
        </div>
      </div>
      
      <div class="profile-actions-card">
        <div class="profile-menu">
          <div class="menu-item" onclick="showUserPosts()">
            <i class="fas fa-book"></i>
            <span>منشوراتي</span>
          </div>
          
          <div class="menu-item" onclick="showInbox();">
            <i class="fas fa-inbox"></i>
            <span>البريد الوارد</span>
            <div id="inbox-badge" class="nav-badge" style="display: none">0</div>
          </div>
          
          <button onclick="sendTestNotification()" class="btn">
  <i class="fas fa-bell"></i> اختبار الإشعار
</button>

          <div class="menu-item" onclick="showUserStatistics()">
            <i class="fas fa-chart-bar"></i>
            <span>إحصائيات المستخدمين</span>
          </div>
          
          <div class="menu-item" onclick="showPrivacyPolicy()">
            <i class="fas fa-shield-alt"></i>
            <span>سياسة الخصوصية</span>
          </div>
          
          <div class="menu-item" onclick="showSupportPage()">
            <i class="fas fa-headset"></i>
            <span>التواصل مع الدعم</span>
          </div>
          
          <!-- في قسم باقي الأزرار في صفحة البروفايل -->
<div class="menu-item owner-only" style="display:none" onclick="showAdminPanel()">
    <i class="fas fa-cogs"></i>
    <span>باقي الازرار</span>
</div>

<!-- إضافة زر تعليم الذكاء الاصطناعي -->
<div class="menu-item owner-only" style="display:none" onclick="showAITrainingPage()">
    <i class="fas fa-brain"></i>
    <span>تعليم الذكاء الاصطناعي</span>
</div>
          
          <div class="menu-item" onclick="logout()">
            <i class="fas fa-sign-out-alt"></i>
            <span>تسجيل الخروج</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="user-posts-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">منشوراتي</span></div>
    <div class="posts-container" id="user-posts-container"></div>
  </div>

  <div id="inbox-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">البريد الوارد</span></div>
    <div class="posts-container" id="inbox-container"></div>
  </div>

  <div id="details-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromDetails()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">تفاصيل المنشور</span></div>
    <div class="posts-container" id="details-container"></div>
  </div>

  <div id="comments-page" class="container page" style="display:none">
    <div class="header"><button class="btn btn-secondary" onclick="backToMainFromComments()"><i class="fas fa-arrow-right"></i></button><span style="font-weight:900">التعليقات</span></div>
    <div class="posts-container">
      <div id="comments-list-page"></div>
      <div class="row" style="margin-top:10px;">
        <input type="text" id="comment-text-page" class="form-control grow" placeholder="أضف تعليقًا...">
        <button id="send-comment-btn" class="btn" onclick="addCommentFromPage()">إرسال</button>
      </div>
    </div>
  </div>

  <div id="user-statistics-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">إحصائيات المستخدمين</span>
    </div>
    <div class="posts-container">
      <div class="stats-grid" id="stats-grid">
      </div>
    </div>
  </div>

  <div id="admin-panel-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
        <span style="font-weight:900">لوحة التحكم</span>
    </div>
    <div class="posts-container">
        <div class="admin-menu">
            <div class="menu-item admin-control-btn" onclick="showUserManagement()">
                <i class="fas fa-users-cog"></i>
                <span>إدارة المستخدمين</span>
            </div>
            <div class="menu-item admin-control-btn" onclick="showBroadcastPanel()">
                <i class="fas fa-bullhorn"></i>
                <span>إشعار عام</span>
            </div>
            <div class="menu-item admin-control-btn" onclick="showUserSupportPage()">
                <i class="fas fa-comments"></i>
                <span>الرد على المستخدمين</span>
            </div>
            <!-- في صفحة لوحة التحكم -->
<div class="menu-item admin-control-btn" onclick="showScheduleRatings()">
    <i class="fas fa-star"></i>
    <span>تقييمات الجداول</span>
    <div id="ratings-badge" class="nav-badge" style="display: none">0</div>
</div>
        </div>
    </div>
</div>

  <div id="user-management-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">إدارة المستخدمين</span>
    </div>
    <div class="posts-container">
      <div class="search-box" style="margin-bottom: 15px;">
        <input type="text" id="user-search-input" class="form-control" placeholder="ابحث بالبريد الإلكتروني أو ID...">
        <button class="btn" onclick="searchUsers()" style="margin-top: 10px; width: 100%;">بحث</button>
      </div>
      <div id="user-management-results"></div>
    </div>
  </div>

  <div id="broadcast-panel-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">إشعار عام</span>
    </div>
    <div class="posts-container">
      <div class="post">
        <div class="form-group">
          <label>عنوان الإشعار</label>
          <input type="text" id="broadcast-title" class="form-control" placeholder="أدخل عنوان الإشعار...">
        </div>
        <div class="form-group">
          <label>محتوى الرسالة</label>
          <textarea id="broadcast-message" class="form-control" rows="6" placeholder="أدخل محتوى الإشعار..."></textarea>
        </div>
        <div class="post-actions">
          <button class="btn btn-success" onclick="sendBroadcast()">
            <i class="fas fa-paper-plane"></i> إرسال الإشعار
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="privacy-policy-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">سياسة الخصوصية</span>
    </div>
    <div class="privacy-content" id="privacy-content">
    </div>
  </div>

  <div id="support-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToProfile()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">التواصل مع الدعم</span>
    </div>
    <div class="support-page">
      <div class="support-card">
        <h2 style="margin-bottom: 15px; text-align: center;">مرحباً بك في مركز الدعم</h2>
        <p style="text-align: center; margin-bottom: 20px; opacity: 0.9;">نحن هنا لمساعدتك في أي استفسار أو مشكلة تواجهك</p>
        
        <div class="support-actions">
          <button class="support-btn" onclick="contactTelegram()">
            <i class="fab fa-telegram"></i>
            <span>التواصل مباشرة عبر التيليجرام</span>
          </button>
          
          <button class="support-btn" onclick="openSuggestionModal()">
            <i class="fas fa-lightbulb"></i>
            <span>إرسال اقتراح للتطبيق</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="user-support-page" class="container page" style="display:none">
    <div class="header">
      <button class="btn btn-secondary" onclick="backToAdminPanel()"><i class="fas fa-arrow-right"></i></button>
      <span style="font-weight:900">الرد على المستخدمين</span>
    </div>
    <div class="user-support-page" id="user-support-container">
      <div id="user-support-results">
        <div class="post">
          <p style="text-align: center; color: var(--text-color);">جاري تحميل طلبات المستخدمين...</p>
        </div>
      </div>
    </div>
  </div>

<!-- إضافة زر المساعد الدراسي في شريط التنقل السفلي -->
<div id="bottom-nav" class="bottom-nav">
    <div class="nav-item active" data-page="main" onclick="showMainPageAndClearBadge();">
        <i class="fas fa-home"></i>
        <span>المنشورات</span>
        <div id="posts-badge" class="nav-badge" style="display: none">0</div>
    </div>
    
    <!-- الزر الجديد -->
    <div class="nav-item" data-page="study-assistant" onclick="showStudyAssistantPage()">
        <i class="fas fa-graduation-cap"></i>
        <span>المساعد الدراسي</span>
    </div>
    
    <div class="nav-item" data-page="profile" onclick="showProfilePage()">
        <i class="fas fa-user"></i>
        <span>حسابي</span>
        <div id="profile-notification-badge" class="nav-badge" style="display: none">0</div>
    </div>
</div>

  <div id="notification" class="notification"></div>

  <div id="create-post-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>إنشاء منشور</h2><button class="close-modal" onclick="closeCreatePostModal()">&times;</button></div>
    
    <div class="select-group">
      <label>المرحلة <span style="color:var(--danger-color)">*</span></label>
      <select id="post-stage" class="select-control" required>
        <option value="" disabled selected>اختر مرحلتك</option>
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس العلمي والادبي</option>
        <option value="rabea">الرابع العلمي والادبي</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
    </div>
    
    <div class="select-group"><label>المادة</label>
      <select id="post-material" class="select-control">
        <option>اسلامية</option><option>عربي</option><option>انكليزي</option>
        <option>رياضيات</option><option>احياء</option><option>كيمياء</option>
        <option>فيزياء</option><option>اقتصاد</option><option>أدب ونصوص</option><option>قواعد</option>
      </select>
    </div>
    
    <div class="select-group"><label>السعر</label><input id="post-price" class="select-control" type="number" value="0"></div>
    
    <div class="select-group">
      <label>أرخص سعر للملزمة (اختياري)</label>
      <input id="post-cheapest-price" class="select-control" type="number" value="0" placeholder="أدخل أرخص سعر للملزمة...">
    </div>
    
    <div class="select-group"><label>الوصف</label><textarea id="post-description" class="select-control" rows="4" placeholder="اكتب وصف المنشور هنا..."></textarea></div>
    
    <div class="select-group"><label>طريقة التواصل</label>
      <select id="contact-method" class="select-control" onchange="changeContactMethod()">
        <option value="whatsapp">واتساب</option>
        <option value="telegram">تلكرام</option>
        <option value="comments">تعليقات</option>
      </select>
    </div>
    <div id="whatsapp-field" class="select-group"><label>رقم واتساب</label><input id="whatsapp-number" class="select-control" placeholder="9647xxxxxxxxx"></div>
    <div id="telegram-field" class="select-group" style="display:none"><label>معرّف تلكرام</label><input id="telegram-username" class="select-control" placeholder="username بدون @"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCreatePostModal()">إلغاء</button>
      <button id="post-submit-btn" class="btn" onclick="createPost()">
        <i class="fas fa-paper-plane"></i> نشر
      </button>
    </div>
  </div></div>

  <div id="edit-post-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>تعديل منشور</h2><button class="close-modal" onclick="closeEditPostModal()">&times;</button></div>
    <input type="hidden" id="edit-post-id"/>
    <div class="select-group"><label>المرحلة</label>
      <select id="edit-post-stage" class="select-control">
        <option value="sades-elmi">السادس العلمي</option>
        <option value="sades-adabi">السادس الادبي</option>
        <option value="khames">الخامس</option>
        <option value="rabea">الرابع</option>
        <option value="thaleth-mut">الثالث متوسط</option>
        <option value="thani-mut">الثاني متوسط</option>
        <option value="awal-mut">الاول متوسط</option>
        <option value="sades-ibtidai">السادس الابتدائي</option>
      </select>
    </div>
    <div class="select-group"><label>السعر</label><input id="edit-post-price" class="select-control" type="number"></div>
    
    <div class="select-group">
      <label>أرخص سعر للملزمة</label>
      <input id="edit-post-cheapest-price" class="select-control" type="number" placeholder="أدخل أرخص سعر للملزمة...">
    </div>
    
    
    <div class="select-group"><label>المادة</label>
      <select id="edit-post-material" class="select-control">
        <option>اسلامية</option><option>عربي</option><option>انكليزي</option>
        <option>رياضيات</option><option>احياء</option><option>كيمياء</option>
        <option>فيزياء</option><option>اقتصاد</option><option>أدب ونصوص</option><option>قواعد</option>
      </select>
    </div>
    <div class="select-group"><label>الوصف</label><textarea id="edit-post-description" class="select-control" rows="4"></textarea></div>
    <div class="select-group"><label>طريقة التواصل</label>
      <select id="edit-contact-method" class="select-control" onchange="changeContactMethod('edit')">
        <option value="whatsapp">واتساب</option>
        <option value="telegram">تلكرام</option>
        <option value="comments">تعليقات</option>
      </select>
    </div>
    <div id="edit-whatsapp-field" class="select-group"><label>رقم واتساب</label><input id="edit-whatsapp-number" class="select-control"></div>
    <div id="edit-telegram-field" class="select-group" style="display:none"><label>معرّف تلكرام</label><input id="edit-telegram-username" class="select-control"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeEditPostModal()">إلغاء</button>
      <button id="post-edit-submit-btn" class="btn" onclick="savePostEdits()">حفظ</button>
    </div>
  </div></div>

  <div id="create-company-modal" class="modal"><div class="modal-content">
    <div class="modal-header"><h2>إضافة شركة توصيل</h2><button class="close-modal" onclick="closeCreateCompanyModal()">&times;</button></div>
    <div class="select-group"><label>اسم الشركة</label><input id="company-name" class="select-control"></div>
    <div class="select-group"><label>من</label><select id="company-from" class="select-control"></select></div>
    <div class="select-group"><label>إلى</label><select id="company-to" class="select-control"></select></div>
    <div class="select-group"><label>الهاتف</label><input id="company-phone" class="select-control"></div>
    <div class="select-group"><label>وصف</label><textarea id="company-desc" class="select-control" rows="3"></textarea></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeCreateCompanyModal()">إلغاء</button>
      <button id="company-submit-btn" class="btn btn-success" onclick="createCompany()">إضافة</button>
    </div>
  </div></div>

  <div id="image-upload-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>رفع صورة شخصية</h2>
            <button class="close-modal" onclick="closeImageUploadModal()">&times;</button>
        </div>
        <div class="select-group">
            <label>اختر صورة</label>
            <input type="file" id="avatar-upload-input" accept="image/*" class="form-control">
            <div class="hint" style="text-align: center; margin-top: 10px;">
                <small>الحجم الأقصى: 2MB | الصيغ المسموحة: JPG, PNG, GIF</small>
            </div>
        </div>
        <div id="avatar-preview" style="text-align: center; margin: 15px 0; display: none;">
            <img id="avatar-preview-img" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #4a6bff;">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImageUploadModal()">إلغاء</button>
            <button id="upload-avatar-btn" class="btn btn-success" onclick="uploadAvatar()" disabled>رفع الصورة</button>
        </div>
    </div>
  </div>

  <div id="avatar-modal" class="modal"><div class="modal-content">
    <div class="modal-header">
      <h2>تغيير الصورة الشخصية</h2><button class="close-modal" onclick="closeAvatarModal()">&times;</button></div>
    
    <div class="avatar-selection">
      <label class="avatar-option" onclick="setAvatar('male')">
        <span class="emo">👨🏻‍💼</span>
        <span class="avatar-label">ولد</span>
      </label>
      
      <label class="avatar-option" onclick="setAvatar('female')">
        <span class="emo">👩🏻‍💼</span>
        <span class="avatar-label">بنت</span>
      </label>
    </div>

    <div style="text-align: center; margin-top: 20px; padding: 15px; background: var(--sky); border-radius: 12px;">
      <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">الصورة الحالية:</div>
      <div id="current-avatar-preview" style="display: inline-block;"></div>
    </div>
  </div></div>

  <div id="forgot-password-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>استعادة كلمة المرور</h2>
        <button class="close-modal" onclick="closeForgotPasswordModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>البريد الإلكتروني</label>
        <input type="email" id="forgot-email" class="select-control" placeholder="أدخل بريدك الإلكتروني المسجل">
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeForgotPasswordModal()">إلغاء</button>
        <button id="forgot-submit-btn" class="btn btn-success" onclick="handleForgotPassword()">إرسال رابط الاستعادة</button>
      </div>
    </div>
  </div>

  <div id="suggestion-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>إرسال اقتراح أو مشكلة</h2>
        <button class="close-modal" onclick="closeSuggestionModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>نوع الرسالة</label>
        <select id="suggestion-type" class="select-control">
          <option value="problem">مشاكل في التطبيق</option>
          <option value="suggestion">اقتراح للتطبيق</option>
        </select>
      </div>
      <div class="select-group">
        <label>الوصف</label>
        <textarea id="suggestion-message" class="select-control" rows="6" placeholder="اكتب وصف المشكلة أو الاقتراح بالتفصيل..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSuggestionModal()">إلغاء</button>
        <button class="btn btn-success" onclick="sendSuggestion()">
          <i class="fas fa-paper-plane"></i> إرسال
        </button>
      </div>
    </div>
  </div>

  <div id="reply-support-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>الرد على المستخدم</h2>
        <button class="close-modal" onclick="closeReplySupportModal()">&times;</button>
      </div>
      <div class="select-group">
        <label>معرف المستخدم</label>
        <input type="text" id="reply-user-id" class="select-control" readonly>
      </div>
      <div class="select-group">
        <label>اسم المستخدم</label>
        <input type="text" id="reply-user-name" class="select-control" readonly>
      </div>
      <div class="select-group">
        <label>الرد</label>
        <textarea id="reply-message" class="select-control" rows="6" placeholder="اكتب ردك على المستخدم..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeReplySupportModal()">إلغاء</button>
        <button class="btn btn-success" onclick="sendSupportReply()">
          <i class="fas fa-paper-plane"></i> إرسال الرد
        </button>
      </div>
    </div>
  </div>

  <div id="broadcast-overlay"></div>
  <div id="broadcast-banner">
    <button class="x" onclick="dismissBroadcast()">×</button>
    <div style="font-weight:900;color:#0f235f" id="broadcast-title-display"></div>
    <div id="broadcast-text-display" style="margin-top:4px;color:#0f235f"></div>
  </div>
  
<div id="report-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <i class="fas fa-flag"></i>
            <h2>الإبلاغ عن منشور</h2>
        </div>
        
        <div class="report-reasons">
            <button class="report-reason-btn" onclick="selectReportReason('محتوى غير لائق')">
                <i class="fas fa-ban"></i>
                محتوى غير لائق
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('احتيال أو نصاب')">
                <i class="fas fa-user-slash"></i>
                احتيال أو نصاب
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('مخالف للشروط')">
                <i class="fas fa-exclamation-triangle"></i>
                مخالف للشروط
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('معلومات خاطئة')">
                <i class="fas fa-times-circle"></i>
                معلومات خاطئة
            </button>
            <button class="report-reason-btn" onclick="selectReportReason('سبب آخر')">
                <i class="fas fa-edit"></i>
                سبب آخر
            </button>
        </div>
        
        <textarea 
            id="report-custom-input" 
            placeholder="اكتب سبب الإبلاغ بالتفصيل... (اختياري)"
            style="display: none;"
        ></textarea>
        
        <div class="report-modal-actions">
            <button id="report-cancel-btn" onclick="closeReportModal()">
                إلغاء
            </button>
            <button id="report-submit-btn" onclick="submitReport()" disabled>
                <i class="fas fa-paper-plane"></i> إرسال الإبلاغ
            </button>
        </div>
    </div>
</div>

<div id="confirmation-modal" class="modal confirmation-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="confirmation-title">تأكيد الإجراء</h2>
            <button class="close-modal" onclick="closeConfirmationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmation-message">هل أنت متأكد من تنفيذ هذا الإجراء؟</p>
        </div>
        <div class="modal-footer">
            <button class="confirmation-btn cancel-btn" onclick="closeConfirmationModal()">إلغاء</button>
            <button class="confirmation-btn confirm-btn" id="confirmation-confirm-btn">تأكيد</button>
        </div>
    </div>
</div>

<!-- صفحة محادثة الذكاء الاصطناعي -->
<div id="ai-chat-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">المساعد الذكي</span>
    </div>
    
    <div class="posts-container" style="padding-bottom: 80px;">
        <!-- منطقة المحادثة -->
        <div id="ai-chat-container" style="min-height: 400px; max-height: 65vh; overflow-y: auto; padding: 15px; background: var(--sky); border-radius: 12px; margin-bottom: 15px;">
            <div class="post" style="background: #e9f0ff; border: 1px solid #d0dcff;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 5px;">المساعد الذكي</div>
                        <div style="color: #333; line-height: 1.5;">مرحباً! أنا المساعد الذكي لسوق الطلاب. كيف يمكنني مساعدتك في دراستك اليوم؟</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- منطقة إدخال الرسالة -->
        <div style="position: fixed; bottom: 70px; left: 15px; right: 15px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
            <div class="row" style="align-items: center; gap: 10px;">
                <input type="text" id="ai-message-input" class="form-control grow" placeholder="اكتب سؤالك هنا..." style="border-radius: 20px; padding: 12px 15px;">
                <button id="ai-send-btn" class="btn" onclick="sendAIMessage()" style="border-radius: 50%; width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- صفحة تعليم الذكاء الاصطناعي -->
<div id="ai-training-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="backToProfile()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">تعليم الذكاء الاصطناعي</span>
    </div>
    
    <div class="posts-container">
        <div class="post">
            <div class="form-group">
                <label>الأوامر والمعلومات الجديدة</label>
                <textarea id="ai-training-text" class="form-control" rows="6" placeholder="أضف الأوامر أو المعلومات التي تريد أن يتعلمها الذكاء الاصطناعي..."></textarea>
            </div>
            
            <div class="form-group">
                <label>نوع المحتوى</label>
                <select id="ai-training-type" class="form-control">
                    <option value="command">أمر جديد</option>
                    <option value="information">معلومات</option>
                    <option value="response">نمط رد</option>
                </select>
            </div>
            
            <div class="post-actions">
                <button class="btn btn-success" onclick="saveAITraining()">
                    <i class="fas fa-save"></i> حفظ التعليمات
                </button>
            </div>
        </div>
        
        <!-- قائمة التعليمات السابقة -->
        <div id="ai-training-list" style="margin-top: 20px;">
            <div class="post">
                <p style="text-align: center; color: var(--light-text);">جاري تحميل التعليمات...</p>
            </div>
        </div>
    </div>
</div>

<!-- في صفحة study-assistant-page، أضف الزر الجديد بعد زر القصائد -->
<div id="study-assistant-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showMainPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">المساعد الدراسي</span>
    </div>
    
    <div class="posts-container">
        <div class="profile-actions-card">
            <div class="profile-menu">
                <div class="menu-item" onclick="showAIChatPage()">
                    <i class="fas fa-robot"></i>
                    <span>الذكاء الاصطناعي</span>
                </div>
                
                <div class="menu-item" onclick="showStudyTimerPage()">
                    <i class="fas fa-clock"></i>
                    <span>العداد الدراسي</span>
                </div>
                
                <div class="menu-item" onclick="showPoemsPage()">
                    <i class="fas fa-music"></i>
                    <span>القصائد</span>
                </div>
                
                <!-- الزر الجديد: الواجبات اليومية -->
                <div class="menu-item" onclick="showDailyTasksPage()">
                    <i class="fas fa-tasks"></i>
                    <span>الواجبات اليومية</span>
                </div>
                
                <!-- الزر الجديد: الجداول الدراسية -->
                <div class="menu-item" onclick="showStudySchedulesPage()">
                    <i class="fas fa-calendar-alt"></i>
                    <span>الجداول الدراسية</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- صفحة الذكاء الاصطناعي -->
<div id="ai-chat-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">المساعد الذكي</span>
    </div>
    
    <div class="posts-container" style="padding-bottom: 80px;">
        <div id="ai-chat-container" style="min-height: 400px; max-height: 65vh; overflow-y: auto; padding: 15px; background: var(--sky); border-radius: 12px; margin-bottom: 15px;">
            <div class="post" style="background: #e9f0ff; border: 1px solid #d0dcff;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 5px;">المساعد الذكي</div>
                        <div style="color: #333; line-height: 1.5;">مرحباً! أنا المساعد الذكي لسوق الطلاب. كيف يمكنني مساعدتك في دراستك اليوم؟</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div style="position: fixed; bottom: 70px; left: 15px; right: 15px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
            <div class="row" style="align-items: center; gap: 10px;">
                <input type="text" id="ai-message-input" class="form-control grow" placeholder="اكتب سؤالك هنا..." style="border-radius: 20px; padding: 12px 15px;">
                <button id="ai-send-btn" class="btn" onclick="sendAIMessage()" style="border-radius: 50%; width: 44px; height: 44px; padding: 0; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- صفحة تعليم الذكاء الاصطناعي -->
<div id="ai-training-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="backToProfile()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">تعليم الذكاء الاصطناعي</span>
    </div>
    
    <div class="posts-container">
        <div class="post">
            <div class="form-group">
                <label>الأوامر والمعلومات الجديدة</label>
                <textarea id="ai-training-text" class="form-control" rows="6" placeholder="أضف الأوامر أو المعلومات التي تريد أن يتعلمها الذكاء الاصطناعي..."></textarea>
            </div>
            
            <div class="form-group">
                <label>نوع المحتوى</label>
                <select id="ai-training-type" class="form-control">
                    <option value="command">أمر جديد</option>
                    <option value="information">معلومات</option>
                    <option value="response">نمط رد</option>
                </select>
            </div>
            
            <div class="post-actions">
                <button class="btn btn-success" onclick="saveAITraining()">
                    <i class="fas fa-save"></i> حفظ التعليمات
                </button>
            </div>
        </div>
        
        <div id="ai-training-list" style="margin-top: 20px;">
            <div class="post">
                <p style="text-align: center; color: var(--light-text);">جاري تحميل التعليمات...</p>
            </div>
        </div>
    </div>
</div>

<!-- صفحة العداد الدراسي -->
<div id="study-timer-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">العداد الدراسي</span>
    </div>
    
    <div class="posts-container">
        <div class="post" style="text-align: center; padding: 30px 20px;">
            <div id="study-timer-display" style="font-size: 48px; font-weight: 900; color: var(--primary-color); margin: 20px 0; font-family: monospace;">
                00:00:00
            </div>
            
            <div class="post-actions" style="justify-content: center; gap: 15px;">
                <button id="start-timer-btn" class="btn btn-success" onclick="startStudyTimer()">
                    <i class="fas fa-play"></i> بدء
                </button>
                <button id="pause-timer-btn" class="btn btn-warning" onclick="pauseStudyTimer()" disabled>
                    <i class="fas fa-pause"></i> إيقاف مؤقت
                </button>
                <button id="stop-timer-btn" class="btn btn-danger" onclick="stopStudyTimer()" disabled>
                    <i class="fas fa-stop"></i> انتهيت
                </button>
            </div>
            
            <div id="timer-stats" style="margin-top: 20px; padding: 15px; background: var(--sky); border-radius: 10px; display: none;">
                <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 10px;">إحصائيات الدراسة</div>
                <div id="session-time"></div>
                <div id="total-time"></div>
            </div>
        </div>
    </div>
</div>

<!-- صفحة القصائد -->
<div id="poems-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">القصائد</span>
        <button class="btn owner-only" onclick="openAddPoemModal()" style="display: none;">
            <i class="fas fa-plus"></i> إضافة
        </button>
    </div>
    
    <div class="posts-container">
        <div id="poems-list">
            <div class="post">
                <p style="text-align: center; color: var(--light-text);">جاري تحميل القصائد...</p>
            </div>
        </div>
    </div>
</div>

<!-- مشغل القصائد الثابت -->
<div id="audio-player" style="display: none; position: fixed; bottom: 70px; left: 15px; right: 15px; background: var(--gradient-primary); color: white; padding: 12px; border-radius: 12px; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
    <div style="display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <button class="btn btn-xs" onclick="toggleAudioPlayer()" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                <i class="fas fa-times"></i>
            </button>
            <div>
                <div id="now-playing" style="font-weight: 700; font-size: 14px;">جاري التشغيل...</div>
                <div id="player-controls" style="display: flex; align-items: center; gap: 8px; margin-top: 5px;">
                    <button class="btn btn-xs" onclick="togglePlayPause()" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                        <i class="fas fa-pause" id="play-pause-icon"></i>
                    </button>
                    <button class="btn btn-xs" onclick="toggleLoop()" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                        <i class="fas fa-redo" id="loop-icon"></i>
                    </button>
                    <button class="btn btn-xs" onclick="hideAudioPlayer()" style="background: rgba(255,255,255,0.2); color: white; border: none;">
                        <i class="fas fa-eye-slash"></i>
                    </button>
                </div>
            </div>
        </div>
        <audio id="poem-audio" style="display: none;"></audio>
    </div>
</div>

<!-- مودال إضافة قصيدة -->
<div id="add-poem-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>إضافة قصيدة جديدة</h2>
            <button class="close-modal" onclick="closeAddPoemModal()">&times;</button>
        </div>
        
        <div class="select-group">
            <label>اسم القصيدة</label>
            <input type="text" id="poem-title" class="form-control" placeholder="أدخل اسم القصيدة...">
        </div>
        
        <div class="select-group">
            <label>رابط اليوتيوب</label>
            <input type="text" id="poem-youtube-url" class="form-control" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddPoemModal()">إلغاء</button>
            <button class="btn btn-success" onclick="savePoem()">
                <i class="fas fa-save"></i> حفظ
            </button>
        </div>
    </div>
</div>
</div>
</div>

<!-- صفحة الواجبات اليومية -->
<div id="daily-tasks-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">الواجبات اليومية</span>
        <button class="btn" onclick="openAddTaskModal()">
            <i class="fas fa-plus"></i> إضافة واجب
        </button>
    </div>
    
    <div class="posts-container">
        <!-- إحصائيات الواجبات -->
        <div id="tasks-stats" class="post" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <div>
                    <div style="font-size: 24px; font-weight: 900;" id="total-tasks">0</div>
                    <div style="font-size: 13px;">إجمالي الواجبات</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 900;" id="completed-tasks">0</div>
                    <div style="font-size: 13px;">مكتملة</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: 900;" id="pending-tasks">0</div>
                    <div style="font-size: 13px;">قيد التنفيذ</div>
                </div>
            </div>
        </div>
        
        <!-- قائمة الواجبات -->
        <div id="tasks-list">
            <div class="post">
                <p style="text-align: center; color: var(--light-text);">لا توجد واجبات. أضف واجبك الأول!</p>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إضافة واجب جديدة -->
<div id="add-task-modal" class="modal">
    <div class="modal-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> إضافة واجب جديد</h2>
            <button class="close-modal" onclick="closeAddTaskModal()" style="color: white;">&times;</button>
        </div>
        
        <div class="select-group">
            <label>اسم الواجب</label>
            <input type="text" id="task-name" class="form-control" placeholder="مثل: حل تمارين الرياضيات" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
        </div>
        
        <div class="select-group">
            <label>وقت التحدي (ساعات)</label>
            <input type="number" id="task-hours" class="form-control" min="1" max="24" value="1" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
        </div>
        
        <div class="select-group">
            <label>وقت التحدي (دقائق)</label>
            <input type="number" id="task-minutes" class="form-control" min="0" max="59" value="0" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
        </div>
        
        <div class="select-group">
            <label>وقت التحدي (ثواني)</label>
            <input type="number" id="task-seconds" class="form-control" min="0" max="59" value="0" style="background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3);">
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddTaskModal()" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">إلغاء</button>
            <button class="btn btn-success" onclick="addNewTask()" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: #000;">
                <i class="fas fa-save"></i> إضافة الواجب
            </button>
        </div>
    </div>
</div>

<!-- نافذة تهنئة عند إكمال الواجب -->
<div id="congrats-modal" class="modal">
    <div class="modal-content" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000; text-align: center; border-radius: 20px; padding: 30px;">
        <div style="font-size: 80px; margin-bottom: 20px;">🎉</div>
        <h2 style="color: #000; margin-bottom: 15px;">مبروك! لقد أكملت الواجب بنجاح</h2>
        <div id="congrats-message" style="font-size: 18px; margin-bottom: 20px;"></div>
        <div style="font-size: 24px; font-weight: 900; margin-bottom: 20px;" id="time-saved"></div>
        <button class="btn" onclick="closeCongratsModal()" style="background: #000; color: #FFD700; padding: 12px 30px; font-weight: 900; border: none;">
            <i class="fas fa-check-circle"></i> ممتاز!
        </button>
    </div>
</div>

<!-- صفحة الجداول الدراسية الرئيسية - معدلة مع الأزرار الجديدة -->
<div id="study-schedules-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudyAssistantPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">الجداول الدراسية</span>
    </div>
    
    <div class="posts-container">
        <div class="profile-actions-card">
            <div class="profile-menu">
                <div class="menu-item" onclick="showDailySchedulePage()">
                    <i class="fas fa-calendar-day"></i>
                    <span>جدول يومي</span>
                </div>
                <div class="menu-item" onclick="openWeeklyScheduleModal()">
                    <i class="fas fa-calendar-week"></i>
                    <span>جدول أسبوعي</span>
                </div>
                <div class="menu-item" onclick="openAccumulativeScheduleModal()">
                    <i class="fas fa-layer-group"></i>
                    <span>جدول التراكمات</span>
                </div>
                <div class="menu-item" onclick="openReviewScheduleModal()">
                    <i class="fas fa-book-open"></i>
                    <span>جدول المراجعة</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إنشاء جدول يومي - معدلة -->
<div id="daily-schedule-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-calendar-day"></i> إنشاء جدول يومي جديد</h2>
            <button class="close-modal" onclick="closeDailyScheduleModal()">&times;</button>
        </div>
        
        <div class="select-group">
            <label>كم عدد المواد التي تريد دراستها يومياً؟ (1-9)</label>
            <input type="number" id="daily-subjects-count" class="form-control" min="1" max="9" value="3" onchange="generateDailySubjectFields()">
        </div>
        
        <div id="daily-subjects-container">
            <!-- سيتم توليد حقول المواد هنا -->
        </div>
        
        <div class="select-group">
            <label>كم ساعة تريد الدراسة يومياً؟</label>
            <input type="number" id="daily-study-hours" class="form-control" min="1" max="12" value="4">
        </div>
        
        <div class="select-group">
            <label>أي وقت تفضل القراءة؟ (يمكن اختيار أكثر من واحد)</label>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="study-time-preference" value="morning" checked>
                    <span>صباحاً (6 صباحاً - 12 ظهراً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="study-time-preference" value="afternoon">
                    <span>ظهراً (12 ظهراً - 4 عصراً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="study-time-preference" value="evening">
                    <span>مساءً (4 عصراً - 8 مساءً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="study-time-preference" value="night">
                    <span>ليلاً (8 مساءً - 12 ليلاً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="study-time-preference" value="anytime">
                    <span>في أي وقت</span>
                </label>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDailyScheduleModal()">إلغاء</button>
            <button class="btn btn-success" onclick="generateDailySchedule()">
                <i class="fas fa-magic"></i> إنشاء الجدول
            </button>
        </div>
    </div>
</div>

<!-- صفحة عرض الجدول اليومي - النسخة المعدلة -->
<div id="daily-schedule-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudySchedulesPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">جدولك اليومي</span>
        <button class="btn" onclick="openDailyScheduleModal()" style="margin-left: auto;">
            <i class="fas fa-redo"></i> جدول جديد
        </button>
    </div>
    
    <div class="posts-container">
        <!-- ستظهر الصورة هنا -->
        <div id="schedule-image-container" style="text-align: center; margin-bottom: 20px;">
            <!-- سيتم إنشاء الجدول كصورة هنا -->
        </div>
        
        <!-- أزرار التحكم -->
        <div class="post" style="background: var(--sky);">
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button id="save-schedule-btn" class="btn btn-success" onclick="saveScheduleAsImage()">
                    <i class="fas fa-download"></i> حفظ الجدول
                </button>
                <button id="rate-schedule-btn" class="btn btn-warning" onclick="rateSchedule()">
                    <i class="fas fa-star"></i> تقييم الجدول
                </button>
                <button id="share-schedule-btn" class="btn btn-primary" onclick="shareScheduleAsImage()">
                    <i class="fas fa-share-alt"></i> مشاركة الجدول
                </button>
            </div>
        </div>
        
        <!-- ختم التطبيق (سيظهر في الصورة فقط) -->
        <div id="schedule-stamp" style="display: none; text-align: center; margin-top: 20px; padding: 15px; border-top: 2px dashed var(--primary-color);">
            <div style="font-weight: 900; color: var(--primary-color); font-size: 18px; margin-bottom: 5px;">
                من تطبيق سوق الطلاب
            </div>
            <div style="color: var(--light-text); font-size: 14px;">
                تم الإنشاء: <span id="schedule-date"></span>
            </div>
        </div>
    </div>
</div>
       

<!-- نافذة إرسال التقييم - معدلة -->
<div id="rating-modal" class="modal">
    <div class="modal-content" style="background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #000;">
        <div class="modal-header">
            <h2><i class="fas fa-star"></i> تقييم الجدول</h2>
            <button class="close-modal" onclick="closeRatingModal()" style="color: #000;">&times;</button>
        </div>
        
        <div class="select-group">
            <label>كم نجمة تعطي لهذا الجدول؟</label>
            <div style="font-size: 32px; text-align: center; margin: 15px 0;" id="rating-stars-input">
                <span onclick="setRating(1)" style="cursor: pointer; margin: 0 5px;">☆</span>
                <span onclick="setRating(2)" style="cursor: pointer; margin: 0 5px;">☆</span>
                <span onclick="setRating(3)" style="cursor: pointer; margin: 0 5px;">☆</span>
                <span onclick="setRating(4)" style="cursor: pointer; margin: 0 5px;">☆</span>
                <span onclick="setRating(5)" style="cursor: pointer; margin: 0 5px;">☆</span>
            </div>
        </div>
        
        <div class="select-group">
            <label>رأيك حول الجدول (اختياري)</label>
            <textarea id="rating-comment" class="form-control" rows="4" placeholder="اكتب رأيك هنا..." style="background: rgba(255,255,255,0.9); color: #000;"></textarea>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeRatingModal()" style="background: rgba(0,0,0,0.2); color: #000;">إلغاء</button>
            <button class="btn" onclick="submitRating()" style="background: #000; color: #FFD700;">
                <i class="fas fa-paper-plane"></i> إرسال التقييم
            </button>
        </div>
    </div>
</div>

<!-- نافذة إنشاء جدول أسبوعي -->
<div id="weekly-schedule-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-calendar-week"></i> إنشاء جدول أسبوعي جديد</h2>
            <button class="close-modal" onclick="closeWeeklyScheduleModal()">&times;</button>
        </div>
        
        <div class="select-group">
            <label>كم عدد المواد التي تريد دراستها أسبوعياً؟ (1-12)</label>
            <input type="number" id="weekly-subjects-count" class="form-control" min="1" max="12" value="7" onchange="generateWeeklySubjectFields()">
        </div>
        
        <div id="weekly-subjects-container">
            <!-- سيتم توليد حقول المواد هنا -->
        </div>
        
        <div class="select-group">
            <label>كم مادة تريد دراستها يومياً؟ (2-6)</label>
            <input type="number" id="daily-subjects-limit" class="form-control" min="2" max="6" value="4">
        </div>
        
        <div class="select-group">
            <label>كم ساعة تريد الدراسة يومياً؟</label>
            <input type="number" id="weekly-study-hours" class="form-control" min="2" max="8" value="4">
        </div>
        
        <div class="select-group">
            <label>أي وقت تفضل القراءة؟ (يمكن اختيار أكثر من واحد)</label>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="weekly-study-time-preference" value="morning" checked>
                    <span>صباحاً (6 صباحاً - 12 ظهراً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="weekly-study-time-preference" value="afternoon">
                    <span>ظهراً (12 ظهراً - 4 عصراً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="weekly-study-time-preference" value="evening">
                    <span>مساءً (4 عصراً - 8 مساءً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="weekly-study-time-preference" value="night">
                    <span>ليلاً (8 مساءً - 12 ليلاً)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="weekly-study-time-preference" value="anytime">
                    <span>في أي وقت</span>
                </label>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeWeeklyScheduleModal()">إلغاء</button>
            <button class="btn btn-success" onclick="generateWeeklySchedule()">
                <i class="fas fa-magic"></i> إنشاء الجدول الأسبوعي
            </button>
        </div>
    </div>
</div>

<!-- صفحة عرض الجدول الأسبوعي -->
<div id="weekly-schedule-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudySchedulesPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">جدولك الأسبوعي</span>
        <button class="btn" onclick="openWeeklyScheduleModal()" style="margin-left: auto;">
            <i class="fas fa-redo"></i> جدول جديد
        </button>
    </div>
    
    <div class="posts-container">
        <!-- ستظهر الصورة هنا -->
        <div id="weekly-schedule-image-container" style="text-align: center; margin-bottom: 20px;">
            <!-- سيتم إنشاء الجدول كصورة هنا -->
        </div>
        
        <!-- أزرار التحكم -->
        <div class="post" style="background: var(--sky);">
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button id="save-weekly-schedule-btn" class="btn btn-success" onclick="saveWeeklyScheduleAsImage()">
                    <i class="fas fa-download"></i> حفظ الجدول
                </button>
                <button id="rate-weekly-schedule-btn" class="btn btn-warning" onclick="rateWeeklySchedule()">
                    <i class="fas fa-star"></i> تقييم الجدول
                </button>
                <button id="share-weekly-schedule-btn" class="btn btn-primary" onclick="shareWeeklyScheduleAsImage()">
                    <i class="fas fa-share-alt"></i> مشاركة الجدول
                </button>
            </div>
        </div>
        
        <!-- ختم التطبيق (سيظهر في الصورة فقط) -->
        <div id="weekly-schedule-stamp" style="display: none; text-align: center; margin-top: 20px; padding: 15px; border-top: 2px dashed var(--primary-color);">
            <div style="font-weight: 900; color: var(--primary-color); font-size: 18px; margin-bottom: 5px;">
                من تطبيق سوق الطلاب - جدول أسبوعي
            </div>
            <div style="color: var(--light-text); font-size: 14px;">
                تم الإنشاء: <span id="weekly-schedule-date"></span>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إنشاء جدول التراكمات -->
<div id="accumulative-schedule-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-layer-group"></i> إنشاء جدول التراكمات</h2>
            <button class="close-modal" onclick="closeAccumulativeScheduleModal()">&times;</button>
        </div>
        
        <div class="select-group">
            <label>كم عدد المواد المتراكمة لديك؟ (1-10)</label>
            <input type="number" id="accumulative-subjects-count" class="form-control" min="1" max="10" value="4" onchange="generateAccumulativeSubjectFields()">
        </div>
        
        <div id="accumulative-subjects-container">
            <!-- سيتم توليد حقول المواد هنا -->
        </div>
        
        <div class="select-group">
            <label>كم ساعة يومياً تخصص للتراكمات؟</label>
            <input type="number" id="accumulative-study-hours" class="form-control" min="1" max="6" value="3">
        </div>
        
        <div class="select-group">
            <label>في كم يوم تريد إنهاء التراكمات؟ (7-60 يوم)</label>
            <input type="number" id="accumulative-days" class="form-control" min="7" max="60" value="20">
        </div>
        
        <div class="select-group">
            <label>أي وقت تفضل القراءة للتراكمات؟</label>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="accumulative-study-time-preference" value="morning" checked>
                    <span>صباحاً</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="accumulative-study-time-preference" value="afternoon">
                    <span>ظهراً</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="accumulative-study-time-preference" value="evening">
                    <span>مساءً</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="accumulative-study-time-preference" value="night">
                    <span>ليلاً</span>
                </label>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAccumulativeScheduleModal()">إلغاء</button>
            <button class="btn btn-success" onclick="generateAccumulativeSchedule()">
                <i class="fas fa-bolt"></i> إنشاء جدول التراكمات
            </button>
        </div>
    </div>
</div>

<!-- صفحة عرض جدول التراكمات -->
<div id="accumulative-schedule-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudySchedulesPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">جدول التراكمات</span>
        <button class="btn" onclick="openAccumulativeScheduleModal()" style="margin-left: auto;">
            <i class="fas fa-redo"></i> جدول جديد
        </button>
    </div>
    
    <div class="posts-container">
        <!-- ستظهر الصورة هنا -->
        <div id="accumulative-schedule-image-container" style="text-align: center; margin-bottom: 20px;">
            <!-- سيتم إنشاء الجدول كصورة هنا -->
        </div>
        
        <!-- أزرار التحكم -->
        <div class="post" style="background: var(--sky);">
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button id="save-accumulative-schedule-btn" class="btn btn-success" onclick="saveAccumulativeScheduleAsImage()">
                    <i class="fas fa-download"></i> حفظ الجدول
                </button>
                <button id="rate-accumulative-schedule-btn" class="btn btn-warning" onclick="rateAccumulativeSchedule()">
                    <i class="fas fa-star"></i> تقييم الجدول
                </button>
                <button id="share-accumulative-schedule-btn" class="btn btn-primary" onclick="shareAccumulativeScheduleAsImage()">
                    <i class="fas fa-share-alt"></i> مشاركة الجدول
                </button>
            </div>
        </div>
        
        <!-- ختم التطبيق -->
        <div id="accumulative-schedule-stamp" style="display: none; text-align: center; margin-top: 20px; padding: 15px; border-top: 2px dashed var(--primary-color);">
            <div style="font-weight: 900; color: var(--primary-color); font-size: 18px; margin-bottom: 5px;">
                من تطبيق سوق الطلاب - جدول التراكمات
            </div>
            <div style="color: var(--light-text); font-size: 14px;">
                تم الإنشاء: <span id="accumulative-schedule-date"></span>
            </div>
        </div>
    </div>
</div>

<!-- نافذة إنشاء جدول المراجعة -->
<div id="review-schedule-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-book-open"></i> إنشاء جدول المراجعة النهائية</h2>
            <button class="close-modal" onclick="closeReviewScheduleModal()">&times;</button>
        </div>
        
        <div class="select-group">
            <label>كم عدد المواد التي تريد مراجعتها؟ (1-12)</label>
            <input type="number" id="review-subjects-count" class="form-control" min="1" max="12" value="8" onchange="generateReviewSubjectFields()">
        </div>
        
        <div id="review-subjects-container">
            <!-- سيتم توليد حقول المواد هنا -->
        </div>
        
        <div class="select-group">
            <label>كم ساعة يومياً تخصص للمراجعة؟</label>
            <input type="number" id="review-study-hours" class="form-control" min="2" max="8" value="5">
        </div>
        
        <div class="select-group">
            <label>كم يوم بقي للامتحانات؟ (7-120 يوم)</label>
            <input type="number" id="review-days-left" class="form-control" min="7" max="120" value="80">
        </div>
        
        <div class="select-group">
            <label>أي وقت تفضل المراجعة؟</label>
            <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="review-study-time-preference" value="morning" checked>
                    <span>صباحاً (أفضل للتركيز)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="review-study-time-preference" value="afternoon">
                    <span>ظهراً</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="review-study-time-preference" value="evening">
                    <span>مساءً (أفضل للحفظ)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" name="review-study-time-preference" value="anytime">
                    <span>في أي وقت</span>
                </label>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeReviewScheduleModal()">إلغاء</button>
            <button class="btn btn-success" onclick="generateReviewSchedule()">
                <i class="fas fa-graduation-cap"></i> إنشاء جدول المراجعة
            </button>
        </div>
    </div>
</div>

<!-- صفحة عرض جدول المراجعة -->
<div id="review-schedule-page" class="container page" style="display:none">
    <div class="header">
        <button class="btn btn-secondary" onclick="showStudySchedulesPage()">
            <i class="fas fa-arrow-right"></i>
        </button>
        <span style="font-weight:900">جدول المراجعة النهائية</span>
        <button class="btn" onclick="openReviewScheduleModal()" style="margin-left: auto;">
            <i class="fas fa-redo"></i> جدول جديد
        </button>
    </div>
    
    <div class="posts-container">
        <!-- ستظهر الصورة هنا -->
        <div id="review-schedule-image-container" style="text-align: center; margin-bottom: 20px;">
            <!-- سيتم إنشاء الجدول كصورة هنا -->
        </div>
        
        <!-- أزرار التحكم -->
        <div class="post" style="background: var(--sky);">
            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button id="save-review-schedule-btn" class="btn btn-success" onclick="saveReviewScheduleAsImage()">
                    <i class="fas fa-download"></i> حفظ الجدول
                </button>
                <button id="rate-review-schedule-btn" class="btn btn-warning" onclick="rateReviewSchedule()">
                    <i class="fas fa-star"></i> تقييم الجدول
                </button>
                <button id="share-review-schedule-btn" class="btn btn-primary" onclick="shareReviewScheduleAsImage()">
                    <i class="fas fa-share-alt"></i> مشاركة الجدول
                </button>
            </div>
        </div>
        
        <!-- ختم التطبيق -->
        <div id="review-schedule-stamp" style="display: none; text-align: center; margin-top: 20px; padding: 15px; border-top: 2px dashed var(--primary-color);">
            <div style="font-weight: 900; color: var(--primary-color); font-size: 18px; margin-bottom: 5px;">
                من تطبيق سوق الطلاب - جدول المراجعة النهائية
            </div>
            <div style="color: var(--light-text); font-size: 14px;">
                تم الإنشاء: <span id="review-schedule-date"></span>
            </div>
        </div>
    </div>
</div>


<script>
const firebaseConfig = {
  apiKey: "AIzaSyBkoSz3ZUy4qKBTeLx42Oo-TlTtvFtF2vY",
  authDomain: "we-kill-the-sixth.firebaseapp.com",
  databaseURL: "https://we-kill-the-sixth-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "we-kill-the-sixth",
  storageBucket: "we-kill-the-sixth.firebasestorage.app",
  messagingSenderId: "862363949793",
  appId: "1:862363949793:web:e0dc01a4eb139da43f75a0",
  measurementId: "G-CT6WFGXRHH"
};

let db, auth, storage;
try {
  firebase.initializeApp(firebaseConfig);
  console.log("✅ Firebase initialized successfully");
  
  db = firebase.firestore();
  auth = firebase.auth();
  storage = firebase.storage();
  
  firebase.firestore().enablePersistence()
    .then(() => console.log("✅ Firestore persistence enabled"))
    .catch(err => console.log("❌ Firestore persistence error:", err));
    
} catch (error) {
  console.error("❌ Firebase initialization failed:", error);
  setTimeout(() => {
    const loadingText = document.getElementById('loading-text');
    if (loadingText) {
      loadingText.innerHTML = 'خطأ في الاتصال بقاعدة البيانات<br><small>تحقق من اتصال الإنترنت</small>';
      loadingText.style.color = '#ff6b6b';
    }
  }, 4000);
}

const APP_OWNER_EMAIL = "mslmalmyaly223@gmail.com";

let currentUser = null;
let posts = [];
let companies = [];
let activeSection = "posts";
let currentDetailsPostId = null;
let currentCommentsPostId = null;
const userMetaCache = {};
let lastBroadcast = null;
let isFirstLoginSession = false;

let unreadNotifications = { inbox: 0, newPosts: 0 };
let unreadPostsCount = 0;
let notificationsListener = null;
let postsListener = null;

let registerAvatarBase64 = null;

let pages = {};

function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  const themeIcon = document.querySelector('.theme-toggle-btn i');
  if (themeIcon) {
    themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
  
  showNotification(newTheme === 'dark' ? 'تم تفعيل الوضع الليلي' : 'تم تفعيل الوضع النهاري');
}

function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  const themeIcon = document.querySelector('.theme-toggle-btn i');
  if (themeIcon) {
    themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }
}

function previewRegisterAvatar(event) {
  const file = event.target.files[0];
  const preview = document.getElementById('register-avatar-preview');
  
  if (file) {
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    const maxSize = 2 * 1024 * 1024;
    
    if (!validTypes.includes(file.type)) {
      showNotification('نوع الملف غير مدعوم');
      return;
    }
    
    if (file.size > maxSize) {
      showNotification('حجم الملف كبير جداً');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
      preview.src = e.target.result;
      preview.style.display = 'block';
      registerAvatarBase64 = e.target.result;
    }
    reader.readAsDataURL(file);
  }
}

function openImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'block';
    document.getElementById('avatar-upload-input').value = '';
    document.getElementById('avatar-preview').style.display = 'none';
    document.getElementById('upload-avatar-btn').disabled = true;
}

function closeImageUploadModal() {
    document.getElementById('image-upload-modal').style.display = 'none';
}

function initializeImageUpload() {
    const uploadInput = document.getElementById('avatar-upload-input');
    if (uploadInput) {
        uploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('avatar-preview');
            const previewImg = document.getElementById('avatar-preview-img');
            const uploadBtn = document.getElementById('upload-avatar-btn');
            
            if (file) {
                const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                const maxSize = 2 * 1024 * 1024;
                
                if (!validTypes.includes(file.type)) {
                    showNotification('نوع الملف غير مدعوم');
                    return;
                }
                
                if (file.size > maxSize) {
                    showNotification('حجم الملف كبير جداً');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                    uploadBtn.disabled = false;
                }
                reader.readAsDataURL(file);
            }
        });
    }
}

async function uploadAvatar() {
    const fileInput = document.getElementById('avatar-upload-input');
    const file = fileInput.files[0];
    
    if (!file || !currentUser) return;
    
    const uploadBtn = document.getElementById('upload-avatar-btn');
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'جاري الحفظ...';
    
    try {
        const compressedImage = await compressImage(file);
        
        await db.collection('users').doc(currentUser.uid).update({
            avatarBase64: compressedImage,
            avatarUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        currentUser.avatarBase64 = compressedImage;
        updateAvatarDisplay();
        
        showNotification('تم حفظ الصورة بنجاح!');
        closeImageUploadModal();
        
    } catch (error) {
        console.error('خطأ في الرفع:', error);
        showNotification('فشل حفظ الصورة');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'رفع الصورة';
    }
}

function compressImage(file, maxWidth = 200, quality = 0.7) {
  return new Promise((resolve, reject) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      let width = img.width;
      let height = img.height;
      
      if (width > maxWidth) {
        height = (height * maxWidth) / width;
        width = maxWidth;
      }
      
      canvas.width = width;
      canvas.height = height;
      
      ctx.drawImage(img, 0, 0, width, height);
      
      const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
      resolve(compressedBase64);
    };
    
    img.onerror = reject;
    img.src = URL.createObjectURL(file);
  });
}

function updateAvatarDisplay() {
  const avatarElement = document.getElementById('avatar');
  if (!avatarElement) return;
  
  if (currentUser.avatarBase64) {
    avatarElement.innerHTML = `<img src="${currentUser.avatarBase64}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
  } else {
    const emoji = currentUser.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    avatarElement.innerHTML = `<div style="width:100%;height:100%;font-size:40px;line-height:72px">${emoji}</div>`;
  }
}

async function getUserAvatarUrl(uid) {
  try {
    const userDoc = await db.collection('users').doc(uid).get();
    if (userDoc.exists) {
      const userData = userDoc.data();
      return userData.avatarBase64 || null;
    }
  } catch (error) {
    console.error('Error getting user avatar:', error);
  }
  return null;
}

function showNotification(msg, type = "success") {
  const n = document.getElementById("notification");
  n.textContent = msg;
  n.style.display = "block";
  const colors = { error: 'var(--danger-color)', warning: 'var(--warning-color)', info: 'var(--primary-color)', success: 'var(--success-color)' };
  n.style.backgroundColor = colors[type] || colors.success;
  clearTimeout(n._t);
  n._t = setTimeout(() => { n.style.display = "none"; }, 2600);
}

function escapeHTML(s = '') {
  return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));
}

function validateEmail(email) {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(email).toLowerCase());
}

function formatWhatsApp(v) {
  let num = (v || "").toString().replace(/[^\d]/g, "");
  if (num.startsWith('07') && num.length === 11) { return '964' + num.substring(1); }
  if (num.startsWith('96407') && num.length === 14) { return '964' + num.substring(4); }
  return num;
}

function sanitizeTelegram(v) {
  return (v || "").toString().replace(/^@+/, "").trim();
}

function openTelegram(username) {
  username = sanitizeTelegram(username);
  if (!username) return;
  window.open("https://t.me/" + username, '_blank');
}

function openWhatsApp(number) {
  if (!number) return;
  window.open("https://wa.me/" + number, '_blank');
}

function copyUidToClipboard() {
  const el = document.getElementById('profile-uid-input');
  if (!el) return;
  el.select();
  el.setSelectionRange(0, 99999);
  document.execCommand('copy');
  showNotification('تم النسخ');
}

function isOwner() {
  return currentUser && (currentUser.email === APP_OWNER_EMAIL);
}

function generateShortUid(uid) {
  if (!uid) return '';
  let hash = 0;
  for (let i = 0; i < uid.length; i++) {
    hash = ((hash << 5) - hash) + uid.charCodeAt(i);
    hash = hash & hash;
  }
  return Math.abs(hash).toString(36).substring(0, 5).toUpperCase();
}

function formatPriceWithZeros(price) {
  const num = Number(price);
  if (isNaN(num)) return '0';
  
  if (num < 1000 && num > 0) {
    return num.toString() + '000'.slice(num.toString().length);
  }
  
  return num.toString();
}

(function(){
  const lastDelay = 0.45, runDur = 0.8, mergeDelay = lastDelay + runDur + .10;
  document.getElementById('final-logo').style.setProperty('--merge-delay', mergeDelay + 's');
  
  setTimeout(() => { 
    document.querySelector('.runner')?.remove(); 
    
    setTimeout(() => {
      const loadingText = document.getElementById('loading-text');
      if (loadingText) {
        loadingText.style.display = 'block';
        loadingText.classList.add('show');
      }
    }, 300);
    
  }, (mergeDelay + 0.4) * 1000);
})();

function hideSplashAfterLoad() {
  const splash = document.getElementById('splash');
  if (splash) {
    splash.classList.add('fade-out');
    setTimeout(() => {
      splash.remove();
    }, 600);
  }
}

function updateLoadingText(text) {
  const loadingText = document.getElementById('loading-text');
  if (loadingText) {
    loadingText.textContent = text;
    loadingText.style.display = 'block';
    loadingText.classList.add('show');
  }
}

function handleAuthError(error) {
  const code = (error && error.code) || '';
  const msg = (error && error.message) ? String(error.message) : '';
  let friendly = 'خطأ مصادقة.';
  if (code === 'auth/user-not-found' || code === 'auth/wrong-password' || msg.includes('INVALID_LOGIN_CREDENTIALS')) {
    friendly = 'البريد الإلكتروني أو كلمة المرور غير صحيحة.';
  } else if (code === 'auth/invalid-email') {
    friendly = 'صيغة البريد الإلكتروني غير صحيحة.';
  } else if (code === 'auth/network-request-failed') {
    friendly = 'تحقّق من اتصال الإنترنت.';
  } else if (code === 'auth/too-many-requests') {
    friendly = 'محاولات كثيرة. حاول لاحقًا.';
  } else if (code === 'auth/email-already-in-use') {
    friendly = 'هذا البريد مسجّل مسبقًا.';
  }
  showNotification(friendly, 'error');
}

async function register() {
  const name = document.getElementById("register-name").value.trim();
  const email = document.getElementById("register-email").value.trim().toLowerCase();
  const password = document.getElementById("register-password").value;
  
  if (!name || !email || !password) return showNotification("يرجى ملء جميع الحقول", "error");
  if (!validateEmail(email)) return showNotification("البريد الإلكتروني غير صالح", "error");
  
  const btn = document.getElementById("register-submit");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري إنشاء الحساب...';
  
  try {
    updateLoadingText('جاري إنشاء الحساب...');
    
    const cred = await auth.createUserWithEmailAndPassword(email, password);
    const shortUid = generateShortUid(cred.user.uid);
    
    updateLoadingText('جاري حفظ بياناتك...');
    
    const userData = {
      name, email, 
      avatar: 'male',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      isVerified: false, 
      isOwner: false, 
      blockedFromPosting: false,
      lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
      shortUid: shortUid
    };
    
    if (registerAvatarBase64) {
      userData.avatarBase64 = registerAvatarBase64;
    }
    
    await db.collection("users").doc(cred.user.uid).set(userData, { merge: true });
    
    showNotification("🎉 تم إنشاء حسابك بنجاح!");
    switchAuthTab('login');
    
    registerAvatarBase64 = null;
    document.getElementById('register-avatar-preview').style.display = 'none';
    
  } catch (error) {
    handleAuthError(error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

async function login() {
  const email = document.getElementById("login-email").value.trim();
  const password = document.getElementById("login-password").value;
  if (!email || !password) return showNotification("يرجى ملء جميع الحقول", "error");
  
  const btn = document.querySelector('#login-form button[type="submit"]');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تسجيل الدخول…';
  
  try {
    updateLoadingText('جاري تسجيل الدخول...');
    await auth.signInWithEmailAndPassword(email, password);
  } catch (error) {
    handleAuthError(error);
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function logout() {
  const keysToRemove = [];
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key.includes('_cache') || key.includes('_time')) {
      keysToRemove.push(key);
    }
  }
  
  keysToRemove.forEach(key => {
    localStorage.removeItem(key);
  });
  
  stopAllListeners();
  auth.signOut();
}

auth.onAuthStateChanged(async (user) => {
  console.log("🔐 Auth state changed:", user ? "User logged in" : "No user");
  
  const isConnected = await checkFirebaseConnection();
  if (!isConnected) {
    console.log("❌ Cannot proceed - Firebase not connected");
    updateLoadingText("فشل الاتصال بالخادم - تحقق من الإنترنت");
    setTimeout(hideSplashAfterLoad, 2000);
    return;
  }
  
  if (!user) {
    console.log("👤 No user - showing auth page");
    updateUIForLoggedOutUser();
    hideSplashAfterLoad();
    return;
  }
  
  try {
    console.log("👤 Loading user data...");
    updateLoadingText('جاري تحميل بيانات الحساب...');
    
    let doc = await db.collection("users").doc(user.uid).get();
    
    if (!doc.exists) {
      console.log("🆕 New user - creating profile");
      isFirstLoginSession = true;
      const shortUid = generateShortUid(user.uid);
      await db.collection("users").doc(user.uid).set({
        name: user.displayName || user.email.split("@")[0],
        email: user.email,
        avatar: 'male',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        isVerified: false, isOwner: false, blockedFromPosting: false,
        lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
        shortUid: shortUid
      }, { merge: true });
      doc = await db.collection("users").doc(user.uid).get();
    } else {
      isFirstLoginSession = false;
      db.collection("users").doc(user.uid).update({
        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(console.error);
    }
    
    currentUser = { uid: user.uid, ...doc.data() };
    
    if (doc.data().avatarBase64) {
      currentUser.avatarBase64 = doc.data().avatarBase64;
    }
    
    console.log("✅ User data loaded:", currentUser.name);
    
    updateUIForLoggedInUser();
    
    console.log("📥 Loading posts and companies...");
    updateLoadingText('جاري تحميل المنشورات...');
    
    await Promise.all([
      loadPostsFromFirestore(), 
      loadCompanies(), 
      fetchLatestBroadcast()
    ]);
    
    startAllListeners();
    
    console.log("✅ All data loaded successfully");
    hideSplashAfterLoad();
    
  } catch (e) {
    console.error("❌ Error in auth state change:", e);
    showNotification("خطأ في تحميل البيانات", "error");
    hideSplashAfterLoad();
  }
});

function initializePages() {
  pages = {
    auth: document.getElementById("auth-page"),
    main: document.getElementById("main-page"),
    profile: document.getElementById("profile-page"),
    userPosts: document.getElementById("user-posts-page"),
    inbox: document.getElementById("inbox-page"),
    details: document.getElementById("details-page"),
    comments: document.getElementById("comments-page"),
    userStatistics: document.getElementById("user-statistics-page"),
    adminPanel: document.getElementById("admin-panel-page"),
    userManagement: document.getElementById("user-management-page"),
    broadcastPanel: document.getElementById("broadcast-panel-page"),
    privacyPolicy: document.getElementById("privacy-policy-page"),
    support: document.getElementById("support-page"),
    userSupport: document.getElementById("user-support-page"), 
    "study-assistant": document.getElementById("study-assistant-page"),
    "ai-chat-page": document.getElementById("ai-chat-page"),
    "study-timer-page": document.getElementById("study-timer-page"),
    "poems-page": document.getElementById("poems-page"),
    "ai-training-page": document.getElementById("ai-training-page"),
    "daily-tasks": document.getElementById("daily-tasks-page"),
    "study-schedules": document.getElementById("study-schedules-page"),
    "daily-schedule": document.getElementById("daily-schedule-page"),
    // تم حذف الصفحات الأخرى
  };
}

function showPage(key) {
  if (Object.keys(pages).length === 0) {
    initializePages();
  }
  
  Object.values(pages).forEach(p => p && (p.style.display = "none"));
  if (!pages[key]) {
    console.error("❌ Page not found:", key);
    return;
  }
  pages[key].style.display = (key === "auth") ? "flex" : "block";
  updateBottomNav(key);
  updateAllBadges();
  
  const helpBtn = document.getElementById('help-floating-btn');
  if (helpBtn) {
    helpBtn.style.display = (key === "auth") ? 'flex' : 'none';
  }
  
  if (key === "userSupport") {
    loadUserSupportRequests();
  }
  
  if (key === "ai-chat-page") {
    initializeAIChat();
  }
}

function updateBottomNav(activePageKey) {
  document.querySelectorAll("#bottom-nav .nav-item").forEach(item => {
    item.classList.toggle("active", item.dataset.page === activePageKey);
  });
}

function showMainPageAndClearBadge() {
  clearPostsBadge();
  showPage("main");
}

function showMainPage() {
  showPage("main");
}

function showInbox() {
  if (!currentUser) return showNotification('سجّل الدخول', 'warning');
  showPage('inbox');
}

function showProfilePage() {
  showPage("profile");
}

function backToProfile() {
  showPage("profile");
}

function backToMainFromDetails() {
  showPage("main");
}

function backToMainFromComments() {
  showPage("main");
}

function backToAdminPanel() {
  showPage("adminPanel");
}

function switchAuthTab(tab) {
  document.querySelectorAll(".auth-tab, .auth-form").forEach(el => el.classList.remove("active"));
  if (tab === "login") {
    document.querySelector(".auth-tab:nth-child(1)").classList.add("active");
    document.getElementById("login-form").classList.add("active");
  } else {
    document.querySelector(".auth-tab:nth-child(2)").classList.add("active");
    document.getElementById("register-form").classList.add("active");
  }
}

function updateUIForLoggedInUser() {
  showPage("main");
  
  document.getElementById("profile-name").textContent = currentUser.name || "";
  document.getElementById("profile-email").textContent = currentUser.email || "";
  const shortUid = currentUser.shortUid || generateShortUid(currentUser.uid);
  document.getElementById("profile-uid-input").value = shortUid || "";
  
  updateAvatarDisplay();
  
  const pv = document.getElementById("profile-verified");
  pv.innerHTML = currentUser.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : '';
  document.querySelectorAll(".owner-only").forEach(el => el.style.display = isOwner() ? "flex" : "none");

  updateCreateButton();
  updatePostCountInProfile();
  updateNavBadges();
}

function updateUIForLoggedOutUser() {
  showPage("auth");
  if (window.postsContainer) window.postsContainer.innerHTML = "";
  if (window.companiesContainer) window.companiesContainer.innerHTML = "";
  posts = [];
  companies = [];
  currentUser = null;
  document.getElementById("broadcast-banner")?.classList.remove('show');
  document.getElementById("broadcast-overlay")?.classList.remove('show');
}

async function showPrivacyPolicy() {
  showPage("privacyPolicy");
  
  try {
    const response = await fetch('https://mslmalmyaly223-sudo.github.io/alntr/');
    const html = await response.text();
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    const bodyContent = tempDiv.querySelector('body') || tempDiv;
    
    const cleanContent = bodyContent.innerHTML
      .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
      .replace(/<style\b[^<]*(?:(?!<\/style>)<[^<]*)*<\/style>/gi, '')
      .replace(/<link[^>]*>/gi, '')
      .replace(/<meta[^>]*>/gi, '')
      .replace(/href="[^"]*"/g, 'href="#"')
      .replace(/src="[^"]*"/g, 'src="#"');
    
    document.getElementById('privacy-content').innerHTML = cleanContent;
    
  } catch (error) {
    console.error('Error loading privacy policy:', error);
    document.getElementById('privacy-content').innerHTML = `
      <div class="post">
        <p>تعذر تحميل سياسة الخصوصية.</p>
      </div>
    `;
  }
}

async function showUserStatistics() {
  showPage("userStatistics");
  await loadUserStatistics();
}

async function loadUserStatistics() {
  const statsGrid = document.getElementById("stats-grid");
  if (!statsGrid) return;

  statsGrid.innerHTML = `
    <div class="stat-card">
      <div class="stat-icon">👥</div>
      <div class="stat-number" id="total-users">0</div>
      <div class="stat-label">إجمالي المستخدمين</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">🟢</div>
      <div class="stat-number" id="active-now">0</div>
      <div class="stat-label">نشطين الآن</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">📅</div>
      <div class="stat-number" id="active-today">0</div>
      <div class="stat-label">نشطين اليوم</div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">📝</div>
      <div class="stat-number" id="total-posts">0</div>
      <div class="stat-label">إجمالي المنشورات</div>
    </div>
  `;

  try {
    const usersSnapshot = await db.collection("users").get();
    const totalUsers = usersSnapshot.size;
    document.getElementById("total-users").textContent = totalUsers;

    const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
    let activeNow = 0;
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const lastSeen = userData.lastSeen?.toDate?.();
      if (lastSeen && lastSeen > fiveMinutesAgo) {
        activeNow++;
      }
    });
    document.getElementById("active-now").textContent = activeNow;

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    let activeToday = 0;
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const lastSeen = userData.lastSeen?.toDate?.();
      if (lastSeen && lastSeen > today) {
        activeToday++;
      }
    });
    document.getElementById("active-today").textContent = activeToday;

    const postsSnapshot = await db.collection("posts").get();
    document.getElementById("total-posts").textContent = postsSnapshot.size;

  } catch (error) {
    console.error("Error loading statistics:", error);
    showNotification("خطأ في تحميل الإحصائيات", "error");
  }
}

function showSupportPage() {
  showPage("support");
}

function contactTelegram() {
  window.open("https://t.me/mslmh19", "_blank");
}

function openSuggestionModal() {
  document.getElementById('suggestion-modal').style.display = 'block';
}

function closeSuggestionModal() {
  document.getElementById('suggestion-modal').style.display = 'none';
}

async function sendSuggestion() {
  if (!currentUser) return showNotification('يرجى تسجيل الدخول أولاً', 'error');
  
  const type = document.getElementById('suggestion-type').value;
  const message = document.getElementById('suggestion-message').value.trim();
  
  if (!message) {
    return showNotification('يرجى كتابة وصف المشكلة أو الاقتراح', 'error');
  }
  
  const btn = document.querySelector('#suggestion-modal .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  
  try {
    const ownerQuery = await db.collection('users')
      .where('email', '==', APP_OWNER_EMAIL)
      .limit(1)
      .get();
    
    if (ownerQuery.empty) return;
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    
    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'support_request',
      supportType: type,
      title: type === 'problem' ? '🚨 مشكلة جديدة' : '💡 اقتراح جديد',
      message: `👤 المستخدم: ${currentUser.name || 'مستخدم'}\n📧 البريد: ${currentUser.email}\n🆔 المعرف: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}\n📝 النوع: ${type === 'problem' ? 'مشكلة' : 'اقتراح'}\n💬 الرسالة: ${message}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      userUid: currentUser.uid,
      userName: currentUser.name
    });
    
    showNotification('تم إرسال رسالتك بنجاح');
    closeSuggestionModal();
    
  } catch (error) {
    console.error('Error sending suggestion:', error);
    showNotification('فشل إرسال الرسالة', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function showAdminPanel() {
  if (!isOwner()) return showNotification('للمالك فقط', 'error');
  showPage("adminPanel");
}

async function showUserManagement() {
  if (!isOwner()) return;
  showPage("userManagement");
  document.getElementById("user-management-results").innerHTML = '<div class="post"><p>استخدم مربع البحث للعثور على المستخدمين</p></div>';
}

async function searchUsers() {
  if (!isOwner()) return;
  
  const searchTerm = document.getElementById("user-search-input").value.trim().toLowerCase();
  if (!searchTerm) {
    showNotification("يرجى إدخال مصطلح البحث", "error");
    return;
  }

  const resultsContainer = document.getElementById("user-management-results");
  resultsContainer.innerHTML = '<div class="post"><p>جاري البحث...</p></div>';

  try {
    const usersSnapshot = await db.collection("users").get();
    const filteredUsers = [];

    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      const userEmail = userData.email?.toLowerCase() || '';
      const userId = doc.id.toLowerCase();
      const shortUid = userData.shortUid?.toLowerCase() || '';
      
      if (userEmail.includes(searchTerm) || userId.includes(searchTerm) || shortUid.includes(searchTerm)) {
        filteredUsers.push({ id: doc.id, ...userData });
      }
    });

    if (filteredUsers.length === 0) {
      resultsContainer.innerHTML = '<div class="post"><p>لا توجد نتائج</p></div>';
      return;
    }

    resultsContainer.innerHTML = filteredUsers.map(user => `
      <div class="post user-management-item">
        <div class="user-info">
          <div class="avatar" style="background: ${user.avatar === 'female' ? '#ffd7ea' : '#d7e4ff'}; width: 40px; height: 40px; font-size: 20px;">
            ${user.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼'}
          </div>
          <div class="user-details">
            <div class="user-name">${escapeHTML(user.name || 'مستخدم')}</div>
            <div class="user-email">${escapeHTML(user.email || '')}</div>
            <div class="user-id">ID: ${user.shortUid || user.id.substring(0, 8)}</div>
            <div class="user-status ${user.blockedFromPosting ? 'banned' : 'active'}">
              ${user.blockedFromPosting ? '🚫 محظور' : '✅ نشط'}
            </div>
          </div>
        </div>
        <div class="user-actions">
          <button class="btn ${user.blockedFromPosting ? 'btn-success' : 'btn-danger'} btn-xs" 
                  onclick="toggleUserBan('${user.id}', ${user.blockedFromPosting})">
            <i class="fas fa-${user.blockedFromPosting ? 'check' : 'ban'}"></i>
            ${user.blockedFromPosting ? 'فك الحظر' : 'حظر المستخدم'}
          </button>
        </div>
      </div>
    `).join('');

  } catch (error) {
    console.error("Error searching users:", error);
    resultsContainer.innerHTML = '<div class="post"><p>خطأ في البحث</p></div>';
  }
}

async function toggleUserBan(userId, isCurrentlyBanned) {
  if (!isOwner()) return;
  
  const action = isCurrentlyBanned ? 'فك الحظر' : 'الحظر';
  if (!confirm(`هل أنت متأكد من ${action} هذا المستخدم؟`)) return;

  try {
    await db.collection("users").doc(userId).update({
      blockedFromPosting: !isCurrentlyBanned,
      banUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showNotification(`تم ${action} المستخدم بنجاح`);
    setTimeout(() => searchUsers(), 1000);
  } catch (error) {
    console.error("Error toggling user ban:", error);
    showNotification("فشل في تنفيذ العملية", "error");
  }
}

function showBroadcastPanel() {
  if (!isOwner()) return;
  showPage("broadcastPanel");
}

async function sendBroadcast() {
  if (!isOwner()) return;
  
  const title = document.getElementById("broadcast-title").value.trim();
  const message = document.getElementById("broadcast-message").value.trim();
  
  if (!title || !message) {
    showNotification("يرجى ملء جميع الحقول", "error");
    return;
  }

  const btn = document.querySelector('#broadcast-panel-page .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';

  try {
    await db.collection("broadcasts").add({
      title: title,
      message: message,
      text: message,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      sentBy: currentUser.uid,
      sentByName: currentUser.name
    });

    showNotification("تم إرسال الإشعار بنجاح");
    
    document.getElementById("broadcast-title").value = "";
    document.getElementById("broadcast-message").value = "";
    
  } catch (error) {
    console.error("Error sending broadcast:", error);
    showNotification("فشل في إرسال الإشعار", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function showUserSupportPage() {
  if (!isOwner()) return;
  showPage("userSupport");
}

async function loadUserSupportRequests() {
  const container = document.getElementById('user-support-results');
  if (!container) return;
  
  container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">جاري تحميل طلبات الدعم...</p></div>';
  
  try {
    const supportSnapshot = await db.collection('inbox').get();
    
    if (supportSnapshot.empty) {
      container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">لا توجد طلبات دعم حالياً</p></div>';
      return;
    }
    
    const supportRequests = supportSnapshot.docs
      .map(doc => ({
        id: doc.id,
        ...doc.data()
      }))
      .filter(request => 
        request.type === 'support_request' || 
        request.type === 'admin_report'
      )
      .sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
    
    if (supportRequests.length === 0) {
      container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--text-color);">لا توجد طلبات دعم حالياً</p></div>';
      return;
    }
    
    container.innerHTML = supportRequests.map(request => {
      const requestTime = request.createdAt?.toDate ? formatRelativeTime(request.createdAt.toDate()) : 'غير معروف';
      const typeText = request.supportType === 'problem' ? 'مشكلة' : 'اقتراح';
      const typeIcon = request.supportType === 'problem' ? '🚨' : '💡';
      const statusColor = request.status === 'resolved' ? 'var(--success-color)' : 'var(--warning-color)';
      
      return `
        <div class="user-support-item">
          <div class="support-meta">
            <div class="support-user">
              ${typeIcon} ${escapeHTML(request.userName || 'مستخدم')}
            </div>
            <div class="support-type" style="background: ${statusColor}">
              ${request.status === 'resolved' ? 'تم الرد' : typeText}
            </div>
          </div>
          
          <div class="support-message">
            ${escapeHTML(request.message || '')}
          </div>
          
          <div class="reply-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <small style="color: var(--light-text);">${requestTime}</small>
              <small style="color: var(--light-text);">ID: ${request.userUid?.substring(0, 8) || 'غير معروف'}</small>
            </div>
            
            ${request.status !== 'resolved' ? `
            <button class="support-reply-btn" onclick="openReplySupportModal('${request.userUid}', '${escapeHTML(request.userName || 'مستخدم')}', '${request.id}')">
              <i class="fas fa-reply"></i> الرد على المستخدم
            </button>
            ` : `
            <div style="color: var(--success-color); font-weight: bold; text-align: center;">
              <i class="fas fa-check-circle"></i> تم الرد على هذه الرسالة
            </div>
            `}
          </div>
        </div>
      `;
    }).join('');
    
  } catch (error) {
    console.error('Error loading support requests:', error);
    container.innerHTML = `
      <div class="post">
        <p style="text-align: center; color: var(--danger-color);">
          خطأ في تحميل طلبات الدعم: ${error.message}
        </p>
        <button class="btn" onclick="loadUserSupportRequests()" style="margin-top: 10px;">
          <i class="fas fa-redo"></i> إعادة المحاولة
        </button>
      </div>
    `;
  }
}

function openReplySupportModal(userId, userName, requestId) {
  document.getElementById('reply-user-id').value = userId;
  document.getElementById('reply-user-name').value = userName;
  document.getElementById('reply-support-modal').setAttribute('data-request-id', requestId);
  document.getElementById('reply-support-modal').style.display = 'block';
}

function closeReplySupportModal() {
  document.getElementById('reply-support-modal').style.display = 'none';
  document.getElementById('reply-message').value = '';
}

async function sendSupportReply() {
  const userId = document.getElementById('reply-user-id').value;
  const userName = document.getElementById('reply-user-name').value;
  const replyMessage = document.getElementById('reply-message').value.trim();
  const requestId = document.getElementById('reply-support-modal').getAttribute('data-request-id');
  
  if (!replyMessage) {
    return showNotification('يرجى كتابة الرد', 'error');
  }
  
  const btn = document.querySelector('#reply-support-modal .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  
  try {
    await db.collection('inbox').add({
      userId: userId,
      type: 'support_reply',
      title: '📬 رد على طلب الدعم',
      message: `مرحباً ${userName},\n\n${replyMessage}\n\nمع تحيات فريق الدعم - سوق الطلاب`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      repliedBy: currentUser.uid,
      repliedByName: currentUser.name
    });
    
    if (requestId) {
      await db.collection('inbox').doc(requestId).update({
        status: 'resolved',
        resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
        resolvedBy: currentUser.uid
      });
    }
    
    showNotification('تم إرسال الرد بنجاح');
    closeReplySupportModal();
    loadUserSupportRequests();
    
  } catch (error) {
    console.error('Error sending support reply:', error);
    showNotification('فشل إرسال الرد', 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function switchSection(section) {
  activeSection = section;
  if (window.pillPosts) window.pillPosts.classList.toggle("active", section === "posts");
  if (window.pillCompanies) window.pillCompanies.classList.toggle("active", section !== "posts");
  if (window.postsContainer) window.postsContainer.style.display = section === "posts" ? "block" : "none";
  if (window.companiesContainer) window.companiesContainer.style.display = section !== "posts" ? "block" : "none";
  if (window.filterBox) window.filterBox.style.display = section === "posts" ? "flex" : "none";
  updateCreateButton();
}

function updateCreateButton() {
  if (!window.createBtnLabel) return;
  window.createBtnLabel.textContent = activeSection === "posts" ? "إنشاء منشور" : "إضافة شركة";
  const showForPosts = activeSection === "posts" && currentUser;
  const showForCompanies = activeSection !== "posts" && isOwner();
  if (window.createBtn) window.createBtn.style.display = (showForPosts || showForCompanies) ? "inline-flex" : "none";
}

function onCreateButton() {
  if (activeSection === "posts") openCreatePostModal();
  else openCreateCompanyModal();
}

async function loadPostsFromFirestore() {
  try {
    const cacheKey = 'posts_cache';
    const cacheTime = 'posts_cache_time';
    const now = Date.now();
    const cacheExpiry = 60 * 1000;
    
    const cachedPosts = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    if (cachedPosts && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
      console.log('📥 تحميل المنشورات من الذاكرة المؤقتة');
      posts = JSON.parse(cachedPosts);
      renderPosts();
      updatePostCountInProfile();
      return;
    }
    
    console.log('📥 تحميل المنشورات من قاعدة البيانات');
    
    const snap = await db.collection("posts")
      .orderBy("createdAt", "desc")
      .limit(100)
      .get();
      
    posts = snap.docs.map(d => {
      const data = d.data();
      const createdAt = data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0);
      return { 
        id: d.id, 
        isPinned: !!data.isPinned, 
        commentsCount: data.commentsCount || 0,
        cheapestPrice: data.cheapestPrice || 0,
        ...data, 
        createdAt 
      };
    });
    
    posts = posts.filter(p => p.status !== 'deleted' && p.status !== 'sold');
    
    posts.sort((a, b) => {
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      return (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0);
    });
    
    localStorage.setItem(cacheKey, JSON.stringify(posts));
    localStorage.setItem(cacheTime, now.toString());
    
    renderPosts();
    updatePostCountInProfile();
  } catch (e) {
    console.error("Error loading posts:", e);
    showNotification("خطأ في تحميل المنشورات", "error");
    
    const cachedPosts = localStorage.getItem('posts_cache');
    if (cachedPosts) {
      posts = JSON.parse(cachedPosts);
      renderPosts();
      updatePostCountInProfile();
    }
  }
}

async function getUserMeta(uid) {
  if (userMetaCache[uid]) return userMetaCache[uid];
  try {
    const u = await db.collection("users").doc(uid).get();
    const data = u.data();
    const meta = { 
      isVerified: !!data?.isVerified, 
      blockedFromPosting: !!data?.blockedFromPosting,
      avatar: data?.avatar || 'male',
      avatarBase64: data?.avatarBase64 || null,
      createdAt: data?.createdAt
    };
    userMetaCache[uid] = meta;
    return meta;
  } catch {
    return { isVerified: false, blockedFromPosting: false, avatar: 'male', avatarBase64: null, createdAt: null };
  }
}

function priceLabelFromNumber(price) {
  const priceValue = Number(price);
  if (!isNaN(priceValue) && priceValue === 0) return 'مجاناً';
  try { return `${priceValue.toLocaleString('ar-IQ')} د.ع`; } catch { return `${priceValue} د.ع`; }
}

function stageLabel(stage) {
  const map = {
    "sades-elmi": "السادس العلمي", "sades-adabi": "السادس الادبي", "khames": "الخامس",
    "rabea": "الرابع", "thaleth-mut": "الثالث متوسط", "thani-mut": "الثاني متوسط",
    "awal-mut": "الاول متوسط", "sades-ibtidai": "السادس الابتدائي"
  };
  return map[stage] || "";
}

function formatRelativeTime(date) {
  if (!date) return 'غير معروف';
  
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / (1000 * 60));
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffMins < 1) return 'الآن';
  if (diffMins < 60) return `منذ ${diffMins} دقيقة`;
  if (diffHours < 24) return `منذ ${diffHours} ساعة`;
  if (diffDays < 7) return `منذ ${diffDays} يوم`;
  
  return date.toLocaleDateString('ar-IQ');
}

function createPostElement(post, meta, context = 'list') {
  const card = document.createElement("div");
  card.className = `post ${post.isPinned ? 'pinned' : ''} ${post.status === 'sold' ? 'sold' : ''}`;
  
  const postTime = formatRelativeTime(post.createdAt);
  
  const verifiedBadge = meta.isVerified ? 
    `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : '';
  
  const pinBadge = post.isPinned ? 
    '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> مثبت</div>' : '';
  
  let ownerTools = '';
  if (isOwner() && context === 'list') {
    const pinTxt = post.isPinned ? 'إلغاء التثبيت' : 'تثبيت';
    const verTxt = meta.isVerified ? 'إلغاء التوثيق' : 'توثيق';
    const banTxt = meta.blockedFromPosting ? 'إلغاء حظر النشر' : 'حظر النشر';
    ownerTools = `
      <div class="owner-tools">
        <button class="btn btn-xs" onclick="ownerTogglePin('${post.id}', ${post.isPinned})">
          <i class="fa-solid fa-thumbtack"></i> ${pinTxt}
        </button>
        <button class="btn btn-xs" onclick="ownerToggleVerify('${post.userId}')">
          <i class="fa-solid fa-crown"></i> ${verTxt}
        </button>
        <button class="btn btn-xs" onclick="ownerToggleUserBanById('${post.userId}')">
          <i class="fa-solid fa-ban"></i> ${banTxt}
        </button>
        <button class="btn btn-danger btn-xs" onclick="ownerDeletePost('${post.id}')">
          <i class="fa-solid fa-trash"></i> حذف
        </button>
      </div>
    `;
  }
  
  let postMenu = '';
  if (currentUser && post.userId === currentUser.uid && context === 'list') {
    postMenu = `
      <div class="post-menu">
        <button class="post-menu-btn" onclick="togglePostMenu(this)">
          <i class="fas fa-ellipsis-v"></i>
        </button>
        <div class="post-menu-dropdown">
          <div class="post-menu-item" onclick="openEditPostModal('${post.id}')">
            <i class="fas fa-edit"></i>
            <span>تعديل</span>
          </div>
          <div class="post-menu-item" onclick="markSoldWithConfirmation('${post.id}', ${post.status === 'sold'})">
            <i class="fas fa-tag"></i>
            <span>${post.status === 'sold' ? 'إلغاء البيع' : 'تم البيع'}</span>
          </div>
          <div class="post-menu-item" onclick="repost('${post.id}')">
            <i class="fas fa-sync"></i>
            <span>إعادة نشر</span>
          </div>
          <div class="post-menu-item" onclick="deletePostWithConfirmation('${post.id}')" style="color: var(--danger-color);">
            <i class="fas fa-trash"></i>
            <span>حذف</span>
          </div>
        </div>
      </div>
    `;
  }
  
  let contactButton = '';
  if (post.contactMethod === "whatsapp" && post.whatsapp) {
    contactButton = `
      <button class="post-action-btn whatsapp-btn" onclick="openWhatsApp('${post.whatsapp}')">
        <i class="fab fa-whatsapp"></i>
        <span>واتساب</span>
      </button>
    `;
  } else if (post.contactMethod === "telegram" && post.telegram) {
    contactButton = `
      <button class="post-action-btn telegram-btn" onclick="openTelegram('${post.telegram}')">
        <i class="fab fa-telegram"></i>
        <span>تلكرام</span>
      </button>
    `;
  } else if (post.contactMethod === "comments") {
    contactButton = `
      <button class="post-action-btn comments-btn" onclick="openCommentsPage('${post.id}')">
        <i class="fas fa-comment"></i>
        <span>تعليق</span>
      </button>
    `;
  }
  
  const detailsButton = `
    <button class="post-action-btn details-btn" onclick="openDetailsPage('${post.id}')">
      <i class="fas fa-question-circle"></i>
      <span>تفاصيل</span>
    </button>
  `;

const reportButton = `
    <button class="post-action-btn report-btn" onclick="reportPost('${post.id}')">
        <i class="fas fa-flag"></i>
        <span>إبلاغ</span>
    </button>
`;
  
  let userAvatarHtml = '';
  if (meta.avatarBase64) {
    userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
  }
  
  const priceLabel = priceLabelFromNumber(post.price);
  const stageLabelText = stageLabel(post.stage);
  
  const commentsCount = post.commentsCount || 0;
  
  card.innerHTML = `
    ${pinBadge}
    ${postMenu}
    ${ownerTools}
    
    <div class="post-header">
      <div class="user-info">
        <div class="rank-avatar-container">
          ${userAvatarHtml}
        </div>
        <div class="user-details">
          <div class="user-name">
            ${escapeHTML(post.userName || 'مستخدم')}
            ${verifiedBadge}
          </div>
          <div class="post-time">${postTime}</div>
        </div>
      </div>
    </div>
    
    <div class="post-content">
      <div class="post-meta">
        <span class="post-stage">${stageLabelText}</span>
        <span class="post-material">${escapeHTML(post.material || '')}</span>
        <span class="post-price">${priceLabel}</span>
      </div>
      
      <div class="post-description">
        ${escapeHTML(post.description || '')}
      </div>
    </div>
    
    <div class="post-stats">
      <span class="views-count">
        <i class="fas fa-comments"></i>
        <span>${commentsCount} تعليق</span>
      </span>
    </div>
    
    <div class="post-actions-new">
      ${contactButton}
      ${detailsButton}
      ${reportButton}
    </div>
  `;
  
  return card;
}

function togglePostMenu(button) {
  const dropdown = button.nextElementSibling;
  const isShowing = dropdown.classList.contains('show');
  
  document.querySelectorAll('.post-menu-dropdown.show').forEach(menu => {
    if (menu !== dropdown) {
      menu.classList.remove('show');
    }
  });
  
  dropdown.classList.toggle('show', !isShowing);
}

document.addEventListener('click', function(e) {
  if (!e.target.closest('.post-menu')) {
    document.querySelectorAll('.post-menu-dropdown.show').forEach(menu => {
      menu.classList.remove('show');
    });
  }
});

async function renderPosts() {
  if (!window.postsContainer) {
    console.error("postsContainer غير معرف");
    return;
  }
  
  window.postsContainer.innerHTML = "";
  const filterMaterial = document.getElementById('filter-material').value;
  const filterStage = document.getElementById('filter-stage').value;
  
  const sorted = [...posts].sort((a, b) => {
    if (a.isPinned && !b.isPinned) return -1;
    if (!a.isPinned && b.isPinned) return 1;
    return (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0);
  });
  
  const filtered = sorted.filter(p => {
    const isVisible = p.status !== 'sold' && p.status !== 'deleted';
    const materialMatch = !filterMaterial || p.material === filterMaterial;
    const stageMatch = !filterStage || p.stage === filterStage;
    return isVisible && materialMatch && stageMatch;
  });
  
  if (filtered.length === 0) {
    window.postsContainer.innerHTML = '<div class="post"><p>لا توجد منشورات تطابق الفلتر</p></div>';
    return;
  }
  
  const uids = [...new Set(filtered.map(p => p.userId).filter(Boolean))];
  await Promise.all(uids.map(async uid => {
    if (!userMetaCache[uid]) userMetaCache[uid] = await getUserMeta(uid);
  }));
  
  const frag = document.createDocumentFragment();
  
  for (const post of filtered) {
    const meta = userMetaCache[post.userId] || { isVerified: false, blockedFromPosting: false, avatar: 'male', avatarBase64: null };
    const postElement = createPostElement(post, meta, 'list');
    frag.appendChild(postElement);
  }
  
  window.postsContainer.appendChild(frag);
}

function openCreatePostModal() {
  resetCreatePostForm();
  document.getElementById("create-post-modal").style.display = "block";
}

function closeCreatePostModal() {
  document.getElementById('create-post-modal').style.display = 'none';
  resetCreatePostForm();
}

function openAvatarModal() {
  renderAvatarPreview();
  document.getElementById('avatar-modal').style.display = 'block';
}

function closeAvatarModal() {
  document.getElementById('avatar-modal').style.display = 'none';
}

function resetCreatePostForm() {
  document.getElementById("post-stage").value = "";
  document.getElementById("post-description").value = "";
  document.getElementById("post-price").value = "0";
  document.getElementById("post-cheapest-price").value = "0";
  document.getElementById("whatsapp-number").value = "";
  document.getElementById("telegram-username").value = "";
  changeContactMethod();
}

function changeContactMethod(prefix = '') {
  const methodEl = document.getElementById(`${prefix ? 'edit-' : ''}contact-method`);
  const w_field = document.getElementById(`${prefix ? 'edit-' : ''}whatsapp-field`);
  const t_field = document.getElementById(`${prefix ? 'edit-' : ''}telegram-field`);
  const method = methodEl ? methodEl.value : '';
  if (w_field) w_field.style.display = method === "whatsapp" ? "block" : "none";
  if (t_field) t_field.style.display = method === "telegram" ? "block" : "none";
}

let createPostBusy = false;
async function createPost() {
  if (createPostBusy) return;
  if (!currentUser) return showNotification("يرجى تسجيل الدخول أولاً", "error");
  
  const stage = document.getElementById("post-stage").value.trim();
  if (!stage) {
    return showNotification("يرجى اختيار مرحلتك", "error");
  }
  
  try {
    const udoc = await db.collection("users").doc(currentUser.uid).get();
    if (udoc.exists && udoc.data()?.blockedFromPosting) {
      return showNotification("تم حظرك من النشر", "error");
    }
  } catch (e) { console.warn("check block failed", e); }
  
  const price = document.getElementById("post-price").value.trim();
  const cheapestPrice = document.getElementById("post-cheapest-price").value.trim();
  const material = document.getElementById("post-material").value;
  const description = document.getElementById("post-description").value.trim();
  const contactMethod = document.getElementById("contact-method").value;
  const whatsapp = formatWhatsApp(document.getElementById("whatsapp-number").value);
  const telegram = sanitizeTelegram(document.getElementById("telegram-username").value);
  
  if (!description) return showNotification("يرجى ملء الوصف", "error");
  if (contactMethod === "whatsapp" && whatsapp.length !== 12) return showNotification("رقم واتساب غير صالح", "error");
  if (contactMethod === "telegram" && !telegram) return showNotification("معرّف تلكرام غير صالح", "error");
  
  createPostBusy = true;
  const btn = document.getElementById("post-submit-btn");
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري النشر...';
  
  try {
    const formattedPrice = formatPriceWithZeros(price);
    const formattedCheapestPrice = formatPriceWithZeros(cheapestPrice);
    
    const newPost = {
      userId: currentUser.uid,
      userName: currentUser.name,
      userEmail: currentUser.email || "",
      stage, material, 
      price: Number(formattedPrice) || 0, 
      cheapestPrice: Number(formattedCheapestPrice) || 0,
      description, contactMethod,
      whatsapp: contactMethod === "whatsapp" ? whatsapp : "",
      telegram: contactMethod === "telegram" ? telegram : "",
      status: "active",
      isPinned: false,
      commentsCount: 0,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    
    await db.collection("posts").add(newPost);
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    closeCreatePostModal();
    await loadPostsFromFirestore();
    showNotification("تم نشر المنشور بنجاح");
  } catch (err) {
    console.error("Error creating post:", err);
    showNotification("حدث خطأ أثناء النشر: " + (err.message || err), "error");
  } finally {
    createPostBusy = false;
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

function openEditPostModal(postId) {
  const post = posts.find(p => p.id === postId);
  if (!post) return showNotification("لم يتم العثور على المنشور", "error");
  
  document.getElementById('edit-post-id').value = postId;
  document.getElementById('edit-post-stage').value = post.stage || 'sades-elmi';
  document.getElementById('edit-post-price').value = post.price || 0;
  document.getElementById('edit-post-cheapest-price').value = post.cheapestPrice || 0;
  document.getElementById('edit-post-material').value = post.material || 'اسلامية';
  document.getElementById('edit-post-description').value = post.description || '';
  document.getElementById('edit-contact-method').value = post.contactMethod || 'whatsapp';
  document.getElementById('edit-whatsapp-number').value = post.whatsapp || '';
  document.getElementById('edit-telegram-username').value = post.telegram || '';
  changeContactMethod('edit');
  document.getElementById('edit-post-modal').style.display = 'block';
}

function closeEditPostModal() {
  document.getElementById('edit-post-modal').style.display = 'none';
}

async function savePostEdits() {
  const postId = document.getElementById('edit-post-id').value;
  if (!postId) return;
  
  const price = document.getElementById('edit-post-price').value.trim();
  const cheapestPrice = document.getElementById('edit-post-cheapest-price').value.trim();
  const formattedPrice = formatPriceWithZeros(price);
  const formattedCheapestPrice = formatPriceWithZeros(cheapestPrice);
  
  const updatedData = {
    stage: document.getElementById('edit-post-stage').value.trim(),
    price: Number(formattedPrice) || 0,
    cheapestPrice: Number(formattedCheapestPrice) || 0,
    material: document.getElementById('edit-post-material').value,
    description: document.getElementById('edit-post-description').value.trim(),
    contactMethod: document.getElementById('edit-contact-method').value,
    whatsapp: formatWhatsApp(document.getElementById('edit-whatsapp-number').value),
    telegram: sanitizeTelegram(document.getElementById('edit-telegram-username').value),
  };
  
  if (!updatedData.description) return showNotification("الوصف مطلوب", "error");
  if (updatedData.contactMethod === "whatsapp" && updatedData.whatsapp.length !== 12) return showNotification("رقم واتساب غير صالح", "error");
  if (updatedData.contactMethod === "telegram" && !updatedData.telegram) return showNotification("معرّف تلكرام غير صالح", "error");
  
  const btn = document.getElementById('post-edit-submit-btn');
  btn.disabled = true;
  
  try {
    await db.collection('posts').doc(postId).update(updatedData);
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification('تم حفظ التعديلات');
    closeEditPostModal();
    await loadPostsFromFirestore();
    if (pages.userPosts && pages.userPosts.style.display === 'block') { showUserPosts(); }
  } catch (e) {
    showNotification('فشل حفظ التعديلات: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
  }
}

async function showUserPosts() {
  if (!currentUser) return showNotification("يرجى تسجيل الدخول", "warning");
  showPage("userPosts");
  markPostsAsSeen();
  
  if (!window.userPostsContainer) return;
  window.userPostsContainer.innerHTML = "";
  const mine = posts.filter(p => p.userId === currentUser.uid).sort((a, b) => (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0));
  
  if (mine.length === 0) {
    window.userPostsContainer.innerHTML = '<div class="post"><p>لا توجد منشورات لك</p></div>';
    return;
  }
  
  for (const post of mine) {
    const meta = await getUserMeta(post.userId);
    const div = document.createElement("div");
    div.className = `post ${post.status === 'sold' ? 'sold' : ''} ${post.status === 'deleted' ? 'deleted' : ''} ${post.isPinned ? 'pinned' : ''}`;
    
    let actions = '';
    if (post.userId === currentUser.uid) {
      actions = `
        <div class="post-actions">
          <button class="btn btn-xs" onclick="openEditPostModal('${post.id}')"><i class="fas fa-edit"></i> تعديل</button>
          <button class="btn btn-warning btn-xs" onclick="markSoldWithConfirmation('${post.id}', ${post.status === 'sold'})">
            <i class="fas fa-tag"></i> ${post.status === 'sold' ? 'إلغاء البيع' : 'تم البيع'}
          </button>
          <button class="btn btn-success btn-xs" onclick="repost('${post.id}')"><i class="fas fa-sync"></i> إعادة نشر</button>
          <button class="btn btn-danger btn-xs" onclick="deletePostWithConfirmation('${post.id}')"><i class="fas fa-trash"></i> حذف</button>
        </div>
      `;
    }
    
    let userAvatarHtml = '';
    if (meta.avatarBase64) {
      userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
    } else {
      const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
      const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
      userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
    }
    
    div.innerHTML = `
      <div class="post-header">
        <div class="user-info">
          <div class="rank-avatar-container">
            ${userAvatarHtml}
          </div>
          <div class="user-details">
            <div class="user-name">
              ${escapeHTML(post.userName || 'مستخدم')}
              ${meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : ''}
            </div>
            <div class="post-time">${formatRelativeTime(post.createdAt)}</div>
          </div>
        </div>
      </div>
      
      <div class="post-content">
        <div class="post-meta">
          <span class="post-stage">${stageLabel(post.stage)}</span>
          <span class="post-material">${escapeHTML(post.material || '')}</span>
          <span class="post-price">${priceLabelFromNumber(post.price)}</span>
        </div>
        
        <div class="post-description">
          ${escapeHTML(post.description || '')}
        </div>
      </div>
      
      ${actions}
    `;
    
    window.userPostsContainer.appendChild(div);
  }
}

function updatePostCountInProfile() {
  if (!currentUser) return;
  const count = posts.filter(p => p.userId === currentUser?.uid && p.status !== 'deleted').length;
  const el = document.getElementById("profile-count");
  if (el) el.textContent = `عدد منشوراتك: ${count}`;
}

async function repost(postId) {
  const doc = await db.collection("posts").doc(postId).get();
  if (!doc.exists || doc.data().userId !== currentUser.uid) return;
  await db.collection("posts").doc(postId).update({
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    status: 'active'
  });
  
  const cacheKey = 'posts_cache';
  localStorage.removeItem(cacheKey);
  
  showNotification("تم إعادة النشر وتحديث التاريخ");
  await loadPostsFromFirestore();
  showUserPosts();
}

async function markSold(postId, isSold) {
  const doc = await db.collection("posts").doc(postId).get();
  if (!doc.exists || doc.data().userId !== currentUser.uid) return;
  await db.collection("posts").doc(postId).update({
    status: isSold ? 'active' : 'sold'
  });
  
  const cacheKey = 'posts_cache';
  localStorage.removeItem(cacheKey);
  
  showNotification(isSold ? "تم إلغاء حالة البيع" : "تم تحديد: تم بيعه");
  await loadPostsFromFirestore();
  showUserPosts();
}

async function deletePost(postId) {
  if (!currentUser || !confirm("هل أنت متأكد من حذف هذا المنشور؟")) return;
  
  try {
    const doc = await db.collection("posts").doc(postId).get();
    if (!doc.exists || doc.data().userId !== currentUser.uid) return showNotification("غير مسموح", "error");
    
    try {
      await db.collection("posts").doc(postId).delete();
    } catch (delErr) {
      await db.collection("posts").doc(postId).update({ status: 'deleted' });
    }
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification("تم الحذف");
    await loadPostsFromFirestore();
    await showUserPosts();
  } catch (err) {
    showNotification("خطأ أثناء الحذف: " + (err.message || err), "error");
  }
}

async function renderDetails(postId) {
  if (!window.detailsContainer) return;
  window.detailsContainer.innerHTML = "<div class='post'><p>جاري التحميل...</p></div>";
  const post = posts.find(p => p.id === postId);
  if (!post) {
    window.detailsContainer.innerHTML = "<div class='post'><p>تعذر تحميل التفاصيل</p></div>";
    return;
  }
  
  const meta = await getUserMeta(post.userId);
  const userDoc = await db.collection("users").doc(post.userId).get();
  const userData = userDoc.data();
  
  const card = document.createElement("div");
  card.className = `post ${post.isPinned ? 'pinned' : ''}`;
  
  let userAvatarHtml = '';
  if (meta.avatarBase64) {
    userAvatarHtml = `<img src="${meta.avatarBase64}" class="rank-avatar" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    userAvatarHtml = `<div class="rank-avatar" style="display:flex;align-items:center;justify-content:center;font-size:20px;background:${avatarBackground};">${userAvatar}</div>`;
  }
  
  const userCreatedAt = userData?.createdAt?.toDate ? userData.createdAt.toDate() : null;
  const userJoinTime = userCreatedAt ? formatRelativeTime(userCreatedAt) : 'غير معروف';
  const lastSeen = userData?.lastSeen?.toDate ? formatRelativeTime(userData.lastSeen.toDate()) : 'غير معروف';
  
  card.innerHTML = `
    ${post.isPinned ? '<div class="pin-ribbon"><i class="fa-solid fa-thumbtack"></i> مثبت</div>' : ''}
    
    <div class="post-header">
      <div class="user-info">
        <div class="rank-avatar-container">
          ${userAvatarHtml}
        </div>
        <div class="user-details">
          <div class="user-name">
            ${escapeHTML(post.userName || 'مستخدم')}
            ${meta.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : ''}
          </div>
          <div class="post-time">${formatRelativeTime(post.createdAt)}</div>
        </div>
      </div>
    </div>
    
    <div class="details-info">
      <h3 style="margin-bottom: 15px; color: var(--primary-color); text-align: center;">معلومات مفصلة</h3>
      
      <div class="detail-item">
        <span class="detail-label">👤 اسم البائع:</span>
        <span class="detail-value">${escapeHTML(post.userName || 'مستخدم')}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📚 المرحلة:</span>
        <span class="detail-value">${stageLabel(post.stage)}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📖 المادة:</span>
        <span class="detail-value">${escapeHTML(post.material || 'غير محدد')}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">💰 السعر:</span>
        <span class="detail-value">${priceLabelFromNumber(post.price)}</span>
      </div>
      
      ${post.cheapestPrice > 0 ? `
      <div class="detail-item">
        <span class="detail-label">🏷️ أرخص سعر للملزمة:</span>
        <span class="detail-value" style="color: var(--success-color); font-weight: 900;">${priceLabelFromNumber(post.cheapestPrice)}</span>
      </div>
      ` : ''}
      
      <div class="detail-item">
        <span class="detail-label">🕒 وقت النشر:</span>
        <span class="detail-value">${post.createdAt?.toLocaleString?.('ar-IQ') || 'غير معروف'}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">👀 آخر ظهور للبائع:</span>
        <span class="detail-value">${lastSeen}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📅 انضم منذ:</span>
        <span class="detail-value">${userJoinTime}</span>
      </div>
      
      <div class="detail-item">
        <span class="detail-label">📞 طريقة التواصل:</span>
        <span class="detail-value">
          ${post.contactMethod === "whatsapp" ? "واتساب" : 
            post.contactMethod === "telegram" ? "تليجرام" : 
            "التعليقات"}
        </span>
      </div>
    </div>
  `;
  
  window.detailsContainer.innerHTML = '';
  window.detailsContainer.appendChild(card);
}

function openDetailsPage(postId) {
  currentDetailsPostId = postId;
  showPage("details");
  renderDetails(postId);
}

async function reportPost(postId) {
  if (!currentUser) return showNotification('يلزم تسجيل الدخول', 'warning');
  const reason = prompt('سبب الإبلاغ:');
  if (!reason) return;
  
  try {
    const post = posts.find(p => p.id === postId);
    
    const ownerQuery = await db.collection('users')
      .where('email', '==', APP_OWNER_EMAIL)
      .limit(1)
      .get();
    
    if (ownerQuery.empty) return;
    
    const ownerDoc = ownerQuery.docs[0];
    const ownerUid = ownerDoc.id;
    
    await db.collection('inbox').add({
      userId: ownerUid,
      type: 'admin_report',
      postId: postId,
      reporterUid: currentUser.uid,
      reporterName: currentUser.name || 'مستخدم',
      reporterShortUid: currentUser.shortUid || 'غير معروف',
      title: '🚨 بلاغ جديد',
      message: `👤 المبلغ: ${currentUser.name || 'مستخدم'}\n?? السبب: ${reason}\n🆔 معرف المبلغ: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`,
      status: 'unread',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
    if (!reportedPosts.includes(postId)) {
      reportedPosts.push(postId);
      localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts));
    }
    
    showNotification('تم الإبلاغ عن المنشور وسيتم مراجعته');
    
  } catch (e) {
    console.error('Report error:', e);
    showNotification('تعذّر إرسال البلاغ', 'error');
  }
}

async function openCommentsPage(postId) {
  if (!currentUser) return;
  currentCommentsPostId = postId;
  showPage("comments");
  await renderComments(postId);
}

async function renderCommentsWithCache(postId) {
  const container = document.getElementById("comments-list-page");
  if (!container) return;
  
  try {
    const cacheKey = `comments_${postId}`;
    const cacheTime = `comments_time_${postId}`;
    const now = Date.now();
    const cacheExpiry = 2 * 60 * 1000;
    
    const cachedComments = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    let comments = [];
    
    if (cachedComments && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
      comments = JSON.parse(cachedComments);
      container.innerHTML = renderCommentsHTML(comments);
    } else {
      container.innerHTML = '<div class="post"><p>جاري تحميل التعليقات...</p></div>';
      
      const snap = await db.collection("posts").doc(postId).collection("comments")
        .orderBy("createdAt", "asc")
        .get();
      
      if (snap.empty) {
        container.innerHTML = '<div class="post"><p>لا توجد تعليقات بعد.</p></div>';
        localStorage.setItem(cacheKey, JSON.stringify([]));
        localStorage.setItem(cacheTime, now.toString());
        return;
      }
      
      comments = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      localStorage.setItem(cacheKey, JSON.stringify(comments));
      localStorage.setItem(cacheTime, now.toString());
      
      container.innerHTML = renderCommentsHTML(comments);
    }
    
  } catch (e) {
    console.error('Error loading comments:', e);
    container.innerHTML = '<div class="post"><p>خطأ في تحميل التعليقات.</p></div>';
  }
}

function renderCommentsHTML(comments) {
  const userIds = [...new Set(comments.map(c => c.userId).filter(Boolean))];
  
  Promise.all(userIds.map(async uid => {
    if (!userMetaCache[uid]) {
      userMetaCache[uid] = await getUserMeta(uid);
    }
  })).then(() => {});
  
  return comments.map(comment => {
    const meta = userMetaCache[comment.userId] || { isVerified: false, avatar: 'male', avatarBase64: null };
    const time = comment.createdAt?.toDate ? formatRelativeTime(comment.createdAt.toDate()) : '';
    
    let userAvatarHtml = '';
    if (meta.avatarBase64) {
      userAvatarHtml = `<img src="${meta.avatarBase64}" class="comment-avatar">`;
    } else {
      const userAvatar = meta.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
      const avatarBackground = meta.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
      userAvatarHtml = `<div class="comment-avatar" style="background:${avatarBackground}; display:flex; align-items:center; justify-content:center; font-size:16px;">${userAvatar}</div>`;
    }
    
    return `
      <div class="comment">
        <div class="comment-header">
          ${userAvatarHtml}
          <div>
            <div class="comment-user">
              ${escapeHTML(comment.userName || 'مستخدم')}
              ${meta.isVerified ? `<span class="badge-verified" style="padding: 2px 6px; font-size: 10px;"><i class="fa-solid fa-crown"></i></span>` : ''}
            </div>
            <div class="comment-time">${time}</div>
          </div>
        </div>
        <div class="comment-content">${escapeHTML(comment.text || '')}</div>
        <div class="comment-actions">
          <button class="comment-action" onclick="replyToComment('${comment.userId}', '${comment.userName}')">
            <i class="fas fa-reply"></i> رد
          </button>
          ${comment.userId === currentUser.uid ? `
          <button class="comment-action" onclick="deleteCommentWithConfirmation('${comment.id}', '${currentCommentsPostId}')">
            <i class="fas fa-trash"></i> حذف
          </button>
          ` : ''}
          ${isOwner() || (currentUser && currentUser.uid === posts.find(p => p.id === currentCommentsPostId)?.userId) ? `
          <button class="comment-action" onclick="banCommentUserWithConfirmation('${comment.userId}', '${currentCommentsPostId}')">
            <i class="fas fa-ban"></i> حظر
          </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

async function addCommentFromPage() {
  if (!currentUser || !currentCommentsPostId) return;
  const textInput = document.getElementById("comment-text-page");
  const text = textInput.value.trim();
  if (!text) return;
  
  const btn = document.getElementById('send-comment-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
  
  try {
    await db.collection("posts").doc(currentCommentsPostId).collection("comments").add({
      text, 
      userId: currentUser.uid, 
      userName: currentUser.name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    const postRef = db.collection("posts").doc(currentCommentsPostId);
    await postRef.update({
      commentsCount: firebase.firestore.FieldValue.increment(1)
    });
    
    const postIndex = posts.findIndex(p => p.id === currentCommentsPostId);
    if (postIndex !== -1) {
      posts[postIndex].commentsCount = (posts[postIndex].commentsCount || 0) + 1;
    }
    
    const post = posts.find(p => p.id === currentCommentsPostId);
    if (post && post.userId !== currentUser.uid) {
      await db.collection('inbox').add({
        userId: post.userId,
        type: 'comment_notification',
        title: '💬 تعليق جديد',
        message: `تعليق جديد على منشورك من ${currentUser.name}: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`,
        postId: currentCommentsPostId,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
    
    await sendCommentReplyNotifications(currentCommentsPostId, text, currentUser.name);
    
    textInput.value = '';
    
    await renderCommentsWithCache(currentCommentsPostId);
    
    showNotification('تم إرسال التعليق');
    
  } catch (e) {
    console.error('Error adding comment:', e);
    showNotification('تم إرسال التعليق بنجاح');
    textInput.value = '';
    await renderCommentsWithCache(currentCommentsPostId);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'إرسال';
  }
}

async function sendCommentReplyNotifications(postId, commentText, commenterName) {
  try {
    const cacheKey = `post_comments_${postId}`;
    const cacheTime = `post_comments_time_${postId}`;
    const now = Date.now();
    const cacheExpiry = 5 * 60 * 1000;
    
    let commentsSnap;
    const cachedComments = localStorage.getItem(cacheKey);
    const cacheTimestamp = localStorage.getItem(cacheTime);
    
    if (cachedComments && cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
      commentsSnap = { 
        forEach: (callback) => JSON.parse(cachedComments).forEach(callback) 
      };
    } else {
      commentsSnap = await db.collection("posts").doc(postId).collection("comments").get();
      const commentsData = [];
      commentsSnap.forEach(doc => {
        commentsData.push({ id: doc.id, ...doc.data() });
      });
      localStorage.setItem(cacheKey, JSON.stringify(commentsData));
      localStorage.setItem(cacheTime, now.toString());
    }
    
    const mentionedUsers = new Set();
    
    commentsSnap.forEach(doc => {
      const comment = doc.data ? doc.data() : doc;
      if (comment.userName && commentText.includes(`@${comment.userName}`) && comment.userId !== currentUser.uid) {
        mentionedUsers.add(comment.userId);
      }
    });
    
    const batch = db.batch();
    let notificationCount = 0;
    
    for (const userId of mentionedUsers) {
      if (notificationCount >= 10) break;
      
      const notificationRef = db.collection('inbox').doc();
      batch.set(notificationRef, {
        userId: userId,
        type: 'comment_reply',
        title: '💬 رد على تعليقك',
        message: `قام ${commenterName} بالرد على تعليقك: ${commentText.substring(0, 50)}${commentText.length > 50 ? '...' : ''}`,
        postId: postId,
        status: 'unread',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      notificationCount++;
    }
    
    if (notificationCount > 0) {
      await batch.commit();
    }
    
  } catch (error) {
    console.error('Error sending comment reply notifications:', error);
  }
}

function replyToComment(userId, userName) {
  const textInput = document.getElementById("comment-text-page");
  textInput.value = `@${userName} `;
  textInput.focus();
}

async function deleteComment(commentId, postId) {
  if (!currentUser) return;
  
  if (!confirm('هل أنت متأكد من حذف هذا التعليق؟')) return;
  
  try {
    await db.collection("posts").doc(postId).collection("comments").doc(commentId).delete();
    
    const postRef = db.collection("posts").doc(postId);
    const postDoc = await postRef.get();
    const currentCount = postDoc.data().commentsCount || 0;
    if (currentCount > 0) {
      await postRef.update({
        commentsCount: currentCount - 1
      });
    }
    
    const postIndex = posts.findIndex(p => p.id === postId);
    if (postIndex !== -1 && posts[postIndex].commentsCount > 0) {
      posts[postIndex].commentsCount--;
    }
    
    showNotification('تم حذف التعليق');
    await renderComments(postId);
    
  } catch (error) {
    console.error('Error deleting comment:', error);
    showNotification('فشل حذف التعليق', 'error');
  }
}

async function banCommentUser(userId, postId) {
  if (!currentUser) return;
  
  const post = posts.find(p => p.id === postId);
  if (!post || (post.userId !== currentUser.uid && !isOwner())) {
    return showNotification('غير مسموح', 'error');
  }
  
  if (!confirm('هل أنت متأكد من حظر هذا المستخدم من التعليق على منشوراتك؟')) return;
  
  try {
    await db.collection('userBlocks').add({
      blockerId: currentUser.uid,
      blockedUserId: userId,
      postId: postId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    showNotification('تم حظر المستخدم من التعليق على منشوراتك');
    
  } catch (error) {
    console.error('Error banning user:', error);
    showNotification('فشل حظر المستخدم', 'error');
  }
}

async function renderComments(postId) {
  await renderCommentsWithCache(postId);
}

async function ownerTogglePin(postId, isPinned) {
  if (!isOwner()) return;
  try {
    await db.collection('posts').doc(postId).update({ isPinned: !isPinned });
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification(isPinned ? 'أُلغي التثبيت' : 'تم التثبيت');
    await loadPostsFromFirestore();
  } catch (e) {
    showNotification('فشل العملية', 'error');
  }
}

async function ownerToggleVerify(uid) {
  if (!isOwner()) return;
  try {
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.isVerified;
    await uref.update({ isVerified: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid] || {}), isVerified: !cur };
    showNotification(!cur ? 'تم توثيق المستخدم' : 'أُلغي التوثيق');
    await renderPosts();
  } catch (e) {
    showNotification('فشل العملية', 'error');
  }
}

async function ownerToggleUserBanById(uid) {
  if (!isOwner()) return;
  try {
    const uref = db.collection('users').doc(uid);
    const snap = await uref.get();
    const cur = !!snap.data()?.blockedFromPosting;
    await uref.update({ blockedFromPosting: !cur });
    userMetaCache[uid] = { ...(userMetaCache[uid] || {}), blockedFromPosting: !cur };
    showNotification(!cur ? 'تم حظر المستخدم من النشر' : 'تم إلغاء الحظر');
  } catch (e) {
    showNotification('فشل العملية', 'error');
  }
}

async function ownerDeletePost(postId) {
  if (!isOwner()) return;
  if (!confirm('حذف المنشور نهائيًا؟')) return;
  try {
    await db.collection('posts').doc(postId).delete();
    
    const cacheKey = 'posts_cache';
    localStorage.removeItem(cacheKey);
    
    showNotification('حُذف المنشور');
    await loadPostsFromFirestore();
  } catch (e) {
    showNotification('فشل الحذف', 'error');
  }
}

const GOVERNORATES = ["بغداد", "نينوى", "البصرة", "أربيل", "النجف", "كربلاء", "ذي قار", "السليمانية", "ديالى", "الأنبار", "بابل", "كركوك", "واسط", "المثنى", "القادسية", "ميسان", "صلاح الدين", "دهوك", "كل المحافظات"];

function populateGovernorateSelects(selectId) {
  const select = document.getElementById(selectId);
  if (!select?.dataset?.populated) {
    select.innerHTML = GOVERNORATES.map(g => `<option value="${g}">${g}</option>`).join('');
    if (select) select.dataset.populated = "true";
  }
}

function openCreateCompanyModal() {
  if (!isOwner()) return showNotification('للمالك فقط', 'error');
  populateGovernorateSelects('company-from');
  populateGovernorateSelects('company-to');
  document.getElementById('create-company-modal').style.display = 'block';
}

function closeCreateCompanyModal() {
  document.getElementById('create-company-modal').style.display = 'none';
}

async function createCompany() {
  if (!isOwner()) return;
  const data = {
    name: document.getElementById('company-name').value.trim(),
    from: document.getElementById('company-from').value,
    to: document.getElementById('company-to').value,
    phone: document.getElementById('company-phone').value.trim(),
    desc: document.getElementById('company-desc').value.trim(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  if (!data.name || !data.phone || !data.from || !data.to) {
    return showNotification("يرجى ملء جميع الحقول المطلوبة", "error");
  }
  
  const btn = document.getElementById('company-submit-btn');
  btn.disabled = true;
  
  try {
    await db.collection('companies').add(data);
    showNotification("تمت إضافة الشركة");
    closeCreateCompanyModal();
    await loadCompanies();
  } catch (e) {
    showNotification("فشل إضافة الشركة: " + e.message, "error");
  } finally {
    btn.disabled = false;
  }
}

async function loadCompanies() {
  try {
    const snap = await db.collection('companies').orderBy('createdAt', 'desc').get();
    companies = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderCompanies();
  } catch (e) {
    if (window.companiesContainer) {
      window.companiesContainer.innerHTML = '<div class="post"><p>خطأ تحميل الشركات</p></div>';
    }
  }
}

function renderCompanies() {
  if (!window.companiesContainer) return;
  if (!companies || companies.length === 0) {
    window.companiesContainer.innerHTML = '<div class="post"><p>لا توجد شركات بعد</p></div>';
    return;
  }
  
  window.companiesContainer.innerHTML = companies.map(c => `
    <div class="company">
      <div class="name"><i class="fa-solid fa-truck"></i> ${escapeHTML(c.name || 'شركة')}</div>
      <div class="route">من: ${escapeHTML(c.from || '-')} → إلى: ${escapeHTML(c.to || '-')}</div>
      <div class="phone"><i class="fa-solid fa-phone"></i> ${escapeHTML(c.phone || '')}</div>
      ${c.desc ? `<div class="desc">${escapeHTML(c.desc)}</div>` : ''}
      ${isOwner() ? `<div class="post-actions" style="margin-top:8px">
        <button class="btn btn-danger btn-xs" onclick="deleteCompany('${c.id}')"><i class="fa-solid fa-trash"></i> حذف</button>
      </div>` : ''}
    </div>
  `).join('');
}

async function deleteCompany(id) {
  if (!isOwner()) return;
  if (!confirm('حذف الشركة؟')) return;
  try {
    await db.collection('companies').doc(id).delete();
    showNotification('حُذفت الشركة');
    await loadCompanies();
  } catch (e) {
    showNotification('فشل الحذف', 'error');
  }
}

async function setAvatar(kind) {
  if (!currentUser) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ 
      avatar: kind,
      avatarBase64: null
    });
    currentUser.avatar = kind;
    currentUser.avatarBase64 = null;
    updateAvatarDisplay();
    showNotification('تم تحديث الصورة');
    closeAvatarModal();
  } catch {
    showNotification('فشل تحديث الصورة', 'error');
  }
}

function renderAvatarPreview() {
  const previewElement = document.getElementById('current-avatar-preview');
  if (!previewElement) return;
  
  if (currentUser && currentUser.avatarBase64) {
    previewElement.innerHTML = `<img src="${currentUser.avatarBase64}" class="rank-avatar" style="width:80px;height:80px;">`;
  } else {
    const emoji = currentUser?.avatar === 'female' ? '👩🏻‍💼' : '👨🏻‍💼';
    const bg = currentUser?.avatar === 'female' ? '#ffd7ea' : '#d7e4ff';
    previewElement.innerHTML = `<div style="width:80px;height:80px;border-radius:50%;background:${bg};display:grid;place-items:center;font-size:32px;">${emoji}</div>`;
  }
}

async function editProfileName() {
  if (!currentUser) return;
  const newName = prompt('اكتب الاسم الجديد:', currentUser.name || '');
  if (!newName) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ name: newName });
    currentUser.name = newName;
    document.getElementById('profile-name').textContent = newName;
    showNotification('تم تغيير الاسم');
  } catch {
    showNotification('فشل تغيير الاسم', 'error');
  }
}

async function showInbox() {
  if (!currentUser) return showNotification('سجّل الدخول', 'warning');
  showPage('inbox');
  await markAllNotificationsAsRead();
  
  if (!window.inboxContainer) return;
  window.inboxContainer.innerHTML = '<div class="post"><p>جاري تحميل الرسائل...</p></div>';
  
  try {
    let messages = [];
    
    if (isOwner()) {
      const allMessages = await db.collection('inbox').get();
      messages = allMessages.docs
        .filter(doc => doc.data().type === 'admin_report' || doc.data().type === 'support_request')
        .sort((a, b) => (b.data().createdAt?.toDate?.() || 0) - (a.data().createdAt?.toDate?.() || 0));
    } else {
      const userMessages = await db.collection('inbox').get();
      messages = userMessages.docs
        .filter(doc => doc.data().userId === currentUser.uid)
        .sort((a, b) => (b.data().createdAt?.toDate?.() || 0) - (a.data().createdAt?.toDate?.() || 0));
    }
    
    if (messages.length === 0) {
      window.inboxContainer.innerHTML = '<div class="post"><p>لا توجد رسائل حالياً.</p></div>';
      return;
    }
    
    window.inboxContainer.innerHTML = messages.map(doc => {
      const msg = doc.data();
      const created = msg.createdAt?.toDate ? formatRelativeTime(msg.createdAt.toDate()) : '';
      
      if (isOwner() && (msg.type === 'admin_report' || msg.type === 'support_request')) {
        if (msg.status === 'resolved') {
          return `
            <div class="post" style="opacity:0.7; background:#f8f9fa;">
              <div style="font-weight:bold;color:#0f235f">📩 ${msg.type === 'support_request' ? 'طلب دعم' : 'بلاغ'} - ${msg.actionMessage || 'تم المعالجة'}</div>
              <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
              <div style="color:#28a745; font-weight:bold; margin-top:8px;">
                ✅ ${msg.actionMessage || 'تمت المعالجة'}
              </div>
              <small style="color:#777">${created}</small>
            </div>`;
        }
        
        const typeText = msg.supportType === 'problem' ? 'مشكلة' : msg.supportType === 'suggestion' ? 'اقتراح' : 'طلب دعم';
        const typeIcon = msg.supportType === 'problem' ? '🚨' : msg.supportType === 'suggestion' ? '💡' : '📩';
        
        return `
          <div class="post">
            <div style="font-weight:bold;color:#0f235f">${typeIcon} ${typeText}</div>
            <p style="margin-top:8px">${escapeHTML(msg.message || '')}</p>
            ${msg.type === 'admin_report' ? `
            <div class="post-actions">
              <button class="btn btn-danger btn-xs" onclick="adminReportAction('${doc.id}','ban_poster','${escapeHTML(msg.postOwnerId || '')}')">
          <i class="fa-solid fa-ban"></i> حظر صاحب المنشور
        </button>
        <button class="btn btn-warning btn-xs" onclick="adminReportAction('${doc.id}','ban_reporter','${escapeHTML(msg.reporterUid || '')}')">
          <i class="fa-solid fa-user-slash"></i> حظر المبلغ
        </button>
        <button class="btn btn-info btn-xs" onclick="adminReportAction('${doc.id}','view_single_post','${escapeHTML(msg.postOwnerId || '')}','','${escapeHTML(msg.postId || '')}')">
          <i class="fa-solid fa-eye"></i> عرض المنشور
        </button>
              <button class="btn btn-secondary btn-xs" onclick="adminReportAction('${doc.id}','delete_post','${escapeHTML(msg.postId || '')}')">
                <i class="fa-solid fa-trash"></i> حذف المنشور
              </button>
              <button class="btn btn-xs" onclick="adminReportAction('${doc.id}','reject','')">
                <i class="fa-solid fa-x"></i> رفض البلاغ
              </button>
            </div>
            ` : ''}
            <small style="color:#777">${created}</small>
          </div>`;
      }
      
      return `
        <div class="post">
          <div style="font-weight:bold;color:#0f235f">${escapeHTML(msg.title || 'إشعار')}</div>
          <p style="margin-top:8px">${escapeHTML(msg.message || '')}</div>
          <small style="color:#777">${created}</small>
        </div>`;
    }).join('');
    
  } catch (error) {
    console.error('Error loading inbox:', error);
    window.inboxContainer.innerHTML = '<div class="post"><p>خطأ في تحميل الرسائل</p></div>';
  }
}

async function adminReportAction(inboxDocId, action, targetId, reporterId = '', postId = '') {
  if (!isOwner()) return;
  
  try {
    let actionMessage = '';

    if (action === 'ban_poster' && targetId) {
      await db.collection('users').doc(targetId).update({
        blockedFromPosting: true
      });
      actionMessage = 'تم حظر صاحب المنشور';
    } else if (action === 'ban_reporter' && reporterId) {
      await db.collection('users').doc(reporterId).update({
        blockedFromPosting: true
      });
      actionMessage = 'تم حظر المُبلّغ';
    } else if (action === 'delete_post' && targetId) {
      try {
        await db.collection('posts').doc(targetId).delete();
      } catch (deleteError) {
        await db.collection('posts').doc(targetId).update({
          status: 'deleted'
        });
      }
      actionMessage = 'تم حذف المنشور';
    } else if (action === 'reject') {
      actionMessage = 'تم رفض البلاغ';
    } else if (action === 'view_posts' && targetId) {
      await showUserPostsPage(targetId);
      return;
    } else if (action === 'view_single_post' && postId) {
      await showSinglePostModal(postId);
      return;
    }

    await db.collection('inbox').doc(inboxDocId).update({
      status: 'resolved',
      resolvedAt: firebase.firestore.FieldValue.serverTimestamp(),
      resolvedBy: currentUser.uid,
      actionMessage: actionMessage
    });

    showNotification('تم معالجة الإبلاغ بنجاح');
    setTimeout(() => { showInbox(); }, 2000);

  } catch (e) {
    console.error('فشل إجراء الإدارة:', e);
    showNotification('فشل تنفيذ الإجراء: ' + e.message, 'error');
  }
}

async function showUserPostsPage(userId) {
  try {
    const userPosts = await db.collection('posts')
      .where('userId', '==', userId)
      .orderBy('createdAt', 'desc')
      .get();
    
    if (userPosts.empty) {
      showNotification('لا توجد منشورات لهذا المستخدم', 'info');
      return;
    }
    
    const postsHTML = `
      <div id="user-posts-page" class="container page" style="display:block">
        <div class="header">
          <button class="btn btn-secondary" onclick="backToInbox()">
            <i class="fas fa-arrow-right"></i>
          </button>
          <span style="font-weight:900">منشورات المستخدم</span>
          <div class="post-actions">
            <button class="btn btn-danger btn-xs" onclick="banUserFromPostsPage('${userId}')">
              <i class="fas fa-ban"></i> حظر المستخدم
            </button>
            <button class="btn btn-warning btn-xs" onclick="deleteAllUserPosts('${userId}')">
              <i class="fas fa-trash"></i> حذف جميع المنشورات
            </button>
          </div>
        </div>
        <div class="posts-container" id="user-posts-admin-container">
          ${userPosts.docs.map(doc => {
            const post = doc.data();
            return `
              <div class="post">
                <div class="post-header">
                  <div class="user-info">
                    <div class="user-details">
                      <div class="user-name">${escapeHTML(post.userName || 'مستخدم')}</div>
                      <div class="post-time">${post.createdAt?.toDate?.().toLocaleString('ar-IQ') || ''}</div>
                    </div>
                  </div>
                </div>
                <div class="post-content">
                  <div class="post-meta">
                    <span class="post-stage">${stageLabel(post.stage)}</span>
                    <span class="post-material">${escapeHTML(post.material || '')}</span>
                    <span class="post-price">${priceLabelFromNumber(post.price)}</span>
                  </div>
                  <div class="post-description">${escapeHTML(post.description || '')}</div>
                </div>
                <div class="post-actions">
                  <button class="btn btn-danger btn-xs" onclick="deleteSinglePost('${doc.id}')">
                    <i class="fas fa-trash"></i> حذف هذا المنشور
                  </button>
                  <button class="btn btn-warning btn-xs" onclick="viewPostDetails('${doc.id}')">
                    <i class="fas fa-eye"></i> عرض التفاصيل
                  </button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    `;
    
    document.querySelector('.page[style*="display: block"]').style.display = 'none';
    document.body.insertAdjacentHTML('beforeend', postsHTML);
    
  } catch (error) {
    console.error('Error loading user posts:', error);
    showNotification('فشل تحميل منشورات المستخدم', 'error');
  }
}

async function showSinglePostModal(postId) {
  try {
    const postDoc = await db.collection('posts').doc(postId).get();
    if (!postDoc.exists) {
      showNotification('المنشور غير موجود', 'error');
      return;
    }
    
    const post = postDoc.data();
    const userDoc = await db.collection('users').doc(post.userId).get();
    const userData = userDoc.data();
    
    const modalHTML = `
      <div id="single-post-modal" class="modal" style="display: block;">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
          <div class="modal-header">
            <h2>عرض المنشور المبلغ عنه</h2>
            <button class="close-modal" onclick="closeSinglePostModal()">&times;</button>
          </div>
          
          <div class="post">
            <div class="post-header">
              <div class="user-info">
                <div class="user-details">
                  <div class="user-name">
                    ${escapeHTML(post.userName || 'مستخدم')}
                    ${userData?.isVerified ? `<span class="badge-verified"><i class="fa-solid fa-crown"></i> موثّق</span>` : ''}
                  </div>
                  <div class="post-time">${post.createdAt?.toDate?.().toLocaleString('ar-IQ') || ''}</div>
                </div>
              </div>
            </div>
            
            <div class="post-content">
              <div class="post-meta">
                <span class="post-stage">${stageLabel(post.stage)}</span>
                <span class="post-material">${escapeHTML(post.material || '')}</span>
                <span class="post-price">${priceLabelFromNumber(post.price)}</span>
              </div>
              
              <div class="post-description">${escapeHTML(post.description || '')}</div>
              
              <div class="details-info">
                <h4>معلومات الاتصال:</h4>
                <div class="detail-item">
                  <span class="detail-label">طريقة التواصل:</span>
                  <span class="detail-value">${post.contactMethod === "whatsapp" ? "واتساب" : post.contactMethod === "telegram" ? "تليجرام" : "التعليقات"}</span>
                </div>
                ${post.whatsapp ? `
                <div class="detail-item">
                  <span class="detail-label">رقم الواتساب:</span>
                  <span class="detail-value">${post.whatsapp}</span>
                </div>
                ` : ''}
                ${post.telegram ? `
                <div class="detail-item">
                  <span class="detail-label">اسم المستخدم في التليجرام:</span>
                  <span class="detail-value">${post.telegram}</span>
                </div>
                ` : ''}
              </div>
            </div>
          </div>
          
          <div class="modal-footer" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
            <button class="btn btn-danger" onclick="banUserFromModal('${post.userId}')">
              <i class="fas fa-ban"></i> حظر صاحب المنشور
            </button>
            <button class="btn btn-warning" onclick="deletePostFromModal('${postId}')">
              <i class="fas fa-trash"></i> حذف المنشور
            </button>
            <button class="btn btn-secondary" onclick="closeSinglePostModal()">
              <i class="fas fa-times"></i> إغلاق
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
  } catch (error) {
    console.error('Error loading single post:', error);
    showNotification('فشل تحميل المنشور', 'error');
  }
}

function closeSinglePostModal() {
  const modal = document.getElementById('single-post-modal');
  if (modal) modal.remove();
}

async function banUserFromModal(userId) {
  if (!confirm('هل أنت متأكد من حظر هذا المستخدم؟')) return;
  
  try {
    await db.collection('users').doc(userId).update({
      blockedFromPosting: true
    });
    showNotification('تم حظر المستخدم بنجاح');
    closeSinglePostModal();
  } catch (error) {
    showNotification('فشل حظر المستخدم', 'error');
  }
}

async function deletePostFromModal(postId) {
  if (!confirm('هل أنت متأكد من حذف هذا المنشور؟')) return;
  
  try {
    await db.collection('posts').doc(postId).delete();
    showNotification('تم حذف المنشور بنجاح');
    closeSinglePostModal();
  } catch (error) {
    showNotification('فشل حذف المنشور', 'error');
  }
}

function backToInbox() {
  document.getElementById('user-posts-page').remove();
  showInbox();
}

async function banUserFromPostsPage(userId) {
  if (!confirm('هل أنت متأكد من حظر هذا المستخدم؟')) return;
  
  try {
    await db.collection('users').doc(userId).update({
      blockedFromPosting: true
    });
    showNotification('تم حظر المستخدم بنجاح');
  } catch (error) {
    showNotification('فشل حظر المستخدم', 'error');
  }
}

async function deleteAllUserPosts(userId) {
  if (!confirm('هل أنت متأكد من حذف جميع منشورات هذا المستخدم؟')) return;
  
  try {
    const userPosts = await db.collection('posts')
      .where('userId', '==', userId)
      .get();
    
    const batch = db.batch();
    userPosts.forEach(doc => {
      batch.delete(doc.ref);
    });
    
    await batch.commit();
    showNotification('تم حذف جميع منشورات المستخدم');
    backToInbox();
  } catch (error) {
    showNotification('فشل حذف المنشورات', 'error');
  }
}

async function deleteSinglePost(postId) {
  if (!confirm('هل أنت متأكد من حذف هذا المنشور؟')) return;
  
  try {
    await db.collection('posts').doc(postId).delete();
    showNotification('تم حذف المنشور بنجاح');
    const userId = document.querySelector('#user-posts-page .btn-danger').onclick.toString().match(/'([^']+)'/)[1];
    document.getElementById('user-posts-page').remove();
    await showUserPostsPage(userId);
  } catch (error) {
    showNotification('فشل حذف المنشور', 'error');
  }
}

async function viewPostDetails(postId) {
  await showSinglePostModal(postId);
}

async function fetchLatestBroadcast() {
  if (isFirstLoginSession) return;
  try {
    const seenBroadcasts = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    const userSignupTime = localStorage.getItem('userSignupTime');
    const snap = await db.collection('broadcasts').orderBy('createdAt', 'desc').limit(1).get();
    if (snap.empty) return;
    const broadcast = snap.docs[0];
    const id = broadcast.id;
    const data = broadcast.data();
    const time = data.createdAt?.toDate ? data.createdAt.toDate() : new Date();
    if (!seenBroadcasts.includes(id) && (!userSignupTime || new Date(userSignupTime) < time)) {
      document.getElementById('broadcast-title-display').textContent = data.title || 'إشعار عام';
      document.getElementById('broadcast-text-display').textContent = data.message || data.text || '';
      document.getElementById('broadcast-banner').classList.add('show');
      document.getElementById('broadcast-overlay').classList.add('show');
      lastBroadcast = id;
    }
  } catch (e) { console.error("fetchLatestBroadcast", e); }
}

function dismissBroadcast() {
  document.getElementById('broadcast-banner').classList.remove('show');
  document.getElementById('broadcast-overlay').classList.remove('show');
  if (lastBroadcast) {
    const seen = JSON.parse(localStorage.getItem('seenBroadcasts') || '[]');
    if (!seen.includes(lastBroadcast)) {
      seen.push(lastBroadcast);
      localStorage.setItem('seenBroadcasts', JSON.stringify(seen));
    }
  }
}

function getLastSeenPostsTime() {
  const lastSeen = localStorage.getItem('lastSeenPostsTime');
  const time = lastSeen ? new Date(parseInt(lastSeen)) : new Date(0);
  return time;
}

function updateLastSeenPostsTime() {
  const now = Date.now();
  localStorage.setItem('lastSeenPostsTime', now.toString());
  unreadPostsCount = 0;
  updateNavBadges();
}

function startAllListeners() {
  startInboxListener();
  startPostsListener();
}

function startInboxListener() {
  if (!currentUser) return;
  if (notificationsListener) {
    notificationsListener();
  }
  
  let lastUpdate = 0;
  const updateInterval = 30000;
  
  notificationsListener = db.collection('inbox')
    .where('userId', '==', currentUser.uid)
    .where('status', '==', 'unread')
    .onSnapshot(async (snapshot) => {
      const now = Date.now();
      if (now - lastUpdate < updateInterval) return;
      
      lastUpdate = now;
      
      let unreadCount = 0;
      const nowTime = Date.now();
      
      snapshot.forEach(doc => {
        const msg = doc.data();
        const msgTime = msg.createdAt?.toDate?.()?.getTime() || 0;
        const isRecent = (nowTime - msgTime) < (7 * 24 * 60 * 60 * 1000);
        
        if (msg.status === 'unread' && isRecent) {
          unreadCount++;
        }
      });
      
      unreadNotifications.inbox = unreadCount;
      updateAllBadges();
    }, (error) => {
      console.error('Notifications listener error:', error);
    });
}

function startPostsListener() {
  if (postsListener) postsListener();
  
  const lastSeenTime = getLastSeenPostsTime();
  let lastUpdate = 0;
  const updateInterval = 60000;
  
  postsListener = db.collection("posts")
    .where("createdAt", ">=", lastSeenTime)
    .where("status", "==", "active")
    .onSnapshot((snapshot) => {
      const now = Date.now();
      if (now - lastUpdate < updateInterval) return;
      
      lastUpdate = now;
      
      let newCount = 0;
      
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const postTime = change.doc.data().createdAt?.toDate?.();
          if (postTime && postTime > lastSeenTime) {
            newCount++;
          }
        }
      });
      
      if (newCount > 0) {
        unreadPostsCount = newCount;
        updateNavBadges();
      }
    }, (error) => {
      console.error("Posts listener error:", error);
    });
}

function stopAllListeners() {
  if (notificationsListener) {
    notificationsListener();
    notificationsListener = null;
  }
  if (postsListener) {
    postsListener();
    postsListener = null;
  }
}

function updateAllBadges() {
  updateNavBadges();
}

function updateNavBadges() {
  const postsBadge = document.getElementById('posts-badge');
  if (postsBadge) {
    if (unreadPostsCount > 0) {
      postsBadge.style.display = 'flex';
      postsBadge.textContent = unreadPostsCount > 9 ? '9+' : unreadPostsCount.toString();
    } else {
      postsBadge.style.display = 'none';
    }
  }
  
  const inboxBadge = document.getElementById('inbox-badge');
  if (inboxBadge) {
    if (unreadNotifications.inbox > 0) {
      inboxBadge.style.display = 'flex';
      inboxBadge.textContent = unreadNotifications.inbox > 9 ? '9+' : unreadNotifications.inbox.toString();
    } else {
      inboxBadge.style.display = 'none';
    }
  }
  
  const profileBadge = document.getElementById('profile-notification-badge');
  if (profileBadge) {
    const totalProfileNotifications = unreadNotifications.inbox;
    if (totalProfileNotifications > 0) {
      profileBadge.style.display = 'flex';
      profileBadge.textContent = totalProfileNotifications > 9 ? '9+' : totalProfileNotifications.toString();
    } else {
      profileBadge.style.display = 'none';
    }
  }
}

async function markAllNotificationsAsRead() {
  if (!currentUser) return;
  try {
    let query;
    if (isOwner()) {
      const allMessages = await db.collection('inbox').get();
      const batch = db.batch();
      let updatedCount = 0;
      
      allMessages.forEach(doc => {
        const msg = doc.data();
        if (msg.status === 'unread' && (msg.type === 'admin_report' || msg.type === 'support_request')) {
          batch.update(doc.ref, { status: 'read' });
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
        unreadNotifications.inbox = 0;
        updateAllBadges();
        showNotification(`تم تحديد ${updatedCount} إشعار كمقروء`);
      }
    } else {
      const userMessages = await db.collection('inbox').get();
      const batch = db.batch();
      let updatedCount = 0;
      
      userMessages.forEach(doc => {
        const msg = doc.data();
        if (msg.status === 'unread' && msg.userId === currentUser.uid) {
          batch.update(doc.ref, { status: 'read' });
          updatedCount++;
        }
      });
      
      if (updatedCount > 0) {
        await batch.commit();
        unreadNotifications.inbox = 0;
        updateAllBadges();
        showNotification(`تم تحديد ${updatedCount} إشعار كمقروء`);
      }
    }
  } catch (error) {
    console.error('Error marking notifications as read:', error);
  }
}

function markPostsAsSeen() {
  updateLastSeenPostsTime();
}

function clearPostsBadge() {
  unreadPostsCount = 0;
  updateLastSeenPostsTime();
  updateAllBadges();
}

function clearInboxBadge() {
  unreadNotifications.inbox = 0;
  updateAllBadges();
}

function openForgotPasswordModal() {
  document.getElementById('forgot-password-modal').style.display = 'block';
}

function closeForgotPasswordModal() {
  document.getElementById('forgot-password-modal').style.display = 'none';
}

async function handleForgotPassword() {
  const email = document.getElementById('forgot-email').value.trim();
  const btn = document.getElementById('forgot-submit-btn');
  
  if (!email) {
    return showNotification('يرجى إدخال البريد الإلكتروني', 'error');
  }
  
  if (!validateEmail(email)) {
    return showNotification('صيغة البريد الإلكتروني غير صحيحة', 'error');
  }
  
  btn.disabled = true;
  btn.textContent = 'جاري الإرسال...';
  
  try {
    await auth.sendPasswordResetEmail(email);
    showNotification('تم إرسال رابط إعادة تعيين كلمة المرور إلى بريدك الإلكتروني');
    setTimeout(() => { closeForgotPasswordModal(); }, 3000);
  } catch (error) {
    console.error('Password reset error:', error);
    let errorMessage = 'حدث خطأ أثناء إرسال رابط الاستعادة';
    switch (error.code) {
      case 'auth/user-not-found':
        errorMessage = 'البريد الإلكتروني غير مسجل في النظام';
        break;
      case 'auth/invalid-email':
        errorMessage = 'صيغة البريد الإلكتروني غير صحيحة';
        break;
      case 'auth/too-many-requests':
        errorMessage = 'محاولات كثيرة. حاول لاحقاً';
        break;
    }
    showNotification(errorMessage, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'إرسال رابط الاستعادة';
  }
}

function initializePullToRefresh() {
  let startY;
  let isAtTop = false;
  const pullIndicator = document.getElementById("pull-bubble");
  
  if (!pullIndicator) return;
  
  document.addEventListener('touchstart', e => {
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    isAtTop = (window.scrollY === 0);
    
    if (isAtTop) {
      startY = e.touches[0].pageY;
    }
  });
  
  document.addEventListener('touchmove', e => {
    if (!startY || !isAtTop) return;
    
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    const currentY = e.touches[0].pageY;
    const diff = currentY - startY;
    
    if (diff > 0 && window.scrollY === 0) {
      e.preventDefault();
      
      if (currentPage === 'main-page') {
        pullIndicator.style.display = 'block';
        pullIndicator.style.opacity = Math.min(1, diff / 100);
      }
    }
  });
  
  document.addEventListener('touchend', e => {
    if (!startY || !isAtTop) return;
    
    const currentPage = document.querySelector('.page[style*="display: block"]')?.id;
    const currentY = e.changedTouches[0].pageY;
    const diff = currentY - startY;
    
    if (diff > 100 && window.scrollY === 0) {
      if (currentPage === 'main-page') {
        pullIndicator.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> جاري التحديث...';
        
        setTimeout(() => {
          loadPostsFromFirestore().then(() => {
            pullIndicator.style.display = 'none';
            clearPostsBadge();
            showNotification("تم تحديث المنشورات");
          }).catch(error => {
            pullIndicator.style.display = 'none';
            showNotification("فشل التحديث", "error");
          });
        }, 1000);
      }
    } else {
      pullIndicator.style.display = 'none';
    }
    
    startY = null;
    isAtTop = false;
  });
  
  window.addEventListener('scroll', () => {
    if (window.scrollY > 10) {
      pullIndicator.style.display = 'none';
    }
  });
}

console.log('✅ تطبيق سوق الطلاب محمل وجاهز للعمل!');

async function checkFirebaseConnection() {
  try {
    console.log("🔍 فحص اتصال Firebase...");
    
    await db.collection('users').limit(1).get();
    console.log("✅ Firebase connected successfully");
    return true;
    
  } catch (error) {
    console.error("❌ Firebase connection failed:", error);
    return false;
  }
}

function initializeDOMElements() {
  window.postsContainer = document.getElementById("posts-container");
  window.companiesContainer = document.getElementById("companies-container");
  window.userPostsContainer = document.getElementById("user-posts-container");
  window.detailsContainer = document.getElementById("details-container");
  window.commentsList = document.getElementById("comments-list-page");
  window.inboxContainer = document.getElementById("inbox-container");
  window.createBtn = document.getElementById("create-btn");
  window.createBtnLabel = document.getElementById("create-btn-label");
  window.filterBox = document.getElementById("filter-container");
  window.pillPosts = document.getElementById("pill-posts");
  window.pillCompanies = document.getElementById("pill-companies");
  
  if (!window.postsContainer) console.error("postsContainer not found");
  if (!window.companiesContainer) console.error("companiesContainer not found");
  if (!window.userPostsContainer) console.error("userPostsContainer not found");
  if (!window.detailsContainer) console.error("detailsContainer not found");
  if (!window.commentsList) console.error("commentsList not found");
  if (!window.inboxContainer) console.error("inboxContainer not found");
}

function initializeApp() {
    console.log('✅ بدء تهيئة تطبيق سوق الطلاب...');
    
    try {
        initializeDOMElements();
        loadTheme();
        initializeImageUpload();
        initializePullToRefresh();
        initializePages();
        
        initializeStudyTimer();
        initializeAIChat();
        
        const messageInput = document.getElementById('ai-message-input');
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });
        }
        
        setTimeout(() => {
            document.querySelectorAll(".owner-only").forEach(el => {
                if (isOwner()) {
                    el.style.display = "flex";
                }
            });
        }, 1000);
        
        console.log('✅ تهيئة التطبيق مكتملة بنجاح');
        
    } catch (error) {
        console.error('❌ خطأ في تهيئة التطبيق:', error);
        showNotification('حدث خطأ في تحميل التطبيق', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM محمل - بدء تهيئة التطبيق');
    setTimeout(() => {
        try {
            initializeApp();
            setTimeout(() => {
                checkFirebaseConnection().then(connected => {
                    if (!connected) {
                        console.warn('⚠️ تحذير: اتصال Firebase ضعيف');
                    }
                });
            }, 2000);
        } catch (error) {
            console.error('❌ خطأ فادح في التهيئة:', error);
            const loadingText = document.getElementById('loading-text');
            if (loadingText) {
                loadingText.innerHTML = 'خطأ في تحميل التطبيق<br><small>حدث خطأ غير متوقع</small>';
                loadingText.style.color = '#ff6b6b';
            }
        }
    }, 100);
});

    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(() => console.log('Service Worker registered'))
            .catch(err => console.log('Error:', err));
    }
    
let currentReportPostId = null;
let selectedReportReason = '';

function reportPost(postId) {
    if (!currentUser) {
        showNotification('يلزم تسجيل الدخول', 'warning');
        return;
    }
    
    currentReportPostId = postId;
    selectedReportReason = '';
    document.getElementById('report-custom-input').style.display = 'none';
    document.getElementById('report-custom-input').value = '';
    document.getElementById('report-submit-btn').disabled = true;
    document.getElementById('report-modal').style.display = 'block';
}

function selectReportReason(reason) {
    selectedReportReason = reason;
    document.getElementById('report-submit-btn').disabled = false;
    
    const customInput = document.getElementById('report-custom-input');
    if (reason === 'سبب آخر') {
        customInput.style.display = 'block';
        customInput.focus();
    } else {
        customInput.style.display = 'none';
        customInput.value = '';
    }
    
    document.querySelectorAll('.report-reason-btn').forEach(btn => {
        btn.style.background = 'rgba(255, 255, 255, 0.15)';
        btn.style.border = '1px solid rgba(255, 255, 255, 0.3)';
    });
    
    event.target.style.background = 'rgba(255, 209, 102, 0.3)';
    event.target.style.border = '1px solid #ffd166';
}

function closeReportModal() {
    document.getElementById('report-modal').style.display = 'none';
    currentReportPostId = null;
    selectedReportReason = '';
}

async function submitReport() {
    if (!currentReportPostId || !selectedReportReason) return;
    
    const customReason = document.getElementById('report-custom-input').value.trim();
    const finalReason = selectedReportReason === 'سبب آخر' && customReason ? 
        `سبب آخر: ${customReason}` : selectedReportReason;
    
    if (!finalReason) {
        showNotification('يرجى اختيار سبب الإبلاغ', 'error');
        return;
    }
    
    const btn = document.getElementById('report-submit-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
    
    try {
        const post = posts.find(p => p.id === currentReportPostId);
        
        const ownerQuery = await db.collection('users')
            .where('email', '==', APP_OWNER_EMAIL)
            .limit(1)
            .get();
        
        if (ownerQuery.empty) return;
        
        const ownerDoc = ownerQuery.docs[0];
        const ownerUid = ownerDoc.id;
        
        await db.collection('inbox').add({
            userId: ownerUid,
            type: 'admin_report',
            postId: currentReportPostId,
            reporterUid: currentUser.uid,
            reporterName: currentUser.name || 'مستخدم',
            reporterShortUid: currentUser.shortUid || 'غير معروف',
            title: '🚨 بلاغ جديد',
            message: `👤 المبلغ: ${currentUser.name || 'مستخدم'}\n📝 السبب: ${finalReason}\n🆔 معرف المبلغ: ${currentUser.shortUid || currentUser.uid.substring(0, 8)}`,
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const reportedPosts = JSON.parse(localStorage.getItem('reportedPosts') || '[]');
        if (!reportedPosts.includes(currentReportPostId)) {
            reportedPosts.push(currentReportPostId);
            localStorage.setItem('reportedPosts', JSON.stringify(reportedPosts));
        }
        
        showNotification('تم الإبلاغ عن المنشور وسيتم مراجعته');
        closeReportModal();
        
    } catch (e) {
        console.error('Report error:', e);
        showNotification('تعذّر إرسال البلاغ', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> إرسال الإبلاغ';
    }
}

document.addEventListener('click', function(e) {
    if (e.target.id === 'report-modal') {
        closeReportModal();
    }
});

function openConfirmationModal(title, message, onConfirm) {
    document.getElementById('confirmation-title').textContent = title;
    document.getElementById('confirmation-message').textContent = message;
    document.getElementById('confirmation-confirm-btn').onclick = function() {
        onConfirm();
        closeConfirmationModal();
    };
    document.getElementById('confirmation-modal').style.display = 'block';
}

function closeConfirmationModal() {
    document.getElementById('confirmation-modal').style.display = 'none';
}

async function deletePostWithConfirmation(postId) {
    openConfirmationModal(
        'حذف المنشور',
        'هل أنت متأكد من حذف هذا المنشور؟',
        async function() {
            await deletePost(postId);
        }
    );
}

async function deleteCommentWithConfirmation(commentId, postId) {
    openConfirmationModal(
        'حذف التعليق',
        'هل أنت متأكد من حذف هذا التعليق؟',
        async function() {
            await deleteComment(commentId, postId);
        }
    );
}

async function banCommentUserWithConfirmation(userId, postId) {
    openConfirmationModal(
        'حظر المستخدم',
        'هل أنت متأكد من حظر هذا المستخدم من التعليق على منشوراتك؟',
        async function() {
            await banCommentUser(userId, postId);
        }
    );
}

function markSoldWithConfirmation(postId, isSold) {
    const action = isSold ? 'إلغاء البيع' : 'تم البيع';
    openConfirmationModal(
        action,
        `هل أنت متأكد من ${action} هذا المنشور؟`,
        async function() {
            await markSold(postId, isSold);
        }
    );
}

function showStudyAssistantPage() {
    showPage("study-assistant");
}

function showAIChatPage() {
    showPage("ai-chat-page");
}

function showStudyTimerPage() {
    showPage("study-timer-page");
}

function showPoemsPage() {
    showPage("poems-page");
    loadPoems();
}

function showAITrainingPage() {
    showPage("ai-training-page");
    loadAITrainingList();
}

let aiConversationHistory = [];
let aiTrainingData = [];

async function sendAIMessage() {
    const messageInput = document.getElementById('ai-message-input');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    addMessageToChat('user', message);
    messageInput.value = '';
    
    const sendBtn = document.getElementById('ai-send-btn');
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        await loadAITrainingData();
        
        const conversation = prepareConversation(message);
        
        const response = await callOpenAI(conversation);
        
        addMessageToChat('assistant', response);
        
    } catch (error) {
        console.error('AI Error:', error);
        addMessageToChat('assistant', 'عذراً، حدث خطأ في المعالجة. يرجى المحاولة مرة أخرى.');
    } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }
}

function prepareConversation(userMessage) {
    const conversation = [];
    
    conversation.push({
        role: "system",
        content: `أنت مساعد ذكي لسوق الطلاب. مهمتك مساعدة الطلاب في دراستهم.
        
        التعليمات الأساسية:
        - كن مفيداً وودوداً
        - ساعد في جميع المواد الدراسية
        - اشرح المفاهيم بطريقة بسيطة
        - استخدم الرموز الرياضية والعلمية عند الحاجة
        - تذكر تاريخ المحادثة كاملاً
        
        التعليمات المخصصة:
        ${aiTrainingData.map(item => item.content).join('\n')}`
    });
    
    aiConversationHistory.forEach(msg => {
        conversation.push({
            role: msg.role,
            content: msg.content
        });
    });
    
    conversation.push({
        role: "user",
        content: userMessage
    });
    
    return conversation;
}

async function callOpenAI(conversation) {
    const API_KEY = "sk-372e4ef14bff4871813101af88060e39";
    
    try {
        const response = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: conversation,
                max_tokens: 1000,
                temperature: 0.7
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            console.error('OpenAI API Error:', errorData);
            throw new Error(`فشل في الاتصال: ${errorData.error?.message || 'Unknown error'}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
        
    } catch (error) {
        console.error('OpenAI Connection Error:', error);
        throw new Error('تعذر الاتصال بالذكاء الاصطناعي. تأكد من اتصال الإنترنت.');
    }
}

function addMessageToChat(role, content) {
    const chatContainer = document.getElementById('ai-chat-container');
    
    const messageDiv = document.createElement('div');
    messageDiv.className = 'post';
    messageDiv.style.background = role === 'user' ? '#f0f8ff' : '#e9f0ff';
    messageDiv.style.border = role === 'user' ? '1px solid #c9e6ff' : '1px solid #d0dcff';
    messageDiv.style.marginBottom = '6px';
    messageDiv.style.padding = '6px 8px';
    messageDiv.style.borderRadius = '8px';
    
    const bgColor = role === 'user' ? 'var(--primary-color)' : 'var(--success-color)';
    const icon = role === 'user' ? 'fas fa-user' : 'fas fa-robot';
    const name = role === 'user' ? 'أنت' : 'المساعد الذكي';
    
    messageDiv.innerHTML = `
        <div style="display: flex; align-items: flex-start; gap: 6px;">
            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${bgColor}; 
                        display: flex; align-items: center; justify-content: center; color: white; 
                        font-size: 11px; flex-shrink: 0;">
                <i class="${icon}"></i>
            </div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 700; color: ${bgColor}; margin-bottom: 2px; font-size: 12px;">${name}</div>
                <div style="color: #333; line-height: 1.3; white-space: pre-wrap; font-size: 13px; 
                            word-wrap: break-word; overflow-wrap: break-word;">
                    ${content}
                </div>
            </div>
        </div>
    `;
    
    chatContainer.appendChild(messageDiv);
    
    aiConversationHistory.push({
        role: role === 'user' ? 'user' : 'assistant',
        content: content
    });
    
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function saveAITraining() {
    if (!isOwner()) return showNotification('للمالك فقط', 'error');
    
    const trainingText = document.getElementById('ai-training-text').value.trim();
    const trainingType = document.getElementById('ai-training-type').value;
    
    if (!trainingText) {
        return showNotification('يرجى إدخال التعليمات', 'error');
    }
    
    try {
        await db.collection('ai_training').add({
            content: trainingText,
            type: trainingType,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedBy: currentUser.uid
        });
        
        showNotification('تم حفظ التعليمات بنجاح');
        document.getElementById('ai-training-text').value = '';
        loadAITrainingList();
        
    } catch (error) {
        console.error('Error saving AI training:', error);
        showNotification('فشل في حفظ التعليمات', 'error');
    }
}

async function loadAITrainingData() {
    try {
        const snapshot = await db.collection('ai_training').get();
        aiTrainingData = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
    } catch (error) {
        console.error('Error loading AI training:', error);
    }
}

async function loadAITrainingList() {
    const container = document.getElementById('ai-training-list');
    if (!container) return;
    
    container.innerHTML = '<div class="post"><p style="text-align: center;">جاري تحميل التعليمات...</p></div>';

    try {
        await loadAITrainingData();
        
        if (aiTrainingData.length === 0) {
            container.innerHTML = '<div class="post"><p style="text-align: center;">لا توجد تعليمات مضافة بعد</p></div>';
            return;
        }
        
        container.innerHTML = aiTrainingData.map(item => `
            <div class="post">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <span style="font-weight: 700; color: var(--primary-color);">
                        ${item.type === 'command' ? '⚡ أمر' : item.type === 'information' ? '📚 معلومات' : '💬 نمط رد'}
                    </span>
                    <button class="btn btn-danger btn-xs" onclick="deleteAITraining('${item.id}')">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
                <div style="color: #333; line-height: 1.5; white-space: pre-wrap;">${item.content}</div>
                <small style="color: var(--light-text);">${formatRelativeTime(item.createdAt?.toDate?.())}</small>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading AI training:', error);
        container.innerHTML = '<div class="post"><p style="text-align: center; color: var(--danger-color);">خطأ في تحميل التعليمات</p></div>';
    }
}

async function deleteAITraining(id) {
    if (!isOwner()) return;
    
    if (!confirm('هل أنت متأكد من حذف هذه التعليمات؟')) return;
    
    try {
        await db.collection('ai_training').doc(id).delete();
        showNotification('تم حذف التعليمات');
        loadAITrainingList();
    } catch (error) {
        showNotification('فشل في الحذف', 'error');
    }
}

function initializeAIChat() {
    aiConversationHistory = [];
    const chatContainer = document.getElementById('ai-chat-container');
    if (chatContainer) {
        chatContainer.innerHTML = `
            <div class="post" style="background: #e9f0ff; border: 1px solid #d0dcff;">
                <div style="display: flex; align-items: flex-start; gap: 10px;">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 5px;">المساعد الذكي</div>
                        <div style="color: #333; line-height: 1.5;">مرحباً! أنا المساعد الذكي لسوق الطلاب. كيف يمكنني مساعدتك في دراستك اليوم؟</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    const clearBtn = document.getElementById('clear-chat-btn');
    if (clearBtn) {
        clearBtn.style.display = 'block';
        clearBtn.onclick = function() {
            if (confirm('هل تريد حذف محادثة الذكاء الاصطناعي؟')) {
                aiConversationHistory = [];
                const chatContainer = document.getElementById('ai-chat-container');
                if (chatContainer) {
                    chatContainer.innerHTML = `
                        <div class="post" style="background: #e9f0ff; border: 1px solid #d0dcff;">
                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 700; color: var(--primary-color); margin-bottom: 5px;">المساعد الذكي</div>
                                    <div style="color: #333; line-height: 1.5;">مرحباً! أنا المساعد الذكي لسوق الطلاب. كيف يمكنني مساعدتك في دراستك اليوم؟</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                showNotification('تم حذف المحادثة');
            }
        };
    }
}

let studyTimer = {
    startTime: parseInt(localStorage.getItem('studyTimerStartTime')) || null,
    totalSeconds: parseInt(localStorage.getItem('studyTimerTotalSeconds')) || 0,
    isRunning: localStorage.getItem('studyTimerIsRunning') === 'true',
    isPaused: localStorage.getItem('studyTimerIsPaused') === 'true'
};

function startStudyTimer() {
    if (!studyTimer.isRunning) {
        studyTimer.startTime = Date.now();
        studyTimer.isRunning = true;
        studyTimer.isPaused = false;
        
        localStorage.setItem('studyTimerStartTime', studyTimer.startTime.toString());
        localStorage.setItem('studyTimerIsRunning', 'true');
        localStorage.setItem('studyTimerIsPaused', 'false');
        
        document.getElementById('start-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').disabled = false;
        document.getElementById('stop-timer-btn').disabled = false;
        
        studyTimer.interval = setInterval(updateTimerDisplay, 1000);
        
        showNotification('بدأت جلسة الدراسة! 💪');
    }
}

function updateTimerDisplay() {
    if (studyTimer.isRunning && !studyTimer.isPaused) {
        let elapsedSeconds;
        
        if (studyTimer.startTime) {
            elapsedSeconds = Math.floor((Date.now() - studyTimer.startTime) / 1000);
        } else {
            elapsedSeconds = studyTimer.totalSeconds;
        }
        
        const hours = Math.floor(elapsedSeconds / 3600);
        const minutes = Math.floor((elapsedSeconds % 3600) / 60);
        const seconds = elapsedSeconds % 60;
        
        const display = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('study-timer-display').textContent = display;
    }
}

function pauseStudyTimer() {
    if (studyTimer.isRunning && !studyTimer.isPaused) {
        studyTimer.isPaused = true;
        studyTimer.totalSeconds = Math.floor((Date.now() - studyTimer.startTime) / 1000);
        
        localStorage.setItem('studyTimerTotalSeconds', studyTimer.totalSeconds.toString());
        localStorage.setItem('studyTimerIsPaused', 'true');
        
        clearInterval(studyTimer.interval);
        
        document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-play"></i> متابعة';
        showNotification('تم إيقاف العداد مؤقتاً', 'warning');
    } else if (studyTimer.isPaused) {
        studyTimer.startTime = Date.now() - (studyTimer.totalSeconds * 1000);
        studyTimer.isPaused = false;
        
        localStorage.setItem('studyTimerStartTime', studyTimer.startTime.toString());
        localStorage.setItem('studyTimerIsPaused', 'false');
        
        studyTimer.interval = setInterval(updateTimerDisplay, 1000);
        
        document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
        showNotification('استمرار الدراسة! 📚');
    }
}

function stopStudyTimer() {
    if (studyTimer.isRunning) {
        if (studyTimer.interval) {
            clearInterval(studyTimer.interval);
            studyTimer.interval = null;
        }
        
        let sessionSeconds = 0;
        if (studyTimer.startTime) {
            sessionSeconds = Math.floor((Date.now() - studyTimer.startTime) / 1000);
        }
        
        addStudySession(sessionSeconds);
        
        studyTimer.isRunning = false;
        studyTimer.isPaused = false;
        studyTimer.startTime = null;
        studyTimer.totalSeconds = 0;
        
        document.getElementById('start-timer-btn').disabled = false;
        document.getElementById('pause-timer-btn').disabled = true;
        document.getElementById('stop-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
        
        document.getElementById('study-timer-display').textContent = '00:00:00';
        
        updateSessionsDisplay();
        
        showNotification(`تم إنهاء جلسة الدراسة! الوقت: ${formatTime(sessionSeconds)} 🎉`);
    } else {
        showNotification('العداد غير نشط', 'warning');
    }
}

function resetStudyTimer() {
    studyTimer = {
        startTime: null,
        totalSeconds: 0,
        isRunning: false,
        isPaused: false
    };
    
    localStorage.removeItem('studyTimerStartTime');
    localStorage.removeItem('studyTimerTotalSeconds');
    localStorage.removeItem('studyTimerIsRunning');
    localStorage.removeItem('studyTimerIsPaused');
    
    document.getElementById('study-timer-display').textContent = '00:00:00';
    document.getElementById('start-timer-btn').disabled = false;
    document.getElementById('pause-timer-btn').disabled = true;
    document.getElementById('stop-timer-btn').disabled = true;
    document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-pause"></i> إيقاف مؤقت';
}

function initializeStudyTimer() {
    if (studyTimer.isRunning && !studyTimer.isPaused && studyTimer.startTime) {
        document.getElementById('start-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').disabled = false;
        document.getElementById('stop-timer-btn').disabled = false;
        
        studyTimer.interval = setInterval(updateTimerDisplay, 1000);
        showNotification('تم استئناف جلسة الدراسة السابقة', 'info');
    } else if (studyTimer.isPaused) {
        document.getElementById('start-timer-btn').disabled = true;
        document.getElementById('pause-timer-btn').disabled = false;
        document.getElementById('stop-timer-btn').disabled = false;
        document.getElementById('pause-timer-btn').innerHTML = '<i class="fas fa-play"></i> متابعة';
    }
    
    updateSessionsDisplay();
}

window.currentAudio = null;

async function loadPoems() {
    const container = document.getElementById('poems-list');
    if (!container) return;
    
    container.innerHTML = '<div class="post"><p style="text-align: center;">جاري تحميل القصائد...</p></div>';

    try {
        const snapshot = await db.collection('poems').orderBy('createdAt', 'desc').get();
        
        if (snapshot.empty) {
            container.innerHTML = '<div class="post"><p style="text-align: center;">لا توجد قصائد مضافة بعد</p></div>';
            return;
        }

        let poemsList = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));

        const pinnedPoems = poemsList.filter(poem => poem.isPinned);
        const normalPoems = poemsList.filter(poem => !poem.isPinned);
        window.poems = [...pinnedPoems, ...normalPoems];

        container.innerHTML = window.poems.map(poem => {
            const isPinned = poem.isPinned || false;
            const isPlaying = window.currentAudio && window.currentAudio.poemId === poem.id;
            const isLooping = window.currentAudio && window.currentAudio.isLooping;
            
            return `
                <div class="post" id="poem-${poem.id}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: var(--primary-color); font-size: 16px; cursor: pointer;" 
                                 onclick="playPoem('${poem.id}')">
                                ${isPinned ? '📌 ' : '🎵 '} 
                                ${poem.title || 'بدون عنوان'}
                                ${isPlaying ? ' <span style="color: var(--danger-color);">🔴</span>' : ''}
                            </div>
                            <small style="color: var(--light-text);">${formatRelativeTime(poem.createdAt?.toDate?.())}</small>
                        </div>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-xs" onclick="toggleAudioLoop('${poem.id}')" 
                                    style="background: ${isLooping ? 'var(--success-color)' : 'var(--secondary-color)'}; 
                                           color: ${isLooping ? 'white' : 'var(--text-color)'}; 
                                           border: none; font-weight: 700; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-redo"></i>
                            </button>
                            
                            <button class="btn btn-xs" onclick="togglePinPoem('${poem.id}', ${isPinned})" 
                                    style="background: ${isPinned ? 'linear-gradient(135deg, #FFD700, #FFA500)' : 'var(--secondary-color)'}; 
                                           color: ${isPinned ? 'white' : 'var(--text-color)'}; 
                                           border: none; font-weight: 700; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-thumbtack"></i>
                            </button>
                            
                            ${isPlaying ? `
                            <button class="btn btn-xs" onclick="stopCurrentAudio()" 
                                    style="background: var(--danger-color); color: white; border: none; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-stop"></i>
                            </button>
                            ` : ''}
                            
                            ${isOwner() ? `
                            <button class="btn btn-xs" onclick="deletePoem('${poem.id}')" 
                                    style="background: var(--danger-color); color: white; border: none; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading poems:', error);
        container.innerHTML = `
            <div class="post">
                <p style="text-align: center; color: var(--danger-color);">
                    خطأ في تحميل القصائد
                </p>
                <button class="btn" onclick="loadPoems()" style="margin-top: 10px; width: 100%;">
                    <i class="fas fa-redo"></i> إعادة المحاولة
                </button>
            </div>
        `;
    }
}

function playPoem(poemId) {
    console.log('playPoem called with ID:', poemId);
    
    const poem = window.poems.find(p => p.id === poemId);
    if (!poem) {
        console.error('Poem not found:', poemId);
        showNotification('لم يتم العثور على القصيدة', 'error');
        return;
    }

    console.log('Found poem:', poem.title);

    const videoId = extractYouTubeId(poem.youtubeUrl);
    if (!videoId) {
        console.error('Invalid YouTube URL:', poem.youtubeUrl);
        showNotification('رابط اليوتيوب غير صالح', 'error');
        return;
    }

    console.log('YouTube Video ID:', videoId);

    stopCurrentAudio();

    createHiddenAudioPlayer(videoId, poem.title, poemId);
    
    showNotification(`🔊 جاري تشغيل: ${poem.title}`);
}

function createHiddenAudioPlayer(videoId, title, poemId) {
    console.log('Creating hidden player for:', title);
    
    const existingPlayer = document.getElementById('hidden-youtube-player');
    if (existingPlayer) {
        console.log('Removing existing player');
        existingPlayer.remove();
    }

    const playerHTML = `
        <div id="hidden-youtube-player" style="position: fixed; top: -1000px; left: -1000px; width: 1px; height: 1px; overflow: hidden; opacity: 0; pointer-events: none;">
            <iframe 
                id="youtube-audio-${poemId}"
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&controls=0&showinfo=0&modestbranding=1&rel=0&enablejsapi=1&playsinline=1&loop=0"
                frameborder="0" 
                allow="autoplay; encrypted-media; accelerometer; clipboard-write; gyroscope"
                allowfullscreen
                style="width: 1px; height: 1px; border: none;">
            </iframe>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', playerHTML);
    
    console.log('Hidden player created');

    window.currentAudio = {
        isPlaying: true,
        videoId: videoId,
        title: title,
        poemId: poemId,
        player: document.getElementById(`youtube-audio-${poemId}`),
        isLooping: false
    };

    updatePoemsDisplay();
    
    console.log('Audio state updated:', window.currentAudio);
}

function toggleAudioLoop(poemId) {
    console.log('toggleAudioLoop called for:', poemId);
    
    if (!window.currentAudio) {
        showNotification('لا يوجد صوت قيد التشغيل', 'warning');
        return;
    }

    if (window.currentAudio.poemId !== poemId) {
        showNotification('يجب تشغيل القصيدة أولاً', 'warning');
        return;
    }

    window.currentAudio.isLooping = !window.currentAudio.isLooping;
    
    const iframe = window.currentAudio.player;
    if (iframe) {
        try {
            if (window.currentAudio.isLooping) {
                iframe.contentWindow.postMessage('{"event":"command","func":"setLoop", "args":[1]}', '*');
                showNotification('🔁 تم تفعيل وضع التكرار');
            } else {
                iframe.contentWindow.postMessage('{"event":"command","func":"setLoop", "args":[0]}', '*');
                showNotification('🔁 تم إلغاء وضع التكرار', 'info');
            }
            
            updatePoemsDisplay();
        } catch (error) {
            console.error('Error toggling loop:', error);
        }
    }
}

async function togglePinPoem(poemId, currentStatus) {
    console.log('togglePinPoem called:', poemId, currentStatus);
    
    try {
        const newPinStatus = !currentStatus;
        
        await db.collection('poems').doc(poemId).update({
            isPinned: newPinStatus,
            pinnedAt: newPinStatus ? firebase.firestore.FieldValue.serverTimestamp() : null
        });
        
        showNotification(newPinStatus ? '📌 تم تثبيت القصيدة' : '📌 تم إلغاء تثبيت القصيدة');
        
        await loadPoems();
        
    } catch (error) {
        console.error('Error toggling poem pin:', error);
        showNotification('فشل في تعديل حالة التثبيت', 'error');
    }
}

function stopCurrentAudio() {
    console.log('stopCurrentAudio called');
    
    const player = document.getElementById('hidden-youtube-player');
    
    if (player) {
        console.log('Removing player element');
        player.remove();
    }
    
    if (window.currentAudio) {
        try {
            if (window.currentAudio.player && window.currentAudio.player.contentWindow) {
                window.currentAudio.player.contentWindow.postMessage('{"event":"command","func":"stopVideo","args":""}', '*');
            }
        } catch (error) {
            console.error('Error stopping video:', error);
        }
        
        showNotification(`⏹️ تم إيقاف: ${window.currentAudio.title}`, 'info');
        window.currentAudio = null;
        
        updatePoemsDisplay();
    }
}

function updatePoemsDisplay() {
    console.log('updatePoemsDisplay called');
    if (document.getElementById('poems-page')?.style.display === 'block') {
        loadPoems();
    }
}

function extractYouTubeId(url) {
    const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
    const match = url.match(regex);
    return match ? match[1] : null;
}

function openAddPoemModal() {
    if (!isOwner()) return;
    document.getElementById('add-poem-modal').style.display = 'block';
}

function closeAddPoemModal() {
    document.getElementById('add-poem-modal').style.display = 'none';
    document.getElementById('poem-title').value = '';
    document.getElementById('poem-youtube-url').value = '';
}

async function savePoem() {
    if (!isOwner()) return;
    
    const title = document.getElementById('poem-title').value.trim();
    const youtubeUrl = document.getElementById('poem-youtube-url').value.trim();
    
    if (!title || !youtubeUrl) {
        return showNotification('يرجى ملء جميع الحقول', 'error');
    }
    
    const videoId = extractYouTubeId(youtubeUrl);
    if (!videoId) {
        return showNotification('رابط اليوتيوب غير صالح', 'error');
    }
    
    const btn = document.querySelector('#add-poem-modal .btn-success');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    
    try {
        await db.collection('poems').add({
            title: title,
            youtubeUrl: youtubeUrl,
            videoId: videoId,
            isPinned: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedBy: currentUser.uid
        });
        
        showNotification('تم إضافة القصيدة بنجاح');
        closeAddPoemModal();
        loadPoems();
        
    } catch (error) {
        console.error('Error saving poem:', error);
        showNotification('فشل في إضافة القصيدة', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function deletePoem(poemId) {
    if (!isOwner()) {
        showNotification('غير مسموح - للمالك فقط', 'error');
        return;
    }
    
    if (!confirm('هل أنت متأكد من حذف هذه القصيدة؟')) return;
    
    try {
        await db.collection('poems').doc(poemId).delete();
        showNotification('تم حذف القصيدة');
        loadPoems();
        
    } catch (error) {
        console.error('Error deleting poem:', error);
        showNotification('فشل في حذف القصيدة', 'error');
    }
}

function initializeAudioSystem() {
    window.currentAudio = null;
    
    const oldPlayer = document.getElementById('hidden-audio-player');
    if (oldPlayer) {
        oldPlayer.remove();
    }
}

let studySessions = JSON.parse(localStorage.getItem('studySessions')) || [];

function addStudySession(sessionSeconds) {
    const newSession = {
        id: Date.now(),
        duration: sessionSeconds,
        date: new Date().toLocaleString('ar-IQ'),
        timestamp: Date.now()
    };
    
    studySessions.unshift(newSession);
    
    studySessions = studySessions.slice(0, 3);
    
    localStorage.setItem('studySessions', JSON.stringify(studySessions));
    
    console.log('✅ تم تسجيل الجلسة:', newSession);
}

function updateSessionsDisplay() {
    const sessionsContainer = document.getElementById('sessions-history');
    if (!sessionsContainer) return;
    
    if (studySessions.length === 0) {
        sessionsContainer.innerHTML = `
            <div style="text-align: center; color: var(--light-text); padding: 15px;">
                <i class="fas fa-history" style="font-size: 24px; margin-bottom: 8px;"></i>
                <div>لا توجد جلسات سابقة</div>
            </div>
        `;
        return;
    }
    
    sessionsContainer.innerHTML = `
        <div style="font-weight: 900; color: var(--primary-color); margin-bottom: 12px; text-align: center; font-size: 16px;">
            📊 سجل الجلسات الأخيرة
        </div>
        ${studySessions.map((session, index) => `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                        padding: 10px; margin: 6px 0; background: rgba(74, 107, 255, 0.1); 
                        border-radius: 8px; border-right: 3px solid var(--primary-color);">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: var(--primary-color); 
                                color: white; display: flex; align-items: center; justify-content: center; 
                                font-size: 12px; font-weight: bold;">
                        ${index + 1}
                    </div>
                    <div>
                        <div style="font-weight: 700; color: var(--text-color); font-size: 14px;">
                            ${formatTime(session.duration)}
                        </div>
                        <div style="color: var(--light-text); font-size: 11px;">
                            ${session.date}
                        </div>
                    </div>
                </div>
                <div style="color: var(--success-color); font-weight: 800; font-size: 13px;">
                    ${getSessionEmoji(session.duration)}
                </div>
            </div>
        `).join('')}
    `;
}

function getSessionEmoji(duration) {
    const minutes = Math.floor(duration / 60);
    if (minutes >= 60) return '🏆';
    if (minutes >= 30) return '🔥';
    if (minutes >= 15) return '⭐';
    return '👍';
}

function formatTime(seconds) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    if (hours > 0) {
        return `${hours} س ${minutes} د ${secs} ث`;
    } else if (minutes > 0) {
        return `${minutes} دقيقة ${secs} ثانية`;
    } else {
        return `${secs} ثانية`;
    }
}

function initializeTimerWithHistory() {
    const timerPage = document.getElementById('study-timer-page');
    if (!timerPage) return;
    
    let sessionsContainer = document.getElementById('sessions-history');
    if (!sessionsContainer) {
        sessionsContainer = document.createElement('div');
        sessionsContainer.id = 'sessions-history';
        sessionsContainer.style.cssText = `
            margin-top: 20px;
            padding: 15px;
            background: var(--sky);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        `;
        
        const statsDiv = document.getElementById('timer-stats');
        if (statsDiv) {
            statsDiv.parentNode.insertBefore(sessionsContainer, statsDiv.nextSibling);
        } else {
            const postsContainer = timerPage.querySelector('.posts-container');
            if (postsContainer) {
                postsContainer.appendChild(sessionsContainer);
            }
        }
    }
    
    updateSessionsDisplay();
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTimerWithHistory, 1000);
});

function showStudyTimerPage() {
    showPage("study-timer-page");
    updateSessionsDisplay();
}

let dailyTasks = JSON.parse(localStorage.getItem('dailyTasks')) || [];
let tasksTimers = {};

function showDailyTasksPage() {
    showPage("daily-tasks");
    loadDailyTasks();
    updateTasksStats();
}

function openAddTaskModal() {
    document.getElementById('add-task-modal').style.display = 'block';
    document.getElementById('task-name').value = '';
    document.getElementById('task-hours').value = '1';
    document.getElementById('task-minutes').value = '0';
    document.getElementById('task-seconds').value = '0';
}

function closeAddTaskModal() {
    document.getElementById('add-task-modal').style.display = 'none';
}

function openCongratsModal(taskName, timeSaved) {
    document.getElementById('congrats-message').textContent = `لقد أكملت "${taskName}" بنجاح!`;
    document.getElementById('time-saved').textContent = `وفرت ${timeSaved}`;
    document.getElementById('congrats-modal').style.display = 'block';
}

function closeCongratsModal() {
    document.getElementById('congrats-modal').style.display = 'none';
}

function addNewTask() {
    const name = document.getElementById('task-name').value.trim();
    const hours = parseInt(document.getElementById('task-hours').value) || 0;
    const minutes = parseInt(document.getElementById('task-minutes').value) || 0;
    const seconds = parseInt(document.getElementById('task-seconds').value) || 0;

    if (!name) {
        showNotification('يرجى إدخال اسم الواجب', 'error');
        return;
    }

    const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
    if (totalSeconds <= 0) {
        showNotification('يرجى تحديد وقت صحيح للواجب', 'error');
        return;
    }

    const colors = [
        'linear-gradient(135deg, #FF6B6B 0%, #FF8E6B 100%)',
        'linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%)',
        'linear-gradient(135deg, #FFD166 0%, #FFB347 100%)',
        'linear-gradient(135deg, #06D6A0 0%, #04A777 100%)',
        'linear-gradient(135deg, #118AB2 0%, #0A6E8F 100%)',
        'linear-gradient(135deg, #EF476F 0%, #D43A5E 100%)',
        'linear-gradient(135deg, #9D4EDD 0%, #7B3CB8 100%)',
        'linear-gradient(135deg, #FF9A9E 0%, #FAD0C4 100%)',
        'linear-gradient(135deg, #A1C4FD 0%, #C2E9FB 100%)',
        'linear-gradient(135deg, #FFECD2 0%, #FCB69F 100%)'
    ];

    const newTask = {
        id: Date.now(),
        name: name,
        totalTime: totalSeconds,
        remainingTime: totalSeconds,
        isCompleted: false,
        createdAt: new Date().toLocaleString('ar-IQ'),
        color: colors[Math.floor(Math.random() * colors.length)]
    };

    dailyTasks.push(newTask);
    saveTasksToLocalStorage();
    
    showNotification('تم إضافة الواجب بنجاح!');
    closeAddTaskModal();
    loadDailyTasks();
    updateTasksStats();
    startTaskTimer(newTask.id);
}

function saveTasksToLocalStorage() {
    localStorage.setItem('dailyTasks', JSON.stringify(dailyTasks));
}

function loadDailyTasks() {
    const tasksList = document.getElementById('tasks-list');
    if (!tasksList) return;

    if (dailyTasks.length === 0) {
        tasksList.innerHTML = `
            <div class="post">
                <p style="text-align: center; color: var(--light-text);">
                    لا توجد واجبات. أضف واجبك الأول!
                </p>
            </div>
        `;
        return;
    }

    const sortedTasks = [...dailyTasks].sort((a, b) => {
        if (a.isCompleted && !b.isCompleted) return 1;
        if (!a.isCompleted && b.isCompleted) return -1;
        return b.id - a.id;
    });

    tasksList.innerHTML = sortedTasks.map(task => `
        <div class="post" id="task-${task.id}" style="background: ${task.color}; color: white; border: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <div style="font-weight: 900; font-size: 18px; margin-bottom: 5px;">
                        ${task.name}
                        ${task.isCompleted ? ' <span style="font-size: 14px;">✅</span>' : ''}
                    </div>
                    <div style="font-size: 13px; opacity: 0.9;">
                        أضيف: ${task.createdAt}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    ${!task.isCompleted ? `
                    <button class="btn btn-xs" onclick="completeTask(${task.id})" 
                            style="background: rgba(255,255,255,0.3); color: white; border: 1px solid rgba(255,255,255,0.5);">
                        <i class="fas fa-check-circle"></i> انتهيت
                    </button>
                    ` : ''}
                    <button class="btn btn-xs" onclick="deleteTask(${task.id})" 
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3);">
                        <i class="fas fa-trash"></i> حذف
                    </button>
                </div>
            </div>
            
            ${!task.isCompleted ? `
            <div style="text-align: center; margin: 15px 0;">
                <div style="font-size: 28px; font-weight: 900; font-family: monospace; letter-spacing: 2px;" id="timer-${task.id}">
                    ${formatTime(task.remainingTime)}
                </div>
                <div style="font-size: 13px; margin-top: 5px; opacity: 0.9;">
                    الوقت المتبقي
                </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden; margin: 10px 0;">
                <div id="progress-${task.id}" 
                     style="height: 100%; background: white; width: ${((task.totalTime - task.remainingTime) / task.totalTime) * 100}%; 
                            border-radius: 3px; transition: width 1s;">
                </div>
            </div>
            ` : `
            <div style="text-align: center; padding: 15px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 10px 0;">
                <div style="font-size: 48px; margin-bottom: 10px;">🎉</div>
                <div style="font-weight: 900; font-size: 16px;">تم إكمال هذا الواجب بنجاح!</div>
            </div>
            `}
        </div>
    `).join('');
}

function startTaskTimer(taskId) {
    if (tasksTimers[taskId]) {
        clearInterval(tasksTimers[taskId]);
    }

    tasksTimers[taskId] = setInterval(() => {
        const taskIndex = dailyTasks.findIndex(t => t.id === taskId);
        if (taskIndex === -1) {
            clearInterval(tasksTimers[taskId]);
            return;
        }

        const task = dailyTasks[taskIndex];
        
        if (task.isCompleted || task.remainingTime <= 0) {
            clearInterval(tasksTimers[taskId]);
            return;
        }

        task.remainingTime--;
        
        const timerElement = document.getElementById(`timer-${taskId}`);
        const progressElement = document.getElementById(`progress-${taskId}`);
        
        if (timerElement) {
            timerElement.textContent = formatTime(task.remainingTime);
        }
        
        if (progressElement) {
            const progressPercent = ((task.totalTime - task.remainingTime) / task.totalTime) * 100;
            progressElement.style.width = `${progressPercent}%`;
        }

        saveTasksToLocalStorage();

        if (task.remainingTime <= 0) {
            clearInterval(tasksTimers[taskId]);
            showNotification(`انتهى وقت الواجب: ${task.name}`, 'warning');
        }
    }, 1000);
}

function completeTask(taskId) {
    const taskIndex = dailyTasks.findIndex(t => t.id === taskId);
    if (taskIndex === -1) return;

    const task = dailyTasks[taskIndex];
    
    if (tasksTimers[taskId]) {
        clearInterval(tasksTimers[taskId]);
    }

    const timeSaved = formatTime(task.remainingTime);
    task.isCompleted = true;
    task.completedAt = new Date().toLocaleString('ar-IQ');
    
    saveTasksToLocalStorage();
    loadDailyTasks();
    updateTasksStats();
    
    setTimeout(() => {
        openCongratsModal(task.name, timeSaved);
    }, 500);
}

function deleteTask(taskId) {
    if (!confirm('هل أنت متأكد من حذف هذا الواجب؟')) return;

    if (tasksTimers[taskId]) {
        clearInterval(tasksTimers[taskId]);
        delete tasksTimers[taskId];
    }

    dailyTasks = dailyTasks.filter(t => t.id !== taskId);
    saveTasksToLocalStorage();
    
    showNotification('تم حذف الواجب');
    loadDailyTasks();
    updateTasksStats();
}

function updateTasksStats() {
    const total = dailyTasks.length;
    const completed = dailyTasks.filter(t => t.isCompleted).length;
    const pending = total - completed;

    document.getElementById('total-tasks').textContent = total;
    document.getElementById('completed-tasks').textContent = completed;
    document.getElementById('pending-tasks').textContent = pending;
}

function formatTaskTime(seconds) {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    
    return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
}

function initializeTasksTimers() {
    dailyTasks.forEach(task => {
        if (!task.isCompleted && task.remainingTime > 0) {
            startTaskTimer(task.id);
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    setTimeout(initializeTasksTimers, 1000);
});

// دوال الجدول اليومي الجديد

let currentSchedule = null;
let currentRating = 0;
let scheduleRatings = JSON.parse(localStorage.getItem('scheduleRatings')) || [];

function generateDailySubjectFields() {
    const count = parseInt(document.getElementById('daily-subjects-count').value) || 3;
    const container = document.getElementById('daily-subjects-container');
    
    let html = '<div style="margin-bottom: 15px;"><label>أسماء المواد</label></div>';
    
    for (let i = 1; i <= count; i++) {
        html += `
            <div class="row" style="margin-bottom: 8px;">
                <input type="text" 
                       class="form-control grow" 
                       placeholder="اسم المادة ${i}"
                       id="daily-subject-${i}">
                <select class="form-control" style="width: 120px;" id="daily-difficulty-${i}">
                    <option value="1">سهلة</option>
                    <option value="2">متوسطة</option>
                    <option value="3" selected>صعبة</option>
                    <option value="4">صعبة جداً</option>
                </select>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function generateDailySchedule() {
    const subjectsCount = parseInt(document.getElementById('daily-subjects-count').value) || 3;
    const studyHours = parseInt(document.getElementById('daily-study-hours').value) || 4;
    
    // جمع تفضيلات الأوقات
    const timePreferences = [];
    document.querySelectorAll('input[name="study-time-preference"]:checked').forEach(checkbox => {
        timePreferences.push(checkbox.value);
    });
    
    if (timePreferences.length === 0) {
        showNotification('يرجى اختيار وقت واحد على الأقل للدراسة', 'error');
        return;
    }
    
    // جمع المواد وصعوباتها
    const subjects = [];
    for (let i = 1; i <= subjectsCount; i++) {
        const subject = document.getElementById(`daily-subject-${i}`).value.trim();
        const difficulty = parseInt(document.getElementById(`daily-difficulty-${i}`).value) || 3;
        
        if (subject) {
            subjects.push({
                name: subject,
                difficulty: difficulty
            });
        }
    }
    
    if (subjects.length === 0) {
        showNotification('يرجى إدخال أسماء المواد', 'error');
        return;
    }
    
    // إنشاء الجدول الذكي
    const schedule = createSmartSchedule({
        subjects: subjects,
        dailyHours: studyHours,
        timePreferences: timePreferences
    });
    
    currentSchedule = schedule;
    localStorage.setItem('currentDailySchedule', JSON.stringify(schedule));
    
    displayDailySchedule(schedule);
    closeDailyScheduleModal();
    showPage("daily-schedule");
    
    showNotification('تم إنشاء جدولك اليومي بنجاح! سيتم تكراره أسبوعياً.');
}

function createSmartSchedule(config) {
    const { subjects, dailyHours, timePreferences } = config;
    
    // تعريف فترات الدراسة
    const timeSlots = {
        morning: { start: '06:00', end: '12:00' },
        afternoon: { start: '12:00', end: '16:00' },
        evening: { start: '16:00', end: '20:00' },
        night: { start: '20:00', end: '00:00' },
        anytime: { start: '08:00', end: '22:00' }
    };
    
    // اختيار أوقات الدراسة بناءً على التفضيلات
    let availableTimeSlots = [];
    timePreferences.forEach(pref => {
        if (timeSlots[pref]) {
            availableTimeSlots.push(timeSlots[pref]);
        }
    });
    
    if (availableTimeSlots.length === 0 && timePreferences.includes('anytime')) {
        availableTimeSlots.push(timeSlots.anytime);
    }
    
    // توزيع الوقت بناءً على صعوبة المواد
    const totalDifficulty = subjects.reduce((sum, sub) => sum + sub.difficulty, 0);
    const totalMinutes = dailyHours * 60;
    
    // احتساب الوقت لكل مادة بناءً على صعوبتها
    const subjectTimes = subjects.map(subject => {
        const timeRatio = subject.difficulty / totalDifficulty;
        const minutes = Math.floor(totalMinutes * timeRatio);
        return {
            name: subject.name,
            difficulty: subject.difficulty,
            minutes: minutes,
            color: getSubjectColor(subjects.indexOf(subject))
        };
    });
    
    // إنشاء جدول زمني ذكي
    const timetable = [];
    let currentSlotIndex = 0;
    let remainingTime = totalMinutes;
    
    subjectTimes.forEach((subject, index) => {
        if (remainingTime <= 0) return;
        
        // اختيار الوقت المناسب بناءً على صعوبة المادة
        const slot = availableTimeSlots[currentSlotIndex % availableTimeSlots.length];
        const startTime = addMinutes(slot.start, index * 15); // إضافة فواصل زمنية
        
        const endTime = addMinutes(startTime, subject.minutes);
        
        timetable.push({
            day: 'اليوم ' + (index + 1),
            subject: subject.name,
            difficulty: subject.difficulty,
            time: `${startTime} - ${endTime}`,
            duration: subject.minutes,
            color: subject.color,
            slotType: Object.keys(timeSlots).find(key => timeSlots[key] === slot)
        });
        
        currentSlotIndex++;
        remainingTime -= subject.minutes;
    });
    
    // إنشاء جدول أسبوعي مكرر
    const weekDays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    const weeklySchedule = [];
    
    weekDays.forEach((day, dayIndex) => {
        const dayTimetable = timetable.map(item => ({
            ...item,
            day: day
        }));
        weeklySchedule.push(...dayTimetable);
    });
    
    return {
        type: 'daily',
        subjects: subjects,
        dailyHours: dailyHours,
        timePreferences: timePreferences,
        createdAt: new Date().toLocaleString('ar-IQ'),
        timetable: weeklySchedule,
        totalStudyTime: dailyHours * 7 // ساعات الدراسة أسبوعياً
    };
}

function displayDailySchedule(schedule) {
    const statsContainer = document.getElementById('daily-schedule-stats');
    const imageContainer = document.getElementById('schedule-image-container');
    
    // عرض الإحصائيات
    statsContainer.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
            <div>
                <div style="font-size: 20px; font-weight: 900;">${schedule.subjects.length}</div>
                <div style="font-size: 12px;">عدد المواد</div>
            </div>
            <div>
                <div style="font-size: 20px; font-weight: 900;">${schedule.dailyHours} س</div>
                <div style="font-size: 12px;">ساعة/يوم</div>
            </div>
            <div>
                <div style="font-size: 20px; font-weight: 900;">${schedule.totalStudyTime} س</div>
                <div style="font-size: 12px;">إجمالي أسبوعي</div>
            </div>
        </div>
        <div style="margin-top: 10px; font-size: 13px; text-align: center;">
            <i class="fas fa-clock"></i> ${schedule.createdAt}
        </div>
    `;
    
    // إنشاء صورة الجدول
    const scheduleImage = createScheduleImage(schedule);
    imageContainer.innerHTML = scheduleImage;
    
    // عرض ختم التطبيق
    document.getElementById('schedule-date').textContent = schedule.createdAt;
    document.getElementById('schedule-stamp').style.display = 'block';
}

function createScheduleImage(schedule, forExport = false) {
    // تحديد حجم الخط بناءً على ما إذا كانت للتصدير أو للعرض
    const baseFontSize = forExport ? '12px' : '10px';
    const headingFontSize = forExport ? '16px' : '14px';
    
    let tableHTML = `
        <div id="schedule-table-container" style="
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: ${forExport ? '10px' : '8px'};
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            font-family: 'Tajawal', sans-serif;
            font-size: ${baseFontSize};
            line-height: 1.3;
        ">
            <!-- عنوان الجدول -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: ${forExport ? '15px' : '12px'};
                text-align: center;
            ">
                <h2 style="
                    margin: 0;
                    font-size: ${headingFontSize};
                    font-weight: 900;
                ">📅 جدول الدراسة الأسبوعي</h2>
                <div style="
                    margin-top: 5px;
                    font-size: ${forExport ? '13px' : '11px'};
                    opacity: 0.9;
                ">${schedule.createdAt}</div>
            </div>
            
            <!-- معلومات سريعة -->
            <div style="
                padding: ${forExport ? '12px' : '10px'};
                background: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
            ">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    flex-wrap: wrap;
                    gap: ${forExport ? '10px' : '5px'};
                ">
                    <div style="text-align: center; flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--primary-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.subjects.length}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">المواد</div>
                    </div>
                    <div style="text-align: center; flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--success-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.dailyHours} س</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">ساعة/يوم</div>
                    </div>
                    <div style="text-align: center; flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--warning-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.totalStudyTime} س</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">أسبوعياً</div>
                    </div>
                </div>
            </div>
            
            <!-- جدول المواد - تصميم متجاوب -->
            <div style="
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-width: 100%;
            ">
                <table style="
                    width: 100%;
                    border-collapse: collapse;
                    min-width: 100%;
                    table-layout: fixed;
                ">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="
                                padding: ${forExport ? '10px' : '8px'};
                                text-align: center;
                                border: 1px solid #34495e;
                                font-size: ${forExport ? '13px' : '11px'};
                                width: 12%;
                                word-break: break-word;
                            ">اليوم</th>
                            <th style="
                                padding: ${forExport ? '10px' : '8px'};
                                text-align: center;
                                border: 1px solid #34495e;
                                font-size: ${forExport ? '13px' : '11px'};
                                width: 22%;
                                word-break: break-word;
                            ">المادة</th>
                            <th style="
                                padding: ${forExport ? '10px' : '8px'};
                                text-align: center;
                                border: 1px solid #34495e;
                                font-size: ${forExport ? '13px' : '11px'};
                                width: 18%;
                                word-break: break-word;
                            ">الوقت</th>
                            <th style="
                                padding: ${forExport ? '10px' : '8px'};
                                text-align: center;
                                border: 1px solid #34495e;
                                font-size: ${forExport ? '13px' : '11px'};
                                width: 13%;
                                word-break: break-word;
                            ">المدة</th>
                            <th style="
                                padding: ${forExport ? '10px' : '8px'};
                                text-align: center;
                                border: 1px solid #34495e;
                                font-size: ${forExport ? '13px' : '11px'};
                                width: 20%;
                                word-break: break-word;
                            ">الصعوبة</th>
                            <th style="
                                padding: ${forExport ? '10px' : '8px'};
                                text-align: center;
                                border: 1px solid #34495e;
                                font-size: ${forExport ? '13px' : '11px'};
                                width: 15%;
                                word-break: break-word;
                            ">النوع</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // أيام الأسبوع
    const weekDays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    
    weekDays.forEach((day, dayIndex) => {
        // إيجاد المواد لهذا اليوم (بنفس التوزيع لكل يوم)
        schedule.subjects.forEach((subject, subjectIndex) => {
            const difficultyStars = '★'.repeat(subject.difficulty);
            const difficultyText = ['سهلة', 'متوسطة', 'صعبة', 'صعبة جداً'][subject.difficulty - 1] || 'متوسطة';
            
            // حساب الوقت بناءً على الصعوبة
            const totalMinutes = schedule.dailyHours * 60;
            const totalDifficulty = schedule.subjects.reduce((sum, s) => sum + s.difficulty, 0);
            const subjectMinutes = Math.floor((subject.difficulty / totalDifficulty) * totalMinutes);
            
            // حساب وقت البداية
            const startHour = 8 + (subjectIndex * (schedule.dailyHours / schedule.subjects.length));
            const startTime = `${Math.floor(startHour)}:${(startHour % 1 === 0.5 ? '30' : '00')}`;
            const endTime = addMinutes(startTime, subjectMinutes);
            
            // ألوان متناوبة للصفوف
            const rowColor = subjectIndex % 2 === 0 ? '#ffffff' : '#f8f9fa';
            const difficultyColor = subject.difficulty === 1 ? '#28a745' : 
                                  subject.difficulty === 2 ? '#ffc107' : 
                                  subject.difficulty === 3 ? '#fd7e14' : '#dc3545';
            
            tableHTML += `
                <tr style="background: ${rowColor};">
                    ${subjectIndex === 0 ? `
                    <td rowspan="${schedule.subjects.length}" style="
                        padding: ${forExport ? '10px' : '8px'};
                        text-align: center;
                        border: 1px solid #dee2e6;
                        font-weight: 700;
                        color: #2c3e50;
                        vertical-align: middle;
                        font-size: ${forExport ? '12px' : '10px'};
                        word-break: break-word;
                    ">
                        ${day}
                    </td>` : ''}
                    <td style="
                        padding: ${forExport ? '10px' : '8px'};
                        text-align: right;
                        border: 1px solid #dee2e6;
                        font-weight: 700;
                        font-size: ${forExport ? '12px' : '10px'};
                        word-break: break-word;
                    ">
                        ${subject.name}
                    </td>
                    <td style="
                        padding: ${forExport ? '10px' : '8px'};
                        text-align: center;
                        border: 1px solid #dee2e6;
                        font-size: ${forExport ? '12px' : '10px'};
                        word-break: break-word;
                    ">
                        <div style="font-weight: 700; color: #2c3e50;">${startTime}</div>
                        <div style="font-size: ${forExport ? '11px' : '9px'}; color: #666;">${endTime}</div>
                    </td>
                    <td style="
                        padding: ${forExport ? '10px' : '8px'};
                        text-align: center;
                        border: 1px solid #dee2e6;
                        font-size: ${forExport ? '12px' : '10px'};
                        word-break: break-word;
                    ">
                        ${Math.floor(subjectMinutes / 60)}س<br>
                        <span style="font-size: ${forExport ? '11px' : '9px'};">${subjectMinutes % 60}د</span>
                    </td>
                    <td style="
                        padding: ${forExport ? '10px' : '8px'};
                        text-align: center;
                        border: 1px solid #dee2e6;
                        color: ${difficultyColor};
                        font-weight: 700;
                        font-size: ${forExport ? '12px' : '10px'};
                        word-break: break-word;
                    ">
                        <div>${difficultyStars}</div>
                        <div style="font-size: ${forExport ? '11px' : '9px'};">${difficultyText}</div>
                    </td>
                    <td style="
                        padding: ${forExport ? '10px' : '8px'};
                        text-align: center;
                        border: 1px solid #dee2e6;
                        font-size: ${forExport ? '12px' : '10px'};
                        word-break: break-word;
                    ">
                        <span style="
                            display: inline-block;
                            padding: 3px 8px;
                            background: ${getSubjectColor(subjectIndex)};
                            color: white;
                            border-radius: 15px;
                            font-size: ${forExport ? '11px' : '9px'};
                            font-weight: 700;
                            max-width: 100%;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        ">
                            ${['نظرية', 'تمرين', 'مراجعة', 'أسئلة'][subjectIndex % 4]}
                        </span>
                    </td>
                </tr>
            `;
        });
    });
    
    tableHTML += `
                    </tbody>
                </table>
            </div>
            
            <!-- ملاحظات -->
            <div style="
                padding: ${forExport ? '15px' : '12px'};
                background: #f1f8ff;
                border-top: 1px solid #d0dcff;
            ">
                <h4 style="
                    color: #2c3e50;
                    margin-bottom: 8px;
                    text-align: center;
                    font-size: ${forExport ? '14px' : '12px'};
                ">📝 ملاحظات</h4>
                <div style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: ${forExport ? '10px' : '6px'};
                    font-size: ${forExport ? '12px' : '10px'};
                ">
                    <div style="
                        padding: 8px;
                        background: white;
                        border-radius: 6px;
                        border-right: 2px solid #4a6bff;
                    ">
                        <div style="font-weight: 700; color: #4a6bff;">⏰ وقت</div>
                        <div style="color: #666;">التزم بالجدول</div>
                    </div>
                    <div style="
                        padding: 8px;
                        background: white;
                        border-radius: 6px;
                        border-right: 2px solid #28a745;
                    ">
                        <div style="font-weight: 700; color: #28a745;">🧠 مراجعة</div>
                        <div style="color: #666;">راجع بعد كل جلسة</div>
                    </div>
                    <div style="
                        padding: 8px;
                        background: white;
                        border-radius: 6px;
                        border-right: 2px solid #ffc107;
                    ">
                        <div style="font-weight: 700; color: #ffc107;">💤 راحة</div>
                        <div style="color: #666;">خذ فترات راحة</div>
                    </div>
                </div>
            </div>
    `;
    
    // إضافة الختم فقط عند التصدير
    if (forExport) {
        tableHTML += `
            <!-- ختم التطبيق - يظهر فقط عند الحفظ/المشاركة -->
            <div style="
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-align: center;
                border-top: 2px solid #4a6bff;
            ">
                <div style="
                    font-weight: 900;
                    font-size: 14px;
                    margin-bottom: 5px;
                ">من تطبيق سوق الطلاب</div>
                <div style="
                    font-size: 12px;
                    opacity: 0.9;
                ">${schedule.createdAt}</div>
            </div>
        `;
    }
    
    tableHTML += `</div>`;
    
    return tableHTML;
}

async function saveScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لحفظه', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('save-schedule-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    saveBtn.disabled = true;
    
    try {
        // إنشاء عنصر مؤقت للجدول مع الختم (للتصدير)
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
        `;
        
        // إنشاء الجدول مع الختم (للتعبئة)
        const scheduleWithStamp = createScheduleImage(currentSchedule, true);
        tempContainer.innerHTML = scheduleWithStamp;
        document.body.appendChild(tempContainer);
        
        // استخدام html2canvas لالتقاط الصورة
        const canvas = await html2canvas(tempContainer, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
            width: tempContainer.offsetWidth,
            height: tempContainer.offsetHeight
        });
        
        // تحويل Canvas إلى صورة
        const imageData = canvas.toDataURL('image/png', 1.0);
        
        // إنشاء رابط للتنزيل
        const link = document.createElement('a');
        const fileName = `جدول_الدراسة_${new Date().toLocaleDateString('ar-IQ').replace(/\//g, '-')}.png`;
        link.download = fileName;
        link.href = imageData;
        
        // محاكاة النقر لبدء التنزيل
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // تنظيف العنصر المؤقت
        document.body.removeChild(tempContainer);
        
        // حفظ معلومات الجدول المحفوظ
        const savedSchedules = JSON.parse(localStorage.getItem('savedSchedules') || '[]');
        savedSchedules.push({
            id: Date.now(),
            name: fileName,
            date: new Date().toLocaleString('ar-IQ'),
            schedule: currentSchedule
        });
        localStorage.setItem('savedSchedules', JSON.stringify(savedSchedules));
        
        showNotification('✅ تم حفظ الجدول في هاتفك بنجاح');
        
    } catch (error) {
        console.error('Error saving schedule:', error);
        showNotification('❌ فشل حفظ الجدول', 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

async function shareScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لمشاركته', 'error');
        return;
    }
    
    const shareBtn = document.getElementById('share-schedule-btn');
    const originalText = shareBtn.innerHTML;
    shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحضير...';
    shareBtn.disabled = true;
    
    try {
        // إنشاء عنصر مؤقت مع الختم
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
        `;
        
        // إنشاء الجدول مع الختم
        const scheduleWithStamp = createScheduleImage(currentSchedule, true);
        tempContainer.innerHTML = scheduleWithStamp;
        document.body.appendChild(tempContainer);
        
        // التقاط الصورة
        const canvas = await html2canvas(tempContainer, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
            width: tempContainer.offsetWidth,
            height: tempContainer.offsetHeight
        });
        
        // تحويل Canvas إلى blob
        const blob = await new Promise(resolve => {
            canvas.toBlob(resolve, 'image/png', 1.0);
        });
        
        // إنشاء ملف للشارة
        const fileName = `جدول_الدراسة_${new Date().toLocaleDateString('ar-IQ').replace(/\//g, '-')}.png`;
        const file = new File([blob], fileName, { type: 'image/png' });
        
        // تنظيف العنصر المؤقت
        document.body.removeChild(tempContainer);
        
        // مشاركة عبر Web Share API
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({
                files: [file],
                title: 'جدول الدراسة الأسبوعي',
                text: 'جدول دراستي الأسبوعي من تطبيق سوق الطلاب',
            });
            
            showNotification('✅ تم مشاركة الجدول بنجاح');
            
        } else {
            // طريقة بديلة
            fallbackShareSchedule(canvas);
        }
        
    } catch (error) {
        console.error('Error sharing schedule:', error);
        
        if (error.name !== 'AbortError') {
            showNotification('استخدم زر "حفظ" ثم شارك الصورة من مجلد التنزيلات', 'info');
        }
        
    } finally {
        shareBtn.innerHTML = originalText;
        shareBtn.disabled = false;
    }
}

function fallbackShareSchedule(canvas) {
    // حفظ الصورة أولاً ثم إعلام المستخدم
    if (canvas) {
        const imageData = canvas.toDataURL('image/png');
        
        // نسخ رابط الصورة إلى الحافظة
        const textArea = document.createElement('textarea');
        textArea.value = imageData;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        showNotification('📋 تم نسخ الجدول كصورة إلى الحافظة، يمكنك مشاركته الآن مع أي تطبيق');
    } else {
        // إذا لم يكن هناك canvas، نسخ معلومات الجدول كنص
        if (currentSchedule) {
            const scheduleText = `
📅 جدول الدراسة الأسبوعي

${currentSchedule.subjects.map(s => `📚 ${s.name} (${['سهلة', 'متوسطة', 'صعبة', 'صعبة جداً'][s.difficulty - 1] || 'متوسطة'})`).join('\n')}

⏰ ${currentSchedule.dailyHours} ساعة دراسة يومياً
🗓️ ${currentSchedule.totalStudyTime} ساعة أسبوعياً

تم الإنشاء: ${currentSchedule.createdAt}

#سوق_الطلاب #جدول_الدراسة
            `.trim();
            
            const textArea = document.createElement('textarea');
            textArea.value = scheduleText;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            
            showNotification('📋 تم نسخ الجدول إلى الحافظة، يمكنك مشاركته الآن');
        }
    }
    
    // عرض خيارات المشاركة البديلة
    setTimeout(() => {
        if (confirm('هل تريد فتح خيارات المشاركة البديلة؟')) {
            showAlternativeShareOptions();
        }
    }, 1500);
}

function showAlternativeShareOptions() {
    // إنشاء نافذة مع خيارات المشاركة
    const modalHTML = `
        <div id="share-modal" class="modal" style="display: block;">
            <div class="modal-content" style="max-width: 400px;">
                <div class="modal-header">
                    <h2><i class="fas fa-share-alt"></i> مشاركة الجدول</h2>
                    <button class="close-modal" onclick="closeShareModal()">&times;</button>
                </div>
                <div class="select-group">
                    <p style="text-align: center; margin-bottom: 20px;">اختر طريقة المشاركة:</p>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="btn" onclick="shareViaWhatsApp()" style="background: #25D366; color: white;">
                            <i class="fab fa-whatsapp"></i> واتساب
                        </button>
                        <button class="btn" onclick="shareViaTelegram()" style="background: #0088cc; color: white;">
                            <i class="fab fa-telegram"></i> تيليجرام
                        </button>
                        <button class="btn" onclick="shareViaEmail()" style="background: #EA4335; color: white;">
                            <i class="fas fa-envelope"></i> بريد إلكتروني
                        </button>
                        <button class="btn" onclick="saveAndShare()" style="background: var(--primary-color); color: white;">
                            <i class="fas fa-save"></i> حفظ ثم مشاركة
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

function closeShareModal() {
    const modal = document.getElementById('share-modal');
    if (modal) modal.remove();
}

function rateSchedule() {
    document.getElementById('rating-modal').style.display = 'block';
    document.getElementById('rating-comment').value = '';
    currentRating = 0;
    
    // إعادة تعيين النجوم
    const starsContainer = document.getElementById('rating-stars-input');
    starsContainer.innerHTML = `
        <span onclick="setRating(1)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(2)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(3)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(4)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(5)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
    `;
}

function setRating(rating) {
    currentRating = rating;
    
    const starsContainer = document.getElementById('rating-stars-input');
    let starsHTML = '';
    
    for (let i = 1; i <= 5; i++) {
        starsHTML += `<span onclick="setRating(${i})" style="cursor: pointer; margin: 0 5px; color: ${i <= rating ? '#FFD700' : '#ccc'};">${i <= rating ? '★' : '☆'}</span>`;
    }
    
    starsContainer.innerHTML = starsHTML;
}

async function submitRating() {
    if (currentRating === 0) {
        showNotification('يرجى اختيار عدد النجوم', 'error');
        return;
    }
    
    const comment = document.getElementById('rating-comment').value.trim();
    
    // التحقق من اتصال المستخدم
    if (!currentUser) {
        showNotification('يرجى تسجيل الدخول لإرسال التقييم', 'error');
        closeRatingModal();
        return;
    }
    
    const btn = document.querySelector('#rating-modal .btn[onclick="submitRating()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
    
    try {
        const ratingData = {
            id: Date.now().toString(),
            rating: currentRating,
            comment: comment,
            scheduleType: 'daily',
            createdAt: new Date().toLocaleString('ar-IQ'),
            userId: currentUser.uid,
            userName: currentUser.name || 'مستخدم',
            userEmail: currentUser.email || 'غير معروف',
            userShortUid: currentUser.shortUid || generateShortUid(currentUser.uid)
        };
        
        // حفظ محلياً
        scheduleRatings.push(ratingData);
        localStorage.setItem('scheduleRatings', JSON.stringify(scheduleRatings));
        
        // إرسال إلى المالك عبر Firebase
        await sendRatingToOwner(ratingData);
        
        showNotification('✅ تم إرسال تقييمك إلى المالك بنجاح');
        closeRatingModal();
        
    } catch (error) {
        console.error('Error submitting rating:', error);
        showNotification('❌ فشل إرسال التقييم، حاول مرة أخرى', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

async function sendRatingToOwner(ratingData) {
    try {
        // البحث عن المالك في قاعدة البيانات
        const ownerQuery = await db.collection('users')
            .where('email', '==', APP_OWNER_EMAIL)
            .limit(1)
            .get();
        
        if (ownerQuery.empty) {
            console.error('Owner not found in database');
            throw new Error('المالك غير موجود في النظام');
        }
        
        const ownerDoc = ownerQuery.docs[0];
        const ownerUid = ownerDoc.id;
        
        // إنشاء رسالة تفصيلية
        const stars = '★'.repeat(ratingData.rating) + '☆'.repeat(5 - ratingData.rating);
        const scheduleInfo = currentSchedule ? 
            `المواد: ${currentSchedule.subjects.length} | الوقت: ${currentSchedule.dailyHours}س/يوم` : 
            'جدول غير محدد';
        
        const message = `
🌟 تقييم جديد للجدول الدراسي

👤 المستخدم: ${ratingData.userName}
📧 البريد: ${ratingData.userEmail}
🆔 المعرف: ${ratingData.userShortUid}

📊 التقييم: ${stars} (${ratingData.rating}/5)
📋 معلومات الجدول: ${scheduleInfo}
💬 التعليق: ${ratingData.comment || 'بدون تعليق'}

📅 تاريخ التقييم: ${ratingData.createdAt}
        `.trim();
        
        // إرسال إلى صندوق الوارد الخاص بالمالك
        await db.collection('inbox').add({
            userId: ownerUid,
            type: 'schedule_rating',
            title: '⭐ تقييم جديد للجدول الدراسي',
            message: message,
            rating: ratingData.rating,
            comment: ratingData.comment,
            userName: ratingData.userName,
            userEmail: ratingData.userEmail,
            userShortUid: ratingData.userShortUid,
            scheduleInfo: scheduleInfo,
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            metadata: {
                scheduleId: currentSchedule ? 'current' : null,
                ratingId: ratingData.id,
                timestamp: Date.now()
            }
        });
        
        console.log('Rating sent to owner successfully');
        
        // أيضاً، حفظ في مجموعة مستقلة للتقارير
        await db.collection('schedule_ratings').add({
            ...ratingData,
            ownerUid: ownerUid,
            sentAt: firebase.firestore.FieldValue.serverTimestamp(),
            delivered: true
        });
        
        return true;
        
    } catch (error) {
        console.error('Error sending rating to owner:', error);
        
        // محاولة بديلة: حفظ محلياً ومحاولة إرسال لاحقاً
        const pendingRatings = JSON.parse(localStorage.getItem('pendingRatings') || '[]');
        pendingRatings.push({
            ...ratingData,
            retryCount: 0,
            lastTry: Date.now()
        });
        localStorage.setItem('pendingRatings', JSON.stringify(pendingRatings));
        
        // جدولة إعادة المحاولة
        setTimeout(retryPendingRatings, 60000); // بعد دقيقة
        
        throw error;
    }
}

async function retryPendingRatings() {
    const pendingRatings = JSON.parse(localStorage.getItem('pendingRatings') || '[]');
    
    if (pendingRatings.length === 0) return;
    
    console.log(`Retrying ${pendingRatings.length} pending ratings...`);
    
    for (let i = pendingRatings.length - 1; i >= 0; i--) {
        const rating = pendingRatings[i];
        
        // التوقف بعد 3 محاولات فاشلة
        if (rating.retryCount >= 3) {
            pendingRatings.splice(i, 1);
            continue;
        }
        
        try {
            await sendRatingToOwner(rating);
            pendingRatings.splice(i, 1); // حذف بعد النجاح
            console.log(`Successfully sent pending rating ${rating.id}`);
        } catch (error) {
            rating.retryCount++;
            rating.lastTry = Date.now();
            console.log(`Failed to send rating ${rating.id}, retry count: ${rating.retryCount}`);
        }
    }
    
    localStorage.setItem('pendingRatings', JSON.stringify(pendingRatings));
}

// تشغيل إعادة المحاولة عند تحميل الصفحة
window.addEventListener('load', function() {
    setTimeout(retryPendingRatings, 5000);
});

function closeRatingModal() {
    document.getElementById('rating-modal').style.display = 'none';
}

function openDailyScheduleModal() {
    document.getElementById('daily-schedule-modal').style.display = 'block';
    generateDailySubjectFields();
}

function closeDailyScheduleModal() {
    document.getElementById('daily-schedule-modal').style.display = 'none';
}

function showDailySchedulePage() {
    showPage("daily-schedule");
    
    // تحميل الجدول المحفوظ إن وجد
    const savedSchedule = localStorage.getItem('currentDailySchedule');
    if (savedSchedule) {
        const schedule = JSON.parse(savedSchedule);
        currentSchedule = schedule;
        displayDailySchedule(schedule);
    } else {
        // إذا لم يكن هناك جدول محفوظ، عرض رسالة
        document.getElementById('daily-schedule-stats').innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <div style="font-size: 48px; margin-bottom: 15px;">📅</div>
                <h3 style="color: var(--primary-color); margin-bottom: 10px;">لا يوجد جدول حالياً</h3>
                <p style="color: var(--light-text); margin-bottom: 20px;">أنشئ جدولك الدراسي الأول الآن</p>
                <button class="btn btn-success" onclick="openDailyScheduleModal()">
                    <i class="fas fa-plus"></i> إنشاء جدول جديد
                </button>
            </div>
        `;
        
        document.getElementById('daily-schedule-table').style.display = 'none';
    }
}

// دالة مساعدة لإضافة الدقائق إلى الوقت
function addMinutes(time, minutes) {
    const [hours, mins] = time.split(':').map(Number);
    let totalMinutes = hours * 60 + mins + minutes;
    
    let newHours = Math.floor(totalMinutes / 60);
    let newMinutes = totalMinutes % 60;
    
    newHours = newHours % 24;
    
    return `${newHours.toString().padStart(2, '0')}:${newMinutes.toString().padStart(2, '0')}`;
}

// دالة للحصول على لون المادة
function getSubjectColor(index) {
    const colors = [
        '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2',
        '#EF476F', '#9D4EDD', '#FF9A9E', '#A1C4FD', '#FFECD2'
    ];
    return colors[index % colors.length];
}

// استعادة الجدول عند تحميل الصفحة
window.addEventListener('load', function() {
    const savedSchedule = localStorage.getItem('currentDailySchedule');
    if (savedSchedule) {
        currentSchedule = JSON.parse(savedSchedule);
    }
});

function showStudySchedulesPage() {
    showPage("study-schedules");
}

function shareViaWhatsApp() {
    if (!currentSchedule) return;
    
    const scheduleText = `
*جدول الدراسة الأسبوعي*

${currentSchedule.subjects.map(s => `📚 ${s.name}`).join('%0A')}

⏰ ${currentSchedule.dailyHours} ساعة دراسة يومياً
🗓️ ${currentSchedule.totalStudyTime} ساعة أسبوعياً

تم الإنشاء: ${currentSchedule.createdAt}

#سوق_الطلاب #جدول_الدراسة
    `.trim();
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(scheduleText)}`;
    window.open(whatsappUrl, '_blank');
    closeShareModal();
    showNotification('فتح واتساب للمشاركة');
}

function shareViaTelegram() {
    if (!currentSchedule) return;
    
    const scheduleText = `
*جدول الدراسة الأسبوعي*

${currentSchedule.subjects.map(s => `📚 ${s.name}`).join('%0A')}

⏰ ${currentSchedule.dailyHours} ساعة دراسة يومياً
🗓️ ${currentSchedule.totalStudyTime} ساعة أسبوعياً

تم الإنشاء: ${currentSchedule.createdAt}

#سوق_الطلاب #جدول_الدراسة
    `.trim();
    
    const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(scheduleText)}`;
    window.open(telegramUrl, '_blank');
    closeShareModal();
    showNotification('فتح تيليجرام للمشاركة');
}

function shareViaEmail() {
    if (!currentSchedule) return;
    
    const subject = 'جدول الدراسة الأسبوعي - تطبيق سوق الطلاب';
    const body = `
جدول الدراسة الأسبوعي

${currentSchedule.subjects.map(s => `📚 ${s.name}`).join('\n')}

⏰ ${currentSchedule.dailyHours} ساعة دراسة يومياً
🗓️ ${currentSchedule.totalStudyTime} ساعة أسبوعياً

تم الإنشاء: ${currentSchedule.createdAt}

تم إنشاء هذا الجدول باستخدام تطبيق سوق الطلاب
    `.trim();
    
    const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    window.location.href = mailtoUrl;
    closeShareModal();
}

async function saveAndShare() {
    closeShareModal();
    
    // حفظ الجدول أولاً
    await saveScheduleAsImage();
    
    // ثم إعلام المستخدم
    setTimeout(() => {
        showNotification('تم حفظ الجدول، يمكنك الآن مشاركته من مجلد التنزيلات');
    }, 1000);
}

function showDailySchedulePage() {
    showPage("daily-schedule");
    
    // تحميل الجدول المحفوظ إن وجد
    const savedSchedule = localStorage.getItem('currentDailySchedule');
    if (savedSchedule) {
        try {
            const schedule = JSON.parse(savedSchedule);
            currentSchedule = schedule;
            displayDailySchedule(schedule);
        } catch (error) {
            console.error('Error loading schedule:', error);
            showNoScheduleMessage();
        }
    } else {
        showNoScheduleMessage();
    }
}

function showNoScheduleMessage() {
    const imageContainer = document.getElementById('schedule-image-container');
    const controls = document.querySelector('.post[style*="background: var(--sky)"]');
    
    imageContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px; color: var(--light-text);">
                📅
            </div>
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                لا يوجد جدول حالياً
            </h3>
            <p style="color: var(--light-text); margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
                أنشئ جدولك الدراسي الأول الآن للحصول على جدول أسبوعي مخصص
            </p>
            <button class="btn btn-success" onclick="openDailyScheduleModal()" style="padding: 12px 30px; font-size: 16px;">
                <i class="fas fa-plus-circle"></i> إنشاء جدول جديد
            </button>
        </div>
    `;
    
    if (controls) {
        controls.style.display = 'none';
    }
}

function displayDailySchedule(schedule) {
    const imageContainer = document.getElementById('schedule-image-container');
    
    // إنشاء الجدول للعرض (بدون الختم)
    const scheduleTable = createScheduleImage(schedule, false);
    imageContainer.innerHTML = scheduleTable;
    
    // إظهار أزرار التحكم
    document.querySelector('.post[style*="background: var(--sky)"]').style.display = 'block';
    
    showNotification('تم تحميل جدولك الدراسي');
}

// دالة للتحقق من وصول التقييمات (للمالك)
async function checkRatingDelivery() {
    if (!isOwner()) return;
    
    try {
        const ratingsSnapshot = await db.collection('inbox')
            .where('type', '==', 'schedule_rating')
            .orderBy('createdAt', 'desc')
            .limit(10)
            .get();
        
        console.log(`Found ${ratingsSnapshot.size} ratings in inbox`);
        
        ratingsSnapshot.forEach(doc => {
            const rating = doc.data();
            console.log('Rating received:', {
                from: rating.userName,
                stars: rating.rating,
                time: rating.createdAt?.toDate?.().toLocaleString('ar-IQ')
            });
        });
        
    } catch (error) {
        console.error('Error checking rating delivery:', error);
    }
}

// للمالك: عرض التقييمات في واجهة خاصة
async function showScheduleRatings() {
    if (!isOwner()) return;
    
    showPage("userSupport"); // أو صفحة مخصصة للتقييمات
    
    try {
        const ratingsSnapshot = await db.collection('schedule_ratings')
            .orderBy('createdAt', 'desc')
            .limit(50)
            .get();
        
        if (ratingsSnapshot.empty) {
            document.getElementById('user-support-results').innerHTML = `
                <div class="post">
                    <p style="text-align: center;">لا توجد تقييمات بعد</p>
                </div>
            `;
            return;
        }
        
        let ratingsHTML = '<h3 style="text-align: center; margin-bottom: 20px;">⭐ تقييمات الجداول الدراسية</h3>';
        
        ratingsSnapshot.forEach(doc => {
            const rating = doc.data();
            const stars = '★'.repeat(rating.rating) + '☆'.repeat(5 - rating.rating);
            const time = rating.createdAt?.toDate ? formatRelativeTime(rating.createdAt.toDate()) : 'غير معروف';
            
            ratingsHTML += `
                <div class="user-support-item">
                    <div class="support-meta">
                        <div class="support-user">
                            👤 ${escapeHTML(rating.userName || 'مستخدم')}
                        </div>
                        <div class="support-type" style="background: #FFD700; color: #000;">
                            ${stars}
                        </div>
                    </div>
                    
                    ${rating.comment ? `
                    <div class="support-message">
                        💬 ${escapeHTML(rating.comment)}
                    </div>
                    ` : ''}
                    
                    <div class="reply-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <small style="color: var(--light-text);">${time}</small>
                            <small style="color: var(--light-text);">📧 ${rating.userEmail || 'غير معروف'}</small>
                        </div>
                        <small style="color: var(--light-text); display: block;">🆔 ${rating.userShortUid || 'غير معروف'}</small>
                    </div>
                </div>
            `;
        });
        
        document.getElementById('user-support-results').innerHTML = ratingsHTML;
        
    } catch (error) {
        console.error('Error loading ratings:', error);
        document.getElementById('user-support-results').innerHTML = `
            <div class="post">
                <p style="text-align: center; color: var(--danger-color);">
                    خطأ في تحميل التقييمات
                </p>
            </div>
        `;
    }
}

// حساب التقييمات غير المقروءة
async function updateRatingsBadge() {
    if (!isOwner()) return;
    
    try {
        const unreadRatings = await db.collection('inbox')
            .where('type', '==', 'schedule_rating')
            .where('status', '==', 'unread')
            .get();
        
        const badge = document.getElementById('ratings-badge');
        if (badge) {
            if (unreadRatings.size > 0) {
                badge.style.display = 'flex';
                badge.textContent = unreadRatings.size > 9 ? '9+' : unreadRatings.size.toString();
            } else {
                badge.style.display = 'none';
            }
        }
        
    } catch (error) {
        console.error('Error updating ratings badge:', error);
    }
}

// تحديث الشارة كل 30 ثانية
if (isOwner()) {
    setInterval(updateRatingsBadge, 30000);
    setTimeout(updateRatingsBadge, 5000);
}

// ==================== دوال الجداول الجديدة ====================

// 1. دوال الجدول الأسبوعي
function openWeeklyScheduleModal() {
    document.getElementById('weekly-schedule-modal').style.display = 'block';
    generateWeeklySubjectFields();
}

function closeWeeklyScheduleModal() {
    document.getElementById('weekly-schedule-modal').style.display = 'none';
}

// تعديل دالة حقول المواد الأسبوعية لتكون فارغة
function generateWeeklySubjectFields() {
    const count = parseInt(document.getElementById('weekly-subjects-count').value) || 7;
    const container = document.getElementById('weekly-subjects-container');
    
    let html = '<div style="margin-bottom: 15px;"><label>أسماء المواد الأسبوعية</label></div>';
    
    for (let i = 1; i <= count; i++) {
        html += `
            <div class="row" style="margin-bottom: 8px;">
                <input type="text" 
                       class="form-control grow" 
                       placeholder="اسم المادة ${i} (مثال: رياضيات، عربي، انكليزي)"
                       id="weekly-subject-${i}"
                       value="">
                <select class="form-control" style="width: 120px;" id="weekly-difficulty-${i}">
                    <option value="1">سهلة</option>
                    <option value="2" selected>متوسطة</option>
                    <option value="3">صعبة</option>
                    <option value="4">صعبة جداً</option>
                </select>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// تعديل دالة حقول المواد التراكمية لتكون فارغة
function generateAccumulativeSubjectFields() {
    const count = parseInt(document.getElementById('accumulative-subjects-count').value) || 4;
    const container = document.getElementById('accumulative-subjects-container');
    
    let html = '<div style="margin-bottom: 15px;"><label>المواد المتراكمة</label></div>';
    
    for (let i = 1; i <= count; i++) {
        html += `
            <div class="row" style="margin-bottom: 8px;">
                <input type="text" 
                       class="form-control grow" 
                       placeholder="اسم المادة المتراكمة ${i}"
                       id="accumulative-subject-${i}"
                       value="">
                <select class="form-control" style="width: 120px;" id="accumulative-priority-${i}">
                    <option value="1">أولوية عالية</option>
                    <option value="2" selected>أولوية متوسطة</option>
                    <option value="3">أولوية منخفضة</option>
                </select>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// تعديل دالة حقول المواد المراجعة لتكون فارغة
function generateReviewSubjectFields() {
    const count = parseInt(document.getElementById('review-subjects-count').value) || 8;
    const container = document.getElementById('review-subjects-container');
    
    let html = '<div style="margin-bottom: 15px;"><label>المواد للمراجعة النهائية</label></div>';
    
    for (let i = 1; i <= count; i++) {
        html += `
            <div class="row" style="margin-bottom: 8px;">
                <input type="text" 
                       class="form-control grow" 
                       placeholder="مادة المراجعة ${i}"
                       id="review-subject-${i}"
                       value="">
                <select class="form-control" style="width: 120px;" id="review-importance-${i}">
                    <option value="1">أساسية</option>
                    <option value="2" selected>مهمة</option>
                    <option value="3">إضافية</option>
                </select>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function generateWeeklySchedule() {
    const subjectsCount = parseInt(document.getElementById('weekly-subjects-count').value) || 7;
    const dailySubjects = parseInt(document.getElementById('daily-subjects-limit').value) || 4;
    const studyHours = parseInt(document.getElementById('weekly-study-hours').value) || 4;
    
    // جمع تفضيلات الأوقات
    const timePreferences = [];
    document.querySelectorAll('input[name="weekly-study-time-preference"]:checked').forEach(checkbox => {
        timePreferences.push(checkbox.value);
    });
    
    if (timePreferences.length === 0) {
        showNotification('يرجى اختيار وقت واحد على الأقل للدراسة', 'error');
        return;
    }
    
    // جمع المواد وصعوباتها
    const subjects = [];
    for (let i = 1; i <= subjectsCount; i++) {
        const subject = document.getElementById(`weekly-subject-${i}`).value.trim();
        const difficulty = parseInt(document.getElementById(`weekly-difficulty-${i}`).value) || 3;
        
        if (subject) {
            subjects.push({
                name: subject,
                difficulty: difficulty,
                isScientific: ['رياضيات', 'فيزياء', 'كيمياء', 'أحياء', 'علوم'].some(s => subject.includes(s))
            });
        }
    }
    
    if (subjects.length === 0) {
        showNotification('يرجى إدخال أسماء المواد', 'error');
        return;
    }
    
    // إنشاء الجدول الأسبوعي الذكي
    const schedule = createWeeklySmartSchedule({
        subjects: subjects,
        dailySubjects: dailySubjects,
        dailyHours: studyHours,
        timePreferences: timePreferences
    });
    
    currentSchedule = schedule;
    localStorage.setItem('currentWeeklySchedule', JSON.stringify(schedule));
    
    displayWeeklySchedule(schedule);
    closeWeeklyScheduleModal();
    showPage("weekly-schedule");
    
    showNotification('تم إنشاء جدولك الأسبوعي بنجاح!');
}

function createWeeklySmartSchedule(config) {
    const { subjects, dailySubjects, dailyHours, timePreferences } = config;
    
    // تعريف فترات الدراسة
    const timeSlots = {
        morning: { start: '06:00', end: '12:00' },
        afternoon: { start: '12:00', end: '16:00' },
        evening: { start: '16:00', end: '20:00' },
        night: { start: '20:00', end: '00:00' },
        anytime: { start: '08:00', end: '22:00' }
    };
    
    // اختيار أوقات الدراسة بناءً على التفضيلات
    let availableTimeSlots = [];
    timePreferences.forEach(pref => {
        if (timeSlots[pref]) {
            availableTimeSlots.push(timeSlots[pref]);
        }
    });
    
    if (availableTimeSlots.length === 0 && timePreferences.includes('anytime')) {
        availableTimeSlots.push(timeSlots.anytime);
    }
    
    // تقسيم المواد إلى علمية وأدبية
    const scientificSubjects = subjects.filter(s => s.isScientific);
    const literarySubjects = subjects.filter(s => !s.isScientific);
    
    // أيام الأسبوع
    const weekDays = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    
    // إنشاء جدول أسبوعي ذكي
    const weeklyTimetable = [];
    let dayIndex = 0;
    let remainingScientific = [...scientificSubjects];
    let remainingLiterary = [...literarySubjects];
    
    const totalMinutesPerDay = dailyHours * 60;
    const minutesPerSubject = Math.floor(totalMinutesPerDay / dailySubjects);
    
    weekDays.forEach(day => {
        const dayTimetable = [];
        let subjectsForDay = [];
        
        // تحديد المواد لهذا اليوم (ذكاء في التوزيع)
        if (remainingScientific.length > 0) {
            // أخذ مادة علمية إذا متوفرة
            subjectsForDay.push(remainingScientific.shift());
        }
        
        // إضافة مواد أدبية لتكملة اليوم
        const literaryNeeded = dailySubjects - subjectsForDay.length;
        for (let i = 0; i < literaryNeeded && remainingLiterary.length > 0; i++) {
            subjectsForDay.push(remainingLiterary.shift());
        }
        
        // إذا نفذت المواد الأدبية، أعد استخدام المواد العلمية
        if (subjectsForDay.length < dailySubjects && remainingScientific.length === 0) {
            subjectsForDay = [...subjectsForDay, ...scientificSubjects.slice(0, dailySubjects - subjectsForDay.length)];
        }
        
        // إذا ما زال هناك نقص، استخدم أي مواد متبقية
        if (subjectsForDay.length < dailySubjects) {
            const allSubjects = [...scientificSubjects, ...literarySubjects];
            subjectsForDay = [...subjectsForDay, ...allSubjects.slice(0, dailySubjects - subjectsForDay.length)];
        }
        
        // إنشاء الجدول اليومي
        let timeSlotIndex = 0;
        subjectsForDay.forEach((subject, subjectIndex) => {
            const slot = availableTimeSlots[timeSlotIndex % availableTimeSlots.length];
            const startTime = addMinutes(slot.start, subjectIndex * (minutesPerSubject + 15)); // إضافة 15 دقيقة راحة
            
            const endTime = addMinutes(startTime, minutesPerSubject);
            const difficultyStars = '★'.repeat(subject.difficulty);
            
            dayTimetable.push({
                day: day,
                subject: subject.name,
                difficulty: subject.difficulty,
                difficultyStars: difficultyStars,
                time: `${startTime} - ${endTime}`,
                duration: minutesPerSubject,
                color: getSubjectColor(subjectIndex),
                type: subject.isScientific ? 'علمي' : 'أدبي',
                slotType: Object.keys(timeSlots).find(key => timeSlots[key] === slot)
            });
            
            timeSlotIndex++;
        });
        
        weeklyTimetable.push(...dayTimetable);
    });
    
    return {
        type: 'weekly',
        subjects: subjects,
        dailySubjects: dailySubjects,
        dailyHours: dailyHours,
        timePreferences: timePreferences,
        createdAt: new Date().toLocaleString('ar-IQ'),
        timetable: weeklyTimetable,
        totalStudyTime: dailyHours * 7, // ساعات الدراسة أسبوعياً
        daysCovered: 7
    };
}

function displayWeeklySchedule(schedule) {
    const imageContainer = document.getElementById('weekly-schedule-image-container');
    
    // إنشاء الجدول للعرض
    const scheduleTable = createScheduleImage(schedule, 'weekly', false);
    imageContainer.innerHTML = scheduleTable;
    
    // إظهار أزرار التحكم
    document.querySelector('#weekly-schedule-page .post[style*="background: var(--sky)"]').style.display = 'block';
    
    // تحديث التاريخ في الختم
    document.getElementById('weekly-schedule-date').textContent = schedule.createdAt;
    document.getElementById('weekly-schedule-stamp').style.display = 'block';
}

async function saveWeeklyScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لحفظه', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('save-weekly-schedule-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    saveBtn.disabled = true;
    
    try {
        // إنشاء عنصر مؤقت للجدول مع الختم
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
        `;
        
        // إنشاء الجدول مع الختم
        const scheduleWithStamp = createScheduleImage(currentSchedule, 'weekly', true);
        tempContainer.innerHTML = scheduleWithStamp;
        document.body.appendChild(tempContainer);
        
        // استخدام html2canvas لالتقاط الصورة
        const canvas = await html2canvas(tempContainer, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
            width: tempContainer.offsetWidth,
            height: tempContainer.offsetHeight
        });
        
        // تحويل Canvas إلى صورة
        const imageData = canvas.toDataURL('image/png', 1.0);
        
        // إنشاء رابط للتنزيل
        const link = document.createElement('a');
        const fileName = `جدول_أسبوعي_${new Date().toLocaleDateString('ar-IQ').replace(/\//g, '-')}.png`;
        link.download = fileName;
        link.href = imageData;
        
        // محاكاة النقر لبدء التنزيل
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // تنظيف العنصر المؤقت
        document.body.removeChild(tempContainer);
        
        showNotification('✅ تم حفظ الجدول الأسبوعي في هاتفك بنجاح');
        
    } catch (error) {
        console.error('Error saving weekly schedule:', error);
        showNotification('❌ فشل حفظ الجدول', 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

function shareWeeklyScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لمشاركته', 'error');
        return;
    }
    
    // نسخ معلومات الجدول كنص
    const scheduleText = `
📅 *جدول الدراسة الأسبوعي*

${currentSchedule.subjects.map(s => `📚 ${s.name}`).join('%0A')}

📊 ${currentSchedule.dailySubjects} مادة يومياً
⏰ ${currentSchedule.dailyHours} ساعة دراسة يومياً
🗓️ ${currentSchedule.totalStudyTime} ساعة أسبوعياً

تم الإنشاء: ${currentSchedule.createdAt}

#سوق_الطلاب #جدول_أسبوعي
    `.trim();
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(scheduleText)}`;
    window.open(whatsappUrl, '_blank');
    showNotification('فتح واتساب للمشاركة');
}

function rateWeeklySchedule() {
    currentRating = 0;
    const scheduleName = 'الجدول الأسبوعي';
    openRatingModal(scheduleName, 'weekly');
}

// 2. دوال جدول التراكمات
function openAccumulativeScheduleModal() {
    document.getElementById('accumulative-schedule-modal').style.display = 'block';
    generateAccumulativeSubjectFields();
}

function closeAccumulativeScheduleModal() {
    document.getElementById('accumulative-schedule-modal').style.display = 'none';
}

function generateAccumulativeSubjectFields() {
    const count = parseInt(document.getElementById('accumulative-subjects-count').value) || 4;
    const container = document.getElementById('accumulative-subjects-container');
    
    let html = '<div style="margin-bottom: 15px;"><label>المواد المتراكمة</label></div>';
    
    for (let i = 1; i <= count; i++) {
        html += `
            <div class="row" style="margin-bottom: 8px;">
                <input type="text" 
                       class="form-control grow" 
                       placeholder="المادة المتراكمة ${i}"
                       id="accumulative-subject-${i}"
                       value="مادة متراكمة ${i}">
                <select class="form-control" style="width: 120px;" id="accumulative-priority-${i}">
                    <option value="1">أولوية عالية</option>
                    <option value="2" selected>أولوية متوسطة</option>
                    <option value="3">أولوية منخفضة</option>
                </select>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function generateAccumulativeSchedule() {
    const subjectsCount = parseInt(document.getElementById('accumulative-subjects-count').value) || 4;
    const studyHours = parseInt(document.getElementById('accumulative-study-hours').value) || 3;
    const totalDays = parseInt(document.getElementById('accumulative-days').value) || 20;
    
    // جمع تفضيلات الأوقات
    const timePreferences = [];
    document.querySelectorAll('input[name="accumulative-study-time-preference"]:checked').forEach(checkbox => {
        timePreferences.push(checkbox.value);
    });
    
    if (timePreferences.length === 0) {
        showNotification('يرجى اختيار وقت واحد على الأقل للدراسة', 'error');
        return;
    }
    
    // جمع المواد وأولوياتها
    const subjects = [];
    for (let i = 1; i <= subjectsCount; i++) {
        const subject = document.getElementById(`accumulative-subject-${i}`).value.trim();
        const priority = parseInt(document.getElementById(`accumulative-priority-${i}`).value) || 2;
        
        if (subject) {
            subjects.push({
                name: subject,
                priority: priority,
                daysNeeded: Math.ceil(totalDays / subjectsCount) // تقسيم الأيام بالتساوي
            });
        }
    }
    
    if (subjects.length === 0) {
        showNotification('يرجى إدخال أسماء المواد المتراكمة', 'error');
        return;
    }
    
    // إنشاء جدول التراكمات الذكي
    const schedule = createAccumulativeSmartSchedule({
        subjects: subjects,
        dailyHours: studyHours,
        totalDays: totalDays,
        timePreferences: timePreferences
    });
    
    currentSchedule = schedule;
    localStorage.setItem('currentAccumulativeSchedule', JSON.stringify(schedule));
    
    displayAccumulativeSchedule(schedule);
    closeAccumulativeScheduleModal();
    showPage("accumulative-schedule");
    
    showNotification('تم إنشاء جدول التراكمات بنجاح! يمكنك إنجازها خلال ' + totalDays + ' يوم');
}

function createAccumulativeSmartSchedule(config) {
    const { subjects, dailyHours, totalDays, timePreferences } = config;
    
    // تعريف فترات الدراسة
    const timeSlots = {
        morning: { start: '06:00', end: '12:00' },
        afternoon: { start: '12:00', end: '16:00' },
        evening: { start: '16:00', end: '20:00' },
        night: { start: '20:00', end: '00:00' }
    };
    
    // اختيار أوقات الدراسة بناءً على التفضيلات
    let availableTimeSlots = [];
    timePreferences.forEach(pref => {
        if (timeSlots[pref]) {
            availableTimeSlots.push(timeSlots[pref]);
        }
    });
    
    // حساب أيام لكل مادة بناءً على الأولوية
    const totalPriority = subjects.reduce((sum, s) => sum + s.priority, 0);
    const daysPerSubject = subjects.map(subject => {
        const days = Math.ceil((subject.priority / totalPriority) * totalDays);
        return {
            ...subject,
            assignedDays: days
        };
    });
    
    // إنشاء جدول التراكمات
    const accumulativeTimetable = [];
    let currentDay = 1;
    
    daysPerSubject.forEach(subject => {
        for (let day = 1; day <= subject.assignedDays && currentDay <= totalDays; day++) {
            const dayName = getDayName(currentDay);
            const timeSlot = availableTimeSlots[(currentDay - 1) % availableTimeSlots.length];
            const startTime = timeSlot.start;
            const endTime = addMinutes(startTime, dailyHours * 60);
            
            accumulativeTimetable.push({
                day: `اليوم ${currentDay} - ${dayName}`,
                subject: subject.name,
                priority: subject.priority,
                priorityText: ['منخفضة', 'متوسطة', 'عالية'][subject.priority - 1],
                time: `${startTime} - ${endTime}`,
                duration: dailyHours * 60,
                color: getPriorityColor(subject.priority),
                progress: `${day}/${subject.assignedDays}`,
                slotType: Object.keys(timeSlots).find(key => timeSlots[key] === timeSlot),
                focus: 'تراكمات'
            });
            
            currentDay++;
        }
    });
    
    // إضافة أيام إضافية إذا بقيت
    while (currentDay <= totalDays) {
        const subject = subjects[(currentDay - 1) % subjects.length];
        const dayName = getDayName(currentDay);
        const timeSlot = availableTimeSlots[(currentDay - 1) % availableTimeSlots.length];
        const startTime = timeSlot.start;
        const endTime = addMinutes(startTime, dailyHours * 60);
        
        accumulativeTimetable.push({
            day: `اليوم ${currentDay} - ${dayName}`,
            subject: subject.name,
            priority: subject.priority,
            priorityText: ['منخفضة', 'متوسطة', 'عالية'][subject.priority - 1],
            time: `${startTime} - ${endTime}`,
            duration: dailyHours * 60,
            color: getPriorityColor(subject.priority),
            progress: `مراجعة`,
            slotType: Object.keys(timeSlots).find(key => timeSlots[key] === timeSlot),
            focus: 'مراجعة سريعة'
        });
        
        currentDay++;
    }
    
    return {
        type: 'accumulative',
        subjects: subjects,
        dailyHours: dailyHours,
        totalDays: totalDays,
        timePreferences: timePreferences,
        createdAt: new Date().toLocaleString('ar-IQ'),
        timetable: accumulativeTimetable,
        totalStudyTime: dailyHours * totalDays,
        estimatedCompletion: totalDays + ' يوم'
    };
}

function displayAccumulativeSchedule(schedule) {
    const imageContainer = document.getElementById('accumulative-schedule-image-container');
    
    // إنشاء الجدول للعرض
    const scheduleTable = createScheduleImage(schedule, 'accumulative', false);
    imageContainer.innerHTML = scheduleTable;
    
    // إظهار أزرار التحكم
    document.querySelector('#accumulative-schedule-page .post[style*="background: var(--sky)"]').style.display = 'block';
    
    // تحديث التاريخ في الختم
    document.getElementById('accumulative-schedule-date').textContent = schedule.createdAt;
    document.getElementById('accumulative-schedule-stamp').style.display = 'block';
}

async function saveAccumulativeScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لحفظه', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('save-accumulative-schedule-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    saveBtn.disabled = true;
    
    try {
        // إنشاء عنصر مؤقت للجدول مع الختم
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
        `;
        
        // إنشاء الجدول مع الختم
        const scheduleWithStamp = createScheduleImage(currentSchedule, 'accumulative', true);
        tempContainer.innerHTML = scheduleWithStamp;
        document.body.appendChild(tempContainer);
        
        // استخدام html2canvas لالتقاط الصورة
        const canvas = await html2canvas(tempContainer, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
            width: tempContainer.offsetWidth,
            height: tempContainer.offsetHeight
        });
        
        // تحويل Canvas إلى صورة
        const imageData = canvas.toDataURL('image/png', 1.0);
        
        // إنشاء رابط للتنزيل
        const link = document.createElement('a');
        const fileName = `جدول_التراكمات_${new Date().toLocaleDateString('ar-IQ').replace(/\//g, '-')}.png`;
        link.download = fileName;
        link.href = imageData;
        
        // محاكاة النقر لبدء التنزيل
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // تنظيف العنصر المؤقت
        document.body.removeChild(tempContainer);
        
        showNotification('✅ تم حفظ جدول التراكمات في هاتفك بنجاح');
        
    } catch (error) {
        console.error('Error saving accumulative schedule:', error);
        showNotification('❌ فشل حفظ الجدول', 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

function shareAccumulativeScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لمشاركته', 'error');
        return;
    }
    
    const scheduleText = `
📚 *جدول التراكمات الدراسية*

${currentSchedule.subjects.map(s => `📖 ${s.name} (${['أولوية منخفضة', 'أولوية متوسطة', 'أولوية عالية'][s.priority - 1]})`).join('%0A')}

⏰ ${currentSchedule.dailyHours} ساعة يومياً
🗓️ ${currentSchedule.totalDays} يوم للإنجاز
✅ ${currentSchedule.estimatedCompletion} للانتهاء

تم الإنشاء: ${currentSchedule.createdAt}

#سوق_الطلاب #جدول_التراكمات
    `.trim();
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(scheduleText)}`;
    window.open(whatsappUrl, '_blank');
    showNotification('فتح واتساب للمشاركة');
}

function rateAccumulativeSchedule() {
    currentRating = 0;
    const scheduleName = 'جدول التراكمات';
    openRatingModal(scheduleName, 'accumulative');
}

// 3. دوال جدول المراجعة
function openReviewScheduleModal() {
    document.getElementById('review-schedule-modal').style.display = 'block';
    generateReviewSubjectFields();
}

function closeReviewScheduleModal() {
    document.getElementById('review-schedule-modal').style.display = 'none';
}

function generateReviewSubjectFields() {
    const count = parseInt(document.getElementById('review-subjects-count').value) || 8;
    const container = document.getElementById('review-subjects-container');
    
    let html = '<div style="margin-bottom: 15px;"><label>المواد للمراجعة النهائية</label></div>';
    
    const subjectsList = [
        'رياضيات', 'فيزياء', 'كيمياء', 'أحياء', 'عربي', 'انجليزي',
        'اسلامية', 'تاريخ', 'جغرافيا', 'اقتصاد', 'علوم', 'حاسوب'
    ];
    
    for (let i = 1; i <= count; i++) {
        const subjectName = subjectsList[Math.min(i-1, subjectsList.length-1)];
        html += `
            <div class="row" style="margin-bottom: 8px;">
                <input type="text" 
                       class="form-control grow" 
                       placeholder="مادة المراجعة ${i}"
                       id="review-subject-${i}"
                       value="${subjectName} ${i > subjectsList.length ? i : ''}">
                <select class="form-control" style="width: 120px;" id="review-importance-${i}">
                    <option value="1">أساسية</option>
                    <option value="2" selected>مهمة</option>
                    <option value="3">إضافية</option>
                </select>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

function generateReviewSchedule() {
    const subjectsCount = parseInt(document.getElementById('review-subjects-count').value) || 8;
    const studyHours = parseInt(document.getElementById('review-study-hours').value) || 5;
    const daysLeft = parseInt(document.getElementById('review-days-left').value) || 80;
    
    // جمع تفضيلات الأوقات
    const timePreferences = [];
    document.querySelectorAll('input[name="review-study-time-preference"]:checked').forEach(checkbox => {
        timePreferences.push(checkbox.value);
    });
    
    if (timePreferences.length === 0) {
        showNotification('يرجى اختيار وقت واحد على الأقل للمراجعة', 'error');
        return;
    }
    
    // جمع المواد وأهميتها
    const subjects = [];
    for (let i = 1; i <= subjectsCount; i++) {
        const subject = document.getElementById(`review-subject-${i}`).value.trim();
        const importance = parseInt(document.getElementById(`review-importance-${i}`).value) || 2;
        
        if (subject) {
            subjects.push({
                name: subject,
                importance: importance,
                daysAllocated: Math.ceil(daysLeft / subjectsCount) // تقسيم الأيام بالتساوي
            });
        }
    }
    
    if (subjects.length === 0) {
        showNotification('يرجى إدخال أسماء المواد للمراجعة', 'error');
        return;
    }
    
    // إنشاء جدول المراجعة الذكي
    const schedule = createReviewSmartSchedule({
        subjects: subjects,
        dailyHours: studyHours,
        daysLeft: daysLeft,
        timePreferences: timePreferences
    });
    
    currentSchedule = schedule;
    localStorage.setItem('currentReviewSchedule', JSON.stringify(schedule));
    
    displayReviewSchedule(schedule);
    closeReviewScheduleModal();
    showPage("review-schedule");
    
    showNotification('تم إنشاء جدول المراجعة النهائية بنجاح! بقي ' + daysLeft + ' يوم للامتحانات');
}

function createReviewSmartSchedule(config) {
    const { subjects, dailyHours, daysLeft, timePreferences } = config;
    
    // تعريف فترات الدراسة للمراجعة
    const timeSlots = {
        morning: { start: '06:00', end: '12:00', efficiency: 0.9 },
        afternoon: { start: '12:00', end: '16:00', efficiency: 0.7 },
        evening: { start: '16:00', end: '20:00', efficiency: 0.8 },
        anytime: { start: '08:00', end: '22:00', efficiency: 0.75 }
    };
    
    // اختيار أوقات الدراسة بناءً على التفضيلات والكفاءة
    let availableTimeSlots = [];
    timePreferences.forEach(pref => {
        if (timeSlots[pref]) {
            availableTimeSlots.push(timeSlots[pref]);
        }
    });
    
    if (availableTimeSlots.length === 0 && timePreferences.includes('anytime')) {
        availableTimeSlots.push(timeSlots.anytime);
    }
    
    // فرز المواد حسب الأهمية
    const sortedSubjects = [...subjects].sort((a, b) => a.importance - b.importance);
    
    // حساب أيام لكل مادة بناءً على الأهمية
    const totalImportance = sortedSubjects.reduce((sum, s) => sum + s.importance, 0);
    const daysPerSubject = sortedSubjects.map(subject => {
        const days = Math.ceil((subject.importance / totalImportance) * daysLeft);
        return {
            ...subject,
            reviewDays: days,
            dailyHours: Math.ceil((dailyHours * (subject.importance / 3)) * 10) / 10 // ساعات حسب الأهمية
        };
    });
    
    // إنشاء جدول المراجعة
    const reviewTimetable = [];
    let currentDay = 1;
    
    daysPerSubject.forEach(subject => {
        for (let day = 1; day <= subject.reviewDays && currentDay <= daysLeft; day++) {
            const dayName = getDayName(currentDay);
            const timeSlot = availableTimeSlots[(currentDay - 1) % availableTimeSlots.length];
            const startTime = timeSlot.start;
            const endTime = addMinutes(startTime, subject.dailyHours * 60);
            
            reviewTimetable.push({
                day: `اليوم ${currentDay} - ${dayName}`,
                subject: subject.name,
                importance: subject.importance,
                importanceText: ['إضافية', 'مهمة', 'أساسية'][subject.importance - 1],
                time: `${startTime} - ${endTime}`,
                duration: subject.dailyHours * 60,
                color: getImportanceColor(subject.importance),
                progress: `${day}/${subject.reviewDays}`,
                efficiency: Math.round(timeSlot.efficiency * 100) + '%',
                slotType: Object.keys(timeSlots).find(key => timeSlots[key] === timeSlot),
                focus: 'مراجعة نهائية'
            });
            
            currentDay++;
        }
    });
    
    // إضافة أيام للمراجعة العامة
    const generalReviewDays = Math.floor(daysLeft * 0.1); // 10% من الأيام للمراجعة العامة
    for (let day = 1; day <= generalReviewDays && currentDay <= daysLeft; day++) {
        const dayName = getDayName(currentDay);
        const timeSlot = availableTimeSlots[(currentDay - 1) % availableTimeSlots.length];
        const startTime = timeSlot.start;
        const endTime = addMinutes(startTime, dailyHours * 60);
        
        reviewTimetable.push({
            day: `اليوم ${currentDay} - ${dayName}`,
            subject: 'مراجعة عامة',
            importance: 2,
            importanceText: 'مهمة',
            time: `${startTime} - ${endTime}`,
            duration: dailyHours * 60,
            color: '#6c757d',
            progress: 'مراجعة',
            efficiency: Math.round(timeSlot.efficiency * 100) + '%',
            slotType: Object.keys(timeSlots).find(key => timeSlots[key] === timeSlot),
            focus: 'مراجعة شاملة'
        });
        
        currentDay++;
    }
    
    return {
        type: 'review',
        subjects: subjects,
        dailyHours: dailyHours,
        daysLeft: daysLeft,
        timePreferences: timePreferences,
        createdAt: new Date().toLocaleString('ar-IQ'),
        timetable: reviewTimetable,
        totalStudyTime: dailyHours * daysLeft,
        completionDate: calculateCompletionDate(daysLeft),
        generalReviewDays: generalReviewDays
    };
}

function displayReviewSchedule(schedule) {
    const imageContainer = document.getElementById('review-schedule-image-container');
    
    // إنشاء الجدول للعرض
    const scheduleTable = createScheduleImage(schedule, 'review', false);
    imageContainer.innerHTML = scheduleTable;
    
    // إظهار أزرار التحكم
    document.querySelector('#review-schedule-page .post[style*="background: var(--sky)"]').style.display = 'block';
    
    // تحديث التاريخ في الختم
    document.getElementById('review-schedule-date').textContent = schedule.createdAt;
    document.getElementById('review-schedule-stamp').style.display = 'block';
}

async function saveReviewScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لحفظه', 'error');
        return;
    }
    
    const saveBtn = document.getElementById('save-review-schedule-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
    saveBtn.disabled = true;
    
    try {
        // إنشاء عنصر مؤقت للجدول مع الختم
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            left: -10000px;
            top: -10000px;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: white;
        `;
        
        // إنشاء الجدول مع الختم
        const scheduleWithStamp = createScheduleImage(currentSchedule, 'review', true);
        tempContainer.innerHTML = scheduleWithStamp;
        document.body.appendChild(tempContainer);
        
        // استخدام html2canvas لالتقاط الصورة
        const canvas = await html2canvas(tempContainer, {
            scale: 2,
            backgroundColor: '#ffffff',
            useCORS: true,
            logging: false,
            width: tempContainer.offsetWidth,
            height: tempContainer.offsetHeight
        });
        
        // تحويل Canvas إلى صورة
        const imageData = canvas.toDataURL('image/png', 1.0);
        
        // إنشاء رابط للتنزيل
        const link = document.createElement('a');
        const fileName = `جدول_المراجعة_${new Date().toLocaleDateString('ar-IQ').replace(/\//g, '-')}.png`;
        link.download = fileName;
        link.href = imageData;
        
        // محاكاة النقر لبدء التنزيل
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // تنظيف العنصر المؤقت
        document.body.removeChild(tempContainer);
        
        showNotification('✅ تم حفظ جدول المراجعة في هاتفك بنجاح');
        
    } catch (error) {
        console.error('Error saving review schedule:', error);
        showNotification('❌ فشل حفظ الجدول', 'error');
    } finally {
        saveBtn.innerHTML = originalText;
        saveBtn.disabled = false;
    }
}

function shareReviewScheduleAsImage() {
    if (!currentSchedule) {
        showNotification('لا يوجد جدول لمشاركته', 'error');
        return;
    }
    
    const scheduleText = `
📖 *جدول المراجعة النهائية*

${currentSchedule.subjects.map(s => `📚 ${s.name} (${['إضافية', 'مهمة', 'أساسية'][s.importance - 1]})`).join('%0A')}

⏰ ${currentSchedule.dailyHours} ساعة مراجعة يومياً
🗓️ ${currentSchedule.daysLeft} يوم للامتحانات
📅 ${currentSchedule.completionDate} تاريخ الانتهاء المتوقع

تم الإنشاء: ${currentSchedule.createdAt}

#سوق_الطلاب #جدول_المراجعة
    `.trim();
    
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(scheduleText)}`;
    window.open(whatsappUrl, '_blank');
    showNotification('فتح واتساب للمشاركة');
}

function rateReviewSchedule() {
    currentRating = 0;
    const scheduleName = 'جدول المراجعة النهائية';
    openRatingModal(scheduleName, 'review');
}

// ==================== دوال مساعدة مشتركة ====================

function getDayName(dayNumber) {
    const days = ['الأحد', 'الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
    return days[(dayNumber - 1) % 7];
}

function getPriorityColor(priority) {
    switch(priority) {
        case 1: return '#dc3545'; // عالية - أحمر
        case 2: return '#ffc107'; // متوسطة - أصفر
        case 3: return '#28a745'; // منخفضة - أخضر
        default: return '#6c757d';
    }
}

function getImportanceColor(importance) {
    switch(importance) {
        case 1: return '#28a745'; // أساسية - أخضر
        case 2: return '#ffc107'; // مهمة - أصفر
        case 3: return '#6c757d'; // إضافية - رمادي
        default: return '#6c757d';
    }
}

function calculateCompletionDate(daysToAdd) {
    const today = new Date();
    today.setDate(today.getDate() + daysToAdd);
    return today.toLocaleDateString('ar-IQ', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
}

function openRatingModal(scheduleName, scheduleType) {
    document.getElementById('rating-modal').style.display = 'block';
    document.getElementById('rating-comment').value = '';
    currentRating = 0;
    currentScheduleType = scheduleType;
    currentScheduleName = scheduleName;
    
    // إعادة تعيين النجوم
    const starsContainer = document.getElementById('rating-stars-input');
    starsContainer.innerHTML = `
        <span onclick="setRating(1)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(2)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(3)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(4)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
        <span onclick="setRating(5)" style="cursor: pointer; margin: 0 5px; color: #ccc;">☆</span>
    `;
}

function createScheduleImage(schedule, scheduleType, forExport = false) {
    // تحديد حجم الخط بناءً على ما إذا كانت للتصدير أو للعرض
    const baseFontSize = forExport ? '12px' : '10px';
    const headingFontSize = forExport ? '16px' : '14px';
    
    let title = '';
    let icon = '';
    
    switch(scheduleType) {
        case 'weekly':
            title = '📅 جدول الدراسة الأسبوعي';
            icon = 'fas fa-calendar-week';
            break;
        case 'accumulative':
            title = '📚 جدول التراكمات الدراسية';
            icon = 'fas fa-layer-group';
            break;
        case 'review':
            title = '📖 جدول المراجعة النهائية';
            icon = 'fas fa-book-open';
            break;
        default:
            title = '📅 جدول الدراسة';
            icon = 'fas fa-calendar-alt';
    }
    
    let tableHTML = `
        <div id="${scheduleType}-schedule-table-container" style="
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: ${forExport ? '10px' : '8px'};
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            font-family: 'Tajawal', sans-serif;
            font-size: ${baseFontSize};
            line-height: 1.3;
        ">
            <!-- عنوان الجدول -->
            <div style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: ${forExport ? '15px' : '12px'};
                text-align: center;
            ">
                <h2 style="
                    margin: 0;
                    font-size: ${headingFontSize};
                    font-weight: 900;
                ">
                    <i class="${icon}" style="margin-left: 8px;"></i>
                    ${title}
                </h2>
                <div style="
                    margin-top: 5px;
                    font-size: ${forExport ? '13px' : '11px'};
                    opacity: 0.9;
                ">${schedule.createdAt}</div>
            </div>
            
            <!-- معلومات سريعة حسب نوع الجدول -->
            <div style="
                padding: ${forExport ? '12px' : '10px'};
                background: #f8f9fa;
                border-bottom: 1px solid #e9ecef;
            ">
                <div style="
                    display: flex;
                    justify-content: space-between;
                    flex-wrap: wrap;
                    gap: ${forExport ? '10px' : '5px'};
                    text-align: center;
                ">
    `;
    
    // إضافة إحصائيات حسب نوع الجدول
    if (scheduleType === 'weekly') {
        tableHTML += `
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--primary-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.subjects.length}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">المواد</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--success-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.dailySubjects}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">مادة/يوم</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--warning-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.totalStudyTime} س</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">أسبوعياً</div>
                    </div>
        `;
    } else if (scheduleType === 'accumulative') {
        tableHTML += `
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--primary-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.subjects.length}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">التراكمات</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--success-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.dailyHours} س</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">يومياً</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--warning-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.totalDays}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">يوم للإنجاز</div>
                    </div>
        `;
    } else if (scheduleType === 'review') {
        tableHTML += `
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--primary-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.subjects.length}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">المواد</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--success-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.daysLeft}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">يوم للامتحانات</div>
                    </div>
                    <div style="flex: 1;">
                        <div style="
                            font-weight: 900;
                            color: var(--warning-color);
                            font-size: ${forExport ? '20px' : '16px'};
                        ">${schedule.completionDate}</div>
                        <div style="
                            font-size: ${forExport ? '12px' : '10px'};
                            color: #666;
                        ">تاريخ الانتهاء</div>
                    </div>
        `;
    }
    
    tableHTML += `
                </div>
            </div>
            
            <!-- جدول المواد - تصميم متجاوب -->
            <div style="
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                max-width: 100%;
            ">
                <table style="
                    width: 100%;
                    border-collapse: collapse;
                    min-width: 100%;
                    table-layout: fixed;
                ">
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
    `;
    
    // تحديد الأعمدة حسب نوع الجدول
    if (scheduleType === 'weekly') {
        tableHTML += `
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">اليوم</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 20%;">المادة</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الوقت</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">المدة</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الصعوبة</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 20%;">النوع</th>
        `;
    } else if (scheduleType === 'accumulative') {
        tableHTML += `
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 20%;">اليوم</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 20%;">المادة</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الوقت</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الأولوية</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">التقدم</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">التركيز</th>
        `;
    } else if (scheduleType === 'review') {
        tableHTML += `
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 20%;">اليوم</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 20%;">المادة</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الوقت</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الأهمية</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">التقدم</th>
                            <th style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #34495e; font-size: ${forExport ? '13px' : '11px'}; width: 15%;">الكفاءة</th>
        `;
    }
    
    tableHTML += `
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    // إضافة بيانات الجدول
    schedule.timetable.forEach((item, index) => {
        const rowColor = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
        
        let rowHTML = `
            <tr style="background: ${rowColor};">
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-weight: 700; color: #2c3e50; font-size: ${forExport ? '12px' : '10px'};">
                    ${item.day}
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: right; border: 1px solid #dee2e6; font-weight: 700; font-size: ${forExport ? '12px' : '10px'};">
                    ${item.subject}
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-size: ${forExport ? '12px' : '10px'};">
                    <div style="font-weight: 700; color: #2c3e50;">${item.time.split(' - ')[0]}</div>
                    <div style="font-size: ${forExport ? '11px' : '9px'}; color: #666;">${item.time.split(' - ')[1]}</div>
                </td>
        `;
        
        if (scheduleType === 'weekly') {
            const minutes = item.duration;
            const difficultyStars = '★'.repeat(item.difficulty);
            
            rowHTML += `
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-size: ${forExport ? '12px' : '10px'};">
                    ${Math.floor(minutes / 60)}س<br>
                    <span style="font-size: ${forExport ? '11px' : '9px'};">${minutes % 60}د</span>
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; color: ${getDifficultyColor(item.difficulty)}; font-weight: 700; font-size: ${forExport ? '12px' : '10px'};">
                    <div>${difficultyStars}</div>
                    <div style="font-size: ${forExport ? '11px' : '9px'};">${['سهلة', 'متوسطة', 'صعبة', 'صعبة جداً'][item.difficulty - 1]}</div>
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-size: ${forExport ? '12px' : '10px'};">
                    <span style="display: inline-block; padding: 3px 8px; background: ${item.color}; color: white; border-radius: 15px; font-size: ${forExport ? '11px' : '9px'}; font-weight: 700;">
                        ${item.type}
                    </span>
                </td>
            `;
        } else if (scheduleType === 'accumulative') {
            rowHTML += `
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; color: ${getPriorityColor(item.priority)}; font-weight: 700; font-size: ${forExport ? '12px' : '10px'};">
                    ${item.priorityText}
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-size: ${forExport ? '12px' : '10px'};">
                    <span style="display: inline-block; padding: 3px 8px; background: ${item.progress.includes('/') ? '#28a745' : '#ffc107'}; color: white; border-radius: 15px; font-size: ${forExport ? '11px' : '9px'}; font-weight: 700;">
                        ${item.progress}
                    </span>
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-size: ${forExport ? '12px' : '10px'};">
                    ${item.focus}
                </td>
            `;
        } else if (scheduleType === 'review') {
            rowHTML += `
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; color: ${getImportanceColor(item.importance)}; font-weight: 700; font-size: ${forExport ? '12px' : '10px'};">
                    ${item.importanceText}
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; font-size: ${forExport ? '12px' : '10px'};">
                    <span style="display: inline-block; padding: 3px 8px; background: ${item.progress.includes('/') ? '#28a745' : '#6c757d'}; color: white; border-radius: 15px; font-size: ${forExport ? '11px' : '9px'}; font-weight: 700;">
                        ${item.progress}
                    </span>
                </td>
                <td style="padding: ${forExport ? '10px' : '8px'}; text-align: center; border: 1px solid #dee2e6; color: ${item.efficiency === '90%' ? '#28a745' : item.efficiency === '80%' ? '#ffc107' : '#fd7e14'}; font-weight: 700; font-size: ${forExport ? '12px' : '10px'};">
                    ${item.efficiency}
                </td>
            `;
        }
        
        rowHTML += `</tr>`;
        tableHTML += rowHTML;
    });
    
    tableHTML += `
                    </tbody>
                </table>
            </div>
            
            <!-- ملاحظات حسب نوع الجدول -->
            <div style="
                padding: ${forExport ? '15px' : '12px'};
                background: #f1f8ff;
                border-top: 1px solid #d0dcff;
            ">
                <h4 style="
                    color: #2c3e50;
                    margin-bottom: 8px;
                    text-align: center;
                    font-size: ${forExport ? '14px' : '12px'};
                ">📝 نصائح وإرشادات</h4>
                <div style="
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                    gap: ${forExport ? '10px' : '6px'};
                    font-size: ${forExport ? '12px' : '10px'};
                ">
    `;
    
    if (scheduleType === 'weekly') {
        tableHTML += `
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #4a6bff;">
                        <div style="font-weight: 700; color: #4a6bff;">🔄 تناوب المواد</div>
                        <div style="color: #666;">تناوب بين المواد العلمية والأدبية</div>
                    </div>
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #28a745;">
                        <div style="font-weight: 700; color: #28a745;">📚 مراجعة أسبوعية</div>
                        <div style="color: #666;">خصص ساعة للمراجعة الأسبوعية</div>
                    </div>
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #ffc107;">
                        <div style="font-weight: 700; color: #ffc107;">💤 فترات راحة</div>
                        <div style="color: #666;">خذ راحة 15 دقيقة بعد كل ساعة</div>
                    </div>
        `;
    } else if (scheduleType === 'accumulative') {
        tableHTML += `
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #4a6bff;">
                        <div style="font-weight: 700; color: #4a6bff;">⚡ ركز على الأولويات</div>
                        <div style="color: #666;">ابدأ بالمواد عالية الأولوية</div>
                    </div>
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #28a745;">
                        <div style="font-weight: 700; color: #28a745;">🎯 قسم المهام</div>
                        <div style="color: #666;">قسّم كل مادة إلى أجزاء صغيرة</div>
                    </div>
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #ffc107;">
                        <div style="font-weight: 700; color: #ffc107;">✅ تتبع التقدم</div>
                        <div style="color: #666;">ضع علامة ✓ عند إنجاز كل جزء</div>
                    </div>
        `;
    } else if (scheduleType === 'review') {
        tableHTML += `
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #4a6bff;">
                        <div style="font-weight: 700; color: #4a6bff;">🧠 جدول المراجعة</div>
                        <div style="color: #666;">راجع المواد الأساسية أولاً</div>
                    </div>
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #28a745;">
                        <div style="font-weight: 700; color: #28a745;">📝 حل الأسئلة</div>
                        <div style="color: #666;">حل أسئلة السنوات السابقة</div>
                    </div>
                    <div style="padding: 8px; background: white; border-radius: 6px; border-right: 2px solid #ffc107;">
                        <div style="font-weight: 700; color: #ffc107;">⏰ إدارة الوقت</div>
                        <div style="color: #666;">تمرن على حل الأسئلة بوقت محدد</div>
                    </div>
        `;
    }
    
    tableHTML += `
                </div>
            </div>
    `;
    
    // إضافة الختم فقط عند التصدير
    if (forExport) {
        tableHTML += `
            <!-- ختم التطبيق - يظهر فقط عند الحفظ/المشاركة -->
            <div style="
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-align: center;
                border-top: 2px solid #4a6bff;
            ">
                <div style="
                    font-weight: 900;
                    font-size: 14px;
                    margin-bottom: 5px;
                ">من تطبيق سوق الطلاب - ${title.split(' ')[1]}</div>
                <div style="
                    font-size: 12px;
                    opacity: 0.9;
                ">${schedule.createdAt}</div>
            </div>
        `;
    }
    
    tableHTML += `</div>`;
    
    return tableHTML;
}

function getDifficultyColor(difficulty) {
    switch(difficulty) {
        case 1: return '#28a745'; // سهلة
        case 2: return '#ffc107'; // متوسطة
        case 3: return '#fd7e14'; // صعبة
        case 4: return '#dc3545'; // صعبة جداً
        default: return '#6c757d';
    }
}

// ==================== استبدال دوال الصفحات ====================

// استبدال showDailySchedulePage للتعامل مع الأنواع المختلفة
function showDailySchedulePage() {
    showPage("daily-schedule");
    
    // تحميل الجدول المحفوظ إن وجد
    const savedSchedule = localStorage.getItem('currentDailySchedule');
    if (savedSchedule) {
        try {
            const schedule = JSON.parse(savedSchedule);
            currentSchedule = schedule;
            displaySchedulePage('daily', schedule);
        } catch (error) {
            console.error('Error loading schedule:', error);
            showNoScheduleMessage('daily');
        }
    } else {
        showNoScheduleMessage('daily');
    }
}

// دالة عامة لعرض أي جدول
function displaySchedulePage(scheduleType, schedule) {
    const imageContainer = document.getElementById(`${scheduleType}-schedule-image-container`);
    const page = document.getElementById(`${scheduleType}-schedule-page`);
    
    if (page && imageContainer) {
        // إنشاء الجدول للعرض
        const scheduleTable = createScheduleImage(schedule, scheduleType, false);
        imageContainer.innerHTML = scheduleTable;
        
        // إظهار أزرار التحكم
        const controls = page.querySelector('.post[style*="background: var(--sky)"]');
        if (controls) {
            controls.style.display = 'block';
        }
        
        // تحديث التاريخ في الختم
        const dateElement = document.getElementById(`${scheduleType}-schedule-date`);
        if (dateElement) {
            dateElement.textContent = schedule.createdAt;
        }
        
        const stampElement = document.getElementById(`${scheduleType}-schedule-stamp`);
        if (stampElement) {
            stampElement.style.display = 'block';
        }
        
        showNotification(`تم تحميل ${getScheduleTypeName(scheduleType)}`);
    }
}

// دالة لعرض رسالة عدم وجود جدول
function showNoScheduleMessage(scheduleType) {
    const imageContainer = document.getElementById(`${scheduleType}-schedule-image-container`);
    const page = document.getElementById(`${scheduleType}-schedule-page`);
    
    if (page && imageContainer) {
        imageContainer.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 64px; margin-bottom: 20px; color: var(--light-text);">
                    ${getScheduleIcon(scheduleType)}
                </div>
                <h3 style="color: var(--primary-color); margin-bottom: 15px;">
                    لا يوجد ${getScheduleTypeName(scheduleType)} حالياً
                </h3>
                <p style="color: var(--light-text); margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
                    ${getScheduleDescription(scheduleType)}
                </p>
                <button class="btn btn-success" onclick="${getModalFunction(scheduleType)}()" style="padding: 12px 30px; font-size: 16px;">
                    <i class="fas fa-plus-circle"></i> إنشاء ${getScheduleTypeName(scheduleType)} جديد
                </button>
            </div>
        `;
        
        const controls = page.querySelector('.post[style*="background: var(--sky)"]');
        if (controls) {
            controls.style.display = 'none';
        }
    }
}

// دوال مساعدة
function getScheduleTypeName(scheduleType) {
    switch(scheduleType) {
        case 'daily': return 'جدول يومي';
        case 'weekly': return 'جدول أسبوعي';
        case 'accumulative': return 'جدول التراكمات';
        case 'review': return 'جدول المراجعة';
        default: return 'جدول';
    }
}

function getScheduleIcon(scheduleType) {
    switch(scheduleType) {
        case 'daily': return '📅';
        case 'weekly': return '🗓️';
        case 'accumulative': return '📚';
        case 'review': return '📖';
        default: return '📋';
    }
}

function getScheduleDescription(scheduleType) {
    switch(scheduleType) {
        case 'daily': return 'أنشئ جدولك الدراسي الأول الآن للحصول على جدول يومي مخصص';
        case 'weekly': return 'أنشئ جدولك الأسبوعي الآن لتوزيع المواد على أيام الأسبوع';
        case 'accumulative': return 'أنشئ جدول التراكمات لإنجاز المواد المتراكمة بأسرع وقت';
        case 'review': return 'أنشئ جدول المراجعة النهائية للتحضير للامتحانات';
        default: return 'أنشئ جدولك الدراسي الآن';
    }
}

function getModalFunction(scheduleType) {
    switch(scheduleType) {
        case 'daily': return 'openDailyScheduleModal';
        case 'weekly': return 'openWeeklyScheduleModal';
        case 'accumulative': return 'openAccumulativeScheduleModal';
        case 'review': return 'openReviewScheduleModal';
        default: return 'openDailyScheduleModal';
    }
}

// ==================== تحديث دوال التقييم ====================

let currentScheduleType = '';
let currentScheduleName = '';

// تحديث دالة submitRating لدعم الأنواع المختلفة
async function submitRating() {
    if (currentRating === 0) {
        showNotification('يرجى اختيار عدد النجوم', 'error');
        return;
    }
    
    const comment = document.getElementById('rating-comment').value.trim();
    
    // التحقق من اتصال المستخدم
    if (!currentUser) {
        showNotification('يرجى تسجيل الدخول لإرسال التقييم', 'error');
        closeRatingModal();
        return;
    }
    
    const btn = document.querySelector('#rating-modal .btn[onclick="submitRating()"]');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
    
    try {
        const ratingData = {
            id: Date.now().toString(),
            rating: currentRating,
            comment: comment,
            scheduleType: currentScheduleType,
            scheduleName: currentScheduleName,
            createdAt: new Date().toLocaleString('ar-IQ'),
            userId: currentUser.uid,
            userName: currentUser.name || 'مستخدم',
            userEmail: currentUser.email || 'غير معروف',
            userShortUid: currentUser.shortUid || generateShortUid(currentUser.uid)
        };
        
        // حفظ محلياً
        scheduleRatings.push(ratingData);
        localStorage.setItem('scheduleRatings', JSON.stringify(scheduleRatings));
        
        // إرسال إلى المالك عبر Firebase
        await sendRatingToOwner(ratingData);
        
        showNotification('✅ تم إرسال تقييمك إلى المالك بنجاح');
        closeRatingModal();
        
    } catch (error) {
        console.error('Error submitting rating:', error);
        showNotification('❌ فشل إرسال التقييم، حاول مرة أخرى', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// تحديث دالة sendRatingToOwner لدعم الأنواع المختلفة
async function sendRatingToOwner(ratingData) {
    try {
        // البحث عن المالك في قاعدة البيانات
        const ownerQuery = await db.collection('users')
            .where('email', '==', APP_OWNER_EMAIL)
            .limit(1)
            .get();
        
        if (ownerQuery.empty) {
            console.error('Owner not found in database');
            throw new Error('المالك غير موجود في النظام');
        }
        
        const ownerDoc = ownerQuery.docs[0];
        const ownerUid = ownerDoc.id;
        
        // إنشاء رسالة تفصيلية حسب نوع الجدول
        const stars = '★'.repeat(ratingData.rating) + '☆'.repeat(5 - ratingData.rating);
        
        let scheduleInfo = '';
        if (currentSchedule) {
            switch(ratingData.scheduleType) {
                case 'weekly':
                    scheduleInfo = `المواد: ${currentSchedule.subjects.length} | ${currentSchedule.dailySubjects} مادة/يوم`;
                    break;
                case 'accumulative':
                    scheduleInfo = `التراكمات: ${currentSchedule.subjects.length} | ${currentSchedule.totalDays} يوم للإنجاز`;
                    break;
                case 'review':
                    scheduleInfo = `المواد: ${currentSchedule.subjects.length} | ${currentSchedule.daysLeft} يوم للامتحانات`;
                    break;
                default:
                    scheduleInfo = `جدول ${ratingData.scheduleName}`;
            }
        }
        
        const message = `
🌟 تقييم جديد - ${ratingData.scheduleName}

👤 المستخدم: ${ratingData.userName}
📧 البريد: ${ratingData.userEmail}
🆔 المعرف: ${ratingData.userShortUid}

📊 التقييم: ${stars} (${ratingData.rating}/5)
📋 نوع الجدول: ${ratingData.scheduleName}
💬 التعليق: ${ratingData.comment || 'بدون تعليق'}

${scheduleInfo ? `📝 معلومات الجدول: ${scheduleInfo}` : ''}

📅 تاريخ التقييم: ${ratingData.createdAt}
        `.trim();
        
        // إرسال إلى صندوق الوارد الخاص بالمالك
        await db.collection('inbox').add({
            userId: ownerUid,
            type: 'schedule_rating',
            title: `⭐ تقييم جديد - ${ratingData.scheduleName}`,
            message: message,
            rating: ratingData.rating,
            comment: ratingData.comment,
            scheduleType: ratingData.scheduleType,
            scheduleName: ratingData.scheduleName,
            userName: ratingData.userName,
            userEmail: ratingData.userEmail,
            userShortUid: ratingData.userShortUid,
            scheduleInfo: scheduleInfo,
            status: 'unread',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            metadata: {
                scheduleId: currentSchedule ? 'current' : null,
                ratingId: ratingData.id,
                timestamp: Date.now()
            }
        });
        
        console.log('Rating sent to owner successfully');
        
        // أيضاً، حفظ في مجموعة مستقلة للتقارير
        await db.collection('schedule_ratings').add({
            ...ratingData,
            ownerUid: ownerUid,
            sentAt: firebase.firestore.FieldValue.serverTimestamp(),
            delivered: true
        });
        
        return true;
        
    } catch (error) {
        console.error('Error sending rating to owner:', error);
        
        // محاولة بديلة: حفظ محلياً ومحاولة إرسال لاحقاً
        const pendingRatings = JSON.parse(localStorage.getItem('pendingRatings') || '[]');
        pendingRatings.push({
            ...ratingData,
            retryCount: 0,
            lastTry: Date.now()
        });
        localStorage.setItem('pendingRatings', JSON.stringify(pendingRatings));
        
        // جدولة إعادة المحاولة
        setTimeout(retryPendingRatings, 60000); // بعد دقيقة
        
        throw error;
    }
}

// ==================== تهيئة الصفحات الجديدة ====================

// إضافة الصفحات الجديدة إلى نظام الصفحات
function initializePages() {
    console.log('✅ بدء تهيئة صفحات التطبيق...');
    
    try {
        pages = {
            auth: document.getElementById("auth-page"),
            main: document.getElementById("main-page"),
            profile: document.getElementById("profile-page"),
            userPosts: document.getElementById("user-posts-page"),
            inbox: document.getElementById("inbox-page"),
            details: document.getElementById("details-page"),
            comments: document.getElementById("comments-page"),
            userStatistics: document.getElementById("user-statistics-page"),
            adminPanel: document.getElementById("admin-panel-page"),
            userManagement: document.getElementById("user-management-page"),
            broadcastPanel: document.getElementById("broadcast-panel-page"),
            privacyPolicy: document.getElementById("privacy-policy-page"),
            support: document.getElementById("support-page"),
            userSupport: document.getElementById("user-support-page"), 
            "study-assistant": document.getElementById("study-assistant-page"),
            "ai-chat-page": document.getElementById("ai-chat-page"),
            "study-timer-page": document.getElementById("study-timer-page"),
            "poems-page": document.getElementById("poems-page"),
            "ai-training-page": document.getElementById("ai-training-page"),
            "daily-tasks": document.getElementById("daily-tasks-page"),
            "study-schedules": document.getElementById("study-schedules-page"),
            "daily-schedule": document.getElementById("daily-schedule-page"),
            // الصفحات الجديدة
            "weekly-schedule": document.getElementById("weekly-schedule-page"),
            "accumulative-schedule": document.getElementById("accumulative-schedule-page"),
            "review-schedule": document.getElementById("review-schedule-page")
        };
        
        console.log('✅ تم تهيئة جميع الصفحات بنجاح');
        
    } catch (error) {
        console.error('❌ خطأ في تهيئة الصفحات:', error);
    }
}

// تهيئة الحقول عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        // توليد الحقول الأولية للجداول
        if (document.getElementById('weekly-subjects-count')) {
            generateWeeklySubjectFields();
        }
        if (document.getElementById('accumulative-subjects-count')) {
            generateAccumulativeSubjectFields();
        }
        if (document.getElementById('review-subjects-count')) {
            generateReviewSubjectFields();
        }
    }, 1000);
});

// ==================== اختبار النظام الجديد ====================

// دالة لاختبار النظام الجديد
function testNewSchedules() {
    console.log('🔍 اختبار نظام الجداول الجديد...');
    
    // اختبار وجود العناصر
    const tests = [
        { id: 'weekly-schedule-modal', name: 'نافذة الجدول الأسبوعي' },
        { id: 'accumulative-schedule-modal', name: 'نافذة جدول التراكمات' },
        { id: 'review-schedule-modal', name: 'نافذة جدول المراجعة' },
        { id: 'weekly-schedule-page', name: 'صفحة الجدول الأسبوعي' },
        { id: 'accumulative-schedule-page', name: 'صفحة جدول التراكمات' },
        { id: 'review-schedule-page', name: 'صفحة جدول المراجعة' }
    ];
    
    let allPassed = true;
    
    tests.forEach(test => {
        const element = document.getElementById(test.id);
        if (element) {
            console.log(`✅ ${test.name} - موجود`);
        } else {
            console.error(`❌ ${test.name} - غير موجود`);
            allPassed = false;
        }
    });
    
    // اختبار الدوال
    const functionTests = [
        { func: typeof openWeeklyScheduleModal, name: 'openWeeklyScheduleModal' },
        { func: typeof generateWeeklySchedule, name: 'generateWeeklySchedule' },
        { func: typeof openAccumulativeScheduleModal, name: 'openAccumulativeScheduleModal' },
        { func: typeof generateAccumulativeSchedule, name: 'generateAccumulativeSchedule' },
        { func: typeof openReviewScheduleModal, name: 'openReviewScheduleModal' },
        { func: typeof generateReviewSchedule, name: 'generateReviewSchedule' }
    ];
    
    functionTests.forEach(test => {
        if (test.func === 'function') {
            console.log(`✅ دالة ${test.name} - جاهزة`);
        } else {
            console.error(`❌ دالة ${test.name} - غير موجودة`);
            allPassed = false;
        }
    });
    
    if (allPassed) {
        console.log('🎉 جميع اختبارات النظام الجديد نجحت!');
        showNotification('✅ نظام الجداول الجديد جاهز للعمل', 'success');
    } else {
        console.error('⚠️ هناك مشاكل في النظام الجديد');
        showNotification('⚠️ بعض مكونات النظام الجديد تحتاج للتصحيح', 'warning');
    }
    
    return allPassed;
}

// تشغيل الاختبار بعد تحميل الصفحة
setTimeout(testNewSchedules, 3000);

console.log('🚀 نظام الجداول الجديد محمل وجاهز للعمل!');

// ==================== FCM NOTIFICATIONS ====================

let messaging = null;

// تهيئة FCM
function initializeFCM() {
  try {
    if (!firebase.messaging.isSupported()) {
      console.log('FCM غير مدعوم في هذا المتصفح');
      return;
    }
    
    messaging = firebase.messaging();
    
    // استخدام مفتاح VAPID الخاص بك
    messaging.usePublicVapidKey("_A0Lv-o4fN9H1-urhaXehLuLjmi4576N9mPrLbiZxww");
    
    // طلب الإذن تلقائياً عند تسجيل الدخول
    if (currentUser) {
      setTimeout(requestNotificationPermission, 2000);
    }
    
    // الاستماع للإشعارات في الواجهة الأمامية
    messaging.onMessage((payload) => {
      console.log('رسالة في الواجهة الأمامية: ', payload);
      showNotification(payload.notification?.title || 'إشعار جديد', 
                      payload.notification?.body || '');
    });
    
  } catch (error) {
    console.error('خطأ في تهيئة FCM:', error);
  }
}

// طلب إذن الإشعارات
async function requestNotificationPermission() {
  if (!('Notification' in window)) {
    showNotification('المتصفح لا يدعم الإشعارات', 'error');
    return;
  }
  
  if (Notification.permission === 'granted') {
    await saveFCMToken();
    return;
  }
  
  if (Notification.permission === 'denied') {
    showNotification('تم رفض الإشعارات. يرجى السماح من إعدادات المتصفح', 'warning');
    return;
  }
  
  // طلب الإذن
  const permission = await Notification.requestPermission();
  
  if (permission === 'granted') {
    showNotification('🎉 تم تفعيل الإشعارات!', 'success');
    await saveFCMToken();
  } else {
    showNotification('تم رفض الإشعارات', 'warning');
  }
}

// حفظ Token في Firebase
async function saveFCMToken() {
  if (!messaging || !currentUser) return;
  
  try {
    // تسجيل Service Worker
    const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
    
    // الحصول على Token
    const token = await messaging.getToken({
      vapidKey: "_A0Lv-o4fN9H1-urhaXehLuLjmi4576N9mPrLbiZxww",
      serviceWorkerRegistration: registration
    });
    
    if (token) {
      // حفظ Token في Firestore
      await db.collection('users').doc(currentUser.uid).update({
        fcmToken: token,
        notificationEnabled: true,
        notificationTokenUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      console.log('✅ FCM Token saved:', token.substring(0, 20) + '...');
    }
  } catch (error) {
    console.error('❌ Error saving FCM token:', error);
  }
}

// إرسال إشعار لجميع المستخدمين
async function sendNotificationToAllUsers(title, message, data = {}) {
  try {
    const usersSnapshot = await db.collection('users')
      .where('fcmToken', '!=', null)
      .where('notificationEnabled', '==', true)
      .get();
    
    if (usersSnapshot.empty) {
      console.log('لا يوجد مستخدمين مفعلين للإشعارات');
      return;
    }
    
    const tokens = [];
    usersSnapshot.forEach(doc => {
      const token = doc.data().fcmToken;
      if (token) tokens.push(token);
    });
    
    if (tokens.length === 0) return;
    
    // إرسال دفعات لتجنب تجاوز الحدود
    for (let i = 0; i < tokens.length; i += 1000) {
      const batchTokens = tokens.slice(i, i + 1000);
      await sendNotificationBatch(batchTokens, title, message, data);
    }
    
    console.log(`✅ تم إرسال الإشعار إلى ${tokens.length} مستخدم`);
    
  } catch (error) {
    console.error('❌ Error sending notifications:', error);
  }
}

// إرسال دفعة من الإشعارات
async function sendNotificationBatch(tokens, title, message, data = {}) {
  const response = await fetch('https://fcm.googleapis.com/fcm/send', {
    method: 'POST',
    headers: {
      'Authorization': 'key=AAAAfojY3J8:APA91bE2NgJ_5r2sV0N4K...', // استبدل بمفتاح السيرفر
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      registration_ids: tokens,
      notification: {
        title: title,
        body: message,
        icon: 'https://your-domain.com/icon.png',
        badge: 'https://your-domain.com/badge.png',
        click_action: window.location.origin
      },
      data: {
        ...data,
        url: window.location.origin,
        timestamp: new Date().toISOString()
      },
      webpush: {
        fcm_options: {
          link: window.location.origin
        }
      }
    })
  });
  
  return response.json();
}

// إرسال إشعار لمستخدم واحد
async function sendNotificationToUser(userId, title, message, data = {}) {
  try {
    const userDoc = await db.collection('users').doc(userId).get();
    const userData = userDoc.data();
    
    if (!userData?.fcmToken || userData?.notificationEnabled !== true) {
      return;
    }
    
    await fetch('https://fcm.googleapis.com/fcm/send', {
      method: 'POST',
      headers: {
        'Authorization': 'key=AAAAfojY3J8:APA91bE2NgJ_5r2sV0N4K...', // استبدل بمفتاح السيرفر
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        to: userData.fcmToken,
        notification: {
          title: title,
          body: message,
          icon: 'https://your-domain.com/icon.png',
          badge: 'https://your-domain.com/badge.png'
        },
        data: {
          ...data,
          userId: userId,
          type: 'direct_notification'
        }
      })
    });
    
  } catch (error) {
    console.error('Error sending notification to user:', error);
  }
}

// ==================== تحديث الدوال الحالية ====================

// تحديث دالة sendBroadcast
async function sendBroadcast() {
  if (!isOwner()) return;
  
  const title = document.getElementById("broadcast-title").value.trim();
  const message = document.getElementById("broadcast-message").value.trim();
  
  if (!title || !message) {
    return showNotification("يرجى ملء جميع الحقول", "error");
  }

  const btn = document.querySelector('#broadcast-panel-page .btn-success');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';

  try {
    // 1. حفظ الإشعار في Firestore
    await db.collection("broadcasts").add({
      title: title,
      message: message,
      text: message,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      sentBy: currentUser.uid,
      sentByName: currentUser.name
    });

    // 2. إرسال إشعارات Push لجميع المستخدمين
    await sendNotificationToAllUsers(title, message, {
      type: 'broadcast',
      broadcastId: Date.now().toString()
    });

    showNotification("✅ تم إرسال الإشعار إلى جميع المستخدمين");
    
    document.getElementById("broadcast-title").value = "";
    document.getElementById("broadcast-message").value = "";
    
  } catch (error) {
    console.error("Error sending broadcast:", error);
    showNotification("فشل في إرسال الإشعار", "error");
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// تحديث دالة الإبلاغ
async function submitReport() {
  // ... الكود الحالي
  
  // بعد حفظ البلاغ، أرسل إشعار للمالك
  if (isOwner()) {
    await sendNotificationToUser(currentUser.uid, 
      '🚨 بلاغ جديد', 
      `بلاغ جديد على منشور ${postId}`);
  }
}

// إضافة زر تفعيل الإشعارات في البروفايل
function addNotificationButton() {
  const profileMenu = document.querySelector('.profile-menu');
  if (!profileMenu) return;
  
  const notificationItem = document.createElement('div');
  notificationItem.className = 'menu-item';
  notificationItem.onclick = 'toggleNotifications()';
  notificationItem.innerHTML = `
    <i class="fas fa-bell"></i>
    <span>تفعيل الإشعارات</span>
    <div id="notification-status" style="margin-right: auto; font-size: 12px; color: var(--success-color);">
      ${Notification.permission === 'granted' ? '✅ مفعل' : '❌ غير مفعل'}
    </div>
  `;
  
  // إضافته قبل زر تسجيل الخروج
  const logoutItem = document.querySelector('.menu-item[onclick="logout()"]');
  profileMenu.insertBefore(notificationItem, logoutItem);
}

// تفعيل/تعطيل الإشعارات
async function toggleNotifications() {
  if (Notification.permission === 'granted') {
    if (confirm('هل تريد تعطيل الإشعارات؟')) {
      await db.collection('users').doc(currentUser.uid).update({
        notificationEnabled: false
      });
      showNotification('تم تعطيل الإشعارات', 'info');
    }
  } else {
    await requestNotificationPermission();
  }
}

// ==================== التهيئة التلقائية ====================

// استدعاء عند تحميل التطبيق
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => {
    initializeFCM();
    
    // إضافة زر الإشعارات بعد تحميل البروفايل
    setTimeout(addNotificationButton, 3000);
  }, 2000);
});

// تحديث عند تسجيل الدخول
auth.onAuthStateChanged(async (user) => {
  if (user) {
    // ... الكود الحالي
    
    // تفعيل الإشعارات بعد 3 ثواني
    setTimeout(() => {
      if (messaging) {
        requestNotificationPermission();
      }
    }, 3000);
  }
});

// أضف في نهاية ملفك
async function setupSimpleNotifications() {
  console.log('🎯 بدء إعداد الإشعارات البسيطة...');
  
  // 1. طلب الإذن
  if (!('Notification' in window)) {
    alert('المتصفح لا يدعم الإشعارات');
    return;
  }
  
  if (Notification.permission === 'default') {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') return;
  }
  
  // 2. تسجيل Service Worker
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
      console.log('✅ Service Worker registered:', registration);
      
      // 3. إظهار إشعار اختبار
      setTimeout(() => {
        registration.showNotification('🎉 تهانينا!', {
          body: 'الإشعارات تعمل بنجاح',
          icon: '/icon.png',
          badge: '/badge.png',
          vibrate: [200, 100, 200]
        });
      }, 2000);
      
    } catch (error) {
      console.error('❌ Service Worker registration failed:', error);
    }
  }
}

// استدعاء الدالة عند التحميل
window.addEventListener('load', () => {
  setTimeout(setupSimpleNotifications, 3000);
});

async function sendTestNotification() {
  if (!currentUser) return;
  
  // إرسال إشعار اختبار
  if ('serviceWorker' in navigator) {
    const registration = await navigator.serviceWorker.ready;
    
    await registration.showNotification('🎯 اختبار الإشعارات', {
      body: `مرحباً ${currentUser.name}! الإشعارات تعمل`,
      icon: '/icon.png',
      badge: '/badge.png',
      tag: 'test-notification',
      requireInteraction: true,
      actions: [
        { action: 'open', title: 'فتح التطبيق' }
      ]
    });
    
    showNotification('تم إرسال إشعار اختبار');
  }
}
</script>
</body>
</html>
